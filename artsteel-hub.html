<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>J&M Artsteel Hub</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üî©</text></svg>">

    <!-- Firebase SDK for Device Authorization (shared with Safety App) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
    // XSS Protection - HTML Escape (available in first script block)
    function escapeHtml(str) {
        if (str === null || str === undefined) return '';
        return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FIREBASE CONFIGURATION (Shared with JMart Safety App)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const firebaseConfig = {
        apiKey: "AIzaSyAECfytYqggzmQ-Kxm_vqQWlEnBJMXz5H4",
        authDomain: "jmart-steel-safety.firebaseapp.com",
        databaseURL: "https://jmart-steel-safety-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "jmart-steel-safety",
        storageBucket: "jmart-steel-safety.firebasestorage.app",
        messagingSenderId: "920798274486",
        appId: "1:920798274486:web:9d6cdd8853d82280665717"
    };

    let firebaseApp = null;
    let firebaseDb = null;
    let firebaseAuthUid = null;

    try {
        firebaseApp = firebase.initializeApp(firebaseConfig);
        firebaseDb = firebase.database();
        // Sign in anonymously so security rules can use auth.uid
        firebase.auth().signInAnonymously().then(cred => {
            firebaseAuthUid = cred.user.uid;
            console.log('üî• Firebase connected, auth uid:', firebaseAuthUid);
        }).catch(err => {
            console.warn('Anonymous auth failed (app still works):', err.message);
        });
    } catch (error) {
        console.warn('Firebase error:', error);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // DEVICE AUTHORIZATION SYSTEM
    // Same system as Safety App - approved devices can use both apps
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const SteelAuth = {
        deviceId: null,
        isApproved: false,
        isAdmin: false,

        generateDeviceId() {
            const stored = localStorage.getItem('jmart-device-id');
            if (stored) { this.deviceId = stored; return stored; }

            const fingerprint = [
                navigator.userAgent, navigator.language,
                screen.width + 'x' + screen.height, screen.colorDepth,
                new Date().getTimezoneOffset(), navigator.platform
            ].join('|');

            let hash = 0;
            for (let i = 0; i < fingerprint.length; i++) {
                hash = ((hash << 5) - hash) + fingerprint.charCodeAt(i);
                hash = hash & hash;
            }

            this.deviceId = 'DEV-' + Math.abs(hash).toString(36).toUpperCase() + '-' + Date.now().toString(36).toUpperCase();
            localStorage.setItem('jmart-device-id', this.deviceId);
            return this.deviceId;
        },

        getDeviceInfo() {
            const ua = navigator.userAgent;
            let deviceType = 'Unknown';
            if (/iPhone/i.test(ua)) deviceType = 'iPhone';
            else if (/iPad/i.test(ua)) deviceType = 'iPad';
            else if (/Android/i.test(ua)) deviceType = 'Android';
            else if (/Windows/i.test(ua)) deviceType = 'Windows';
            else if (/Mac/i.test(ua)) deviceType = 'Mac';

            return { id: this.deviceId, type: deviceType, app: 'J&M Artsteel Hub', registeredAt: new Date().toISOString() };
        },

        async init() {
            this.generateDeviceId();
            console.log('üîê Device ID:', this.deviceId);

            if (!firebaseDb) {
                // Offline mode - allow access
                this.isApproved = true;
                this.isAdmin = true;
                return { approved: true, offline: true };
            }

            try {
                // Check if device is approved (same path as Safety App)
                const snap = await firebaseDb.ref('jmart-safety/devices/approved/' + this.deviceId).once('value');
                if (snap.exists()) {
                    const data = snap.val();
                    this.isApproved = true;
                    this.isAdmin = data.isAdmin || false;
                    // Update last seen and auth UID (links Firebase Auth to device)
                    const updates = { lastSeen: new Date().toISOString(), lastApp: 'STEEL' };
                    if (firebaseAuthUid) updates.authUid = firebaseAuthUid;
                    await firebaseDb.ref('jmart-safety/devices/approved/' + this.deviceId).update(updates);
                    console.log('‚úÖ Device approved, admin:', this.isAdmin);
                    return { approved: true, admin: this.isAdmin };
                }

                // Check if first device (auto-approve as admin)
                const allSnap = await firebaseDb.ref('jmart-safety/devices/approved').once('value');
                if (!allSnap.exists() || allSnap.numChildren() === 0) {
                    await this.registerAsApproved(true);
                    return { approved: true, admin: true, firstDevice: true };
                }

                // Register as pending if not already
                const pendingSnap = await firebaseDb.ref('jmart-safety/devices/pending/' + this.deviceId).once('value');
                if (!pendingSnap.exists()) {
                    await firebaseDb.ref('jmart-safety/devices/pending/' + this.deviceId).set({
                        ...this.getDeviceInfo(),
                        authUid: firebaseAuthUid || null,
                        requestedAt: new Date().toISOString(),
                        requestedFrom: 'STEEL'
                    });
                }

                this.isApproved = false;
                return { approved: false, pending: true };

            } catch (error) {
                console.error('Auth error:', error);
                // On error, allow access (don't lock out users due to network issues)
                this.isApproved = true;
                return { approved: true, error: error.message };
            }
        },

        async registerAsApproved(isAdmin) {
            if (!firebaseDb) return;
            await firebaseDb.ref('jmart-safety/devices/approved/' + this.deviceId).set({
                ...this.getDeviceInfo(),
                authUid: firebaseAuthUid || null,
                isAdmin: isAdmin,
                approvedAt: new Date().toISOString(),
                approvedFrom: 'STEEL'
            });
            this.isApproved = true;
            this.isAdmin = isAdmin;
        },

        async renameDevice(targetDeviceId, newName) {
            if (!firebaseDb || !this.isAdmin) return false;
            if (!newName || !newName.trim()) return false;
            try {
                const approvedRef = firebaseDb.ref('jmart-safety/devices/approved/' + targetDeviceId);
                const approvedSnap = await approvedRef.once('value');
                if (approvedSnap.exists()) {
                    await approvedRef.child('name').set(newName.trim());
                    return true;
                }
                const pendingRef = firebaseDb.ref('jmart-safety/devices/pending/' + targetDeviceId);
                const pendingSnap = await pendingRef.once('value');
                if (pendingSnap.exists()) {
                    await pendingRef.child('name').set(newName.trim());
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error renaming device:', error);
                return false;
            }
        },

        async approveDevice(deviceId) {
            if (!firebaseDb || !this.isAdmin) return false;
            try {
                const pendingRef = firebaseDb.ref('jmart-safety/devices/pending/' + deviceId);
                const snap = await pendingRef.once('value');
                if (!snap.exists()) return false;
                const deviceData = snap.val();
                await firebaseDb.ref('jmart-safety/devices/approved/' + deviceId).set({
                    ...deviceData,
                    isAdmin: false,
                    approvedAt: new Date().toISOString(),
                    approvedBy: 'Admin (STEEL)'
                });
                await pendingRef.remove();
                return true;
            } catch (error) {
                console.error('Error approving device:', error);
                return false;
            }
        },

        async denyDevice(deviceId) {
            if (!firebaseDb || !this.isAdmin) return false;
            try {
                await firebaseDb.ref('jmart-safety/devices/pending/' + deviceId).remove();
                return true;
            } catch (error) {
                console.error('Error denying device:', error);
                return false;
            }
        },

        async removeDevice(deviceId) {
            if (!firebaseDb || !this.isAdmin) return false;
            try {
                await firebaseDb.ref('jmart-safety/devices/approved/' + deviceId).remove();
                return true;
            } catch (error) {
                console.error('Error removing device:', error);
                return false;
            }
        },

        showPendingScreen() {
            document.body.innerHTML = `
                <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;text-align:center;padding:20px;background:linear-gradient(135deg,#1a1a2e,#16213e,#0f3460);color:#fff;font-family:system-ui,sans-serif;">
                    <div style="font-size:80px;margin-bottom:20px;">üîê</div>
                    <h1 style="font-size:2rem;margin-bottom:10px;">Device Pending Approval</h1>
                    <p style="color:#888;margin-bottom:20px;">Your device needs to be approved to access J&M Artsteel Hub.</p>
                    <div style="background:rgba(255,255,255,0.1);padding:20px;border-radius:12px;margin-bottom:20px;">
                        <p style="font-size:14px;color:#aaa;">Device ID:</p>
                        <code style="font-size:12px;color:#667eea;">${escapeHtml(this.deviceId)}</code>
                    </div>
                    <p style="color:#666;font-size:14px;">Ask an admin to approve this device in the JMart Safety App.</p>
                    <button onclick="location.reload()" style="margin-top:20px;padding:12px 24px;background:linear-gradient(135deg,#667eea,#764ba2);border:none;border-radius:8px;color:#fff;cursor:pointer;font-size:14px;">
                        üîÑ Check Again
                    </button>
                </div>
            `;
        }
    };
    </script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }
        .header {
            text-align: center;
            padding: 20px;
            margin-bottom: 20px;
        }
        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .header p { color: #888; margin-top: 8px; }

        /* Navigation */
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .nav-tab {
            padding: 12px 24px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .nav-tab:hover { background: rgba(255,255,255,0.2); }
        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .nav-tab.offline {
            opacity: 0.5;
            position: relative;
        }
        .nav-tab.offline::after {
            content: "API";
            font-size: 8px;
            background: #f59e0b;
            padding: 2px 4px;
            border-radius: 3px;
            position: absolute;
            top: -5px;
            right: -5px;
        }

        /* Agent Section */
        .agent-section {
            display: none;
            background: rgba(0,0,0,0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .agent-section.active { display: block; }
        .agent-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        .agent-icon { font-size: 2.5rem; }
        .agent-title h2 {
            color: #60a5fa;
            font-size: 1.5rem;
        }
        .agent-title p { color: #888; font-size: 0.9rem; }

        /* Controls */
        .control-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .btn-group {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 10px 16px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        .btn:hover { background: rgba(255,255,255,0.2); }
        .btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
        }
        .btn.primary {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            border: none;
        }
        label { color: rgba(255,255,255,0.7); margin-bottom: 5px; display: block; font-size: 13px; }

        /* Results */
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .result-card {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        .result-card .label { color: #888; font-size: 11px; margin-bottom: 4px; }
        .result-card .value { font-size: 1.4rem; font-weight: bold; color: #60a5fa; }
        .result-card .unit { color: #888; font-size: 12px; }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 13px;
        }
        .data-table th, .data-table td {
            padding: 10px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .data-table th {
            background: rgba(245,158,11,0.3);
            color: #f59e0b;
        }
        .data-table td { background: rgba(0,0,0,0.2); }

        /* Section Buttons Grid */
        .section-btns {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            padding: 5px;
        }
        .section-btn {
            padding: 8px 12px;
            background: rgba(59,130,246,0.2);
            border: 1px solid rgba(59,130,246,0.3);
            border-radius: 6px;
            color: #93c5fd;
            cursor: pointer;
            font-size: 12px;
            font-family: monospace;
        }
        .section-btn:hover { background: rgba(59,130,246,0.4); }
        .section-btn.active {
            background: #3b82f6;
            color: #fff;
        }

        /* Calculator inputs */
        .calc-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
            margin: 15px 0;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }
        .calc-input { flex: 1; min-width: 120px; }
        .calc-input input {
            width: 100%;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
        }
        .calc-total {
            text-align: center;
            padding: 10px 20px;
            background: rgba(34,197,94,0.2);
            border-radius: 8px;
        }
        .calc-total .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #22c55e;
        }

        /* Console */
        .console {
            background: rgba(0,0,0,0.4);
            border-radius: 8px;
            padding: 12px 15px;
            font-family: monospace;
            font-size: 13px;
            color: #22c55e;
            margin-top: 15px;
        }

        /* FRANK Specific Styles */
        .frank-section {
            border: 2px solid #10b981;
        }
        .frank-section .agent-icon {
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 12px;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .frank-section .agent-title h2 {
            color: #34d399;
        }
        .frank-quick-tasks {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }
        .frank-quick-btn {
            padding: 10px 16px;
            border: 1px solid rgba(16, 185, 129, 0.3);
            background: rgba(16, 185, 129, 0.1);
            border-radius: 20px;
            color: #6ee7b7;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .frank-quick-btn:hover {
            background: rgba(16, 185, 129, 0.25);
            border-color: #10b981;
            color: #fff;
            transform: translateY(-1px);
        }
        .frank-quick-btn.selected {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #10b981;
            color: #fff;
        }
        .frank-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        .frank-form-group {
            margin-bottom: 15px;
        }
        .frank-form-group label {
            display: block;
            color: rgba(255,255,255,0.8);
            margin-bottom: 8px;
            font-weight: 500;
        }
        .frank-form-group input,
        .frank-form-group textarea,
        .frank-form-group select {
            width: 100%;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
            box-sizing: border-box;
        }
        .frank-form-group input:focus,
        .frank-form-group textarea:focus,
        .frank-form-group select:focus {
            outline: none;
            border-color: #10b981;
        }
        .frank-form-group textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        .frank-form-group select option {
            background: #1a1a2e;
            color: #fff;
        }
        .frank-workers {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .frank-workers-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .frank-workers-header label {
            color: rgba(255,255,255,0.8);
            font-weight: 500;
        }
        .frank-workers-actions {
            display: flex;
            gap: 8px;
        }
        .frank-workers-actions button {
            padding: 5px 12px;
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.4);
            border-radius: 5px;
            color: #6ee7b7;
            font-size: 0.8rem;
            cursor: pointer;
        }
        .frank-workers-actions button:hover {
            background: rgba(16, 185, 129, 0.4);
        }
        .frank-workers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 8px;
            max-height: 180px;
            overflow-y: auto;
        }
        .frank-worker-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            color: rgba(255,255,255,0.8);
        }
        .frank-worker-checkbox:hover {
            background: rgba(16, 185, 129, 0.15);
        }
        .frank-worker-checkbox input {
            width: auto;
            accent-color: #10b981;
        }
        .frank-worker-count {
            text-align: right;
            font-size: 0.85rem;
            color: #6ee7b7;
            margin-top: 8px;
        }
        .frank-generate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        .frank-generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4);
        }
        .frank-generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .frank-progress {
            display: none;
            margin-top: 15px;
        }
        .frank-progress.active {
            display: block;
        }
        .frank-progress-bar {
            height: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            overflow: hidden;
        }
        .frank-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #34d399);
            width: 0%;
            transition: width 0.3s;
            animation: frankPulse 1.5s infinite;
        }
        @keyframes frankPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .frank-progress-text {
            text-align: center;
            color: #6ee7b7;
            margin-top: 8px;
            font-size: 0.9rem;
        }
        .frank-result {
            display: none;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
        }
        .frank-result.active {
            display: block;
        }
        .frank-result.success {
            border: 1px solid rgba(16, 185, 129, 0.5);
        }
        .frank-result.error {
            border: 1px solid rgba(239, 68, 68, 0.5);
        }
        .frank-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .frank-result-header h4 {
            color: #34d399;
            margin: 0;
        }
        .frank-result-actions {
            display: flex;
            gap: 10px;
        }
        .frank-result-btn {
            padding: 8px 15px;
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.4);
            border-radius: 6px;
            color: #6ee7b7;
            cursor: pointer;
        }
        .frank-result-btn:hover {
            background: rgba(16, 185, 129, 0.4);
        }
        .frank-result-content {
            color: rgba(255,255,255,0.9);
            line-height: 1.6;
        }
        .frank-result-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .frank-badge {
            padding: 4px 10px;
            background: rgba(16, 185, 129, 0.2);
            border-radius: 12px;
            font-size: 0.8rem;
            color: #6ee7b7;
        }
        .frank-console {
            background: rgba(0,0,0,0.5);
            border-radius: 8px;
            padding: 12px 15px;
            font-family: monospace;
            font-size: 0.85rem;
            color: #34d399;
            margin-top: 15px;
        }
        @media (max-width: 768px) {
            .frank-form-row {
                grid-template-columns: 1fr;
            }
            .frank-workers-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* API Notice */
        .api-notice {
            background: rgba(245,158,11,0.2);
            border: 1px solid rgba(245,158,11,0.5);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }
        .api-notice h3 { color: #f59e0b; margin-bottom: 10px; }
        .api-notice p { color: #fcd34d; }

        /* Status badge */
        .status-badge {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-badge.online { background: rgba(34,197,94,0.3); color: #22c55e; }
        .status-badge.offline { background: rgba(239,68,68,0.3); color: #ef4444; }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        /* IGOR Dropdown Styles */
        .igor-dropdown-container {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .igor-dropdown-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }
        .igor-labels {
            display: flex;
            gap: 8px;
            font-size: 11px;
            color: rgba(255,255,255,0.5);
        }
        .igor-labels span:nth-child(1) { flex: 2; min-width: 120px; }
        .igor-labels span:nth-child(2) { flex: 2; min-width: 150px; }
        .igor-labels span:nth-child(3) { width: 80px; }
        .igor-labels span:nth-child(4) { width: 60px; }
        .igor-labels span:nth-child(5) { width: 40px; }
        .igor-select {
            flex: 2;
            min-width: 120px;
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
        }
        .igor-select:focus { outline: none; border-color: #3b82f6; }
        .igor-select option { background: #1a1a2e; color: #fff; }
        .igor-input {
            width: 80px;
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            text-align: center;
        }
        .igor-input.igor-qty { width: 60px; }
        .igor-input:focus { outline: none; border-color: #3b82f6; }
        .igor-add-btn {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .igor-add-btn:hover { transform: scale(1.05); }
        .igor-preview {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(168,85,247,0.1);
            border: 1px solid rgba(168,85,247,0.3);
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
        }
        .igor-members-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .igor-member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: rgba(59,130,246,0.1);
            border: 1px solid rgba(59,130,246,0.2);
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .igor-member-item .weight { color: #a855f7; margin-left: auto; margin-right: 15px; }
        .igor-member-item .remove-btn {
            background: rgba(239,68,68,0.3);
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            color: #ef4444;
            cursor: pointer;
            font-size: 16px;
        }
        .igor-member-item .remove-btn:hover { background: rgba(239,68,68,0.5); }
        .igor-results {
            background: rgba(34,197,94,0.1);
            border: 1px solid rgba(34,197,94,0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        .igor-breakdown {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .igor-totals { }
        .igor-total-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 16px;
        }
        .igor-total-row.total {
            font-size: 20px;
            font-weight: bold;
            color: #22c55e;
        }
        @media (max-width: 600px) {
            .igor-dropdown-row { flex-direction: column; }
            .igor-select, .igor-input { width: 100%; min-width: unset; }
            .igor-labels { display: none; }
            .igor-add-btn { width: 100%; height: 44px; }
        }

        /* IGOR PRICING MODULE */
        .igor-pricing-section {
            margin-top: 20px;
            background: linear-gradient(135deg, rgba(34,197,94,0.1) 0%, rgba(22,163,74,0.05) 100%);
            border: 1px solid rgba(34,197,94,0.3);
            border-radius: 12px;
            padding: 20px;
        }
        .igor-pricing-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .igor-pricing-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .igor-pricing-title h3 {
            font-size: 1.2rem;
            color: #22c55e;
            margin: 0;
        }
        .igor-pricing-title .price-badge {
            font-size: 10px;
            background: rgba(34,197,94,0.3);
            padding: 3px 8px;
            border-radius: 10px;
            color: #22c55e;
        }
        .igor-pricing-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: rgba(255,255,255,0.7);
            font-size: 13px;
        }
        .igor-pricing-toggle input {
            width: 18px;
            height: 18px;
            accent-color: #22c55e;
        }
        .igor-pricing-body {
            display: none;
        }
        .igor-pricing-body.active {
            display: block;
        }

        /* Supplier Selection */
        .igor-supplier-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .igor-supplier-select {
            flex: 1;
            min-width: 200px;
            padding: 12px 15px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
        }
        .igor-supplier-select option {
            background: #1a1a2e;
            color: #fff;
        }
        .igor-supplier-btn {
            padding: 12px 16px;
            background: rgba(34,197,94,0.2);
            border: 1px solid rgba(34,197,94,0.4);
            border-radius: 8px;
            color: #22c55e;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .igor-supplier-btn:hover {
            background: rgba(34,197,94,0.3);
        }
        .igor-supplier-btn.danger {
            background: rgba(239,68,68,0.2);
            border-color: rgba(239,68,68,0.4);
            color: #ef4444;
        }
        .igor-supplier-btn.danger:hover {
            background: rgba(239,68,68,0.3);
        }

        /* Upload Zone */
        .igor-upload-zone {
            border: 2px dashed rgba(34,197,94,0.4);
            border-radius: 10px;
            padding: 30px 20px;
            text-align: center;
            background: rgba(34,197,94,0.05);
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 15px;
        }
        .igor-upload-zone:hover,
        .igor-upload-zone.drag-over {
            border-color: #22c55e;
            background: rgba(34,197,94,0.1);
        }
        .igor-upload-zone .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        .igor-upload-zone .upload-text {
            color: rgba(255,255,255,0.8);
            font-size: 14px;
            margin-bottom: 5px;
        }
        .igor-upload-zone .upload-formats {
            color: rgba(255,255,255,0.5);
            font-size: 12px;
        }
        .igor-upload-zone input[type="file"] {
            display: none;
        }

        /* Column Mapping Modal */
        .igor-mapping-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .igor-mapping-overlay.active {
            display: flex;
        }
        .igor-mapping-modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 16px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 25px;
        }
        .igor-mapping-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .igor-mapping-header h3 {
            color: #22c55e;
            font-size: 1.3rem;
            margin: 0;
        }
        .igor-mapping-close {
            background: rgba(239,68,68,0.2);
            border: none;
            border-radius: 8px;
            width: 36px;
            height: 36px;
            color: #ef4444;
            font-size: 18px;
            cursor: pointer;
        }
        .igor-mapping-info {
            background: rgba(59,130,246,0.1);
            border: 1px solid rgba(59,130,246,0.3);
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
            font-size: 13px;
            color: rgba(255,255,255,0.8);
        }
        .igor-mapping-info strong {
            color: #60a5fa;
        }
        .igor-mapping-preview {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            overflow-x: auto;
        }
        .igor-mapping-preview table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .igor-mapping-preview th,
        .igor-mapping-preview td {
            padding: 8px 12px;
            border: 1px solid rgba(255,255,255,0.1);
            text-align: left;
        }
        .igor-mapping-preview th {
            background: rgba(245,158,11,0.2);
            color: #f59e0b;
            font-weight: normal;
        }
        .igor-mapping-preview td {
            color: rgba(255,255,255,0.7);
        }
        .igor-mapping-preview tr:hover td {
            background: rgba(255,255,255,0.05);
        }
        .igor-mapping-selectors {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .igor-mapping-field {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 12px;
        }
        .igor-mapping-field label {
            display: block;
            font-size: 11px;
            color: rgba(255,255,255,0.6);
            margin-bottom: 6px;
            text-transform: uppercase;
        }
        .igor-mapping-field select {
            width: 100%;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: #fff;
            font-size: 13px;
        }
        .igor-mapping-field select option {
            background: #1a1a2e;
        }
        .igor-mapping-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .igor-mapping-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .igor-mapping-btn.cancel {
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.7);
        }
        .igor-mapping-btn.confirm {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: #fff;
        }
        .igor-mapping-btn:hover {
            transform: translateY(-1px);
        }

        /* Price Status */
        .igor-price-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .igor-price-status .status-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .igor-price-status .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #22c55e;
        }
        .igor-price-status .status-dot.warning {
            background: #f59e0b;
        }
        .igor-price-status .status-dot.error {
            background: #ef4444;
        }
        .igor-price-status .status-text {
            font-size: 13px;
            color: rgba(255,255,255,0.8);
        }
        .igor-price-status .status-text strong {
            color: #22c55e;
        }
        .igor-price-status .status-actions {
            display: flex;
            gap: 8px;
        }

        /* Missing Prices Alert */
        .igor-missing-alert {
            background: rgba(245,158,11,0.1);
            border: 1px solid rgba(245,158,11,0.3);
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
        }
        .igor-missing-alert h4 {
            color: #f59e0b;
            font-size: 13px;
            margin: 0 0 8px 0;
        }
        .igor-missing-alert ul {
            margin: 0;
            padding-left: 20px;
            font-size: 12px;
            color: rgba(255,255,255,0.7);
        }
        .igor-missing-alert li {
            margin-bottom: 3px;
        }

        /* Add Supplier Modal */
        .igor-add-supplier-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .igor-add-supplier-modal.active {
            display: flex;
        }
        .igor-add-supplier-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 16px;
            max-width: 400px;
            width: 100%;
            padding: 25px;
        }
        .igor-add-supplier-content h3 {
            color: #22c55e;
            margin: 0 0 20px 0;
        }
        .igor-add-supplier-content input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .igor-add-supplier-content input:focus {
            outline: none;
            border-color: #22c55e;
        }
        .igor-add-supplier-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* CHUCK Temperature & Cure Styles */
        .chuck-temp-display {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(59,130,246,0.2);
            border: 1px solid rgba(59,130,246,0.3);
            border-radius: 10px;
            padding: 12px 15px;
            margin-bottom: 15px;
        }
        .chuck-temp-display .temp-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #60a5fa;
        }
        .chuck-temp-display .temp-location {
            flex: 1;
            color: rgba(255,255,255,0.7);
            font-size: 13px;
        }
        .chuck-temp-display .temp-refresh {
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 16px;
        }
        .chuck-cure-section {
            background: rgba(245,158,11,0.1);
            border: 1px solid rgba(245,158,11,0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        .cure-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .cure-card {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        .cure-card.standard { border-left: 3px solid #22c55e; }
        .cure-card.coastal { border-left: 3px solid #3b82f6; }
        .cure-card.shade { border-left: 3px solid #a855f7; }
        .cure-icon { font-size: 1.5rem; margin-bottom: 5px; }
        .cure-label { font-size: 11px; color: rgba(255,255,255,0.6); margin-bottom: 5px; }
        .cure-work { font-size: 12px; color: #f59e0b; }
        .cure-time { font-size: 14px; font-weight: bold; color: #fff; }
        .chuck-cartridge-options {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .cart-option {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 10px 20px;
            text-align: center;
        }
        .cart-size { display: block; font-size: 12px; color: rgba(255,255,255,0.6); }
        .cart-count { display: block; font-size: 1.2rem; font-weight: bold; color: #22c55e; }

        /* BRITTANY Parameters Styles */
        .brittany-params {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 15px 0;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }
        .param-group {
            flex: 1;
            min-width: 100px;
        }
        .param-group label {
            display: block;
            font-size: 12px;
            color: rgba(255,255,255,0.7);
            margin-bottom: 5px;
        }
        .param-group input {
            width: 100%;
            padding: 8px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
        }
        .param-min {
            display: block;
            font-size: 10px;
            color: rgba(255,255,255,0.5);
            margin-top: 3px;
        }
        .brittany-options {
            margin: 15px 0;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            color: rgba(255,255,255,0.8);
            font-size: 14px;
        }
        .checkbox-label input { width: 18px; height: 18px; }
        .brittany-load-check {
            background: rgba(168,85,247,0.1);
            border: 1px solid rgba(168,85,247,0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        .brittany-load-check label {
            color: #a855f7;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .load-input-row {
            display: flex;
            gap: 10px;
        }
        .load-input-row input {
            flex: 1;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
        }
        .load-input-row select {
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
        }
        .load-check-result { margin-top: 15px; }
        .load-bar {
            height: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            overflow: hidden;
        }
        .load-fill {
            height: 100%;
            transition: width 0.3s, background 0.3s;
            border-radius: 10px;
        }
        .load-status {
            text-align: center;
            margin-top: 8px;
            font-weight: bold;
        }
        @media (max-width: 600px) {
            .cure-cards { grid-template-columns: 1fr; }
            .brittany-params { flex-direction: column; }
            .load-input-row { flex-direction: column; }
        }

        /* CHUCK Timer Styles */
        .chuck-timer-section {
            background: linear-gradient(135deg, rgba(34,197,94,0.2) 0%, rgba(22,163,74,0.2) 100%);
            border: 2px solid rgba(34,197,94,0.5);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
        }
        .chuck-timer-section.curing {
            background: linear-gradient(135deg, rgba(245,158,11,0.2) 0%, rgba(217,119,6,0.2) 100%);
            border-color: rgba(245,158,11,0.5);
            animation: pulse-border 2s infinite;
        }
        @keyframes pulse-border {
            0%, 100% { border-color: rgba(245,158,11,0.5); }
            50% { border-color: rgba(245,158,11,1); }
        }
        .chuck-timer-section.ready {
            background: linear-gradient(135deg, rgba(34,197,94,0.3) 0%, rgba(22,163,74,0.3) 100%);
            border-color: #22c55e;
        }
        .timer-display {
            font-size: 2.5rem;
            font-weight: bold;
            color: #22c55e;
            font-family: monospace;
        }
        .timer-display.curing { color: #f59e0b; }
        .timer-label {
            font-size: 14px;
            color: rgba(255,255,255,0.7);
            margin-bottom: 5px;
        }
        .timer-ready-at {
            font-size: 1.2rem;
            color: #60a5fa;
            margin: 10px 0;
        }
        .timer-btn {
            padding: 15px 40px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.2s;
        }
        .timer-btn.start {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }
        .timer-btn.stop {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        .timer-btn:hover { transform: scale(1.05); }
        .timer-progress {
            height: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            margin-top: 15px;
            overflow: hidden;
        }
        .timer-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f59e0b, #22c55e);
            border-radius: 4px;
            transition: width 1s linear;
        }

        /* HOBART Tube Finder Styles */
        .hobart-tube-finder {
            background: rgba(168,85,247,0.1);
            border: 1px solid rgba(168,85,247,0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        .tube-finder-title {
            color: #a855f7;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .tube-finder-inputs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .tube-finder-inputs .calc-input {
            flex: 1;
            min-width: 100px;
        }
        .tube-finder-results {
            display: none;
        }
        .tube-finder-results.active { display: block; }
        .tube-match {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #22c55e;
        }
        .tube-match.warning { border-left-color: #f59e0b; }
        .tube-match.fail { border-left-color: #ef4444; }
        .tube-match-bolt { font-weight: bold; color: #60a5fa; }
        .tube-match-info { font-size: 12px; color: rgba(255,255,255,0.6); }
        .tube-match-status { font-size: 20px; }

        /* HOBART Grip Visual */
        .grip-visual {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }
        .grip-diagram {
            position: relative;
            height: 70px;
            background: linear-gradient(90deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            border-radius: 5px;
            margin: 10px 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .grip-range {
            display: none; /* Hide old single range div */
        }
        .grip-marker {
            position: absolute;
            top: -25px;
            transform: translateX(-50%);
            font-size: 11px;
            color: #fff;
        }
        .grip-current {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 4px;
            height: 80%;
            background: #f59e0b;
            border-radius: 2px;
        }
        .grip-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: rgba(255,255,255,0.6);
            margin-top: 5px;
        }

        /* BRITTANY Report Section */
        .brittany-report-section {
            background: rgba(59,130,246,0.1);
            border: 1px solid rgba(59,130,246,0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        .report-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .report-btn:hover { transform: scale(1.02); }
        .utilisation-display {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
        }
        .utilisation-big {
            font-size: 3rem;
            font-weight: bold;
        }
        .utilisation-big.ok { color: #22c55e; }
        .utilisation-big.warning { color: #f59e0b; }
        .utilisation-big.fail { color: #ef4444; }
        .utilisation-status {
            font-size: 1.5rem;
            margin-top: 10px;
        }
        .safety-factor {
            font-size: 14px;
            color: rgba(255,255,255,0.6);
            margin-top: 5px;
        }

        /* HANNA Receipt Scanner Styles */
        .hanna-upload-zone {
            border: 3px dashed #4ade80;
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.1), rgba(34, 197, 94, 0.05));
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        .hanna-upload-zone:hover, .hanna-upload-zone.dragover {
            border-color: #22c55e;
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.2), rgba(34, 197, 94, 0.1));
            transform: scale(1.02);
        }
        .hanna-upload-zone .upload-icon {
            font-size: 4rem;
            margin-bottom: 10px;
        }
        .hanna-upload-zone .upload-text {
            font-size: 1.2rem;
            color: #22c55e;
            font-weight: 600;
        }
        .hanna-upload-zone .upload-hint {
            font-size: 0.9rem;
            color: #6b7280;
            margin-top: 8px;
        }
        .hanna-receipt-preview {
            display: none;
            background: #1f2937;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .hanna-receipt-preview.show { display: block; }
        .hanna-receipt-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            object-fit: contain;
        }
        .hanna-result-card {
            background: linear-gradient(135deg, #065f46, #047857);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            display: none;
        }
        .hanna-result-card.show { display: block; }
        .hanna-store-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 5px;
        }
        .hanna-date {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
            margin-bottom: 15px;
        }
        .hanna-total {
            font-size: 2.5rem;
            font-weight: 800;
            color: #4ade80;
            text-align: center;
            padding: 15px 0;
        }
        .hanna-gst {
            text-align: center;
            color: rgba(255,255,255,0.7);
            font-size: 1rem;
            margin-bottom: 15px;
        }
        .hanna-items {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .hanna-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 0.9rem;
        }
        .hanna-item:last-child { border-bottom: none; }
        .hanna-item-name { color: #fff; flex: 1; }
        .hanna-item-qty { color: rgba(255,255,255,0.6); font-size: 0.85rem; margin: 0 10px; }
        .hanna-item-price { color: #4ade80; font-weight: 600; margin-left: 10px; }
        .hanna-job-select {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }
        .hanna-job-select label {
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
            margin-bottom: 8px;
            display: block;
        }
        .hanna-job-select select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #4ade80;
            background: #1f2937;
            color: #fff;
            font-size: 1rem;
        }
        .hanna-save-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
        }
        .hanna-save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
        }
        .hanna-save-btn:disabled {
            background: #4b5563;
            cursor: not-allowed;
            transform: none;
        }
        .hanna-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .hanna-stat {
            background: #1f2937;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }
        .hanna-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4ade80;
        }
        .hanna-stat-label {
            font-size: 0.8rem;
            color: #9ca3af;
            margin-top: 5px;
        }
        .hanna-recent {
            background: #1f2937;
            border-radius: 12px;
            padding: 15px;
        }
        .hanna-recent-title {
            font-size: 1rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .hanna-recent-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .hanna-recent-store {
            font-weight: 600;
            color: #fff;
        }
        .hanna-recent-amount {
            color: #4ade80;
            font-weight: 700;
        }
        .hanna-recent-date {
            font-size: 0.75rem;
            color: #6b7280;
        }
        .hanna-scanning {
            display: none;
            text-align: center;
            padding: 40px;
        }
        .hanna-scanning.show { display: block; }
        .hanna-scanning .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(74, 222, 128, 0.2);
            border-top-color: #4ade80;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üî© J&M Artsteel Hub</h1>
        <p>AI-Powered Tools for J&M Artsteel</p>
    </div>

    <!-- Navigation -->
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="showSection('hobart')">üî© HOBART</button>
        <button class="nav-tab" onclick="showSection('igor')">‚öñÔ∏è IGOR</button>
        <button class="nav-tab" onclick="showSection('chuck')">üß™ CHUCK</button>
        <button class="nav-tab" onclick="showSection('brittany')">üí™ BRITTANY</button>
        <button class="nav-tab" onclick="showSection('hanna')">üßæ HANNA</button>
        <button class="nav-tab" onclick="showSection('victor')">üîç VICTOR</button>
        <button class="nav-tab" onclick="showSection('frank')">ü¶∫ FRANK</button>
        <button class="nav-tab" onclick="showSection('settings')">‚öôÔ∏è</button>
    </div>

    <!-- HOBART Section -->
    <div id="hobart" class="agent-section active">
        <div class="agent-header">
            <div class="agent-icon">üî©</div>
            <div class="agent-title">
                <h2>HOBART - Hollo-Bolt Reference</h2>
                <p>Lindapter Hollo-Bolt drilling, capacities & grip ranges</p>
            </div>
        </div>

        <!-- Tube Finder - Reverse Lookup -->
        <div class="hobart-tube-finder">
            <div class="tube-finder-title">üîç WHAT FITS THIS TUBE?</div>
            <div class="tube-finder-inputs">
                <div class="calc-input" style="max-width:300px;margin:0 auto;">
                    <label>Wall Thickness (mm)</label>
                    <input type="number" id="tubeWallThickness" placeholder="e.g. 6" min="1" max="50" oninput="hobartFindFits()">
                </div>
            </div>
            <div class="tube-finder-results" id="tubeFitResults"></div>
        </div>

        <label>Bolt Type</label>
        <div class="btn-group" id="hobartTypeButtons">
            <button class="btn active" onclick="hobartSetType('HB', this)">HB Hex Head</button>
            <button class="btn" onclick="hobartSetType('HBCSK', this)">HBCSK Countersunk</button>
            <button class="btn" onclick="hobartSetType('HBFF', this)">HBFF Flush Fit</button>
            <button class="btn" onclick="hobartSetType('LB', this)">LB2 LindiBolt</button>
        </div>

        <label style="margin-top:15px">Bolt Size</label>
        <div class="btn-group" id="hobartSizeButtons">
            <button class="btn" onclick="hobartSetSize('M8', this)">M8</button>
            <button class="btn" onclick="hobartSetSize('M10', this)">M10</button>
            <button class="btn active" onclick="hobartSetSize('M12', this)">M12</button>
            <button class="btn" onclick="hobartSetSize('M16', this)">M16</button>
            <button class="btn" onclick="hobartSetSize('M20', this)">M20</button>
        </div>

        <div class="result-grid" id="hobartResults"></div>

        <!-- Visual Grip Range -->
        <div class="grip-visual" id="hobartGripVisual">
            <div style="color:#f59e0b;font-weight:bold;margin-bottom:10px">üìè Grip Range Visualization</div>
            <div class="grip-diagram" id="gripDiagram">
                <div class="grip-range" id="gripRange"></div>
                <div class="grip-current" id="gripCurrent" style="display:none"></div>
            </div>
            <div class="grip-labels">
                <span id="gripMinLabel">0mm</span>
                <span id="gripMaxLabel">100mm</span>
            </div>
            <div style="margin-top:10px">
                <label style="font-size:12px">Your clamping thickness:</label>
                <input type="number" id="hobartClampInput" placeholder="mm" style="width:80px;padding:5px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:5px;color:#fff;margin-left:10px" oninput="hobartUpdateGripVisual()">
                <span id="gripStatus" style="margin-left:10px;font-weight:bold"></span>
            </div>
        </div>

        <table class="data-table" id="hobartGripTable">
            <thead>
                <tr><th>Product Code</th><th>Clamping Range (mm)</th></tr>
            </thead>
            <tbody id="hobartGripBody"></tbody>
        </table>

        <div class="console" id="hobartConsole">üî© HOBART Ready - "Lindapter Hollo-Bolt at your service"</div>
    </div>

    <!-- IGOR Section -->
    <div id="igor" class="agent-section">
        <div class="agent-header">
            <div class="agent-icon">‚öñÔ∏è</div>
            <div class="agent-title">
                <h2>IGOR - IBSC Steel Reference</h2>
                <p>Complete IBSC Know Your Steel V11 catalogue - 543 sections across 14 types</p>
            </div>
        </div>

        <!-- Dropdown-based member selector -->
        <div class="igor-dropdown-container">
            <div class="igor-dropdown-row">
                <select id="igorTypeSelect" onchange="igorLoadSections()" class="igor-select">
                    <option value="">Type</option>
                    <option value="SHS">SHS - Square Hollow</option>
                    <option value="RHS">RHS - Rectangular Hollow</option>
                    <option value="CHS">CHS - Circular Hollow</option>
                    <option value="EA">EA - Equal Angle</option>
                    <option value="UA">UA - Unequal Angle</option>
                    <option value="FB">FB - Flat Bar</option>
                    <option value="RB">RB - Round Bar</option>
                    <option value="SB">SB - Square Bar</option>
                    <option value="UB">UB - Universal Beam</option>
                    <option value="WB">WB - Welded Beam</option>
                    <option value="UC">UC - Universal Column</option>
                    <option value="WC">WC - Welded Column</option>
                    <option value="PFC">PFC - Parallel Flange Channel</option>
                    <option value="TFB">TFB - Taper Flange Beam</option>
                </select>
                <select id="igorSectionSelect" onchange="igorUpdatePreview()" class="igor-select">
                    <option value="">Section</option>
                </select>
                <input type="number" id="igorLengthInput" class="igor-input" placeholder="Length (m)" min="0.1" step="0.1" value="1" onchange="igorUpdatePreview()" oninput="igorUpdatePreview()">
                <input type="number" id="igorQtyInput" class="igor-input igor-qty" placeholder="Qty" min="1" value="1" onchange="igorUpdatePreview()" oninput="igorUpdatePreview()">
                <button class="igor-add-btn" onclick="igorAddMember()" title="Add member">+</button>
            </div>
            <div class="igor-labels">
                <span>Type</span>
                <span>Section</span>
                <span>Length (m)</span>
                <span>Qty</span>
                <span></span>
            </div>
            <div class="igor-preview" id="igorPreview" style="display: none;">
                <span id="igorPreviewMember">-</span>
                <span id="igorPreviewWeight" style="color:#a855f7;">0 kg</span>
            </div>
        </div>

        <!-- Added members list -->
        <div class="igor-members-list" id="igorMembersList"></div>

        <!-- Results -->
        <div class="igor-results" id="igorResultsSection" style="display:none">
            <div class="igor-breakdown" id="igorBreakdown"></div>
            <div class="igor-totals">
                <div class="igor-total-row">
                    <span>Steel Weight:</span>
                    <span id="igorSteelWeight">0 kg</span>
                </div>
                <div class="igor-total-row total">
                    <span>+ 10% Fittings:</span>
                    <span id="igorTotalWeight">0 kg</span>
                </div>
            </div>
        </div>

        <!-- PRICING MODULE -->
        <div class="igor-pricing-section">
            <div class="igor-pricing-header">
                <div class="igor-pricing-title">
                    <h3>üí∞ PRICING</h3>
                    <span class="price-badge">NEW</span>
                </div>
                <label class="igor-pricing-toggle">
                    <input type="checkbox" id="igorPricingEnabled" onchange="igorTogglePricing()">
                    <span>Enable Pricing</span>
                </label>
            </div>

            <div class="igor-pricing-body" id="igorPricingBody">
                <!-- Supplier Selection -->
                <div class="igor-supplier-row">
                    <select id="igorSupplierSelect" class="igor-supplier-select" onchange="igorSelectSupplier()">
                        <option value="">Select Supplier...</option>
                        <option value="__upload__">üì§ Upload New Price List</option>
                        <optgroup label="Sydney Suppliers" id="igorSupplierGroup">
                            <option value="bluescope">BlueScope Distribution</option>
                            <option value="metalcorp">Metalcorp Steel</option>
                            <option value="midalia">Midalia Steel</option>
                            <option value="vulcan">Vulcan Steel</option>
                            <option value="sanmetal">Sanmetal</option>
                            <option value="infrabuild">InfraBuild (OneSteel)</option>
                            <option value="orrcon">Orrcon Steel</option>
                            <option value="southern">Southern Steel</option>
                            <option value="steelmains">Steel Mains</option>
                        </optgroup>
                    </select>
                    <button class="igor-supplier-btn" onclick="igorShowAddSupplier()">‚ûï Add Supplier</button>
                    <button class="igor-supplier-btn danger" onclick="igorClearPrices()" title="Clear all loaded prices">üóëÔ∏è</button>
                </div>

                <!-- Upload Zone -->
                <div class="igor-upload-zone" id="igorUploadZone" onclick="document.getElementById('igorPriceFileInput').click()">
                    <div class="upload-icon">üìé</div>
                    <div class="upload-text">Drag & drop supplier price list here</div>
                    <div class="upload-formats">Excel (.xlsx, .xls, .csv) or PDF</div>
                    <input type="file" id="igorPriceFileInput" accept=".xlsx,.xls,.csv,.pdf" onchange="igorHandleFileUpload(event)">
                </div>

                <!-- Price Status (shows when prices loaded) -->
                <div class="igor-price-status" id="igorPriceStatus" style="display:none;">
                    <div class="status-info">
                        <div class="status-dot" id="igorStatusDot"></div>
                        <span class="status-text" id="igorStatusText">No prices loaded</span>
                    </div>
                    <div class="status-actions">
                        <button class="igor-supplier-btn" onclick="igorShowPriceList()" title="View loaded prices">üëÅÔ∏è View</button>
                        <button class="igor-supplier-btn" onclick="igorReloadPrices()" title="Reload from saved">üîÑ</button>
                    </div>
                </div>

                <!-- Missing Prices Alert -->
                <div class="igor-missing-alert" id="igorMissingAlert" style="display:none;">
                    <h4>‚ö†Ô∏è Some sizes not found in price list:</h4>
                    <ul id="igorMissingList"></ul>
                </div>
            </div>
        </div>

        <!-- Column Mapping Modal -->
        <div class="igor-mapping-overlay" id="igorMappingOverlay">
            <div class="igor-mapping-modal">
                <div class="igor-mapping-header">
                    <h3>üìã Map Columns</h3>
                    <button class="igor-mapping-close" onclick="igorCloseMappingModal()">√ó</button>
                </div>
                <div class="igor-mapping-info" id="igorMappingInfo">
                    <strong>File:</strong> <span id="igorMappingFileName">-</span> |
                    <strong>Rows:</strong> <span id="igorMappingRowCount">0</span>
                </div>
                <div class="igor-mapping-preview" id="igorMappingPreview">
                    <p style="color: rgba(255,255,255,0.5); text-align: center;">Loading preview...</p>
                </div>
                <div class="igor-mapping-selectors">
                    <div class="igor-mapping-field">
                        <label>Size/Section Column</label>
                        <select id="igorMapSize"><option value="">Auto-detect</option></select>
                    </div>
                    <div class="igor-mapping-field">
                        <label>Price Column ($/m or $/t)</label>
                        <select id="igorMapPrice"><option value="">Auto-detect</option></select>
                    </div>
                    <div class="igor-mapping-field">
                        <label>Member Type Column (optional)</label>
                        <select id="igorMapType"><option value="">Not specified</option></select>
                    </div>
                    <div class="igor-mapping-field">
                        <label>Grade Column (optional)</label>
                        <select id="igorMapGrade"><option value="">Not specified</option></select>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display:flex;align-items:center;gap:8px;color:rgba(255,255,255,0.8);font-size:13px;">
                        <input type="checkbox" id="igorPricePerTonne" style="width:18px;height:18px;">
                        Prices are per tonne (not per metre)
                    </label>
                </div>
                <div class="igor-mapping-actions">
                    <button class="igor-mapping-btn cancel" onclick="igorCloseMappingModal()">Cancel</button>
                    <button class="igor-mapping-btn confirm" onclick="igorConfirmMapping()">‚úì Import Prices</button>
                </div>
            </div>
        </div>

        <!-- Add Supplier Modal -->
        <div class="igor-add-supplier-modal" id="igorAddSupplierModal">
            <div class="igor-add-supplier-content">
                <h3>‚ûï Add New Supplier</h3>
                <input type="text" id="igorNewSupplierName" placeholder="Supplier name..." onkeypress="if(event.key==='Enter')igorAddSupplier()">
                <div class="igor-add-supplier-actions">
                    <button class="igor-mapping-btn cancel" onclick="igorCloseAddSupplierModal()">Cancel</button>
                    <button class="igor-mapping-btn confirm" onclick="igorAddSupplier()">Add</button>
                </div>
            </div>
        </div>

        <!-- View Prices Modal -->
        <div class="igor-mapping-overlay" id="igorPriceListOverlay">
            <div class="igor-mapping-modal" style="max-width:900px;">
                <div class="igor-mapping-header">
                    <h3>üìã Loaded Prices - <span id="igorPriceListSupplier">-</span></h3>
                    <button class="igor-mapping-close" onclick="document.getElementById('igorPriceListOverlay').classList.remove('active')">√ó</button>
                </div>
                <div id="igorPriceListFilter" style="margin-bottom:15px;">
                    <input type="text" id="igorPriceFilterInput" placeholder="Filter by size..."
                           style="width:100%;padding:12px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:#fff;"
                           oninput="igorFilterPriceList()">
                </div>
                <div class="igor-mapping-preview" id="igorPriceListTable" style="max-height:400px;">
                    <p style="color: rgba(255,255,255,0.5); text-align: center;">No prices loaded</p>
                </div>
                <div style="text-align:right;margin-top:15px;">
                    <button class="igor-mapping-btn confirm" onclick="document.getElementById('igorPriceListOverlay').classList.remove('active')">Close</button>
                </div>
            </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:15px;">
            <button class="btn primary" onclick="igorCalculateTotal()" style="flex:1; min-width:150px;">
                ‚öñÔ∏è Calculate Weight
            </button>
            <button class="btn" onclick="igorDownloadExcel()" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); flex:1; min-width:150px;">
                üì• Download Excel
            </button>
        </div>

        <div class="console" id="igorConsole">‚öñÔ∏è IGOR Ready - "I know the weight of every steel section"</div>
    </div>

    <!-- CHUCK Section -->
    <div id="chuck" class="agent-section">
        <div class="agent-header">
            <div class="agent-icon">üß™</div>
            <div class="agent-title">
                <h2>CHUCK - Hilti Calculator</h2>
                <p>Chemical anchor usage calculator with cure times</p>
            </div>
        </div>

        <!-- Temperature Display -->
        <div class="chuck-temp-display" id="chuckTempDisplay">
            <div class="temp-value"><span id="chuckCurrentTemp">--</span>¬∞C</div>
            <div class="temp-location" id="chuckLocation">üìç Getting location...</div>
            <button class="temp-refresh" onclick="chuckGetWeather()">üîÑ</button>
        </div>

        <label>Chemical Type</label>
        <div class="btn-group" id="chuckTypeButtons">
            <button class="btn active" onclick="chuckSetType('HY200R', this)">HY 200-R</button>
            <button class="btn" onclick="chuckSetType('HY200A', this)">HY 200-A</button>
            <button class="btn" onclick="chuckSetType('RE500', this)">RE 500</button>
            <button class="btn" onclick="chuckSetType('HY170', this)">HY 170</button>
        </div>

        <label style="margin-top:15px">Rod Size</label>
        <div class="btn-group" id="chuckSizeButtons">
            <button class="btn" onclick="chuckSetSize('M10', this)">M10</button>
            <button class="btn" onclick="chuckSetSize('M12', this)">M12</button>
            <button class="btn active" onclick="chuckSetSize('M16', this)">M16</button>
            <button class="btn" onclick="chuckSetSize('M20', this)">M20</button>
            <button class="btn" onclick="chuckSetSize('M24', this)">M24</button>
            <button class="btn" onclick="chuckSetSize('M30', this)">M30</button>
        </div>

        <div class="calc-row">
            <div class="calc-input">
                <label>Embed Depth (mm)</label>
                <input type="number" id="chuckDepth" value="125" oninput="chuckCalculate()">
            </div>
            <div class="calc-input">
                <label>Quantity</label>
                <input type="number" id="chuckQty" value="10" min="1" oninput="chuckCalculate()">
            </div>
        </div>

        <div class="result-grid" id="chuckResults"></div>

        <!-- Cure Times Section -->
        <div class="chuck-cure-section" id="chuckCureSection" style="display:none">
            <h4 style="color:#f59e0b;margin-bottom:10px">‚è±Ô∏è Cure Times @ <span id="chuckCureTemp">--</span>¬∞C</h4>
            <div class="cure-cards">
                <div class="cure-card standard">
                    <div class="cure-icon">üèóÔ∏è</div>
                    <div class="cure-label">Standard</div>
                    <div class="cure-work" id="cureWorkStd">-</div>
                    <div class="cure-time" id="cureCureStd">-</div>
                </div>
                <div class="cure-card coastal">
                    <div class="cure-icon">üåä</div>
                    <div class="cure-label">Coastal/Humid</div>
                    <div class="cure-work" id="cureWorkCoast">-</div>
                    <div class="cure-time" id="cureCureCoast">-</div>
                </div>
                <div class="cure-card shade">
                    <div class="cure-icon">üå•Ô∏è</div>
                    <div class="cure-label">Shade/Cold</div>
                    <div class="cure-work" id="cureWorkShade">-</div>
                    <div class="cure-time" id="cureCureShade">-</div>
                </div>
            </div>
        </div>

        <!-- Cartridge Options -->
        <div class="chuck-cartridge-options" id="chuckCartOptions" style="display:none">
            <div class="cart-option"><span class="cart-size">330ml</span><span class="cart-count" id="chuckCart330">-</span></div>
            <div class="cart-option"><span class="cart-size">500ml</span><span class="cart-count" id="chuckCart500">-</span></div>
            <div class="cart-option"><span class="cart-size">1400ml</span><span class="cart-count" id="chuckCart1400">-</span></div>
        </div>

        <!-- Cure Timer Section -->
        <div class="chuck-timer-section" id="chuckTimerSection">
            <div class="timer-label">‚è±Ô∏è CURE TIMER</div>
            <div class="timer-display" id="chuckTimerDisplay">--:--:--</div>
            <div class="timer-ready-at" id="chuckReadyAt">Set anchors and start timer</div>
            <div>
                <button class="timer-btn start" id="chuckTimerStart" onclick="chuckStartTimer()">‚ñ∂Ô∏è START TIMER</button>
                <button class="timer-btn stop" id="chuckTimerStop" onclick="chuckStopTimer()" style="display:none">‚èπÔ∏è STOP</button>
            </div>
            <div class="timer-progress" id="chuckTimerProgress" style="display:none">
                <div class="timer-progress-fill" id="chuckTimerFill"></div>
            </div>
        </div>

        <div class="console" id="chuckConsole">üß™ CHUCK Ready - "Hilti chemical calculations at your service"</div>
    </div>

    <!-- BRITTANY Section -->
    <div id="brittany" class="agent-section">
        <div class="agent-header">
            <div class="agent-icon">üí™</div>
            <div class="agent-title">
                <h2>BRITTANY - Fixing Capacity</h2>
                <p>Will it hold? How many kg?</p>
            </div>
        </div>

        <label>Fixing Type</label>
        <div class="btn-group" id="brittanyTypeButtons">
            <button class="btn active" onclick="brittanySetType('dynabolt', this)">Dynabolt</button>
            <button class="btn" onclick="brittanySetType('trubolt', this)">TruBolt</button>
            <button class="btn" onclick="brittanySetType('hilti_hsl', this)">Hilti HSL</button>
            <button class="btn" onclick="brittanySetType('chemset', this)">Chemset</button>
            <button class="btn" onclick="brittanySetType('dropin', this)">Drop-In</button>
        </div>

        <label style="margin-top:15px">Size</label>
        <div class="btn-group" id="brittanySizeButtons">
            <button class="btn" onclick="brittanySetSize('M8', this)">M8</button>
            <button class="btn" onclick="brittanySetSize('M10', this)">M10</button>
            <button class="btn active" onclick="brittanySetSize('M12', this)">M12</button>
            <button class="btn" onclick="brittanySetSize('M16', this)">M16</button>
            <button class="btn" onclick="brittanySetSize('M20', this)">M20</button>
            <button class="btn" onclick="brittanySetSize('M24', this)">M24</button>
        </div>

        <div class="calc-row">
            <div class="calc-input">
                <label>Quantity</label>
                <input type="number" id="brittanyQty" value="4" min="1" oninput="brittanyCalculate()">
            </div>
            <div class="calc-input">
                <label>Substrate</label>
                <select id="brittanyConcrete" onchange="brittanyCalculate()">
                    <optgroup label="Concrete">
                        <option value="20">Concrete 20 MPa</option>
                        <option value="25">Concrete 25 MPa</option>
                        <option value="32" selected>Concrete 32 MPa</option>
                        <option value="40">Concrete 40 MPa</option>
                        <option value="50">Concrete 50 MPa</option>
                    </optgroup>
                    <optgroup label="Masonry">
                        <option value="15">Solid Brick (‚âà15 MPa)</option>
                        <option value="7">Clay Brick (‚âà7 MPa)</option>
                        <option value="10">Concrete Block Solid (‚âà10 MPa)</option>
                        <option value="4">Concrete Block Hollow (‚âà4 MPa)</option>
                        <option value="3">AAC/Hebel Block (‚âà3 MPa)</option>
                    </optgroup>
                    <optgroup label="Natural Stone">
                        <option value="60">Granite (‚âà60 MPa)</option>
                        <option value="35">Sandstone (‚âà35 MPa)</option>
                        <option value="25">Limestone (‚âà25 MPa)</option>
                        <option value="50">Bluestone (‚âà50 MPa)</option>
                    </optgroup>
                </select>
            </div>
        </div>

        <!-- Adjustable Parameters -->
        <div class="brittany-params">
            <div class="param-group">
                <label>Embed (mm)</label>
                <input type="number" id="brittanyEmbed" placeholder="auto" onchange="brittanyCalculate()">
                <span class="param-min" id="brittanyEmbedMin">min: -</span>
            </div>
            <div class="param-group">
                <label>Edge (mm)</label>
                <input type="number" id="brittanyEdge" placeholder="auto" onchange="brittanyCalculate()">
                <span class="param-min" id="brittanyEdgeMin">min: -</span>
            </div>
            <div class="param-group">
                <label>Spacing (mm)</label>
                <input type="number" id="brittanySpacing" placeholder="auto" onchange="brittanyCalculate()">
                <span class="param-min" id="brittanySpacingMin">min: -</span>
            </div>
        </div>

        <!-- Options -->
        <div class="brittany-options">
            <label class="checkbox-label">
                <input type="checkbox" id="brittanyOverhead" onchange="brittanyCalculate()">
                <span>Overhead / Cracked Concrete (50% reduction)</span>
            </label>
        </div>

        <div class="result-grid" id="brittanyResults"></div>

        <!-- Load Check -->
        <div class="brittany-load-check">
            <label>Check Load (kg)</label>
            <div class="load-input-row">
                <input type="number" id="brittanyLoad" placeholder="e.g. 500" oninput="brittanyCheckLoad()">
                <select id="brittanyLoadType" onchange="brittanyCheckLoad()">
                    <option value="tension">Tension ‚Üì</option>
                    <option value="shear">Shear ‚Üí</option>
                </select>
            </div>
            <div class="load-check-result" id="brittanyLoadResult" style="display:none">
                <div class="load-bar"><div class="load-fill" id="brittanyLoadFill"></div></div>
                <div class="load-status" id="brittanyLoadStatus"></div>
            </div>
        </div>

        <!-- Quick Utilisation Display -->
        <div class="utilisation-display" id="brittanyUtilDisplay" style="display:none">
            <div class="timer-label">WILL IT HOLD?</div>
            <div class="utilisation-big" id="brittanyUtilPercent">--%</div>
            <div class="utilisation-status" id="brittanyUtilStatus">Enter a load to check</div>
            <div class="safety-factor" id="brittanySafetyFactor"></div>
        </div>

        <!-- Report Generator -->
        <div class="brittany-report-section">
            <button class="report-btn" onclick="brittanyGenerateReport()">
                üìÑ GENERATE ENGINEER REPORT
            </button>
        </div>

        <div class="console" id="brittanyConsole">üí™ BRITTANY Ready - "I'll tell you if it'll hold"</div>
    </div>

    <!-- HANNA Section -->
    <div id="hanna" class="agent-section">
        <div class="agent-header">
            <div class="agent-icon">üßæ</div>
            <div class="agent-title">
                <h2>HANNA - Receipt Scanner</h2>
                <p>AI-powered receipt scanning for expense tracking</p>
            </div>
        </div>

        <!-- Upload Zone -->
        <div class="hanna-upload-zone" id="hannaUploadZone" onclick="document.getElementById('hannaFileInput').click()">
            <div class="hanna-upload-icon">üì∏</div>
            <div class="hanna-upload-text">Tap to take photo or upload receipt</div>
            <div class="hanna-upload-hint">Supports JPG, PNG, PDF</div>
            <input type="file" id="hannaFileInput" accept="image/*,application/pdf" capture="environment" style="display:none" onchange="hannaFileSelected(event)">
        </div>

        <!-- Preview Area -->
        <div class="hanna-preview" id="hannaPreview" style="display:none">
            <img id="hannaPreviewImage" src="" alt="Receipt preview">
            <button class="hanna-preview-remove" onclick="hannaClearPreview()">‚úï</button>
        </div>

        <!-- Scanning Animation -->
        <div class="hanna-scanning" id="hannaScanning" style="display:none">
            <div class="hanna-scan-animation"></div>
            <div class="hanna-scan-text">Scanning receipt...</div>
        </div>

        <!-- Results Card -->
        <div class="hanna-result-card" id="hannaResult" style="display:none">
            <div class="hanna-result-header">
                <span class="hanna-store-name" id="hannaStoreName">-</span>
                <span class="hanna-receipt-date" id="hannaReceiptDate">-</span>
            </div>

            <div class="hanna-totals">
                <div class="hanna-total-row">
                    <span>Subtotal</span>
                    <span id="hannaSubtotal">$0.00</span>
                </div>
                <div class="hanna-total-row gst">
                    <span>GST (10%)</span>
                    <span id="hannaGST">$0.00</span>
                </div>
                <div class="hanna-total-row total">
                    <span>TOTAL</span>
                    <span id="hannaTotal">$0.00</span>
                </div>
            </div>

            <div class="hanna-items-section">
                <h4>Items Detected</h4>
                <div class="hanna-items-list" id="hannaItemsList">
                    <!-- Items populated by JS -->
                </div>
            </div>

            <!-- Job Assignment -->
            <div class="hanna-job-section">
                <label>Assign to Job</label>
                <select id="hannaJobSelect">
                    <option value="">-- Select Job --</option>
                    <option value="general">General Expenses</option>
                    <option value="workshop">Workshop Supplies</option>
                </select>
                <input type="text" id="hannaNewJob" placeholder="Or enter new job name..." style="margin-top:8px">
            </div>

            <!-- Notes -->
            <div class="hanna-notes-section">
                <label>Notes (optional)</label>
                <textarea id="hannaNotes" placeholder="Add any notes about this receipt..."></textarea>
            </div>

            <!-- Action Buttons -->
            <div class="hanna-actions">
                <button class="btn" onclick="hannaClearAll()">Clear</button>
                <button class="btn primary" onclick="hannaSaveReceipt()">üíæ Save Receipt</button>
            </div>
        </div>

        <!-- Recent Receipts -->
        <div class="hanna-recent-section">
            <h4>üìã Recent Receipts</h4>
            <div class="hanna-recent-list" id="hannaRecentList">
                <div class="hanna-empty-state">No receipts scanned yet</div>
            </div>
        </div>

        <!-- Stats -->
        <div class="hanna-stats" id="hannaStats">
            <div class="hanna-stat">
                <div class="hanna-stat-value" id="hannaStatTotal">0</div>
                <div class="hanna-stat-label">Total Scanned</div>
            </div>
            <div class="hanna-stat">
                <div class="hanna-stat-value" id="hannaStatMonth">$0</div>
                <div class="hanna-stat-label">This Month</div>
            </div>
            <div class="hanna-stat">
                <div class="hanna-stat-value" id="hannaStatGST">$0</div>
                <div class="hanna-stat-label">GST Claimable</div>
            </div>
        </div>

        <div class="console" id="hannaConsole">üßæ HANNA Ready - "I'll scan your receipts in a flash"</div>
    </div>

    <!-- VICTOR - MSDS Register Section -->
    <div id="victor" class="agent-section">
        <div class="agent-header">
            <div class="agent-icon">üîç</div>
            <div class="agent-title">
                <h2>VICTOR - MSDS Register</h2>
                <p>All Safety Data Sheets &amp; WHS compliance status</p>
            </div>
        </div>

        <!-- Compliance Dashboard -->
        <div id="victorDashboard" class="calc-card" style="padding:16px;">
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;text-align:center;">
                <div style="background:rgba(255,255,255,0.08);border-radius:8px;padding:12px 8px;">
                    <div id="victorCountTotal" style="font-size:28px;font-weight:700;color:#fff;">0</div>
                    <div style="font-size:11px;color:#aaa;margin-top:2px;">TOTAL</div>
                </div>
                <div style="background:rgba(76,175,80,0.15);border-radius:8px;padding:12px 8px;border:1px solid rgba(76,175,80,0.3);">
                    <div id="victorCountCurrent" style="font-size:28px;font-weight:700;color:#4CAF50;">0</div>
                    <div style="font-size:11px;color:#4CAF50;margin-top:2px;">CURRENT</div>
                </div>
                <div style="background:rgba(242,153,74,0.15);border-radius:8px;padding:12px 8px;border:1px solid rgba(242,153,74,0.3);">
                    <div id="victorCountExpiring" style="font-size:28px;font-weight:700;color:#f2994a;">0</div>
                    <div style="font-size:11px;color:#f2994a;margin-top:2px;">EXPIRING</div>
                </div>
                <div style="background:rgba(244,67,54,0.15);border-radius:8px;padding:12px 8px;border:1px solid rgba(244,67,54,0.3);">
                    <div id="victorCountExpired" style="font-size:28px;font-weight:700;color:#f44336;">0</div>
                    <div style="font-size:11px;color:#f44336;margin-top:2px;">EXPIRED</div>
                </div>
            </div>
            <div id="victorActionNeeded" style="display:none;margin-top:10px;padding:8px 12px;background:rgba(242,153,74,0.1);border-radius:6px;font-size:12px;color:#aaa;text-align:center;"></div>
        </div>

        <!-- All MSDS Register -->
        <div class="calc-card">
            <h3>üìã All MSDS</h3>
            <!-- Search & Filter Controls -->
            <div style="margin-top:10px;">
                <input type="text" id="victorFilterText" oninput="victorRenderProducts()" placeholder="Filter by product or manufacturer..." style="width:100%;padding:10px 14px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:#fff;font-size:13px;margin-bottom:10px;box-sizing:border-box;">
                <div id="victorFilterButtons" style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap;">
                    <button onclick="victorSetFilter('all')" id="victorFilterAll" style="padding:6px 14px;border-radius:6px;border:1px solid rgba(255,255,255,0.2);background:rgba(102,126,234,0.3);color:#fff;cursor:pointer;font-size:12px;font-weight:600;">All</button>
                    <button onclick="victorSetFilter('current')" id="victorFilterCurrent" style="padding:6px 14px;border-radius:6px;border:1px solid rgba(76,175,80,0.3);background:transparent;color:#4CAF50;cursor:pointer;font-size:12px;font-weight:600;">Current</button>
                    <button onclick="victorSetFilter('expiring')" id="victorFilterExpiring" style="padding:6px 14px;border-radius:6px;border:1px solid rgba(242,153,74,0.3);background:transparent;color:#f2994a;cursor:pointer;font-size:12px;font-weight:600;">Expiring</button>
                    <button onclick="victorSetFilter('expired')" id="victorFilterExpired" style="padding:6px 14px;border-radius:6px;border:1px solid rgba(244,67,54,0.3);background:transparent;color:#f44336;cursor:pointer;font-size:12px;font-weight:600;">Expired</button>
                </div>
            </div>
            <div id="victorProductList" style="margin-top:4px;"></div>
            <p id="victorEmptyMsg" style="color:#666;font-size:13px;margin-top:8px;">No products tracked yet. Search below to add.</p>
        </div>

        <!-- Add New MSDS -->
        <div class="calc-card">
            <h3>‚ûï Add New MSDS</h3>
            <div style="margin-top:10px;">
                <input type="text" id="victorProductName" placeholder="Product name (e.g. HIT-HY 200 Hilti)" style="width:100%;padding:12px 14px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:#fff;font-size:14px;margin-bottom:10px;box-sizing:border-box;">
                <input type="text" id="victorManufacturer" placeholder="Manufacturer (optional - auto-detected)" style="width:100%;padding:12px 14px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:#fff;font-size:14px;margin-bottom:10px;box-sizing:border-box;">
                <button onclick="victorSearch()" style="width:100%;padding:14px;background:linear-gradient(135deg,#667eea,#764ba2);border:none;border-radius:8px;color:#fff;cursor:pointer;font-weight:600;font-size:16px;">üîç Find MSDS</button>
            </div>
        </div>

        <div id="victorSearching" style="display:none;text-align:center;padding:30px;">
            <div style="font-size:40px;animation:pulse 1s infinite;">üîç</div>
            <p style="color:#aaa;margin-top:10px;">Searching for MSDS...</p>
        </div>

        <div id="victorResults" style="display:none;">
            <div class="calc-card">
                <h3>üìÑ Results</h3>
                <div id="victorResultContent" style="margin-top:10px;"></div>
            </div>
        </div>

        <div class="console" id="victorConsole">üîç VICTOR Ready - "All your Safety Data Sheets in one place"</div>
    </div>

    <!-- FRANK - SWMS Generator Section -->
    <div id="frank" class="agent-section frank-section">
        <div class="agent-header">
            <div class="agent-icon">ü¶∫</div>
            <div class="agent-title">
                <h2>FRANK - SWMS Generator</h2>
                <p>Safe Work Method Statement Generator - Creates compliant SWMS for high-risk construction work</p>
            </div>
        </div>

        <!-- Quick Task Buttons -->
        <label style="color: rgba(255,255,255,0.7); margin-bottom: 8px; display: block;">Quick Tasks - Click to auto-fill job description</label>
        <div class="frank-quick-tasks" id="frankQuickTasks">
            <button class="frank-quick-btn" onclick="frankSelectTask('Steel balustrade installation including mechanical fixing to concrete substrate and on-site welding')">üî© Balustrade Install</button>
            <button class="frank-quick-btn" onclick="frankSelectTask('Steel handrail installation including core drilling, chemical anchoring and MIG welding')">üõ°Ô∏è Handrail Install</button>
            <button class="frank-quick-btn" onclick="frankSelectTask('Glass balustrade and glazing installation including handling glass panels, silicone sealing and edge protection')">ü™ü Glazing Install</button>
            <button class="frank-quick-btn" onclick="frankSelectTask('Operable wall steel frame installation including overhead track mounting, working at heights and precision alignment')">üö™ Operable Walls</button>
            <button class="frank-quick-btn" onclick="frankSelectTask('Structural steel installation including beam/column erection, bolted connections and crane/rigging operations')">üèóÔ∏è Structural Steel</button>
            <button class="frank-quick-btn" onclick="frankSelectTask('Steel staircase installation including lifting heavy components, temporary supports and handrail attachment')">ü™ú Staircase Install</button>
            <button class="frank-quick-btn" onclick="frankSelectTask('Steel platform and mezzanine installation including edge protection, working at heights and floor grating')">üè¢ Platform/Mezzanine</button>
            <button class="frank-quick-btn" onclick="frankSelectTask('MIG welding operations including hot work permit, fire watch, UV/fume hazards and grinding')">‚ö° MIG Welding</button>
            <button class="frank-quick-btn" onclick="frankSelectTask('Plasma cutting steel sections including electrical hazards, hot metal, UV exposure and fume extraction')">üî• Plasma Cutting</button>
            <button class="frank-quick-btn" onclick="frankSelectTask('Oxy-acetylene cutting including gas cylinder handling, flashback arrestors, hot work and fire prevention')">üî• Oxy Cutting</button>
            <button class="frank-quick-btn" onclick="frankSelectTask('Angle grinding and linishing operations including disc guards, PPE, sparks/hot metal and dust extraction')">‚öôÔ∏è Grinding/Linishing</button>
            <button class="frank-quick-btn" onclick="frankSelectTask('Steel gate and fence installation including post setting, hinge welding and automation wiring')">üöß Gate Installation</button>
        </div>

        <!-- Job Description -->
        <div class="frank-form-group">
            <label>Job/Task Description *</label>
            <textarea id="frankJobDesc" placeholder="Describe the high-risk work activity in detail, or click a Quick Task above..."></textarea>
        </div>

        <!-- Job Number & Location -->
        <div class="frank-form-row">
            <div class="frank-form-group">
                <label>Job Number</label>
                <input type="text" id="frankJobNumber" placeholder="e.g., JOB-2026-001 (optional)">
            </div>
            <div class="frank-form-group">
                <label>Work Location</label>
                <input type="text" id="frankLocation" placeholder="e.g., 123 Main St, Sydney NSW 2000">
            </div>
        </div>

        <!-- Builder Dropdown -->
        <div class="frank-form-group">
            <label>Builder/Client</label>
            <select id="frankBuilder">
                <option value="">-- Select Builder --</option>
                <option value="FDC Fitout and Refurbishment">FDC Fitout and Refurbishment</option>
                <option value="FDC Construction">FDC Construction</option>
                <option value="Built">Built</option>
                <option value="Landlease">Landlease</option>
                <option value="Hunter Mason">Hunter Mason</option>
                <option value="Other">Other</option>
            </select>
        </div>

        <!-- Worker Selection Grid -->
        <div class="frank-workers">
            <div class="frank-workers-header">
                <label>Select Workers</label>
                <div class="frank-workers-actions">
                    <button type="button" onclick="frankSelectAllWorkers()">Select All</button>
                    <button type="button" onclick="frankClearAllWorkers()">Clear All</button>
                </div>
            </div>
            <div class="frank-workers-grid" id="frankWorkersGrid">
                <label class="frank-worker-checkbox"><input type="checkbox" value="Davide Casolini"> Davide Casolini</label>
                <label class="frank-worker-checkbox"><input type="checkbox" value="Genbao Shi"> Genbao Shi</label>
                <label class="frank-worker-checkbox"><input type="checkbox" value="Jackson Cox"> Jackson Cox</label>
                <label class="frank-worker-checkbox"><input type="checkbox" value="Jeff Fu"> Jeff Fu</label>
                <label class="frank-worker-checkbox"><input type="checkbox" value="Jia Wang"> Jia Wang</label>
                <label class="frank-worker-checkbox"><input type="checkbox" value="Jiang Zhao"> Jiang Zhao</label>
                <label class="frank-worker-checkbox"><input type="checkbox" value="Leon Yu"> Leon Yu</label>
                <label class="frank-worker-checkbox"><input type="checkbox" value="Mark Edison"> Mark Edison</label>
                <label class="frank-worker-checkbox"><input type="checkbox" value="Mitchell Hall"> Mitchell Hall</label>
                <label class="frank-worker-checkbox"><input type="checkbox" value="Paul Fitzpatrick"> Paul Fitzpatrick</label>
                <label class="frank-worker-checkbox"><input type="checkbox" value="Paul Waters"> Paul Waters</label>
                <label class="frank-worker-checkbox"><input type="checkbox" value="Russell Hinds"> Russell Hinds</label>
                <label class="frank-worker-checkbox"><input type="checkbox" value="Sam Higginbotham"> Sam Higginbotham</label>
                <label class="frank-worker-checkbox"><input type="checkbox" value="Scott Seeho"> Scott Seeho</label>
                <label class="frank-worker-checkbox"><input type="checkbox" value="Shanchuang Zhang"> Shanchuang Zhang</label>
                <label class="frank-worker-checkbox"><input type="checkbox" value="Yong Xiao"> Yong Xiao</label>
                <label class="frank-worker-checkbox"><input type="checkbox" value="Zhangbo XIANG"> Zhangbo XIANG</label>
                <label class="frank-worker-checkbox"><input type="checkbox" value="Zonggang Jiang"> Zonggang Jiang</label>
            </div>
            <div class="frank-worker-count" id="frankWorkerCount">0 workers selected</div>
        </div>

        <!-- Generate Button -->
        <button class="frank-generate-btn" id="frankGenerateBtn" onclick="frankGenerate()">
            ü¶∫ Generate SWMS
        </button>

        <!-- Progress Bar -->
        <div class="frank-progress" id="frankProgress">
            <div class="frank-progress-bar">
                <div class="frank-progress-fill" id="frankProgressFill"></div>
            </div>
            <div class="frank-progress-text" id="frankProgressText">Generating SWMS...</div>
        </div>

        <!-- Result Display -->
        <div class="frank-result" id="frankResult">
            <div class="frank-result-header">
                <h4>ü¶∫ SWMS Generated</h4>
                <div class="frank-result-actions">
                    <button class="frank-result-btn" onclick="frankPrint()">üñ®Ô∏è Print / PDF</button>
                </div>
            </div>
            <div class="frank-result-content" id="frankResultContent"></div>
            <div class="frank-result-badges" id="frankResultBadges"></div>
        </div>

        <!-- Recent SWMS -->
        <div class="calc-card" style="border:1px solid rgba(16,185,129,0.2);margin-top:15px;">
            <h3 style="color:#34d399;">üìÅ Recent SWMS</h3>
            <div id="frankRecentList" style="margin-top:10px;"></div>
            <p id="frankEmptyMsg" style="color:#666;font-size:13px;margin-top:8px;">No SWMS generated yet.</p>
        </div>

        <div class="frank-console" id="frankConsole">ü¶∫ FRANK Ready - "G'day mate, ready to write your SWMS!"</div>
    </div>

    <!-- Settings Section -->
    <div id="settings" class="agent-section">
        <div class="agent-header">
            <div class="agent-icon">‚öôÔ∏è</div>
            <div class="agent-title">
                <h2>Settings</h2>
                <p>Device management and app preferences</p>
            </div>
        </div>

        <!-- AI API Key -->
        <div class="calc-card">
            <h3>üîë AI API Key</h3>
            <p style="font-size:12px;color:#aaa;margin-bottom:10px;">Required for Victor (MSDS) &amp; Frank (SWMS) agents</p>
            <div style="display:flex;gap:10px;align-items:center;">
                <input type="password" id="apiKeyInput" placeholder="sk-ant-..." style="flex:1;padding:10px 14px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:#fff;font-size:14px;">
                <button onclick="saveApiKey()" style="padding:10px 20px;background:linear-gradient(135deg,#667eea,#764ba2);border:none;border-radius:8px;color:#fff;cursor:pointer;font-weight:600;">Save</button>
            </div>
            <p id="apiKeyStatus" style="margin-top:8px;font-size:12px;color:#4CAF50;"></p>
        </div>

        <!-- This Device Name -->
        <div class="calc-card">
            <h3>üì± This Device</h3>
            <div style="display:flex;gap:10px;align-items:center;margin-top:10px;">
                <input type="text" id="thisDeviceName" placeholder="Enter device name" style="flex:1;padding:10px 14px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:#fff;font-size:14px;">
                <button onclick="saveThisDeviceName()" style="padding:10px 20px;background:linear-gradient(135deg,#4CAF50,#45a049);border:none;border-radius:8px;color:#fff;cursor:pointer;font-weight:600;">Save</button>
            </div>
            <p style="margin-top:8px;font-size:12px;color:#667eea;" id="settingsDeviceId"></p>
        </div>

        <!-- Approved Devices -->
        <div class="calc-card">
            <h3>‚úÖ Approved Devices</h3>
            <div id="approvedDevicesList" style="margin-top:10px;"></div>
        </div>

        <!-- Pending Devices -->
        <div class="calc-card">
            <h3>‚è≥ Pending Approval</h3>
            <div id="pendingDevicesList" style="margin-top:10px;"></div>
        </div>

        <div class="console" id="settingsConsole">‚öôÔ∏è Settings loaded</div>
    </div>

    <!-- Status Badge -->
    <div class="status-badge offline" id="statusBadge">
        <div class="status-dot"></div>
        <span>Standalone Mode</span>
    </div>

    <script>
    // escapeHtml() defined in first <script> block (line 16) ‚Äî available globally

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // EMBEDDED DATA - HOBART
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const HOLLO_BOLT_DATA={DRILLING_DATA:{M8:{clearance_hole:14,tolerance:"+1.0/-0.2",min_hole_distance:35,min_edge_distance:13},M10:{clearance_hole:18,tolerance:"+1.0/-0.2",min_hole_distance:40,min_edge_distance:15},M12:{clearance_hole:20,tolerance:"+1.0/-0.2",min_hole_distance:50,min_edge_distance:18},M16:{clearance_hole:26,tolerance:"+2.0/-0.2",min_hole_distance:55,min_edge_distance:20,min_outer_ply:8},M20:{clearance_hole:33,tolerance:"+2.0/-0.2",min_hole_distance:70,min_edge_distance:25,min_outer_ply:8}},HEXAGONAL_HEAD:{M8:{product_codes_with_sizes:["HB08-1 (L=45mm, clamp 3-22mm)","HB08-2 (L=65mm, clamp 22-41mm)","HB08-3 (L=85mm, clamp 41-60mm)"],clamping_ranges:["3-22","22-41","41-60"],torque_nm:23,spanner_mm:19,tensile_swl_kn:4.0,shear_swl_kn:5.0},M10:{product_codes_with_sizes:["HB10-1 (L=49mm, clamp 3-22mm)","HB10-2 (L=64mm, clamp 22-41mm)","HB10-3 (L=84mm, clamp 41-60mm)"],clamping_ranges:["3-22","22-41","41-60"],torque_nm:45,spanner_mm:24,tensile_swl_kn:8.5,shear_swl_kn:10.0},M12:{product_codes_with_sizes:["HB12-1 (L=53mm, clamp 3-25mm)","HB12-2 (L=73mm, clamp 25-47mm)","HB12-3 (L=93mm, clamp 47-69mm)"],clamping_ranges:["3-25","25-47","47-69"],torque_nm:80,spanner_mm:30,tensile_swl_kn:10.5,shear_swl_kn:15.0},M16:{product_codes_with_sizes:["HB16-1 (L=67mm, clamp 12-29mm)","HB16-2 (L=92mm, clamp 29-50mm)","HB16-3 (L=112mm, clamp 50-71mm)"],clamping_ranges:["12-29","29-50","50-71"],torque_nm:190,spanner_mm:36,tensile_swl_kn:21.0,shear_swl_kn:30.0},M20:{product_codes_with_sizes:["HB20-1 (L=80mm, clamp 12-34mm)","HB20-2 (L=110mm, clamp 34-60mm)","HB20-3 (L=140mm, clamp 60-86mm)"],clamping_ranges:["12-34","34-60","60-86"],torque_nm:300,spanner_mm:46,tensile_swl_kn:35.0,shear_swl_kn:40.0}},COUNTERSUNK_HEAD:{M8:{product_codes_with_sizes:["HBCSK08-1 (L=45mm, clamp 3-22mm)","HBCSK08-2 (L=65mm, clamp 22-41mm)","HBCSK08-3 (L=85mm, clamp 41-60mm)"],clamping_ranges:["3-22","22-41","41-60"],torque_nm:23,spanner_mm:19,tensile_swl_kn:4.0,shear_swl_kn:5.0},M10:{product_codes_with_sizes:["HBCSK10-1 (L=44mm, clamp 3-22mm)","HBCSK10-2 (L=64mm, clamp 22-41mm)","HBCSK10-3 (L=84mm, clamp 41-60mm)"],clamping_ranges:["3-22","22-41","41-60"],torque_nm:45,spanner_mm:24,tensile_swl_kn:8.5,shear_swl_kn:10.0},M12:{product_codes_with_sizes:["HBCSK12-1 (L=48mm, clamp 3-25mm)","HBCSK12-2 (L=73mm, clamp 25-47mm)","HBCSK12-3 (L=93mm, clamp 47-69mm)"],clamping_ranges:["3-25","25-47","47-69"],torque_nm:80,spanner_mm:30,tensile_swl_kn:10.5,shear_swl_kn:15.0},M16:{product_codes_with_sizes:["HBCSK16-1 (L=62mm, clamp 12-29mm)","HBCSK16-2 (L=92mm, clamp 29-50mm)","HBCSK16-3 (L=112mm, clamp 50-71mm)"],clamping_ranges:["12-29","29-50","50-71"],torque_nm:190,spanner_mm:36,tensile_swl_kn:21.0,shear_swl_kn:30.0}},FLUSH_FIT_HEAD:{M8:{product_codes_with_sizes:["HBFF08-1 (L=50mm, clamp 10-27mm)","HBFF08-2 (L=70mm, clamp 27-45mm)","HBFF08-3 (L=90mm, clamp 45-64mm)"],clamping_ranges:["10-27","27-45","45-64"],torque_nm:23,spanner_mm:19,tensile_swl_kn:4.0,shear_swl_kn:5.0},M10:{product_codes_with_sizes:["HBFF10-1 (L=50mm, clamp 12-27mm)","HBFF10-2 (L=70mm, clamp 27-45mm)","HBFF10-3 (L=90mm, clamp 45-64mm)"],clamping_ranges:["12-27","27-45","45-64"],torque_nm:45,spanner_mm:24,tensile_swl_kn:8.5,shear_swl_kn:10.0},M12:{product_codes_with_sizes:["HBFF12-1 (L=55mm, clamp 12-30mm)","HBFF12-2 (L=80mm, clamp 30-52mm)","HBFF12-3 (L=100mm, clamp 52-74mm)"],clamping_ranges:["12-30","30-52","52-74"],torque_nm:80,spanner_mm:30,tensile_swl_kn:10.5,shear_swl_kn:15.0}},LINDIBOLT:{M10:{product_codes_with_sizes:["LB10 (L=74mm, clamp 7-30mm)"],clamping_ranges:["7-30"],torque_nm:20,spanner_mm:17,tensile_swl_kn:3.0,shear_swl_kn:3.4},M12:{product_codes_with_sizes:["LB12 (L=85mm, clamp 10-36mm)"],clamping_ranges:["10-36"],torque_nm:31,spanner_mm:19,tensile_swl_kn:5.0,shear_swl_kn:5.0},M16:{product_codes_with_sizes:["LB16 (L=105mm, clamp 12-48mm)"],clamping_ranges:["12-48"],torque_nm:81,spanner_mm:24,tensile_swl_kn:8.0,shear_swl_kn:9.8},M20:{product_codes_with_sizes:["LB20 (L=128mm, clamp 14-60mm)"],clamping_ranges:["14-60"],torque_nm:129,spanner_mm:30,tensile_swl_kn:14.0,shear_swl_kn:15.2},M24:{product_codes_with_sizes:["LB24 (L=158mm, clamp 18-72mm)"],clamping_ranges:["18-72"],torque_nm:203,spanner_mm:36,tensile_swl_kn:20.0,shear_swl_kn:22.5}}};

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // EMBEDDED DATA - IGOR (Steel Sections)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const STEEL_SECTIONS = {
        SHS: {desc:"Square Hollow Sections",data:{"25x25x1.6":1.12,"25x25x2.0":1.36,"25x25x2.5":1.64,"25x25x3.0":1.89,"30x30x1.6":1.38,"30x30x2.0":1.68,"30x30x2.5":2.03,"30x30x3.0":2.36,"35x35x1.6":1.63,"35x35x2.0":1.99,"35x35x2.5":2.42,"35x35x3.0":2.83,"40x40x1.6":1.88,"40x40x2.0":2.31,"40x40x2.5":2.82,"40x40x3.0":3.30,"40x40x4.0":4.09,"50x50x1.6":2.38,"50x50x2.0":2.93,"50x50x2.5":3.60,"50x50x3.0":4.25,"50x50x4.0":5.35,"50x50x5.0":6.39,"50x50x6.0":7.32,"65x65x2.0":3.88,"65x65x2.5":4.78,"65x65x3.0":5.66,"65x65x4.0":7.23,"65x65x5.0":8.75,"65x65x6.0":10.1,"75x75x2.0":4.50,"75x75x2.5":5.56,"75x75x3.0":6.60,"75x75x4.0":8.49,"75x75x5.0":10.3,"75x75x6.0":12.0,"89x89x3.5":9.07,"89x89x5.0":12.5,"89x89x6.0":14.7,"100x100x2.0":6.07,"100x100x2.5":7.53,"100x100x3.0":8.96,"100x100x4.0":11.6,"100x100x5.0":14.2,"100x100x6.0":16.7,"100x100x8.0":21.4,"100x100x9.0":23.5,"100x100x10.0":25.6,"125x125x4.0":14.8,"125x125x5.0":18.2,"125x125x6.0":21.4,"125x125x8.0":27.7,"150x150x5.0":22.1,"150x150x6.0":26.2,"150x150x8.0":33.9,"150x150x10.0":41.3,"200x200x5.0":29.9,"200x200x6.0":35.6,"200x200x8.0":46.5,"200x200x10.0":57.0}},
        RHS: {desc:"Rectangular Hollow Sections",data:{"50x25x1.6":1.75,"50x25x2.0":2.15,"50x25x2.5":2.62,"50x25x3.0":3.07,"65x35x2.0":2.93,"65x35x2.5":3.60,"65x35x3.0":4.25,"75x50x2.0":3.72,"75x50x2.5":4.58,"75x50x3.0":5.42,"75x50x4.0":6.92,"100x50x2.0":4.50,"100x50x2.5":5.56,"100x50x3.0":6.60,"100x50x4.0":8.49,"100x50x5.0":10.3,"100x50x6.0":12.0,"125x75x3.0":8.96,"125x75x4.0":11.6,"125x75x5.0":14.2,"125x75x6.0":16.7,"150x50x3.0":8.96,"150x50x4.0":11.6,"150x50x5.0":14.2,"150x100x4.0":14.8,"150x100x5.0":18.2,"150x100x6.0":21.4,"200x100x4.0":17.9,"200x100x5.0":22.1,"200x100x6.0":26.2,"250x150x6.0":35.6,"250x150x8.0":46.5}},
        CHS: {desc:"Circular Hollow Sections",data:{"21.3x2.0":0.952,"26.9x2.0":1.23,"26.9x2.6":1.56,"33.7x2.6":1.99,"33.7x3.2":2.41,"42.4x2.6":2.55,"42.4x3.2":3.10,"48.3x3.2":3.56,"48.3x4.0":4.37,"60.3x3.6":5.03,"60.3x4.5":6.19,"76.1x3.6":6.44,"76.1x4.5":7.95,"88.9x4.0":8.38,"88.9x4.8":9.97,"101.6x4.0":9.63,"101.6x4.8":11.5,"114.3x4.5":12.2,"114.3x5.4":14.5,"139.7x5.0":16.6,"139.7x6.3":20.7,"165.1x5.0":19.7,"165.1x6.3":24.7,"219.1x6.4":33.6,"219.1x8.2":42.6,"273.1x6.4":42.1,"323.9x6.4":50.1}},
        EA: {desc:"Equal Angles",data:{"25x25x3":1.12,"25x25x5":1.65,"30x30x3":1.35,"30x30x5":2.01,"40x40x3":1.83,"40x40x5":2.73,"40x40x6":3.50,"50x50x3":2.31,"50x50x5":3.48,"50x50x6":4.46,"65x65x5":4.56,"65x65x6":5.87,"65x65x8":7.51,"75x75x5":5.27,"75x75x6":6.81,"75x75x8":8.73,"90x90x6":8.22,"90x90x8":10.6,"100x100x6":9.16,"100x100x8":11.8,"100x100x10":14.2}},
        UA: {desc:"Unequal Angles",data:{"65x50x5":4.02,"65x50x6":5.16,"75x50x5":4.40,"75x50x6":5.66,"100x75x6":7.98,"100x75x8":10.3,"125x75x6":9.16,"125x75x8":11.8,"150x90x8":14.3,"150x90x10":17.3,"150x100x10":18.0}},
        FB: {desc:"Flat Bars",data:{"25x3":0.60,"25x5":1.00,"25x6":1.21,"32x5":1.29,"32x6":1.55,"40x5":1.61,"40x6":1.93,"40x8":2.57,"50x5":2.01,"50x6":2.42,"50x8":3.22,"50x10":4.03,"65x6":3.14,"65x8":4.18,"65x10":5.23,"75x6":3.62,"75x8":4.83,"75x10":6.04,"100x6":4.83,"100x8":6.44,"100x10":8.05,"100x12":9.66}},
        RB: {desc:"Round Bars",data:{"10":0.64,"12":0.91,"14":1.24,"16":1.62,"18":2.05,"20":2.53,"22":3.05,"24":3.64,"27":4.61,"30":5.69,"33":6.88,"36":8.19,"40":10.1,"45":12.8,"50":15.8}},
        SB: {desc:"Square Bars",data:{"10x10":0.81,"12x12":1.16,"16x16":2.06,"20x20":3.22,"25x25":5.03,"32x32":8.24,"40x40":12.9}},
        UB: {desc:"Universal Beams",data:{"150UB14":14.0,"150UB18":18.0,"180UB16":16.1,"180UB18":18.1,"180UB22":22.2,"200UB18":18.2,"200UB22":22.3,"200UB25":25.4,"200UB30":29.8,"250UB26":25.7,"250UB31":31.4,"250UB37":37.3,"310UB32":32.0,"310UB40":40.4,"310UB46":46.2,"360UB45":44.7,"360UB51":50.7,"360UB57":56.7,"410UB54":53.7,"410UB60":59.7,"460UB67":67.1,"460UB75":74.6,"460UB82":82.1,"530UB82":82.0,"530UB92":92.4,"610UB101":101,"610UB113":113,"610UB125":125}},
        WB: {desc:"Welded Beams",data:{"700WB115":115,"700WB130":130,"700WB150":150,"700WB173":173,"800WB122":122,"800WB146":146,"800WB168":168,"800WB192":192,"900WB175":175,"900WB218":218,"900WB257":257,"1000WB215":215,"1000WB258":258,"1000WB296":296,"1200WB249":249,"1200WB278":278,"1200WB317":317}},
        UC: {desc:"Universal Columns",data:{"100UC15":14.8,"150UC23":23.4,"150UC30":30.0,"150UC37":37.2,"200UC46":46.2,"200UC52":52.2,"200UC60":59.5,"250UC73":72.9,"250UC90":89.5,"310UC97":96.8,"310UC118":118,"310UC137":137,"310UC158":158}},
        WC: {desc:"Welded Columns",data:{"350WC197":197,"350WC230":230,"350WC258":258,"350WC280":280,"400WC144":144,"400WC181":181,"400WC212":212,"400WC270":270,"400WC303":303,"500WC228":228,"500WC267":267,"500WC290":290,"500WC340":340,"500WC383":383}},
        PFC: {desc:"Parallel Flange Channels",data:{"75x40":5.92,"100x50":8.33,"125x65":11.9,"150x75":17.7,"180x75":20.9,"200x75":22.9,"230x75":25.1,"250x90":35.5,"300x90":40.1,"380x100":55.2}},
        TFB: {desc:"Taper Flange Beams",data:{"100x45":7.20,"125x65":13.1}}
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // EMBEDDED DATA - CHUCK (Hilti Chemicals)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const HILTI_DATA = {
        HY200R: {name:"HIT-HY 200-R",volume_ml:330,sizes:{M10:{hole:12,embed:80},M12:{hole:14,embed:96},M16:{hole:18,embed:125},M20:{hole:22,embed:160},M24:{hole:26,embed:192},M30:{hole:35,embed:240}}},
        HY200A: {name:"HIT-HY 200-A",volume_ml:330,sizes:{M10:{hole:12,embed:80},M12:{hole:14,embed:96},M16:{hole:18,embed:125},M20:{hole:22,embed:160},M24:{hole:26,embed:192},M30:{hole:35,embed:240}}},
        RE500: {name:"HIT-RE 500",volume_ml:500,sizes:{M10:{hole:12,embed:90},M12:{hole:14,embed:110},M16:{hole:18,embed:125},M20:{hole:24,embed:170},M24:{hole:28,embed:210},M30:{hole:35,embed:270}}},
        HY170: {name:"HIT-HY 170",volume_ml:330,sizes:{M8:{hole:10,embed:60},M10:{hole:12,embed:75},M12:{hole:14,embed:90},M16:{hole:18,embed:115},M20:{hole:22,embed:145}}}
    };

    // Cure time data based on temperature (minutes)
    const CURE_TIME_DATA = {
        'HY200R': [
            {min: -10, max: -5, work: 180, cure: 1200},
            {min: -4, max: 0, work: 120, cure: 420},
            {min: 1, max: 5, work: 60, cure: 180},
            {min: 6, max: 10, work: 40, cure: 120},
            {min: 11, max: 20, work: 15, cure: 60},
            {min: 21, max: 30, work: 9, cure: 60},
            {min: 31, max: 40, work: 6, cure: 60},
        ],
        'HY200A': [
            {min: -10, max: -5, work: 90, cure: 420},
            {min: -4, max: 0, work: 50, cure: 240},
            {min: 1, max: 5, work: 25, cure: 120},
            {min: 6, max: 10, work: 15, cure: 60},
            {min: 11, max: 20, work: 7, cure: 30},
            {min: 21, max: 30, work: 4, cure: 30},
            {min: 31, max: 40, work: 3, cure: 30},
        ],
        'RE500': [
            // RE 500 V3 EPOXY - VERY LONG cure times! (per Hilti ETA-16/0143)
            {min: -5, max: -1, work: 120, cure: 10080},  // 7 days at -5 to -1¬∞C
            {min: 0, max: 4, work: 120, cure: 2880},     // 48h at 0-4¬∞C
            {min: 5, max: 9, work: 120, cure: 1440},     // 24h at 5-9¬∞C
            {min: 10, max: 14, work: 90, cure: 960},     // 16h at 10-14¬∞C
            {min: 15, max: 19, work: 60, cure: 720},     // 12h at 15-19¬∞C
            {min: 20, max: 24, work: 30, cure: 420},     // 7h at 20-24¬∞C
            {min: 25, max: 29, work: 20, cure: 360},     // 6h at 25-29¬∞C
            {min: 30, max: 34, work: 15, cure: 300},     // 5h at 30-34¬∞C
            {min: 35, max: 40, work: 10, cure: 270},     // 4.5h at 35-40¬∞C
        ],
        'HY170': [
            // HY 170 HYBRID - Fast cure times (per Hilti IFU)
            {min: -5, max: 0, work: 10, cure: 720},      // 12h at -5 to 0¬∞C
            {min: 1, max: 5, work: 10, cure: 360},       // 6h at 1-5¬∞C (interpolated)
            {min: 6, max: 10, work: 8, cure: 150},       // 2.5h at 6-10¬∞C
            {min: 11, max: 20, work: 5, cure: 90},       // 1.5h at 11-20¬∞C
            {min: 21, max: 30, work: 4, cure: 60},       // 1h at 21-30¬∞C
            {min: 31, max: 40, work: 3, cure: 45},       // 45min at 31-40¬∞C
        ]
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // EMBEDDED DATA - BRITTANY (Fixing Capacities)
    // Format: [tensionKn, shearKn, minEmbed, minEdge, minSpacing, holeSize]
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const FIXING_DATA = {
        dynabolt: {
            name: 'Dynabolt Plus',
            sizes: {
                M8: [4.2, 4.0, 35, 60, 105, 10],
                M10: [5.9, 6.4, 45, 70, 135, 12],
                M12: [7.7, 7.9, 50, 75, 150, 16],
                M16: [11.9, 10.5, 65, 100, 195, 20],
                M20: [16.6, 15.6, 85, 130, 255, 24],
            }
        },
        trubolt: {
            name: 'TruBolt Stud',
            sizes: {
                M8: [5.4, 4.8, 30, 55, 80, 8],
                M10: [8.5, 8.1, 40, 60, 120, 10],
                M12: [11.2, 10.5, 48, 75, 150, 12],
                M16: [17.2, 15.2, 64, 100, 200, 16],
                M20: [24.0, 21.3, 80, 120, 240, 20],
            }
        },
        hilti_hsl: {
            name: 'Hilti HSL-3',
            sizes: {
                M8: [5.7, 7.9, 50, 48, 100, 12],
                M10: [8.5, 12.5, 60, 60, 120, 15],
                M12: [11.9, 19.4, 70, 72, 140, 18],
                M16: [18.8, 31.1, 90, 96, 192, 24],
                M20: [24.4, 47.9, 110, 120, 240, 28],
                M24: [28.6, 44.8, 130, 144, 288, 32],
            }
        },
        chemset: {
            name: 'ChemSet',
            sizes: {
                M10: [12.0, 11.0, 100, 60, 100, 12],
                M12: [17.0, 15.5, 120, 72, 120, 14],
                M16: [28.0, 26.0, 160, 96, 160, 18],
                M20: [42.0, 38.0, 200, 120, 200, 24],
                M24: [55.0, 50.0, 240, 144, 240, 28],
            }
        },
        dropin: {
            name: 'Drop-In Anchor',
            sizes: {
                M8: [4.0, 5.0, 30, 45, 60, 10],
                M10: [6.0, 7.5, 40, 55, 80, 13],
                M12: [8.5, 10.0, 50, 65, 100, 16],
                M16: [12.0, 15.0, 65, 85, 130, 20],
            }
        }
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // NAVIGATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showSection(id) {
        document.querySelectorAll('.agent-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.target.classList.add('active');
        // Load settings data when settings tab is opened
        if (id === 'settings') {
            loadSettingsData();
            loadApiKeyStatus();
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // HOBART FUNCTIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let hobartType = 'HB', hobartSize = 'M12';

    function hobartSetType(type, btn) {
        hobartType = type;
        document.querySelectorAll('#hobartTypeButtons .btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        hobartUpdateSizes();
        hobartUpdate();
    }

    function hobartSetSize(size, btn) {
        hobartSize = size;
        document.querySelectorAll('#hobartSizeButtons .btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        hobartUpdate();
    }

    function hobartUpdateSizes() {
        const container = document.getElementById('hobartSizeButtons');
        let sizes = ['M8','M10','M12','M16','M20'];
        if (hobartType === 'HBFF') sizes = ['M8','M10','M12'];
        else if (hobartType === 'HBCSK') sizes = ['M8','M10','M12','M16'];
        else if (hobartType === 'LB') sizes = ['M10','M12','M16','M20','M24'];

        container.innerHTML = sizes.map(s =>
            `<button class="btn${s === hobartSize ? ' active' : ''}" onclick="hobartSetSize('${escapeHtml(s)}', this)">${escapeHtml(s)}</button>`
        ).join('');

        if (!sizes.includes(hobartSize)) {
            hobartSize = sizes[0];
            container.querySelector('.btn').classList.add('active');
        }
    }

    function hobartUpdate() {
        let dataSource;
        if (hobartType === 'HB') dataSource = HOLLO_BOLT_DATA.HEXAGONAL_HEAD;
        else if (hobartType === 'HBCSK') dataSource = HOLLO_BOLT_DATA.COUNTERSUNK_HEAD;
        else if (hobartType === 'HBFF') dataSource = HOLLO_BOLT_DATA.FLUSH_FIT_HEAD;
        else dataSource = HOLLO_BOLT_DATA.LINDIBOLT;

        const data = dataSource[hobartSize];
        const drill = HOLLO_BOLT_DATA.DRILLING_DATA[hobartSize] || {};

        if (!data) {
            document.getElementById('hobartResults').innerHTML = '<div class="result-card"><div class="value">Not Available</div></div>';
            return;
        }

        const tensionKg = Math.round(data.tensile_swl_kn * 102);
        const shearKg = Math.round(data.shear_swl_kn * 102);

        document.getElementById('hobartResults').innerHTML = `
            <div class="result-card"><div class="label">Clearance Hole</div><div class="value">${escapeHtml(drill.clearance_hole || '-')}<span class="unit">mm</span></div></div>
            <div class="result-card"><div class="label">Tolerance</div><div class="value">${escapeHtml(drill.tolerance || '-')}</div></div>
            <div class="result-card"><div class="label">Min Edge</div><div class="value">${escapeHtml(drill.min_edge_distance || '-')}<span class="unit">mm</span></div></div>
            <div class="result-card"><div class="label">Min Spacing</div><div class="value">${escapeHtml(drill.min_hole_distance || '-')}<span class="unit">mm</span></div></div>
            <div class="result-card"><div class="label">Tension SWL</div><div class="value">${escapeHtml(tensionKg)}<span class="unit">kg</span></div></div>
            <div class="result-card"><div class="label">Shear SWL</div><div class="value">${escapeHtml(shearKg)}<span class="unit">kg</span></div></div>
            <div class="result-card"><div class="label">Torque</div><div class="value">${escapeHtml(data.torque_nm)}<span class="unit">Nm</span></div></div>
            <div class="result-card"><div class="label">Spanner</div><div class="value">${escapeHtml(data.spanner_mm)}<span class="unit">mm</span></div></div>
        `;

        const tbody = document.getElementById('hobartGripBody');
        tbody.innerHTML = data.product_codes_with_sizes.map((code, i) =>
            `<tr><td>${escapeHtml(code)}</td><td>${escapeHtml(data.clamping_ranges[i])}</td></tr>`
        ).join('');

        document.getElementById('hobartConsole').textContent = `üî© ${hobartType} ${hobartSize}: Drill ${drill.clearance_hole}mm hole, torque to ${data.torque_nm}Nm`;

        // Update grip visual
        hobartUpdateGripVisual();
    }

    // Find what bolts fit a given tube thickness
    function hobartFindFits() {
        const wallThickness = parseFloat(document.getElementById('tubeWallThickness').value) || 0;
        const resultsDiv = document.getElementById('tubeFitResults');

        if (!wallThickness) {
            resultsDiv.classList.remove('active');
            return;
        }

        const totalClamp = wallThickness * 2; // Through-bolt clamps 2x wall thickness
        const results = [];

        // Check all bolt types and sizes
        const boltTypes = [
            { key: 'HB', name: 'HB Hex Head', data: HOLLO_BOLT_DATA.HEXAGONAL_HEAD },
            { key: 'HBCSK', name: 'HBCSK Countersunk', data: HOLLO_BOLT_DATA.COUNTERSUNK_HEAD },
            { key: 'HBFF', name: 'HBFF Flush Fit', data: HOLLO_BOLT_DATA.FLUSH_FIT_HEAD },
            { key: 'LB', name: 'LB LindiBolt', data: HOLLO_BOLT_DATA.LINDIBOLT }
        ];

        boltTypes.forEach(type => {
            Object.entries(type.data).forEach(([size, data]) => {
                data.clamping_ranges.forEach((range, idx) => {
                    const [min, max] = range.split('-').map(Number);
                    let status = 'fail';
                    let statusIcon = '‚ùå';
                    let info = '';

                    if (totalClamp >= min && totalClamp <= max) {
                        const midPoint = (min + max) / 2;
                        if (totalClamp >= min + 3 && totalClamp <= max - 3) {
                            status = 'ok';
                            statusIcon = '‚úÖ';
                            info = 'Perfect fit';
                        } else {
                            status = 'warning';
                            statusIcon = '‚ö†Ô∏è';
                            info = totalClamp < midPoint ? 'Near minimum' : 'Near maximum';
                        }

                        results.push({
                            bolt: `${type.key} ${size}`,
                            code: data.product_codes_with_sizes[idx].split(' ')[0],
                            range: `${min}-${max}mm`,
                            status,
                            statusIcon,
                            info,
                            torque: data.torque_nm
                        });
                    }
                });
            });
        });

        if (results.length === 0) {
            resultsDiv.innerHTML = '<div style="color:#ef4444;padding:10px;">‚ùå No Hollo-Bolts fit this clamping thickness</div>';
        } else {
            resultsDiv.innerHTML = results.map(r => `
                <div class="tube-match ${escapeHtml(r.status)}">
                    <div>
                        <div class="tube-match-bolt">${escapeHtml(r.bolt)} (${escapeHtml(r.code)})</div>
                        <div class="tube-match-info">Grip: ${escapeHtml(r.range)} | Torque: ${escapeHtml(r.torque)}Nm | ${escapeHtml(r.info)}</div>
                    </div>
                    <div class="tube-match-status">${escapeHtml(r.statusIcon)}</div>
                </div>
            `).join('');
        }

        resultsDiv.classList.add('active');
    }

    // Update grip range visual
    function hobartUpdateGripVisual() {
        let dataSource;
        if (hobartType === 'HB') dataSource = HOLLO_BOLT_DATA.HEXAGONAL_HEAD;
        else if (hobartType === 'HBCSK') dataSource = HOLLO_BOLT_DATA.COUNTERSUNK_HEAD;
        else if (hobartType === 'HBFF') dataSource = HOLLO_BOLT_DATA.FLUSH_FIT_HEAD;
        else dataSource = HOLLO_BOLT_DATA.LINDIBOLT;

        const data = dataSource[hobartSize];
        if (!data) return;

        // Get all grip ranges for this bolt
        const allRanges = data.clamping_ranges.map(r => r.split('-').map(Number));
        const overallMin = Math.min(...allRanges.map(r => r[0]));
        const overallMax = Math.max(...allRanges.map(r => r[1]));

        // Update labels
        document.getElementById('gripMinLabel').textContent = `${overallMin}mm`;
        document.getElementById('gripMaxLabel').textContent = `${overallMax}mm`;

        // Clear and redraw ALL ranges on diagram
        const diagram = document.getElementById('gripDiagram');
        // Remove old range divs (except the current marker)
        diagram.querySelectorAll('.grip-range-segment').forEach(el => el.remove());

        // Get product codes (extract short name from full description)
        const productCodes = data.product_codes_with_sizes.map(p => p.split(' ')[0]);

        // Draw each bolt length range with different color intensity
        const colors = ['#22c55e', '#3b82f6', '#a855f7']; // green, blue, purple
        allRanges.forEach((range, i) => {
            const leftPercent = ((range[0] - overallMin) / (overallMax - overallMin)) * 100;
            const widthPercent = ((range[1] - range[0]) / (overallMax - overallMin)) * 100;

            const rangeDiv = document.createElement('div');
            rangeDiv.className = 'grip-range-segment';
            rangeDiv.style.cssText = `
                position: absolute;
                top: ${i * 20}px;
                height: 18px;
                left: ${leftPercent}%;
                width: ${widthPercent}%;
                background: ${colors[i % colors.length]};
                opacity: 0.7;
                border-radius: 3px;
                border: 1px solid rgba(255,255,255,0.3);
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 4px;
                box-sizing: border-box;
            `;
            // Add label with product code AND range numbers
            rangeDiv.innerHTML = `
                <span style="font-size:9px;color:#fff;white-space:nowrap;font-weight:bold">${escapeHtml(productCodes[i])}</span>
                <span style="font-size:8px;color:rgba(255,255,255,0.9);white-space:nowrap">${escapeHtml(range[0])}-${escapeHtml(range[1])}</span>
            `;
            diagram.appendChild(rangeDiv);
        });

        // Check user input
        const userClamp = parseFloat(document.getElementById('hobartClampInput').value);
        const currentMarker = document.getElementById('gripCurrent');
        const statusSpan = document.getElementById('gripStatus');

        if (userClamp) {
            currentMarker.style.display = 'block';
            const pos = ((userClamp - overallMin) / (overallMax - overallMin)) * 100;
            currentMarker.style.left = `${Math.min(100, Math.max(0, pos))}%`;

            // Check if in range and which bolt fits
            let matchingBolt = null;
            allRanges.forEach((range, i) => {
                if (userClamp >= range[0] && userClamp <= range[1]) {
                    matchingBolt = productCodes[i];
                }
            });

            if (matchingBolt) {
                statusSpan.innerHTML = `‚úÖ <span style="color:#22c55e">USE ${escapeHtml(matchingBolt)}</span>`;
            } else if (userClamp < overallMin) {
                statusSpan.innerHTML = '‚ùå <span style="color:#ef4444">TOO THIN - No bolt fits</span>';
            } else if (userClamp > overallMax) {
                statusSpan.innerHTML = '‚ùå <span style="color:#ef4444">TOO THICK - No bolt fits</span>';
            } else {
                // In between ranges (gap)
                statusSpan.innerHTML = '‚ö†Ô∏è <span style="color:#f59e0b">BETWEEN RANGES - Check table</span>';
            }
        } else {
            currentMarker.style.display = 'none';
            statusSpan.textContent = '';
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // IGOR FUNCTIONS (Dropdown-based)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let igorMembers = []; // Array to store added members

    // Load sections into dropdown when type changes
    function igorLoadSections() {
        const typeSelect = document.getElementById('igorTypeSelect');
        const sectionSelect = document.getElementById('igorSectionSelect');
        const selectedType = typeSelect.value;

        if (!selectedType) {
            sectionSelect.innerHTML = '<option value="">Section</option>';
            document.getElementById('igorPreview').style.display = 'none';
            return;
        }

        const sections = STEEL_SECTIONS[selectedType].data;
        sectionSelect.innerHTML = '<option value="">Select section</option>';

        Object.entries(sections).forEach(([name, mass]) => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.dataset.mass = mass;
            opt.textContent = `${name} (${mass} kg/m)`;
            sectionSelect.appendChild(opt);
        });

        document.getElementById('igorConsole').textContent = `‚öñÔ∏è ${selectedType}: ${Object.keys(sections).length} sections available`;
        document.getElementById('igorPreview').style.display = 'none';
    }

    // Update preview when section/length/qty changes
    function igorUpdatePreview() {
        const typeSelect = document.getElementById('igorTypeSelect');
        const sectionSelect = document.getElementById('igorSectionSelect');
        const lengthInput = document.getElementById('igorLengthInput');
        const qtyInput = document.getElementById('igorQtyInput');
        const preview = document.getElementById('igorPreview');

        const type = typeSelect.value;
        const section = sectionSelect.value;
        const length = parseFloat(lengthInput.value) || 0;
        const qty = parseInt(qtyInput.value) || 1;

        if (!section || !length) {
            preview.style.display = 'none';
            return;
        }

        const selectedOption = sectionSelect.options[sectionSelect.selectedIndex];
        const massPerM = parseFloat(selectedOption.dataset.mass) || 0;
        const totalWeight = massPerM * length * qty;

        document.getElementById('igorPreviewMember').textContent = `${qty}x ${section} ${type} @ ${length}m`;
        document.getElementById('igorPreviewWeight').textContent = `${totalWeight.toFixed(1)} kg`;
        preview.style.display = 'flex';
    }

    // Add member to list
    function igorAddMember() {
        const typeSelect = document.getElementById('igorTypeSelect');
        const sectionSelect = document.getElementById('igorSectionSelect');
        const lengthInput = document.getElementById('igorLengthInput');
        const qtyInput = document.getElementById('igorQtyInput');

        const type = typeSelect.value;
        const section = sectionSelect.value;
        const length = parseFloat(lengthInput.value) || 0;
        const qty = parseInt(qtyInput.value) || 1;

        if (!section || !length) {
            alert('Please select a section and enter a length');
            return;
        }

        const selectedOption = sectionSelect.options[sectionSelect.selectedIndex];
        const massPerM = parseFloat(selectedOption.dataset.mass) || 0;
        const total = massPerM * length * qty;

        igorMembers.push({ type, section, length, qty, massPerM, total });
        igorRenderMembers();

        // Reset for next entry
        sectionSelect.value = '';
        lengthInput.value = '1';
        qtyInput.value = '1';
        document.getElementById('igorPreview').style.display = 'none';

        document.getElementById('igorConsole').textContent = `‚öñÔ∏è Added: ${qty}x ${section} ${type} @ ${length}m = ${total.toFixed(1)} kg`;
    }

    // Render members list
    function igorRenderMembers() {
        const list = document.getElementById('igorMembersList');
        list.innerHTML = igorMembers.map((m, i) => `
            <div class="igor-member-item">
                <span>${escapeHtml(m.qty)}x ${escapeHtml(m.section)} ${escapeHtml(m.type)} @ ${escapeHtml(m.length)}m</span>
                <span class="weight">${escapeHtml(m.total.toFixed(1))} kg</span>
                <button class="remove-btn" onclick="igorRemoveMember(${i})">√ó</button>
            </div>
        `).join('');
    }

    // Remove member from list
    function igorRemoveMember(index) {
        igorMembers.splice(index, 1);
        igorRenderMembers();
        document.getElementById('igorResultsSection').style.display = 'none';
    }

    // Calculate total weight
    function igorCalculateTotal() {
        if (igorMembers.length === 0) {
            alert('Please add at least one steel member');
            return;
        }

        const breakdown = {};
        let totalWeight = 0;

        igorMembers.forEach(m => {
            const key = m.type;
            if (!breakdown[key]) breakdown[key] = 0;
            breakdown[key] += m.total;
            totalWeight += m.total;
        });

        // Render breakdown
        const breakdownHtml = Object.entries(breakdown).map(([type, weight]) =>
            `<div style="display:flex;justify-content:space-between;padding:5px 0;"><span>${escapeHtml(type)}:</span><span>${escapeHtml(weight.toFixed(1))} kg</span></div>`
        ).join('');

        document.getElementById('igorBreakdown').innerHTML = breakdownHtml;
        document.getElementById('igorSteelWeight').textContent = `${totalWeight.toFixed(1)} kg`;
        document.getElementById('igorTotalWeight').textContent = `${(totalWeight * 1.1).toFixed(1)} kg`;
        document.getElementById('igorResultsSection').style.display = 'block';

        document.getElementById('igorConsole').textContent = `‚öñÔ∏è Total: ${totalWeight.toFixed(1)} kg steel + 10% fittings = ${(totalWeight * 1.1).toFixed(1)} kg`;
    }

    // Excel Download Function - generates multi-sheet IBSC Steel Calculator with styling
    async function igorDownloadExcel() {
        document.getElementById('igorConsole').textContent = '‚öñÔ∏è Generating Excel calculator... Please wait';

        // Load ExcelJS library dynamically (supports styling)
        if (typeof ExcelJS === 'undefined') {
            await new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        const workbook = new ExcelJS.Workbook();
        workbook.creator = 'IGOR - J&M Artsteel Hub';
        workbook.created = new Date();

        const SS_FACTOR = 1.02; // Stainless steel factor (density 8000 vs 7850 kg/m¬≥)

        // Different colors for each sheet type
        const sheetColors = {
            'SHS': '1E88E5',  // Blue
            'RHS': '43A047',  // Green
            'CHS': 'E53935',  // Red
            'EA':  'FB8C00',  // Orange
            'UA':  '8E24AA',  // Purple
            'FB':  '00ACC1',  // Cyan
            'RB':  '6D4C41',  // Brown
            'SB':  '546E7A',  // Blue Grey
            'UB':  '5E35B1',  // Deep Purple
            'WB':  '00897B',  // Teal
            'UC':  'D81B60',  // Pink
            'WC':  '3949AB',  // Indigo
            'PFC': 'F4511E',  // Deep Orange
            'TFB': '7CB342'   // Light Green
        };
        const headerFont = { bold: true, color: { argb: 'FFFFFF' } };
        const ssHeaderFill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '4A7C59' } };
        const summaryHeaderFill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '2F5496' } };
        const titleFont = { bold: true, size: 16 };
        const inputFill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF9C4' } };  // Light yellow
        const calcFill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'E3F2FD' } };   // Light blue
        const border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
        };

        // Sheet order for summary references
        const sheetOrder = ['SHS', 'RHS', 'CHS', 'EA', 'UA', 'FB', 'RB', 'SB', 'UB', 'WB', 'UC', 'WC', 'PFC', 'TFB'];

        // Full names for member types
        const memberFullNames = {
            'SHS': 'Square Hollow Section',
            'RHS': 'Rectangular Hollow Section',
            'CHS': 'Circular Hollow Section',
            'EA': 'Equal Angle',
            'UA': 'Unequal Angle',
            'FB': 'Flat Bar',
            'RB': 'Round Bar',
            'SB': 'Square Bar',
            'UB': 'Universal Beam',
            'WB': 'Welded Beam',
            'UC': 'Universal Column',
            'WC': 'Welded Column',
            'PFC': 'Parallel Flange Channel',
            'TFB': 'Taper Flange Beam'
        };
        const sheetInfo = [];

        // Create hidden Lists sheet for dropdown references
        const listsSheet = workbook.addWorksheet('_Lists');
        listsSheet.state = 'veryHidden';
        let listCol = 1;
        const listRanges = {};

        // Populate Lists sheet with all section sizes
        sheetOrder.forEach(type => {
            const typeData = STEEL_SECTIONS[type];
            const entries = Object.entries(typeData.data);
            const sizes = entries.map(([size]) => size);

            // Write sizes to column
            sizes.forEach((size, idx) => {
                listsSheet.getCell(idx + 1, listCol).value = size;
            });

            // Store range reference for this type
            listRanges[type] = `_Lists!$${String.fromCharCode(64 + listCol)}$1:$${String.fromCharCode(64 + listCol)}$${sizes.length}`;
            listCol++;
        });

        // Create lookup sheet for VLOOKUP formulas
        const lookupSheet = workbook.addWorksheet('_Lookup');
        lookupSheet.state = 'veryHidden';
        let lookupCol = 1;
        const lookupRanges = {};

        // Populate lookup sheet with size -> mass data
        sheetOrder.forEach(type => {
            const typeData = STEEL_SECTIONS[type];
            const entries = Object.entries(typeData.data);

            entries.forEach(([size, mass], idx) => {
                lookupSheet.getCell(idx + 1, lookupCol).value = size;
                lookupSheet.getCell(idx + 1, lookupCol + 1).value = mass;
            });

            const colLetter1 = String.fromCharCode(64 + lookupCol);
            const colLetter2 = String.fromCharCode(64 + lookupCol + 1);
            lookupRanges[type] = `_Lookup!$${colLetter1}$1:$${colLetter2}$${entries.length}`;
            lookupCol += 2;
        });

        // Check if pricing is enabled and has data
        const pricingEnabled = IgorPricing && IgorPricing.enabled && IgorPricing.currentSupplier;
        const supplierPrices = pricingEnabled ? IgorPricing.prices[IgorPricing.currentSupplier] : null;
        const supplierName = pricingEnabled ? (IgorPricing.suppliers[IgorPricing.currentSupplier]?.name || 'Unknown') : null;
        const priceHeaderFill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '2E7D32' } }; // Dark green for price columns

        // Create price lookup sheet if pricing enabled
        let priceLookupRanges = {};
        if (pricingEnabled && supplierPrices) {
            const priceSheet = workbook.addWorksheet('_Prices');
            priceSheet.state = 'veryHidden';

            // Build price lookup for each type
            let priceCol = 1;
            sheetOrder.forEach(type => {
                const typeData = STEEL_SECTIONS[type];
                const entries = Object.entries(typeData.data);
                let priceRow = 1;

                entries.forEach(([size, mass]) => {
                    // Try to match price
                    const priceInfo = igorMatchPrice(type, size);
                    const pricePerM = priceInfo ? igorGetPricePerMetre(type, size, mass) : null;

                    priceSheet.getCell(priceRow, priceCol).value = size;
                    priceSheet.getCell(priceRow, priceCol + 1).value = pricePerM || 0;
                    priceRow++;
                });

                const colLetter1 = String.fromCharCode(64 + priceCol);
                const colLetter2 = String.fromCharCode(64 + priceCol + 1);
                priceLookupRanges[type] = `_Prices!$${colLetter1}$1:$${colLetter2}$${entries.length}`;
                priceCol += 2;
            });
        }

        // Create data sheets with different colors and dropdowns (EMPTY rows)
        const NUM_EMPTY_ROWS = 50; // 50 empty rows for user input
        sheetOrder.forEach(type => {
            const typeData = STEEL_SECTIONS[type];
            const fullName = memberFullNames[type] || type;
            const ws = workbook.addWorksheet(fullName);
            const entries = Object.entries(typeData.data);

            // Set tab color
            ws.properties.tabColor = { argb: sheetColors[type] };
            const sheetHeaderFill = { type: 'pattern', pattern: 'solid', fgColor: { argb: sheetColors[type] } };

            // Headers with sheet-specific color
            // If pricing enabled: Size, Mass, Length, Weight, $/m, $/t, Line Total, Breakdown
            const headers = pricingEnabled
                ? ['Size (mm)', 'Mass (kg/m)', 'Linear Metres', 'Total Weight (kg)', '$/metre', '$/tonne', 'Line Total ($)', 'Breakdown']
                : ['Size (mm)', 'Mass (kg/m)', 'Linear Metres', 'Total Weight (kg)', 'Breakdown'];
            const headerRow = ws.addRow(headers);
            headerRow.eachCell((cell, colNumber) => {
                // Price columns get green header
                if (pricingEnabled && colNumber >= 5 && colNumber <= 7) {
                    cell.fill = priceHeaderFill;
                } else {
                    cell.fill = sheetHeaderFill;
                }
                cell.font = headerFont;
                cell.alignment = { horizontal: 'center', vertical: 'middle' };
                cell.border = border;
            });

            // Empty data rows with dropdowns and VLOOKUP for mass
            for (let idx = 0; idx < NUM_EMPTY_ROWS; idx++) {
                const rowNum = idx + 2;

                let rowData;
                if (pricingEnabled) {
                    // With pricing: A=Size, B=Mass, C=Length, D=Weight, E=$/m, F=$/t, G=Total$, H=Breakdown
                    rowData = [
                        null, // A: Size (user input)
                        { formula: `IF(A${rowNum}="","",VLOOKUP(A${rowNum},${lookupRanges[type]},2,FALSE))` }, // B: Mass
                        null, // C: Linear Metres (user input)
                        { formula: `IF(OR(A${rowNum}="",C${rowNum}=""),"",B${rowNum}*C${rowNum})` }, // D: Weight
                        { formula: `IF(A${rowNum}="","",IFERROR(VLOOKUP(A${rowNum},${priceLookupRanges[type]},2,FALSE),"N/A"))` }, // E: $/metre
                        { formula: `IF(OR(A${rowNum}="",B${rowNum}=""),"",IF(ISNUMBER(E${rowNum}),E${rowNum}/(B${rowNum}/1000),"N/A"))` }, // F: $/tonne
                        { formula: `IF(OR(A${rowNum}="",C${rowNum}="",NOT(ISNUMBER(E${rowNum}))),"",E${rowNum}*C${rowNum})` }, // G: Line Total
                        { formula: `IF(OR(A${rowNum}="",C${rowNum}=""),"",A${rowNum}&" - "&TEXT(C${rowNum},"0.#")&"m")` } // H: Breakdown
                    ];
                } else {
                    // Without pricing: A=Size, B=Mass, C=Length, D=Weight, E=Breakdown
                    rowData = [
                        null,
                        { formula: `IF(A${rowNum}="","",VLOOKUP(A${rowNum},${lookupRanges[type]},2,FALSE))` },
                        null,
                        { formula: `IF(OR(A${rowNum}="",C${rowNum}=""),"",B${rowNum}*C${rowNum})` },
                        { formula: `IF(OR(A${rowNum}="",C${rowNum}=""),"",A${rowNum}&" - "&TEXT(C${rowNum},"0.#")&"m")` }
                    ];
                }

                const row = ws.addRow(rowData);
                row.eachCell((cell, colNumber) => {
                    cell.alignment = { horizontal: 'center', vertical: 'middle' };
                    cell.border = border;
                    // Column 1 (Size) is input - yellow
                    if (colNumber === 1) cell.fill = inputFill;
                    // Column 3 (Linear Metres) is input - yellow
                    if (colNumber === 3) cell.fill = inputFill;
                    // Column 4 (Total Weight) is calculated - light blue
                    if (colNumber === 4) cell.fill = calcFill;
                    // Price columns - light green
                    if (pricingEnabled && colNumber >= 5 && colNumber <= 7) {
                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'E8F5E9' } };
                    }
                });
                row.getCell(2).numFmt = '0.00';
                row.getCell(3).numFmt = '0.00';
                row.getCell(4).numFmt = '#,##0.00';

                if (pricingEnabled) {
                    row.getCell(5).numFmt = '$#,##0.00';  // $/m
                    row.getCell(6).numFmt = '$#,##0.00';  // $/t
                    row.getCell(7).numFmt = '$#,##0.00';  // Line Total
                }

                // Add dropdown for Size column using range reference
                row.getCell(1).dataValidation = {
                    type: 'list',
                    allowBlank: true,
                    formulae: [listRanges[type]]
                };
            }

            // Set column widths
            ws.getColumn(1).width = 25;
            ws.getColumn(2).width = 15;
            ws.getColumn(3).width = 15;
            ws.getColumn(4).width = 18;

            if (pricingEnabled) {
                ws.getColumn(5).width = 12;  // $/m
                ws.getColumn(6).width = 12;  // $/t
                ws.getColumn(7).width = 14;  // Line Total
                ws.getColumn(8).width = 0.1; // Breakdown (hidden)
                ws.getColumn(8).hidden = true;
            } else {
                ws.getColumn(5).width = 0.1; // Breakdown (hidden)
                ws.getColumn(5).hidden = true;
            }

            // Freeze header
            ws.views = [{ state: 'frozen', ySplit: 1 }];

            sheetInfo.push({
                name: fullName,
                shortName: type,
                rows: NUM_EMPTY_ROWS,
                color: sheetColors[type],
                breakdownCol: pricingEnabled ? 'H' : 'E',
                totalCol: pricingEnabled ? 'G' : null
            });
        });

        // Create Summary sheet at the beginning
        const summary = workbook.addWorksheet('Summary');

        // Title - merge cells A1:D1
        summary.mergeCells('A1:D1');
        const titleCell = summary.getCell('A1');
        titleCell.value = 'STEEL WEIGHT SUMMARY';
        titleCell.font = titleFont;
        titleCell.alignment = { horizontal: 'center' };

        // Instructions
        summary.mergeCells('A3:D3');
        summary.getCell('A3').value = 'Enter linear metres in each sheet. Totals update automatically.';
        summary.getCell('A3').font = { italic: true };

        summary.mergeCells('A4:D4');
        summary.getCell('A4').value = 'Stainless Steel weight = Mild Steel √ó 1.02 (density difference)';
        summary.getCell('A4').font = { italic: true };

        // Headers at row 6
        const summaryHeaders = ['Category', 'Total Weight (kg)', 'Weight (tonnes)', 'Stainless (kg)'];
        const summaryHeaderRow = summary.getRow(6);
        summaryHeaders.forEach((h, idx) => {
            const cell = summaryHeaderRow.getCell(idx + 1);
            cell.value = h;
            cell.fill = idx === 3 ? ssHeaderFill : summaryHeaderFill;
            cell.font = headerFont;
            cell.alignment = { horizontal: 'center', vertical: 'middle' };
            cell.border = border;
        });

        // Data rows
        sheetInfo.forEach((info, idx) => {
            const rowNum = idx + 7;
            const endRow = info.rows + 1;
            const row = summary.getRow(rowNum);

            row.getCell(1).value = info.name;
            row.getCell(2).value = { formula: `SUM('${info.name}'!D2:D${endRow})` };
            row.getCell(3).value = { formula: `B${rowNum}/1000` };
            row.getCell(4).value = { formula: `B${rowNum}*${SS_FACTOR}` };

            row.eachCell(cell => {
                cell.alignment = { horizontal: 'center', vertical: 'middle' };
                cell.border = border;
            });
            row.getCell(2).numFmt = '#,##0.00';
            row.getCell(3).numFmt = '#,##0.000';
            row.getCell(4).numFmt = '#,##0.00';
        });

        // Grand total row
        const startDataRow = 7;
        const endDataRow = 6 + sheetInfo.length;
        const totalRowNum = endDataRow + 2;
        const totalRow = summary.getRow(totalRowNum);

        totalRow.getCell(1).value = 'GRAND TOTAL';
        totalRow.getCell(1).font = { bold: true, size: 12 };
        totalRow.getCell(2).value = { formula: `SUM(B${startDataRow}:B${endDataRow})` };
        totalRow.getCell(3).value = { formula: `SUM(C${startDataRow}:C${endDataRow})` };
        totalRow.getCell(4).value = { formula: `SUM(D${startDataRow}:D${endDataRow})` };

        totalRow.eachCell(cell => {
            cell.font = { bold: true };
            cell.alignment = { horizontal: 'center', vertical: 'middle' };
            cell.border = border;
        });
        totalRow.getCell(2).numFmt = '#,##0.00';
        totalRow.getCell(3).numFmt = '#,##0.000';
        totalRow.getCell(4).numFmt = '#,##0.00';

        // Set column widths
        summary.getColumn(1).width = 20;
        summary.getColumn(2).width = 18;
        summary.getColumn(3).width = 18;
        summary.getColumn(4).width = 18;

        // Freeze at row 7
        summary.views = [{ state: 'frozen', ySplit: 6 }];

        // Move Summary to first position
        workbook.removeWorksheet('Summary');
        const summaryNew = workbook.addWorksheet('Summary');

        // Re-create Summary (ExcelJS doesn't support moving sheets easily)
        // Determine column count based on pricing
        const summaryColCount = pricingEnabled ? 7 : 5;
        const lastColLetter = pricingEnabled ? 'G' : 'E';

        // Company Header
        const companyHeaderFill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '1a365d' } };

        summaryNew.mergeCells(`A1:${lastColLetter}1`);
        summaryNew.getCell('A1').value = 'J&M Art Steel Fabrication P/L';
        summaryNew.getCell('A1').font = { bold: true, size: 18, color: { argb: 'FFFFFF' } };
        summaryNew.getCell('A1').fill = companyHeaderFill;
        summaryNew.getCell('A1').alignment = { horizontal: 'center', vertical: 'middle' };
        summaryNew.getRow(1).height = 30;

        summaryNew.mergeCells(`A2:${lastColLetter}2`);
        summaryNew.getCell('A2').value = 'Unit 2/ 28-30 Lillian Flower Place, Marrickville NSW 2204';
        summaryNew.getCell('A2').font = { size: 11, color: { argb: 'FFFFFF' } };
        summaryNew.getCell('A2').fill = companyHeaderFill;
        summaryNew.getCell('A2').alignment = { horizontal: 'center', vertical: 'middle' };

        summaryNew.mergeCells(`A3:${lastColLetter}3`);
        summaryNew.getCell('A3').value = 'T: 02 8021 6707  |  M: 0421 470 043';
        summaryNew.getCell('A3').font = { size: 11, color: { argb: 'FFFFFF' } };
        summaryNew.getCell('A3').fill = companyHeaderFill;
        summaryNew.getCell('A3').alignment = { horizontal: 'center', vertical: 'middle' };

        // Title
        summaryNew.mergeCells(`A5:${lastColLetter}5`);
        summaryNew.getCell('A5').value = pricingEnabled ? 'STEEL WEIGHT & COST SUMMARY' : 'STEEL WEIGHT SUMMARY';
        summaryNew.getCell('A5').font = titleFont;
        summaryNew.getCell('A5').alignment = { horizontal: 'center' };

        // Supplier info if pricing enabled
        if (pricingEnabled) {
            summaryNew.mergeCells(`A6:${lastColLetter}6`);
            summaryNew.getCell('A6').value = `Supplier: ${supplierName} | Prices as at: ${new Date().toLocaleDateString()}`;
            summaryNew.getCell('A6').font = { italic: true, color: { argb: '2E7D32' } };
            summaryNew.getCell('A6').alignment = { horizontal: 'center' };
        }

        summaryNew.mergeCells(`A7:${lastColLetter}7`);
        summaryNew.getCell('A7').value = 'Enter linear metres in each sheet. Totals update automatically.';
        summaryNew.getCell('A7').font = { italic: true };

        summaryNew.mergeCells(`A8:${lastColLetter}8`);
        summaryNew.getCell('A8').value = 'Stainless Steel weight = Mild Steel √ó 1.02 (density difference)';
        summaryNew.getCell('A8').font = { italic: true };

        // Headers including Breakdown column (and price columns if enabled)
        const newSummaryHeaders = pricingEnabled
            ? ['Category', 'Total Weight (kg)', 'Weight (tonnes)', 'Stainless (t)', 'Total Cost ($)', 'Avg $/m', 'Breakdown']
            : ['Category', 'Total Weight (kg)', 'Weight (tonnes)', 'Stainless (t)', 'Breakdown'];
        const newHeaderRow = summaryNew.getRow(10);
        newSummaryHeaders.forEach((h, idx) => {
            const cell = newHeaderRow.getCell(idx + 1);
            cell.value = h;
            // Color coding: SS=green, Price cols=dark green, rest=blue
            if (idx === 3) {
                cell.fill = ssHeaderFill;
            } else if (pricingEnabled && (idx === 4 || idx === 5)) {
                cell.fill = priceHeaderFill;
            } else {
                cell.fill = summaryHeaderFill;
            }
            cell.font = headerFont;
            cell.alignment = { horizontal: 'center', vertical: 'middle' };
            cell.border = border;
        });

        // Data rows start at row 11 (after header at row 10)
        sheetInfo.forEach((info, idx) => {
            const rowNum = idx + 11;
            const endRow = info.rows + 1;
            const row = summaryNew.getRow(rowNum);

            // Row fill color matching the member sheet tab color
            const rowFill = { type: 'pattern', pattern: 'solid', fgColor: { argb: info.color } };

            row.getCell(1).value = info.name;
            row.getCell(2).value = { formula: `SUM('${info.name}'!D2:D${endRow})` };
            row.getCell(3).value = { formula: `B${rowNum}/1000` };
            // Stainless now in TONNES: (kg * 1.02) / 1000
            row.getCell(4).value = { formula: `(B${rowNum}*${SS_FACTOR})/1000` };

            if (pricingEnabled) {
                // Total Cost - sum of Line Total column (G) from sheet
                row.getCell(5).value = { formula: `SUM('${info.name}'!G2:G${endRow})` };
                // Avg $/m - Total Cost / Total metres
                row.getCell(6).value = { formula: `IF(SUM('${info.name}'!C2:C${endRow})=0,"",E${rowNum}/SUM('${info.name}'!C2:C${endRow}))` };
                // Breakdown - from hidden column H
                const breakdownFormula = `_xlfn.TEXTJOIN(", ",TRUE,'${info.name}'!${info.breakdownCol}2:${info.breakdownCol}${endRow})`;
                row.getCell(7).value = { formula: breakdownFormula };
            } else {
                // Breakdown - from column E
                const breakdownFormula = `_xlfn.TEXTJOIN(", ",TRUE,'${info.name}'!${info.breakdownCol}2:${info.breakdownCol}${endRow})`;
                row.getCell(5).value = { formula: breakdownFormula };
            }

            const totalCols = pricingEnabled ? 7 : 5;
            for (let c = 1; c <= totalCols; c++) {
                const isBreakdown = (pricingEnabled && c === 7) || (!pricingEnabled && c === 5);
                row.getCell(c).alignment = { horizontal: isBreakdown ? 'left' : 'center', vertical: 'middle' };
                row.getCell(c).border = border;
                // Color the Category cell (col 1) with the member's color
                if (c === 1) {
                    row.getCell(c).fill = rowFill;
                    row.getCell(c).font = { bold: true, color: { argb: 'FFFFFF' } };
                }
                // Light green for price cells
                if (pricingEnabled && (c === 5 || c === 6)) {
                    row.getCell(c).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'E8F5E9' } };
                }
            }
            row.getCell(2).numFmt = '#,##0.00';
            row.getCell(3).numFmt = '#,##0.000';
            row.getCell(4).numFmt = '#,##0.000';  // Stainless tonnes - 3 decimals

            if (pricingEnabled) {
                row.getCell(5).numFmt = '$#,##0.00';  // Total Cost
                row.getCell(6).numFmt = '$#,##0.00';  // Avg $/m
            }
        });

        // Grand total row for new summary
        const newStartDataRow = 11;
        const newEndDataRow = 10 + sheetInfo.length;
        const newTotalRowNum = newEndDataRow + 2;
        const newTotalRow = summaryNew.getRow(newTotalRowNum);
        newTotalRow.getCell(1).value = 'GRAND TOTAL';
        newTotalRow.getCell(1).font = { bold: true, size: 12 };
        newTotalRow.getCell(2).value = { formula: `SUM(B${newStartDataRow}:B${newEndDataRow})` };
        newTotalRow.getCell(3).value = { formula: `SUM(C${newStartDataRow}:C${newEndDataRow})` };
        newTotalRow.getCell(4).value = { formula: `SUM(D${newStartDataRow}:D${newEndDataRow})` };

        if (pricingEnabled) {
            newTotalRow.getCell(5).value = { formula: `SUM(E${newStartDataRow}:E${newEndDataRow})` };
            newTotalRow.getCell(6).value = ''; // No avg for total
            newTotalRow.getCell(7).value = '';
        } else {
            newTotalRow.getCell(5).value = '';
        }

        const totalCols = pricingEnabled ? 7 : 5;
        for (let c = 1; c <= totalCols; c++) {
            newTotalRow.getCell(c).font = { bold: true };
            newTotalRow.getCell(c).alignment = { horizontal: 'center', vertical: 'middle' };
            newTotalRow.getCell(c).border = border;
        }
        newTotalRow.getCell(2).numFmt = '#,##0.00';
        newTotalRow.getCell(3).numFmt = '#,##0.000';
        newTotalRow.getCell(4).numFmt = '#,##0.000';  // Stainless tonnes

        if (pricingEnabled) {
            newTotalRow.getCell(5).numFmt = '$#,##0.00';
            // Highlight grand total cost
            newTotalRow.getCell(5).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '2E7D32' } };
            newTotalRow.getCell(5).font = { bold: true, color: { argb: 'FFFFFF' }, size: 12 };
        }

        summaryNew.getColumn(1).width = 25;  // Wider for full names
        summaryNew.getColumn(2).width = 16;
        summaryNew.getColumn(3).width = 16;
        summaryNew.getColumn(4).width = 16;

        if (pricingEnabled) {
            summaryNew.getColumn(5).width = 14;  // Total Cost
            summaryNew.getColumn(6).width = 12;  // Avg $/m
            summaryNew.getColumn(7).width = 60;  // Breakdown
        } else {
            summaryNew.getColumn(5).width = 60;  // Breakdown
        }

        summaryNew.views = [{ state: 'frozen', ySplit: 10 }];

        // Generate and download
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const fileName = pricingEnabled
            ? `IBSC_Steel_Calculator_${supplierName.replace(/[^a-zA-Z0-9]/g, '_')}.xlsx`
            : 'IBSC_Steel_Calculator.xlsx';
        a.download = fileName;
        a.click();
        URL.revokeObjectURL(url);

        const msg = pricingEnabled
            ? `‚öñÔ∏è Excel downloaded with ${supplierName} pricing! Columns: Weight, $/m, $/t, Line Total`
            : '‚öñÔ∏è Excel downloaded! Empty rows with dropdowns, breakdown column in Summary.';
        document.getElementById('igorConsole').textContent = msg;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // IGOR PRICING MODULE
    // Complete pricing system with Excel/CSV/PDF parsing, column mapping,
    // smart size matching, and price integration
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // Pricing state
    const IgorPricing = {
        enabled: false,
        currentSupplier: null,
        prices: {},           // { supplierId: { sizeKey: { price, unit, grade } } }
        suppliers: {},        // { supplierId: { name, lastUpdated, priceCount, mapping } }
        tempData: null,       // Temporary parsed data during mapping
        tempFileName: null,
        customSuppliers: []   // User-added suppliers
    };

    // Initialize pricing from localStorage
    function igorInitPricing() {
        try {
            const saved = localStorage.getItem('igor-pricing-data');
            if (saved) {
                const data = JSON.parse(saved);
                IgorPricing.prices = data.prices || {};
                IgorPricing.suppliers = data.suppliers || {};
                IgorPricing.customSuppliers = data.customSuppliers || [];

                // Add custom suppliers to dropdown
                const select = document.getElementById('igorSupplierSelect');
                IgorPricing.customSuppliers.forEach(s => {
                    if (!select.querySelector(`option[value="${s.id}"]`)) {
                        const opt = document.createElement('option');
                        opt.value = s.id;
                        opt.textContent = s.name + ' ‚≠ê';
                        document.getElementById('igorSupplierGroup').appendChild(opt);
                    }
                });
            }
        } catch (e) {
            console.warn('Failed to load pricing data:', e);
        }

        // Setup drag & drop
        const zone = document.getElementById('igorUploadZone');
        zone.addEventListener('dragover', (e) => {
            e.preventDefault();
            zone.classList.add('drag-over');
        });
        zone.addEventListener('dragleave', () => {
            zone.classList.remove('drag-over');
        });
        zone.addEventListener('drop', (e) => {
            e.preventDefault();
            zone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) {
                igorProcessFile(e.dataTransfer.files[0]);
            }
        });
    }

    // Save pricing to localStorage
    function igorSavePricing() {
        try {
            localStorage.setItem('igor-pricing-data', JSON.stringify({
                prices: IgorPricing.prices,
                suppliers: IgorPricing.suppliers,
                customSuppliers: IgorPricing.customSuppliers
            }));
        } catch (e) {
            console.warn('Failed to save pricing data:', e);
        }
    }

    // Toggle pricing enabled
    function igorTogglePricing() {
        IgorPricing.enabled = document.getElementById('igorPricingEnabled').checked;
        document.getElementById('igorPricingBody').classList.toggle('active', IgorPricing.enabled);

        if (IgorPricing.enabled && IgorPricing.currentSupplier) {
            igorUpdatePriceStatus();
        }
    }

    // Supplier selection
    function igorSelectSupplier() {
        const select = document.getElementById('igorSupplierSelect');
        const value = select.value;

        if (value === '__upload__') {
            document.getElementById('igorPriceFileInput').click();
            select.value = '';
            return;
        }

        if (value && IgorPricing.prices[value]) {
            IgorPricing.currentSupplier = value;
            igorUpdatePriceStatus();
            document.getElementById('igorConsole').textContent = `üí∞ Loaded prices from ${IgorPricing.suppliers[value]?.name || value}`;
        } else if (value) {
            IgorPricing.currentSupplier = value;
            document.getElementById('igorPriceStatus').style.display = 'none';
            document.getElementById('igorConsole').textContent = `üí∞ Selected ${select.options[select.selectedIndex].text} - upload price list to enable pricing`;
        }
    }

    // Handle file upload
    function igorHandleFileUpload(event) {
        const file = event.target.files[0];
        if (file) {
            igorProcessFile(file);
        }
        event.target.value = ''; // Reset for next upload
    }

    // Process uploaded file
    async function igorProcessFile(file) {
        const console = document.getElementById('igorConsole');
        console.textContent = `üí∞ Processing ${file.name}...`;

        const ext = file.name.split('.').pop().toLowerCase();

        try {
            if (ext === 'pdf') {
                await igorParsePDF(file);
            } else if (ext === 'csv') {
                await igorParseCSV(file);
            } else if (ext === 'xlsx' || ext === 'xls') {
                await igorParseExcel(file);
            } else {
                throw new Error('Unsupported file type: ' + ext);
            }
        } catch (error) {
            console.textContent = `‚ùå Error: ${error.message}`;
            alert('Failed to process file: ' + error.message);
        }
    }

    // Parse CSV file
    async function igorParseCSV(file) {
        const text = await file.text();
        const rows = [];
        const lines = text.split(/\r?\n/);

        // Simple CSV parser (handles quoted fields)
        lines.forEach(line => {
            if (!line.trim()) return;
            const row = [];
            let inQuotes = false;
            let field = '';

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    row.push(field.trim());
                    field = '';
                } else {
                    field += char;
                }
            }
            row.push(field.trim());
            rows.push(row);
        });

        if (rows.length < 2) {
            throw new Error('File has no data rows');
        }

        IgorPricing.tempData = { headers: rows[0], rows: rows.slice(1) };
        IgorPricing.tempFileName = file.name;
        igorShowMappingModal();
    }

    // Parse Excel file
    async function igorParseExcel(file) {
        // Load SheetJS if not already loaded
        if (typeof XLSX === 'undefined') {
            await new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });

        // Use first sheet
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

        if (jsonData.length < 2) {
            throw new Error('Excel file has no data rows');
        }

        // Find header row (first row with multiple non-empty cells)
        let headerIndex = 0;
        for (let i = 0; i < Math.min(10, jsonData.length); i++) {
            const row = jsonData[i] || [];
            const nonEmpty = row.filter(c => c !== undefined && c !== '').length;
            if (nonEmpty >= 3) {
                headerIndex = i;
                break;
            }
        }

        const headers = (jsonData[headerIndex] || []).map(h => String(h || ''));
        const rows = jsonData.slice(headerIndex + 1).filter(row => {
            // Filter out empty rows
            return row && row.some(c => c !== undefined && c !== '');
        });

        if (rows.length === 0) {
            throw new Error('No data rows found after header');
        }

        IgorPricing.tempData = { headers, rows };
        IgorPricing.tempFileName = file.name;
        igorShowMappingModal();
    }

    // Parse PDF file
    async function igorParsePDF(file) {
        // Load PDF.js if not already loaded
        if (typeof pdfjsLib === 'undefined') {
            await new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
                script.onload = () => {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    resolve();
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

        const allText = [];

        // Extract text from all pages
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();

            // Get text items with positions
            const items = textContent.items.map(item => ({
                text: item.str,
                x: item.transform[4],
                y: item.transform[5]
            }));

            // Group by approximate Y position (same line)
            const lines = {};
            items.forEach(item => {
                const lineY = Math.round(item.y / 10) * 10; // Group within 10 units
                if (!lines[lineY]) lines[lineY] = [];
                lines[lineY].push(item);
            });

            // Sort lines by Y (descending - top to bottom) and items by X
            const sortedLines = Object.entries(lines)
                .sort((a, b) => parseFloat(b[0]) - parseFloat(a[0]))
                .map(([, items]) =>
                    items.sort((a, b) => a.x - b.x).map(i => i.text).join('\t')
                );

            allText.push(...sortedLines);
        }

        // Convert to rows
        const rows = allText.map(line => line.split('\t').map(s => s.trim()).filter(s => s));

        // Filter out rows that don't look like data (need at least 2 columns, one with numbers)
        const dataRows = rows.filter(row => {
            if (row.length < 2) return false;
            return row.some(cell => /\d/.test(cell)); // At least one cell with numbers
        });

        if (dataRows.length < 2) {
            throw new Error('Could not extract table data from PDF. Try exporting as Excel from the supplier portal.');
        }

        // Try to identify header row
        let headerIndex = 0;
        for (let i = 0; i < Math.min(5, dataRows.length); i++) {
            const row = dataRows[i];
            // Headers usually have words like "size", "price", "description"
            const isHeader = row.some(cell =>
                /size|price|description|section|mass|weight|grade|$/i.test(cell.toLowerCase())
            );
            if (isHeader) {
                headerIndex = i;
                break;
            }
        }

        const headers = dataRows[headerIndex].map(h => String(h || ''));
        const data = dataRows.slice(headerIndex + 1);

        IgorPricing.tempData = { headers, rows: data, isPDF: true };
        IgorPricing.tempFileName = file.name;
        igorShowMappingModal();
    }

    // Show column mapping modal
    function igorShowMappingModal() {
        const data = IgorPricing.tempData;
        if (!data) return;

        document.getElementById('igorMappingFileName').textContent = IgorPricing.tempFileName;
        document.getElementById('igorMappingRowCount').textContent = data.rows.length;

        // Populate column selectors
        const selects = ['igorMapSize', 'igorMapPrice', 'igorMapType', 'igorMapGrade'];
        selects.forEach(id => {
            const select = document.getElementById(id);
            const defaultOption = id === 'igorMapType' || id === 'igorMapGrade'
                ? '<option value="">Not specified</option>'
                : '<option value="">Auto-detect</option>';
            select.innerHTML = defaultOption;

            data.headers.forEach((header, idx) => {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.textContent = header || `Column ${idx + 1}`;
                select.appendChild(opt);
            });
        });

        // Auto-detect columns
        igorAutoDetectColumns(data.headers);

        // Build preview table
        const previewRows = data.rows.slice(0, 8);
        let tableHtml = '<table><thead><tr>';
        data.headers.forEach((h, i) => {
            tableHtml += `<th>Col ${i + 1}: ${escapeHtml(h || '-')}</th>`;
        });
        tableHtml += '</tr></thead><tbody>';

        previewRows.forEach(row => {
            tableHtml += '<tr>';
            data.headers.forEach((_, i) => {
                tableHtml += `<td>${row[i] !== undefined ? escapeHtml(row[i]) : ''}</td>`;
            });
            tableHtml += '</tr>';
        });
        tableHtml += '</tbody></table>';

        if (data.rows.length > 8) {
            tableHtml += `<p style="text-align:center;color:rgba(255,255,255,0.5);margin-top:10px;">... and ${data.rows.length - 8} more rows</p>`;
        }

        document.getElementById('igorMappingPreview').innerHTML = tableHtml;
        document.getElementById('igorMappingOverlay').classList.add('active');
    }

    // Auto-detect columns based on header names
    function igorAutoDetectColumns(headers) {
        const lowerHeaders = headers.map(h => (h || '').toLowerCase());

        // Size column - look for size, section, dimension, description
        const sizePatterns = ['size', 'section', 'dimension', 'description', 'product', 'item'];
        const sizeIdx = lowerHeaders.findIndex(h => sizePatterns.some(p => h.includes(p)));
        if (sizeIdx >= 0) document.getElementById('igorMapSize').value = sizeIdx;

        // Price column - look for price, $, cost, rate
        const pricePatterns = ['price', '$', 'cost', 'rate', '/m', '/t', 'per m', 'per t'];
        const priceIdx = lowerHeaders.findIndex(h => pricePatterns.some(p => h.includes(p)));
        if (priceIdx >= 0) document.getElementById('igorMapPrice').value = priceIdx;

        // Type column - look for type, category, member
        const typePatterns = ['type', 'category', 'member', 'group'];
        const typeIdx = lowerHeaders.findIndex(h => typePatterns.some(p => h.includes(p)));
        if (typeIdx >= 0) document.getElementById('igorMapType').value = typeIdx;

        // Grade column - look for grade, steel
        const gradePatterns = ['grade', 'steel', 'material'];
        const gradeIdx = lowerHeaders.findIndex(h => gradePatterns.some(p => h.includes(p)));
        if (gradeIdx >= 0) document.getElementById('igorMapGrade').value = gradeIdx;

        // Check if prices seem to be per tonne (large values)
        const priceCol = document.getElementById('igorMapPrice').value;
        if (priceCol !== '') {
            const samplePrices = IgorPricing.tempData.rows.slice(0, 10)
                .map(r => parseFloat(String(r[priceCol]).replace(/[^0-9.]/g, '')))
                .filter(p => !isNaN(p) && p > 0);

            if (samplePrices.length > 0) {
                const avgPrice = samplePrices.reduce((a, b) => a + b, 0) / samplePrices.length;
                document.getElementById('igorPricePerTonne').checked = avgPrice > 500;
            }
        }
    }

    // Close mapping modal
    function igorCloseMappingModal() {
        document.getElementById('igorMappingOverlay').classList.remove('active');
        IgorPricing.tempData = null;
        IgorPricing.tempFileName = null;
    }

    // Confirm column mapping and import prices
    function igorConfirmMapping() {
        const data = IgorPricing.tempData;
        if (!data) return;

        const sizeCol = document.getElementById('igorMapSize').value;
        const priceCol = document.getElementById('igorMapPrice').value;
        const typeCol = document.getElementById('igorMapType').value;
        const gradeCol = document.getElementById('igorMapGrade').value;
        const isPerTonne = document.getElementById('igorPricePerTonne').checked;

        // Validate required columns
        if (sizeCol === '' && priceCol === '') {
            alert('Please select at least the Size and Price columns');
            return;
        }

        // Get or create supplier
        let supplierId = document.getElementById('igorSupplierSelect').value;
        if (!supplierId || supplierId === '__upload__') {
            // Use filename as supplier name
            const name = IgorPricing.tempFileName.replace(/\.[^/.]+$/, '').replace(/[_-]/g, ' ');
            supplierId = 'custom_' + Date.now();

            IgorPricing.customSuppliers.push({ id: supplierId, name });

            const opt = document.createElement('option');
            opt.value = supplierId;
            opt.textContent = name + ' ‚≠ê';
            document.getElementById('igorSupplierGroup').appendChild(opt);
            document.getElementById('igorSupplierSelect').value = supplierId;
        }

        // Process rows
        const prices = {};
        let imported = 0;
        let skipped = 0;

        data.rows.forEach(row => {
            // Get size
            let size = sizeCol !== '' ? String(row[sizeCol] || '') : '';
            if (!size && sizeCol === '') {
                // Auto-detect: first column with pattern matching steel size
                for (let i = 0; i < row.length; i++) {
                    const val = String(row[i] || '');
                    if (/^\d{2,4}[xX√ó*]\d{2,4}/.test(val) || /^[A-Z]{2,3}\s?\d/.test(val)) {
                        size = val;
                        break;
                    }
                }
            }

            if (!size) {
                skipped++;
                return;
            }

            // Get price
            let priceStr = priceCol !== '' ? String(row[priceCol] || '') : '';
            if (!priceStr && priceCol === '') {
                // Auto-detect: first column with $ or numeric value
                for (let i = 0; i < row.length; i++) {
                    const val = String(row[i] || '');
                    if (/\$?\d+\.?\d*/.test(val)) {
                        priceStr = val;
                        break;
                    }
                }
            }

            const price = parseFloat(priceStr.replace(/[^0-9.]/g, ''));
            if (isNaN(price) || price <= 0) {
                skipped++;
                return;
            }

            // Normalize size for matching
            const normalizedSize = igorNormalizeSize(size);

            // Get type and grade if specified
            const type = typeCol !== '' ? String(row[typeCol] || '') : '';
            const grade = gradeCol !== '' ? String(row[gradeCol] || '') : '';

            prices[normalizedSize] = {
                originalSize: size,
                price: price,
                unit: isPerTonne ? 'tonne' : 'metre',
                type: type,
                grade: grade
            };
            imported++;
        });

        if (imported === 0) {
            alert('No valid price data found. Please check column mapping.');
            return;
        }

        // Save prices
        IgorPricing.prices[supplierId] = prices;
        IgorPricing.suppliers[supplierId] = {
            name: document.getElementById('igorSupplierSelect').options[
                document.getElementById('igorSupplierSelect').selectedIndex
            ].textContent.replace(' ‚≠ê', ''),
            lastUpdated: new Date().toISOString(),
            priceCount: imported,
            mapping: { sizeCol, priceCol, typeCol, gradeCol, isPerTonne }
        };

        IgorPricing.currentSupplier = supplierId;
        igorSavePricing();
        igorCloseMappingModal();
        igorUpdatePriceStatus();

        document.getElementById('igorConsole').textContent =
            `üí∞ Imported ${imported} prices from ${IgorPricing.tempFileName}${skipped > 0 ? ` (${skipped} rows skipped)` : ''}`;
    }

    // Normalize size string for matching
    function igorNormalizeSize(size) {
        if (!size) return '';

        return String(size)
            .toUpperCase()
            .replace(/\s+/g, '')           // Remove spaces
            .replace(/[√ó*]/g, 'X')         // Normalize multiplication signs
            .replace(/X0+(\d)/g, 'X$1')    // Remove leading zeros after X
            .replace(/^0+(\d)/g, '$1')     // Remove leading zeros at start
            .replace(/\.0+$/g, '')         // Remove trailing .0
            .replace(/(\d)\.0+X/g, '$1X')  // Remove .0 before X
            .replace(/MM$/i, '')           // Remove MM suffix
            .replace(/SHS|RHS|CHS|EA|UA|FB|RB|SB|UB|WB|UC|WC|PFC|TFB/gi, '') // Remove type prefixes
            .trim();
    }

    // Match BOM size to price list
    function igorMatchPrice(type, section) {
        if (!IgorPricing.enabled || !IgorPricing.currentSupplier) return null;

        const prices = IgorPricing.prices[IgorPricing.currentSupplier];
        if (!prices) return null;

        // Try exact match first
        const normalizedSection = igorNormalizeSize(section);
        if (prices[normalizedSection]) {
            return prices[normalizedSection];
        }

        // Try with type prefix
        const withType = igorNormalizeSize(type + section);
        if (prices[withType]) {
            return prices[withType];
        }

        // Try fuzzy matching
        const sectionParts = normalizedSection.match(/(\d+)X(\d+)(?:X(\d+(?:\.\d+)?))?/);
        if (sectionParts) {
            for (const [key, value] of Object.entries(prices)) {
                const keyParts = key.match(/(\d+)X(\d+)(?:X(\d+(?:\.\d+)?))?/);
                if (keyParts) {
                    // Match dimensions (allow small variations)
                    const d1Match = Math.abs(parseFloat(sectionParts[1]) - parseFloat(keyParts[1])) <= 1;
                    const d2Match = Math.abs(parseFloat(sectionParts[2]) - parseFloat(keyParts[2])) <= 1;
                    const d3Match = !sectionParts[3] || !keyParts[3] ||
                        Math.abs(parseFloat(sectionParts[3]) - parseFloat(keyParts[3])) <= 0.5;

                    if (d1Match && d2Match && d3Match) {
                        return value;
                    }
                }
            }
        }

        return null;
    }

    // Get price per metre for a section
    function igorGetPricePerMetre(type, section, massPerM) {
        const priceInfo = igorMatchPrice(type, section);
        if (!priceInfo) return null;

        let pricePerMetre = priceInfo.price;

        // Convert from $/tonne to $/metre if needed
        if (priceInfo.unit === 'tonne' && massPerM) {
            pricePerMetre = priceInfo.price * (massPerM / 1000);
        }

        return pricePerMetre;
    }

    // Update price status display
    function igorUpdatePriceStatus() {
        const status = document.getElementById('igorPriceStatus');
        const supplier = IgorPricing.suppliers[IgorPricing.currentSupplier];

        if (!supplier) {
            status.style.display = 'none';
            return;
        }

        status.style.display = 'flex';

        const prices = IgorPricing.prices[IgorPricing.currentSupplier] || {};
        const priceCount = Object.keys(prices).length;
        const lastUpdated = supplier.lastUpdated ? new Date(supplier.lastUpdated).toLocaleDateString() : 'Unknown';

        document.getElementById('igorStatusText').innerHTML =
            `<strong>${escapeHtml(supplier.name)}</strong> ‚Ä¢ ${escapeHtml(priceCount)} prices ‚Ä¢ Updated: ${escapeHtml(lastUpdated)}`;
        document.getElementById('igorStatusDot').className = 'status-dot' + (priceCount > 0 ? '' : ' error');

        // Check for missing prices in current BOM
        igorCheckMissingPrices();
    }

    // Check for missing prices
    function igorCheckMissingPrices() {
        if (!IgorPricing.enabled || igorMembers.length === 0) {
            document.getElementById('igorMissingAlert').style.display = 'none';
            return;
        }

        const missing = [];
        igorMembers.forEach(m => {
            const price = igorMatchPrice(m.type, m.section);
            if (!price) {
                const key = `${m.section} ${m.type}`;
                if (!missing.includes(key)) missing.push(key);
            }
        });

        const alert = document.getElementById('igorMissingAlert');
        if (missing.length > 0) {
            document.getElementById('igorMissingList').innerHTML =
                missing.slice(0, 5).map(s => `<li>${escapeHtml(s)}</li>`).join('') +
                (missing.length > 5 ? `<li>... and ${missing.length - 5} more</li>` : '');
            alert.style.display = 'block';
        } else {
            alert.style.display = 'none';
        }
    }

    // Show price list
    function igorShowPriceList() {
        const overlay = document.getElementById('igorPriceListOverlay');
        const supplier = IgorPricing.suppliers[IgorPricing.currentSupplier];

        document.getElementById('igorPriceListSupplier').textContent = supplier?.name || 'Unknown';
        igorRenderPriceList();
        overlay.classList.add('active');
    }

    // Render price list table
    function igorRenderPriceList(filter = '') {
        const prices = IgorPricing.prices[IgorPricing.currentSupplier] || {};
        const entries = Object.entries(prices).filter(([key, val]) => {
            if (!filter) return true;
            const search = filter.toLowerCase();
            return key.toLowerCase().includes(search) ||
                   (val.originalSize || '').toLowerCase().includes(search);
        });

        if (entries.length === 0) {
            document.getElementById('igorPriceListTable').innerHTML =
                '<p style="color: rgba(255,255,255,0.5); text-align: center;">No prices found</p>';
            return;
        }

        let html = '<table><thead><tr><th>Size</th><th>Price</th><th>Unit</th><th>Type</th><th>Grade</th></tr></thead><tbody>';
        entries.slice(0, 100).forEach(([key, val]) => {
            html += `<tr>
                <td>${escapeHtml(val.originalSize || key)}</td>
                <td>$${escapeHtml(val.price.toFixed(2))}</td>
                <td>/${val.unit === 'tonne' ? 't' : 'm'}</td>
                <td>${escapeHtml(val.type || '-')}</td>
                <td>${escapeHtml(val.grade || '-')}</td>
            </tr>`;
        });
        html += '</tbody></table>';

        if (entries.length > 100) {
            html += `<p style="text-align:center;color:rgba(255,255,255,0.5);margin-top:10px;">Showing 100 of ${escapeHtml(entries.length)} items. Use filter to find specific sizes.</p>`;
        }

        document.getElementById('igorPriceListTable').innerHTML = html;
    }

    // Filter price list
    function igorFilterPriceList() {
        const filter = document.getElementById('igorPriceFilterInput').value;
        igorRenderPriceList(filter);
    }

    // Clear all prices
    function igorClearPrices() {
        if (!confirm('Clear all loaded prices for current supplier?')) return;

        if (IgorPricing.currentSupplier) {
            delete IgorPricing.prices[IgorPricing.currentSupplier];
            delete IgorPricing.suppliers[IgorPricing.currentSupplier];
            igorSavePricing();
        }

        document.getElementById('igorSupplierSelect').value = '';
        document.getElementById('igorPriceStatus').style.display = 'none';
        document.getElementById('igorMissingAlert').style.display = 'none';
        document.getElementById('igorConsole').textContent = 'üí∞ Prices cleared';
    }

    // Reload prices from saved
    function igorReloadPrices() {
        igorInitPricing();
        if (IgorPricing.currentSupplier) {
            document.getElementById('igorSupplierSelect').value = IgorPricing.currentSupplier;
            igorUpdatePriceStatus();
        }
        document.getElementById('igorConsole').textContent = 'üí∞ Prices reloaded from storage';
    }

    // Show add supplier modal
    function igorShowAddSupplier() {
        document.getElementById('igorAddSupplierModal').classList.add('active');
        document.getElementById('igorNewSupplierName').focus();
    }

    // Close add supplier modal
    function igorCloseAddSupplierModal() {
        document.getElementById('igorAddSupplierModal').classList.remove('active');
        document.getElementById('igorNewSupplierName').value = '';
    }

    // Add new supplier
    function igorAddSupplier() {
        const name = document.getElementById('igorNewSupplierName').value.trim();
        if (!name) {
            alert('Please enter a supplier name');
            return;
        }

        const id = 'custom_' + Date.now();
        IgorPricing.customSuppliers.push({ id, name });

        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = name + ' ‚≠ê';
        document.getElementById('igorSupplierGroup').appendChild(opt);
        document.getElementById('igorSupplierSelect').value = id;

        igorSavePricing();
        igorCloseAddSupplierModal();

        document.getElementById('igorConsole').textContent = `üí∞ Added supplier: ${name}. Now upload their price list.`;
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', igorInitPricing);

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CHUCK FUNCTIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let chuckType = 'HY200R', chuckSize = 'M16';
    let chuckLat = null, chuckLon = null, chuckCurrentTemp = null;

    function chuckGetLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    chuckLat = position.coords.latitude;
                    chuckLon = position.coords.longitude;
                    chuckGetWeather();
                },
                (error) => {
                    console.log('Location error:', error);
                    document.getElementById('chuckLocation').textContent = 'üìç Location unavailable';
                    chuckLat = -33.87; // Sydney default
                    chuckLon = 151.21;
                    chuckGetWeather();
                }
            );
        }
    }

    async function chuckGetWeather() {
        if (!chuckLat || !chuckLon) return;

        try {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${chuckLat}&longitude=${chuckLon}&current=temperature_2m,relative_humidity_2m&timezone=auto`;
            const res = await fetch(url);
            const data = await res.json();

            if (data.current) {
                chuckCurrentTemp = Math.round(data.current.temperature_2m);
                document.getElementById('chuckCurrentTemp').textContent = chuckCurrentTemp;

                // Try to get location name
                try {
                    const geoUrl = `https://nominatim.openstreetmap.org/reverse?lat=${chuckLat}&lon=${chuckLon}&format=json`;
                    const geoRes = await fetch(geoUrl);
                    const geoData = await geoRes.json();
                    const suburb = geoData.address?.suburb || geoData.address?.city || geoData.address?.town || 'Your location';
                    document.getElementById('chuckLocation').textContent = `üìç ${suburb}`;
                } catch (e) {
                    document.getElementById('chuckLocation').textContent = 'üìç Your location';
                }

                // Update cure times display
                chuckUpdateCureTimes();
            }
        } catch (err) {
            console.log('Weather error:', err);
            document.getElementById('chuckCurrentTemp').textContent = '20';
            chuckCurrentTemp = 20;
        }
    }

    function getCureTimeLocal(product, temp) {
        const data = CURE_TIME_DATA[product] || CURE_TIME_DATA['HY200R'];
        for (const entry of data) {
            if (temp >= entry.min && temp <= entry.max) {
                return { work: formatCureTime(entry.work), cure: formatCureTime(entry.cure), cureMin: entry.cure };
            }
        }
        return { work: '15 min', cure: '1h', cureMin: 60 };
    }

    function formatCureTime(mins) {
        mins = Math.round(mins);
        if (mins < 60) return `${mins} min`;
        if (mins < 1440) {
            const h = mins / 60;
            return h === Math.floor(h) ? `${h}h` : `${h.toFixed(1)}h`;
        }
        return `${(mins/1440).toFixed(1)} days`;
    }

    function chuckUpdateCureTimes() {
        const temp = chuckCurrentTemp || 20;
        const cureData = getCureTimeLocal(chuckType, temp);

        document.getElementById('chuckCureTemp').textContent = temp;
        document.getElementById('cureWorkStd').textContent = `Work: ${cureData.work}`;
        document.getElementById('cureCureStd').textContent = cureData.cure;

        document.getElementById('cureWorkCoast').textContent = `Work: ${cureData.work}`;
        document.getElementById('cureCureCoast').textContent = formatCureTime(cureData.cureMin * 1.5);

        const shadeCure = getCureTimeLocal(chuckType, temp - 5);
        document.getElementById('cureWorkShade').textContent = `Work: ${shadeCure.work}`;
        document.getElementById('cureCureShade').textContent = shadeCure.cure;

        document.getElementById('chuckCureSection').style.display = 'block';
    }

    function chuckSetType(type, btn) {
        chuckType = type;
        document.querySelectorAll('#chuckTypeButtons .btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        chuckUpdateSizes();
        chuckCalculate();
    }

    function chuckUpdateSizes() {
        const sizes = Object.keys(HILTI_DATA[chuckType].sizes);
        const container = document.getElementById('chuckSizeButtons');
        container.innerHTML = sizes.map(s =>
            `<button class="btn${s === chuckSize ? ' active' : ''}" onclick="chuckSetSize('${escapeHtml(s)}', this)">${escapeHtml(s)}</button>`
        ).join('');
        if (!sizes.includes(chuckSize)) {
            chuckSize = sizes[Math.floor(sizes.length/2)];
        }
    }

    function chuckSetSize(size, btn) {
        chuckSize = size;
        document.querySelectorAll('#chuckSizeButtons .btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const sizeData = HILTI_DATA[chuckType].sizes[size];
        if (sizeData) document.getElementById('chuckDepth').value = sizeData.embed;
        chuckCalculate();
    }

    function chuckCalculate() {
        const depth = parseFloat(document.getElementById('chuckDepth').value) || 0;
        const qty = parseInt(document.getElementById('chuckQty').value) || 1;
        const chemical = HILTI_DATA[chuckType];
        const sizeData = chemical.sizes[chuckSize];

        if (!sizeData) return;

        const holeVol = Math.PI * Math.pow(sizeData.hole/2, 2) * depth / 1000;
        const totalVol = holeVol * qty * 1.15;

        // Calculate cartridge options
        const cart330 = Math.ceil(totalVol / 330);
        const cart500 = Math.ceil(totalVol / 500);
        const cart1400 = Math.ceil(totalVol / 1400);

        document.getElementById('chuckResults').innerHTML = `
            <div class="result-card"><div class="label">Hole Size</div><div class="value">${escapeHtml(sizeData.hole)}<span class="unit">mm</span></div></div>
            <div class="result-card"><div class="label">Min Embed</div><div class="value">${escapeHtml(sizeData.embed)}<span class="unit">mm</span></div></div>
            <div class="result-card"><div class="label">Vol/Hole</div><div class="value">${escapeHtml(holeVol.toFixed(1))}<span class="unit">ml</span></div></div>
            <div class="result-card"><div class="label">Total Vol</div><div class="value">${escapeHtml(totalVol.toFixed(0))}<span class="unit">ml</span></div></div>
            <div class="result-card"><div class="label">Cartridges</div><div class="value" style="color:#22c55e">${escapeHtml(cart330)}</div></div>
            <div class="result-card"><div class="label">Product</div><div class="value" style="font-size:0.9rem">${escapeHtml(chemical.name)}</div></div>
        `;

        // Show cartridge options
        document.getElementById('chuckCart330').textContent = cart330;
        document.getElementById('chuckCart500').textContent = cart500;
        document.getElementById('chuckCart1400').textContent = cart1400;
        document.getElementById('chuckCartOptions').style.display = 'flex';

        // Update cure times if temp available
        if (chuckCurrentTemp) {
            chuckUpdateCureTimes();
        }

        document.getElementById('chuckConsole').textContent = `üß™ ${chemical.name} ${chuckSize}: ${qty} holes √ó ${depth}mm = ${cart330} √ó 330ml cartridge${cart330>1?'s':''}`;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // BRITTANY FUNCTIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let brittanyType = 'dynabolt', brittanySize = 'M12';
    let brittanyTotalTension = 0, brittanyTotalShear = 0;

    function brittanySetType(type, btn) {
        brittanyType = type;
        document.querySelectorAll('#brittanyTypeButtons .btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        brittanyUpdateSizes();
        brittanyCalculate();
    }

    function brittanySetSize(size, btn) {
        brittanySize = size;
        document.querySelectorAll('#brittanySizeButtons .btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        brittanyCalculate();
    }

    function brittanyUpdateSizes() {
        const data = FIXING_DATA[brittanyType];
        const availableSizes = Object.keys(data.sizes);
        const container = document.getElementById('brittanySizeButtons');

        container.innerHTML = availableSizes.map(s =>
            `<button class="btn${s === brittanySize ? ' active' : ''}" onclick="brittanySetSize('${escapeHtml(s)}', this)">${escapeHtml(s)}</button>`
        ).join('');

        if (!availableSizes.includes(brittanySize)) {
            brittanySize = availableSizes[0];
        }

        // Update min values display
        if (data.sizes[brittanySize]) {
            const [t, s, embed, edge, spacing, hole] = data.sizes[brittanySize];
            document.getElementById('brittanyEmbedMin').textContent = `min: ${embed}`;
            document.getElementById('brittanyEdgeMin').textContent = `min: ${edge}`;
            document.getElementById('brittanySpacingMin').textContent = `min: ${spacing}`;
        }
    }

    function brittanyCalculate() {
        const qty = parseInt(document.getElementById('brittanyQty').value) || 1;
        const concrete = parseInt(document.getElementById('brittanyConcrete').value);
        const overhead = document.getElementById('brittanyOverhead').checked;
        const fixing = FIXING_DATA[brittanyType];
        const sizeData = fixing.sizes[brittanySize];

        if (!sizeData) return;

        const [tensionKn, shearKn, minEmbed, minEdge, minSpacing, holeSize] = sizeData;

        // Get custom params or use minimums
        const embedInput = document.getElementById('brittanyEmbed').value;
        const edgeInput = document.getElementById('brittanyEdge').value;
        const spacingInput = document.getElementById('brittanySpacing').value;

        const embed = embedInput ? parseInt(embedInput) : minEmbed;
        const edge = edgeInput ? parseInt(edgeInput) : minEdge;
        const spacing = spacingInput ? parseInt(spacingInput) : minSpacing;

        // Update min displays
        document.getElementById('brittanyEmbedMin').textContent = `min: ${minEmbed}`;
        document.getElementById('brittanyEdgeMin').textContent = `min: ${minEdge}`;
        document.getElementById('brittanySpacingMin').textContent = `min: ${minSpacing}`;

        // Calculate reduction factors
        const edgeFactor = edge < minEdge ? Math.max(0.5, edge / minEdge) : 1.0;
        const spacingFactor = spacing < minSpacing ? Math.max(0.5, spacing / minSpacing) : 1.0;
        let embedFactor = 1.0;
        if (brittanyType === 'chemset') {
            embedFactor = Math.min(2.0, Math.max(0.5, embed / minEmbed));
        } else if (embed < minEmbed) {
            embedFactor = Math.max(0.5, embed / minEmbed);
        }

        // Substrate factor - calculate based on MPa value relative to 32MPa baseline
        // Formula: sqrt(actual MPa / 32) gives reasonable scaling
        const concFactor = Math.sqrt(concrete / 32);

        // Get substrate name for display
        const substrateSelect = document.getElementById('brittanyConcrete');
        const substrateName = substrateSelect.options[substrateSelect.selectedIndex].text;
        const isWeakSubstrate = concrete < 10;
        const isMasonry = concrete <= 15 && !substrateName.includes('Concrete');

        // Overhead/cracked factor (50% reduction as shown in checkbox label)
        const overheadFactor = overhead ? 0.5 : 1.0;

        // Calculate
        let tensionPerKg = Math.round(tensionKn * concFactor * overheadFactor * edgeFactor * embedFactor * 102);
        let shearPerKg = Math.round(shearKn * concFactor * overheadFactor * edgeFactor * spacingFactor * 102);

        // Additional reduction for masonry - mechanical anchors less reliable
        if (isMasonry && (brittanyType === 'dynabolt' || brittanyType === 'trubolt' || brittanyType === 'hilti_hsl' || brittanyType === 'dropin')) {
            tensionPerKg = Math.round(tensionPerKg * 0.5);
            shearPerKg = Math.round(shearPerKg * 0.5);
        }

        brittanyTotalTension = tensionPerKg * qty;
        brittanyTotalShear = shearPerKg * qty;

        // Substrate warning for display
        let substrateWarning = '';
        if (isWeakSubstrate) {
            substrateWarning = '<div style="background:#ef4444;color:white;padding:8px;border-radius:6px;margin-bottom:10px;font-weight:bold">‚ö†Ô∏è WEAK SUBSTRATE - Consider chemical anchors only!</div>';
        } else if (isMasonry) {
            substrateWarning = '<div style="background:#f59e0b;color:white;padding:8px;border-radius:6px;margin-bottom:10px">‚ö†Ô∏è MASONRY - Use chemical anchors for best results</div>';
        }

        document.getElementById('brittanyResults').innerHTML = `
            ${substrateWarning}
            <div class="result-card"><div class="label">Tension (each)</div><div class="value">${escapeHtml(tensionPerKg)}<span class="unit">kg</span></div></div>
            <div class="result-card"><div class="label">Shear (each)</div><div class="value">${escapeHtml(shearPerKg)}<span class="unit">kg</span></div></div>
            <div class="result-card"><div class="label">Total Tension</div><div class="value" style="color:#22c55e">${escapeHtml(brittanyTotalTension.toLocaleString())}<span class="unit">kg</span></div></div>
            <div class="result-card"><div class="label">Total Shear</div><div class="value" style="color:#22c55e">${escapeHtml(brittanyTotalShear.toLocaleString())}<span class="unit">kg</span></div></div>
            <div class="result-card"><div class="label">Hole Size</div><div class="value">${escapeHtml(holeSize)}<span class="unit">mm</span></div></div>
            <div class="result-card"><div class="label">Substrate</div><div class="value" style="font-size:0.8rem">${escapeHtml(substrateName)}</div></div>
        `;

        // Show warnings for reduced factors
        let warnings = [];
        if (edgeFactor < 1.0) warnings.push(`Edge: ${Math.round(edgeFactor*100)}%`);
        if (spacingFactor < 1.0) warnings.push(`Spacing: ${Math.round(spacingFactor*100)}%`);
        if (embedFactor !== 1.0 && brittanyType === 'chemset') warnings.push(`Embed: ${Math.round(embedFactor*100)}%`);
        if (isMasonry && brittanyType !== 'chemset') warnings.push('Masonry: 50%');

        let consoleMsg = `üí™ ${qty}√ó ${fixing.name} ${brittanySize}: Holds ${brittanyTotalTension.toLocaleString()}kg tension, ${brittanyTotalShear.toLocaleString()}kg shear`;
        if (warnings.length > 0) consoleMsg += ` (Reduced: ${warnings.join(', ')})`;
        document.getElementById('brittanyConsole').textContent = consoleMsg;

        // Update load check if there's a value
        brittanyCheckLoad();
    }

    function brittanyCheckLoad() {
        const loadInput = document.getElementById('brittanyLoad').value;
        const loadType = document.getElementById('brittanyLoadType').value;
        const resultDiv = document.getElementById('brittanyLoadResult');
        const utilDisplay = document.getElementById('brittanyUtilDisplay');

        if (!loadInput) {
            resultDiv.style.display = 'none';
            utilDisplay.style.display = 'none';
            return;
        }

        const load = parseInt(loadInput);
        const capacity = loadType === 'tension' ? brittanyTotalTension : brittanyTotalShear;
        const utilisation = load / capacity;
        const percent = Math.min(utilisation * 100, 150);

        resultDiv.style.display = 'block';
        utilDisplay.style.display = 'block';

        const fill = document.getElementById('brittanyLoadFill');
        const status = document.getElementById('brittanyLoadStatus');
        const utilPercent = document.getElementById('brittanyUtilPercent');
        const utilStatus = document.getElementById('brittanyUtilStatus');
        const safetyFactor = document.getElementById('brittanySafetyFactor');

        fill.style.width = `${Math.min(percent, 100)}%`;
        utilPercent.textContent = `${Math.round(utilisation * 100)}%`;

        const sf = 1 / utilisation;
        safetyFactor.textContent = `Safety Factor: ${sf.toFixed(1)}√ó`;

        if (utilisation <= 0.8) {
            fill.style.background = '#22c55e';
            status.textContent = `‚úÖ OK - ${Math.round(utilisation * 100)}% utilised`;
            status.style.color = '#22c55e';
            utilPercent.className = 'utilisation-big ok';
            utilStatus.textContent = '‚úÖ YES - SAFE TO USE';
            utilStatus.style.color = '#22c55e';
        } else if (utilisation <= 1.0) {
            fill.style.background = '#f59e0b';
            status.textContent = `‚ö†Ô∏è OK - ${Math.round(utilisation * 100)}% utilised (close to limit)`;
            status.style.color = '#f59e0b';
            utilPercent.className = 'utilisation-big warning';
            utilStatus.textContent = '‚ö†Ô∏è MARGINAL - Consider larger size';
            utilStatus.style.color = '#f59e0b';
        } else {
            fill.style.background = '#ef4444';
            status.textContent = `‚ùå FAIL - ${Math.round(utilisation * 100)}% (exceeds capacity!)`;
            status.style.color = '#ef4444';
            utilPercent.className = 'utilisation-big fail';
            utilStatus.textContent = '‚ùå NO - WILL FAIL!';
            utilStatus.style.color = '#ef4444';
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CHUCK TIMER FUNCTIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let chuckTimerInterval = null;
    let chuckTimerEndTime = null;
    let chuckCureMinutes = 60;

    function chuckStartTimer() {
        // Get current cure time
        const temp = chuckCurrentTemp || 20;
        const cureData = getCureTimeLocal(chuckType, temp);
        chuckCureMinutes = cureData.cureMin || 60;

        // Calculate end time
        const now = new Date();
        chuckTimerEndTime = new Date(now.getTime() + chuckCureMinutes * 60 * 1000);

        // Update UI
        document.getElementById('chuckTimerStart').style.display = 'none';
        document.getElementById('chuckTimerStop').style.display = 'inline-block';
        document.getElementById('chuckTimerProgress').style.display = 'block';
        document.getElementById('chuckTimerSection').classList.add('curing');

        // Show ready time
        const readyTime = chuckTimerEndTime.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });
        document.getElementById('chuckReadyAt').textContent = `üéØ Ready at: ${readyTime}`;

        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Start countdown
        chuckTimerInterval = setInterval(chuckUpdateTimer, 1000);
        chuckUpdateTimer();

        document.getElementById('chuckConsole').textContent = `‚è±Ô∏è Timer started - Curing ${HILTI_DATA[chuckType].name} at ${temp}¬∞C`;
    }

    function chuckStopTimer() {
        if (chuckTimerInterval) {
            clearInterval(chuckTimerInterval);
            chuckTimerInterval = null;
        }

        document.getElementById('chuckTimerStart').style.display = 'inline-block';
        document.getElementById('chuckTimerStop').style.display = 'none';
        document.getElementById('chuckTimerProgress').style.display = 'none';
        document.getElementById('chuckTimerSection').classList.remove('curing');
        document.getElementById('chuckTimerDisplay').textContent = '--:--:--';
        document.getElementById('chuckReadyAt').textContent = 'Set anchors and start timer';
        document.getElementById('chuckTimerFill').style.width = '0%';

        document.getElementById('chuckConsole').textContent = 'üß™ Timer stopped';
    }

    function chuckUpdateTimer() {
        const now = new Date();
        const remaining = chuckTimerEndTime - now;

        if (remaining <= 0) {
            // Timer complete!
            clearInterval(chuckTimerInterval);
            chuckTimerInterval = null;

            document.getElementById('chuckTimerDisplay').textContent = '‚úÖ READY!';
            document.getElementById('chuckTimerDisplay').style.color = '#22c55e';
            document.getElementById('chuckReadyAt').textContent = 'üéâ Anchors fully cured!';
            document.getElementById('chuckTimerFill').style.width = '100%';
            document.getElementById('chuckTimerFill').style.background = '#22c55e';
            document.getElementById('chuckTimerSection').classList.remove('curing');
            document.getElementById('chuckTimerSection').style.borderColor = '#22c55e';

            // Send notification
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('‚ö° CHUCK says: Anchors Ready!', {
                    body: `${HILTI_DATA[chuckType].name} cure complete. Safe to load!`,
                    icon: 'üî©',
                    requireInteraction: true
                });
            }

            // Play sound alert (simple beep)
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                oscillator.start();
                setTimeout(() => { oscillator.stop(); audioCtx.close(); }, 300);
            } catch(e) {}

            document.getElementById('chuckConsole').textContent = '‚úÖ CURE COMPLETE! Anchors ready to load!';
            return;
        }

        // Calculate time remaining
        const hours = Math.floor(remaining / 3600000);
        const mins = Math.floor((remaining % 3600000) / 60000);
        const secs = Math.floor((remaining % 60000) / 1000);

        document.getElementById('chuckTimerDisplay').textContent =
            `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        document.getElementById('chuckTimerDisplay').style.color = '#f59e0b';

        // Update progress bar
        const totalMs = chuckCureMinutes * 60 * 1000;
        const elapsed = totalMs - remaining;
        const progress = (elapsed / totalMs) * 100;
        document.getElementById('chuckTimerFill').style.width = `${progress}%`;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // BRITTANY REPORT GENERATOR - Professional Engineering Report
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function brittanyGenerateReport() {
        const qty = parseInt(document.getElementById('brittanyQty').value) || 1;
        const concrete = parseInt(document.getElementById('brittanyConcrete').value);
        const substrateSelect = document.getElementById('brittanyConcrete');
        const substrateName = substrateSelect.options[substrateSelect.selectedIndex].text;
        const overhead = document.getElementById('brittanyOverhead').checked;
        const embedInput = document.getElementById('brittanyEmbed').value;
        const edgeInput = document.getElementById('brittanyEdge').value;
        const spacingInput = document.getElementById('brittanySpacing').value;
        const load = document.getElementById('brittanyLoad').value;
        const loadType = document.getElementById('brittanyLoadType').value;

        const fixing = FIXING_DATA[brittanyType];
        const sizeData = fixing.sizes[brittanySize];
        if (!sizeData) return;

        const [tensionKn, shearKn, minEmbed, minEdge, minSpacing, holeSize] = sizeData;
        const embed = embedInput ? parseInt(embedInput) : minEmbed;
        const edge = edgeInput ? parseInt(edgeInput) : minEdge;
        const spacing = spacingInput ? parseInt(spacingInput) : minSpacing;

        // Calculate all reduction factors for display
        const edgeFactor = edge < minEdge ? Math.max(0.5, edge / minEdge) : 1.0;
        const spacingFactor = spacing < minSpacing ? Math.max(0.5, spacing / minSpacing) : 1.0;
        let embedFactor = 1.0;
        if (brittanyType === 'chemset') {
            embedFactor = Math.min(2.0, Math.max(0.5, embed / minEmbed));
        } else if (embed < minEmbed) {
            embedFactor = Math.max(0.5, embed / minEmbed);
        }
        const concFactor = Math.sqrt(concrete / 32);
        const overheadFactor = overhead ? 0.5 : 1.0;
        const isMasonry = concrete <= 15 && !substrateName.includes('Concrete');
        const masonryFactor = (isMasonry && brittanyType !== 'chemset') ? 0.5 : 1.0;

        // Calculate per anchor values
        const tensionPerKg = Math.round(tensionKn * concFactor * overheadFactor * edgeFactor * embedFactor * masonryFactor * 102);
        const shearPerKg = Math.round(shearKn * concFactor * overheadFactor * edgeFactor * spacingFactor * masonryFactor * 102);

        const date = new Date();
        const dateStr = date.toLocaleDateString('en-AU', { year: 'numeric', month: 'long', day: 'numeric' });
        const timeStr = date.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });
        const refNo = `JMS-${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}-${Math.random().toString(36).substr(2,6).toUpperCase()}`;

        let loadCheckHTML = '';
        let loadCheckCalcs = '';
        if (load) {
            const loadVal = parseInt(load);
            const capacity = loadType === 'tension' ? brittanyTotalTension : brittanyTotalShear;
            const util = (loadVal / capacity) * 100;
            const sf = capacity / loadVal;
            const passClass = util > 100 ? 'fail' : util > 80 ? 'warning' : 'pass';
            const passText = util > 100 ? 'FAILS' : 'PASSES';

            loadCheckHTML = `
            <div class="section">
                <h2>5. LOAD VERIFICATION</h2>
                <table>
                    <tr><th width="40%">Applied Load (P<sub>d</sub>)</th><td>${loadVal.toLocaleString()} kg (${loadType})</td></tr>
                    <tr><th>Design Capacity (œÜN<sub>Rd</sub>)</th><td>${capacity.toLocaleString()} kg</td></tr>
                    <tr><th>Utilisation Ratio</th><td class="${passClass}">${util.toFixed(1)}%</td></tr>
                    <tr><th>Safety Factor</th><td class="${passClass}">${sf.toFixed(2)}</td></tr>
                </table>
                <div class="result-box ${passClass}">
                    <strong>RESULT: ${passText}</strong><br>
                    ${util > 100 ? 'Applied load exceeds design capacity. Increase anchor size, quantity, or embedment.' :
                      util > 80 ? 'Utilisation within acceptable limits but close to capacity. Consider design margin.' :
                      'Applied load is within design capacity with adequate safety margin.'}
                </div>
            </div>`;

            loadCheckCalcs = `
                <tr><td>Load Check</td><td>P<sub>d</sub> ‚â§ œÜN<sub>Rd</sub></td><td>${loadVal.toLocaleString()} ‚â§ ${capacity.toLocaleString()}</td><td class="${passClass}">${passText}</td></tr>`;
        }

        const reportHTML = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Anchor Design Report - Ref: ${refNo}</title>
    <style>
        @page { size: A4; margin: 20mm; }
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            font-size: 11pt;
            line-height: 1.4;
            color: #1a1a1a;
            max-width: 210mm;
            margin: 0 auto;
            padding: 15mm;
            background: #fff;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 3px solid #1e40af;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .header-left h1 {
            margin: 0;
            font-size: 18pt;
            color: #1e40af;
            font-weight: 700;
        }
        .header-left p { margin: 5px 0 0 0; color: #666; font-size: 10pt; }
        .header-right { text-align: right; font-size: 9pt; color: #666; }
        .ref-number { font-size: 11pt; font-weight: bold; color: #1e40af; }

        /* Company Logo Area */
        .logo-area {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            margin-bottom: 5px;
            font-weight: bold;
        }

        /* Sections */
        .section { margin-bottom: 20px; page-break-inside: avoid; }
        .section h2 {
            font-size: 12pt;
            color: #1e40af;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 5px;
            margin: 0 0 10px 0;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 10pt;
        }
        th, td {
            padding: 8px 10px;
            text-align: left;
            border: 1px solid #d1d5db;
            vertical-align: top;
        }
        th {
            background: #f3f4f6;
            font-weight: 600;
            color: #374151;
        }

        /* Capacity highlight */
        .capacity-value {
            font-size: 14pt;
            font-weight: bold;
            color: #059669;
        }
        .capacity-table td:last-child {
            text-align: center;
            font-weight: bold;
        }

        /* Status colors */
        .pass { color: #059669; }
        .warning { color: #d97706; }
        .fail { color: #dc2626; }

        /* Result box */
        .result-box {
            padding: 12px 15px;
            border-radius: 5px;
            margin-top: 10px;
            border-left: 4px solid;
        }
        .result-box.pass { background: #ecfdf5; border-color: #059669; }
        .result-box.warning { background: #fffbeb; border-color: #d97706; }
        .result-box.fail { background: #fef2f2; border-color: #dc2626; }

        /* Calculation box */
        .calc-box {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            padding: 12px;
            margin: 10px 0;
            font-family: 'Consolas', monospace;
            font-size: 9pt;
        }
        .calc-box .formula { color: #1e40af; font-weight: bold; }
        .calc-box .value { color: #059669; }

        /* Two column layout */
        .two-col { display: flex; gap: 20px; }
        .two-col > div { flex: 1; }

        /* Reduction factors */
        .factor-table td:nth-child(2) { text-align: center; font-family: monospace; }
        .factor-table td:nth-child(3) { text-align: center; }
        .factor-reduced { background: #fef3c7 !important; }

        /* Footer */
        .footer {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 2px solid #e5e7eb;
            font-size: 9pt;
            color: #6b7280;
        }
        .footer-grid { display: flex; justify-content: space-between; }

        /* Disclaimer */
        .disclaimer {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 5px;
            padding: 12px;
            margin-top: 15px;
            font-size: 9pt;
        }
        .disclaimer strong { color: #92400e; }

        /* Standards reference */
        .standards {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 5px;
            padding: 10px;
            font-size: 9pt;
        }

        /* Print styles */
        @media print {
            body { padding: 0; }
            .section { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div class="logo-area">J&M ART STEEL FABRICATION P/L</div>
            <div style="font-size:9pt;color:#374151;margin:5px 0;">
                Unit 2/ 28-30 Lillian Flower Place, Marrickville NSW 2204<br>
                T: 02 8021 6707 | M: 0421 470 043
            </div>
            <h1>ANCHOR DESIGN CALCULATION</h1>
            <p>Post-Installed Anchor Capacity Assessment</p>
        </div>
        <div class="header-right">
            <div class="ref-number">Ref: ${refNo}</div>
            <div>Date: ${dateStr}</div>
            <div>Time: ${timeStr}</div>
            <div>Page 1 of 1</div>
        </div>
    </div>

    <div class="section">
        <h2>1. PROJECT INFORMATION</h2>
        <div class="two-col">
            <table>
                <tr><th width="40%">Document Type</th><td>Anchor Capacity Calculation</td></tr>
                <tr><th>Calculation By</th><td>Scott Seeho - J&M Artsteel</td></tr>
                <tr><th>Status</th><td>For Construction / Reference</td></tr>
            </table>
            <table>
                <tr><th width="40%">Reference No.</th><td>${refNo}</td></tr>
                <tr><th>Date Issued</th><td>${dateStr}</td></tr>
                <tr><th>Revision</th><td>0 (Original Issue)</td></tr>
            </table>
        </div>
    </div>

    <div class="section">
        <h2>2. ANCHOR SPECIFICATION</h2>
        <table>
            <tr>
                <th width="25%">Anchor Type</th>
                <td width="25%">${fixing.name}</td>
                <th width="25%">Size</th>
                <td width="25%">${brittanySize}</td>
            </tr>
            <tr>
                <th>Quantity</th>
                <td>${qty} No.</td>
                <th>Drill Hole Size</th>
                <td>√ò${holeSize}mm</td>
            </tr>
            <tr>
                <th>Anchor Category</th>
                <td>${brittanyType === 'chemset' ? 'Chemical (Bonded)' : 'Mechanical (Expansion)'}</td>
                <th>Installation</th>
                <td>${overhead ? 'Overhead / Cracked Concrete' : 'Standard (Downward)'}</td>
            </tr>
        </table>
    </div>

    <div class="section">
        <h2>3. BASE MATERIAL & INSTALLATION PARAMETERS</h2>
        <div class="two-col">
            <div>
                <table>
                    <tr><th colspan="2" style="background:#dbeafe">Substrate Properties</th></tr>
                    <tr><th width="50%">Material</th><td>${substrateName}</td></tr>
                    <tr><th>Compressive Strength</th><td>f'c = ${concrete} MPa</td></tr>
                    <tr><th>Condition</th><td>${overhead ? 'Cracked / Overhead' : 'Uncracked / Sound'}</td></tr>
                </table>
            </div>
            <div>
                <table>
                    <tr><th colspan="3" style="background:#dbeafe">Installation Geometry</th></tr>
                    <tr><th width="40%">Parameter</th><th width="30%">Actual</th><th width="30%">Min Req'd</th></tr>
                    <tr ${embed < minEmbed ? 'class="factor-reduced"' : ''}><td>Embedment (h<sub>ef</sub>)</td><td>${embed}mm</td><td>${minEmbed}mm</td></tr>
                    <tr ${edge < minEdge ? 'class="factor-reduced"' : ''}><td>Edge Distance (c)</td><td>${edge}mm</td><td>${minEdge}mm</td></tr>
                    <tr ${spacing < minSpacing ? 'class="factor-reduced"' : ''}><td>Spacing (s)</td><td>${spacing}mm</td><td>${minSpacing}mm</td></tr>
                </table>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>4. DESIGN CAPACITY CALCULATION</h2>

        <h3 style="font-size:11pt;color:#374151;margin:15px 0 10px 0;">4.1 Reduction Factors</h3>
        <table class="factor-table">
            <tr>
                <th width="35%">Factor</th>
                <th width="20%">Symbol</th>
                <th width="20%">Value</th>
                <th width="25%">Notes</th>
            </tr>
            <tr ${concFactor !== 1.0 ? 'class="factor-reduced"' : ''}>
                <td>Concrete Strength Factor</td>
                <td>œà<sub>c</sub></td>
                <td>${concFactor.toFixed(3)}</td>
                <td>‚àö(f'c/32) = ‚àö(${concrete}/32)</td>
            </tr>
            <tr ${edgeFactor < 1.0 ? 'class="factor-reduced"' : ''}>
                <td>Edge Distance Factor</td>
                <td>œà<sub>ed</sub></td>
                <td>${edgeFactor.toFixed(2)}</td>
                <td>${edgeFactor < 1.0 ? 'Reduced: c < c,min' : 'Full: c ‚â• c,min'}</td>
            </tr>
            <tr ${spacingFactor < 1.0 ? 'class="factor-reduced"' : ''}>
                <td>Spacing Factor</td>
                <td>œà<sub>s</sub></td>
                <td>${spacingFactor.toFixed(2)}</td>
                <td>${spacingFactor < 1.0 ? 'Reduced: s < s,min' : 'Full: s ‚â• s,min'}</td>
            </tr>
            <tr ${embedFactor !== 1.0 ? 'class="factor-reduced"' : ''}>
                <td>Embedment Factor</td>
                <td>œà<sub>h</sub></td>
                <td>${embedFactor.toFixed(2)}</td>
                <td>${brittanyType === 'chemset' ? 'Chemical anchor scaling' : embedFactor < 1.0 ? 'Reduced embedment' : 'Standard'}</td>
            </tr>
            <tr ${overheadFactor < 1.0 ? 'class="factor-reduced"' : ''}>
                <td>Overhead/Cracked Factor</td>
                <td>œà<sub>cr</sub></td>
                <td>${overheadFactor.toFixed(2)}</td>
                <td>${overhead ? 'Applied: 50% reduction' : 'Not applied'}</td>
            </tr>
            ${isMasonry ? `<tr class="factor-reduced">
                <td>Masonry Substrate Factor</td>
                <td>œà<sub>m</sub></td>
                <td>${masonryFactor.toFixed(2)}</td>
                <td>Mechanical anchor in masonry</td>
            </tr>` : ''}
        </table>

        <h3 style="font-size:11pt;color:#374151;margin:15px 0 10px 0;">4.2 Capacity Calculation</h3>
        <div class="calc-box">
            <div><span class="formula">Base Tension Capacity:</span> N<sub>Rk</sub> = ${tensionKn} kN (manufacturer data)</div>
            <div><span class="formula">Base Shear Capacity:</span> V<sub>Rk</sub> = ${shearKn} kN (manufacturer data)</div>
            <br>
            <div><span class="formula">Design Tension (per anchor):</span></div>
            <div>œÜN<sub>Rd</sub> = N<sub>Rk</sub> √ó œà<sub>c</sub> √ó œà<sub>ed</sub> √ó œà<sub>h</sub> √ó œà<sub>cr</sub> ${isMasonry ? '√ó œà<sub>m</sub>' : ''} √ó 102</div>
            <div>œÜN<sub>Rd</sub> = ${tensionKn} √ó ${concFactor.toFixed(3)} √ó ${edgeFactor.toFixed(2)} √ó ${embedFactor.toFixed(2)} √ó ${overheadFactor.toFixed(2)} ${isMasonry ? '√ó 0.50' : ''} √ó 102</div>
            <div><span class="value">œÜN<sub>Rd</sub> = ${tensionPerKg.toLocaleString()} kg</span></div>
            <br>
            <div><span class="formula">Design Shear (per anchor):</span></div>
            <div>œÜV<sub>Rd</sub> = V<sub>Rk</sub> √ó œà<sub>c</sub> √ó œà<sub>ed</sub> √ó œà<sub>s</sub> √ó œà<sub>cr</sub> ${isMasonry ? '√ó œà<sub>m</sub>' : ''} √ó 102</div>
            <div>œÜV<sub>Rd</sub> = ${shearKn} √ó ${concFactor.toFixed(3)} √ó ${edgeFactor.toFixed(2)} √ó ${spacingFactor.toFixed(2)} √ó ${overheadFactor.toFixed(2)} ${isMasonry ? '√ó 0.50' : ''} √ó 102</div>
            <div><span class="value">œÜV<sub>Rd</sub> = ${shearPerKg.toLocaleString()} kg</span></div>
        </div>

        <h3 style="font-size:11pt;color:#374151;margin:15px 0 10px 0;">4.3 Total Design Capacity</h3>
        <table class="capacity-table">
            <tr>
                <th width="30%">Load Type</th>
                <th width="25%">Per Anchor</th>
                <th width="20%">Quantity</th>
                <th width="25%">Total Capacity</th>
            </tr>
            <tr>
                <td><strong>Tension</strong></td>
                <td>${tensionPerKg.toLocaleString()} kg</td>
                <td>√ó ${qty}</td>
                <td class="capacity-value">${brittanyTotalTension.toLocaleString()} kg</td>
            </tr>
            <tr>
                <td><strong>Shear</strong></td>
                <td>${shearPerKg.toLocaleString()} kg</td>
                <td>√ó ${qty}</td>
                <td class="capacity-value">${brittanyTotalShear.toLocaleString()} kg</td>
            </tr>
        </table>
    </div>

    ${loadCheckHTML}

    <div class="section">
        <h2>${load ? '6' : '5'}. REFERENCES & STANDARDS</h2>
        <div class="standards">
            <strong>Applicable Standards:</strong>
            <ul style="margin:5px 0;padding-left:20px;">
                <li>AS 5216:2021 - Design of post-installed and cast-in fastenings in concrete</li>
                <li>AS 3600:2018 - Concrete structures</li>
                <li>Manufacturer technical data sheet for ${fixing.name}</li>
            </ul>
        </div>
    </div>

    <div class="disclaimer">
        <strong>‚ö†Ô∏è DISCLAIMER & LIMITATIONS:</strong>
        <ul style="margin:5px 0;padding-left:20px;">
            <li>This calculation is for preliminary design reference only and must be verified by a qualified structural engineer.</li>
            <li>Capacities are based on manufacturer published data for ${substrateName} substrate conditions.</li>
            <li>Site-specific factors including concrete quality, reinforcement proximity, and edge conditions must be verified.</li>
            <li>Installation must be performed in accordance with manufacturer specifications and relevant Australian Standards.</li>
            <li>Combined tension and shear loading requires interaction check per AS 5216.</li>
            <li>The designer accepts no liability for use of this document without independent verification.</li>
        </ul>
    </div>

    <div class="signature-section" style="margin-top:30px;padding:20px;border:2px solid #1e40af;border-radius:8px;background:#f8fafc;">
        <h3 style="margin:0 0 15px 0;color:#1e40af;font-size:12pt;">CERTIFICATION & APPROVAL</h3>
        <div style="display:flex;gap:40px;">
            <div style="flex:1;">
                <p style="margin:0 0 5px 0;font-size:10pt;color:#374151;"><strong>Prepared By:</strong></p>
                <div style="border-bottom:1px solid #000;height:50px;margin-bottom:5px;"></div>
                <p style="margin:0;font-size:10pt;"><strong>Scott Seeho</strong></p>
                <p style="margin:0;font-size:9pt;color:#6b7280;">Manager | J&M Art Steel Fabrication P/L</p>
            </div>
            <div style="flex:1;">
                <p style="margin:0 0 5px 0;font-size:10pt;color:#374151;"><strong>Date:</strong></p>
                <div style="border-bottom:1px solid #000;height:50px;margin-bottom:5px;"></div>
                <p style="margin:0;font-size:9pt;color:#6b7280;">${dateStr}</p>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="footer-grid">
            <div>
                <strong>J&M Art Steel Fabrication P/L</strong><br>
                Unit 2/ 28-30 Lillian Flower Place, Marrickville NSW 2204
            </div>
            <div style="text-align:center;">
                <strong>Document Reference:</strong><br>
                ${refNo}
            </div>
            <div style="text-align:right;">
                <strong>Issue Date:</strong> ${dateStr}<br>
                <strong>ABN:</strong> 94 164 562 207
            </div>
        </div>
    </div>
</body>
</html>`;

        // Create and download the report
        const blob = new Blob([reportHTML], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Anchor_Design_Report_${refNo}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        document.getElementById('brittanyConsole').textContent = `üìÑ Report ${refNo} downloaded! Open in browser ‚Üí Print ‚Üí Save as PDF`;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // HANNA - Receipt Scanner Functions (Firebase-synced across all devices)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let hannaCurrentFile = null;
    let hannaCurrentResult = null;
    let hannaReceipts = [];
    let hannaFirebaseListenerActive = false;

    function hannaSaveReceipts() {
        if (firebaseDb) {
            try {
                firebaseDb.ref('jmart-safety/hanna/receipts').set(hannaReceipts);
            } catch (e) { console.warn('Hanna Firebase save failed:', e.message); }
        }
        localStorage.setItem('hannaReceipts', JSON.stringify(hannaReceipts));
    }

    function hannaStartSync() {
        if (!firebaseDb || hannaFirebaseListenerActive) return;
        hannaFirebaseListenerActive = true;
        firebaseDb.ref('jmart-safety/hanna/receipts').on('value', (snap) => {
            const data = snap.val();
            if (data && Array.isArray(data)) {
                hannaReceipts = data;
                localStorage.setItem('hannaReceipts', JSON.stringify(data));
            } else if (data === null) {
                const local = JSON.parse(localStorage.getItem('hannaReceipts') || '[]');
                if (local.length > 0) {
                    hannaReceipts = local;
                    firebaseDb.ref('jmart-safety/hanna/receipts').set(local);
                }
            }
            hannaUpdateRecentList();
            hannaUpdateStats();
        });
    }

    function hannaFileSelected(event) {
        const file = event.target.files[0];
        if (!file) return;

        hannaCurrentFile = file;
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('hannaPreviewImage').src = e.target.result;
            document.getElementById('hannaPreview').style.display = 'block';
            document.getElementById('hannaUploadZone').style.display = 'none';
            document.getElementById('hannaConsole').textContent = `üì∑ Image loaded: ${file.name}`;

            // Auto-scan after upload
            hannaScanReceipt();
        };
        reader.readAsDataURL(file);
    }

    function hannaClearPreview() {
        document.getElementById('hannaPreview').style.display = 'none';
        document.getElementById('hannaUploadZone').style.display = 'flex';
        document.getElementById('hannaFileInput').value = '';
        hannaCurrentFile = null;
        document.getElementById('hannaConsole').textContent = 'üßæ HANNA Ready - "I\'ll scan your receipts in a flash"';
    }

    function hannaClearAll() {
        hannaClearPreview();
        document.getElementById('hannaResult').style.display = 'none';
        document.getElementById('hannaJobSelect').value = '';
        document.getElementById('hannaNewJob').value = '';
        document.getElementById('hannaNotes').value = '';
        hannaCurrentResult = null;
    }

    async function hannaScanReceipt() {
        if (!hannaCurrentFile) {
            document.getElementById('hannaConsole').textContent = '‚ö†Ô∏è Please upload a receipt first';
            return;
        }

        // Show scanning animation
        document.getElementById('hannaScanning').style.display = 'flex';
        document.getElementById('hannaConsole').textContent = 'üîç Scanning receipt with AI...';

        try {
            // Convert to base64
            const base64 = await new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(hannaCurrentFile);
            });

            // Detect media type
            const mediaType = hannaCurrentFile.type || 'image/jpeg';

            // Call Claude API directly with vision (no backend needed)
            const result = await callClaudeAPI(
                [{
                    role: 'user',
                    content: [
                        {
                            type: 'image',
                            source: { type: 'base64', media_type: mediaType, data: base64 }
                        },
                        {
                            type: 'text',
                            text: 'Extract all data from this receipt. Return ONLY valid JSON:\n' +
                                '{"store_name":"store name","date":"DD/MM/YYYY","subtotal":0.00,"gst":0.00,"total":0.00,' +
                                '"items":[{"name":"item name","qty":1,"price":0.00}],"confidence":0.95}\n' +
                                'Rules:\n- All prices in AUD\n- GST is 10% in Australia (calculate if not shown)\n' +
                                '- confidence: 0.0-1.0 based on image clarity\n- Return ONLY JSON, no other text'
                        }
                    ]
                }],
                { model: 'claude-3-5-haiku-20241022', maxTokens: 1024 }
            );

            // Extract text from response
            let text = '';
            if (result.content) {
                for (const block of result.content) {
                    if (block.type === 'text') text += block.text;
                }
            }

            // Parse JSON
            const jsonMatch = text.match(/\{[\s\S]*\}/);
            const parsed = jsonMatch ? JSON.parse(jsonMatch[0]) : null;
            if (!parsed) throw new Error('Could not parse receipt data');

            hannaCurrentResult = parsed;
            hannaDisplayResult(parsed);
            document.getElementById('hannaConsole').textContent = '‚úÖ Receipt scanned! Store: ' + (parsed.store_name || 'Unknown') + ', Total: $' + (parsed.total || 0).toFixed(2);

        } catch (error) {
            console.error('Scan error:', error);
            if (error.message.includes('API key')) {
                document.getElementById('hannaConsole').textContent = '‚ö†Ô∏è ' + error.message;
            } else {
                // Fallback: simulate offline scanning with demo data
                hannaSimulateScan();
            }
        } finally {
            document.getElementById('hannaScanning').style.display = 'none';
        }
    }

    function hannaSimulateScan() {
        // Demo data for offline use
        const demoResult = {
            store_name: 'Bunnings Warehouse',
            date: new Date().toLocaleDateString('en-AU'),
            subtotal: 127.27,
            gst: 12.73,
            total: 140.00,
            items: [
                { name: 'M16 Galvanised Bolt Pack', qty: 2, price: 24.50 },
                { name: 'Chemical Anchor HY200', qty: 1, price: 89.00 },
                { name: 'Safety Glasses', qty: 1, price: 14.00 }
            ],
            confidence: 0.85
        };

        hannaCurrentResult = demoResult;
        hannaDisplayResult(demoResult);
        document.getElementById('hannaConsole').textContent = '‚ö†Ô∏è Offline mode - showing demo data. Connect to STEEL server for real scanning.';
    }

    function hannaDisplayResult(result) {
        document.getElementById('hannaStoreName').textContent = result.store_name || 'Unknown Store';
        document.getElementById('hannaReceiptDate').textContent = result.date || '-';
        document.getElementById('hannaSubtotal').textContent = `$${(result.subtotal || 0).toFixed(2)}`;
        document.getElementById('hannaGST').textContent = `$${(result.gst || 0).toFixed(2)}`;
        document.getElementById('hannaTotal').textContent = `$${(result.total || 0).toFixed(2)}`;

        // Display items
        const itemsList = document.getElementById('hannaItemsList');
        if (result.items && result.items.length > 0) {
            itemsList.innerHTML = result.items.map(item => `
                <div class="hanna-item">
                    <span class="hanna-item-name">${escapeHtml(item.name)}</span>
                    <span class="hanna-item-qty">x${escapeHtml(item.qty || 1)}</span>
                    <span class="hanna-item-price">$${escapeHtml((item.price || 0).toFixed(2))}</span>
                </div>
            `).join('');
        } else {
            itemsList.innerHTML = '<div class="hanna-empty-state">No items detected</div>';
        }

        document.getElementById('hannaResult').style.display = 'block';
        document.getElementById('hannaConsole').textContent = `‚úÖ Receipt scanned! Store: ${result.store_name}, Total: $${result.total?.toFixed(2) || '0.00'}`;
    }

    function hannaSaveReceipt() {
        if (!hannaCurrentResult) {
            document.getElementById('hannaConsole').textContent = '‚ö†Ô∏è No receipt to save';
            return;
        }

        const job = document.getElementById('hannaJobSelect').value ||
                    document.getElementById('hannaNewJob').value ||
                    'Uncategorized';
        const notes = document.getElementById('hannaNotes').value;

        const receipt = {
            id: Date.now(),
            ...hannaCurrentResult,
            job: job,
            notes: notes,
            saved_at: new Date().toISOString()
        };

        // Save to Firebase + localStorage
        hannaReceipts.unshift(receipt);
        if (hannaReceipts.length > 100) hannaReceipts = hannaReceipts.slice(0, 100); // Keep last 100
        hannaSaveReceipts();

        // Update UI
        hannaUpdateRecentList();
        hannaUpdateStats();
        hannaClearAll();

        document.getElementById('hannaConsole').textContent = `üíæ Receipt saved to "${job}"! Total: $${receipt.total?.toFixed(2) || '0.00'}`;
    }

    function hannaUpdateRecentList() {
        const list = document.getElementById('hannaRecentList');
        if (hannaReceipts.length === 0) {
            list.innerHTML = '<div class="hanna-empty-state">No receipts scanned yet</div>';
            return;
        }

        list.innerHTML = hannaReceipts.slice(0, 5).map(r => `
            <div class="hanna-recent-item">
                <div class="hanna-recent-store">${escapeHtml(r.store_name || 'Unknown')}</div>
                <div class="hanna-recent-job">${escapeHtml(r.job || '-')}</div>
                <div class="hanna-recent-total">$${escapeHtml((r.total || 0).toFixed(2))}</div>
            </div>
        `).join('');
    }

    function hannaUpdateStats() {
        document.getElementById('hannaStatTotal').textContent = hannaReceipts.length;

        // This month's spending
        const now = new Date();
        const thisMonth = hannaReceipts.filter(r => {
            const d = new Date(r.saved_at);
            return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
        });
        const monthTotal = thisMonth.reduce((sum, r) => sum + (r.total || 0), 0);
        document.getElementById('hannaStatMonth').textContent = `$${monthTotal.toFixed(0)}`;

        // GST claimable
        const gstTotal = hannaReceipts.reduce((sum, r) => sum + (r.gst || 0), 0);
        document.getElementById('hannaStatGST').textContent = `$${gstTotal.toFixed(0)}`;
    }

    function hannaInit() {
        hannaUpdateRecentList();
        hannaUpdateStats();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SETTINGS & DEVICE MANAGEMENT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let editingDeviceId = null;

    // Helper: safely create a styled element with text content (XSS-safe)
    function el(tag, styles, textContent) {
        const e = document.createElement(tag);
        if (styles) e.setAttribute('style', styles);
        if (textContent !== undefined) e.textContent = textContent;
        return e;
    }

    function loadSettingsData() {
        if (!firebaseDb) return;

        // Show this device info
        document.getElementById('settingsDeviceId').textContent = 'Device ID: ' + SteelAuth.deviceId;

        // Load this device name
        firebaseDb.ref('jmart-safety/devices/approved/' + SteelAuth.deviceId + '/name').once('value', snap => {
            document.getElementById('thisDeviceName').value = snap.val() || '';
        });

        // Listen for approved devices
        firebaseDb.ref('jmart-safety/devices/approved').on('value', snap => {
            const container = document.getElementById('approvedDevicesList');
            container.textContent = '';
            if (!snap.exists()) {
                container.appendChild(el('p', 'color:#888;font-size:14px;', 'No approved devices'));
                return;
            }
            snap.forEach(child => {
                const d = child.val();
                const id = child.key;
                const isThis = id === SteelAuth.deviceId;
                const name = d.name || d.type || 'Unknown Device';
                const date = d.approvedAt ? new Date(d.approvedAt).toLocaleDateString('en-AU') : '';

                const card = el('div', 'padding:12px;border-radius:8px;margin-bottom:8px;' + (isThis ? 'background:rgba(102,126,234,0.15);border:1px solid rgba(102,126,234,0.3);' : 'background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);'));
                const row = el('div', 'display:flex;align-items:center;justify-content:space-between;');
                const info = el('div', 'flex:1;min-width:0;');

                if (editingDeviceId === id) {
                    const editRow = el('div', 'display:flex;align-items:center;gap:8px;');
                    const input = el('input', 'flex:1;padding:6px 10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.3);border-radius:6px;color:#fff;font-size:14px;');
                    input.type = 'text'; input.id = 'renameInput-' + id; input.value = name; input.maxLength = 30;
                    input.addEventListener('keydown', function(e) { if (e.key === 'Enter') handleSaveRename(id); if (e.key === 'Escape') cancelRename(); });
                    const saveBtn = el('button', 'padding:4px 10px;background:#4CAF50;border:none;border-radius:6px;color:#fff;cursor:pointer;font-size:14px;', '\u2713');
                    saveBtn.addEventListener('click', function() { handleSaveRename(id); });
                    const cancelBtn = el('button', 'padding:4px 10px;background:transparent;border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:#888;cursor:pointer;font-size:14px;', '\u2717');
                    cancelBtn.addEventListener('click', function() { cancelRename(); });
                    editRow.appendChild(input); editRow.appendChild(saveBtn); editRow.appendChild(cancelBtn);
                    info.appendChild(editRow);
                } else {
                    const nameRow = el('div', 'display:flex;align-items:center;gap:8px;');
                    const nameEl = el('strong', 'color:#fff;', name);
                    nameRow.appendChild(nameEl);
                    if (isThis) { nameRow.appendChild(el('span', 'color:#667eea;font-size:12px;', '(This device)')); }
                    if (d.isAdmin) {
                        const badge = el('span', 'background:#e65100;color:#fff;font-size:10px;padding:2px 8px;border-radius:4px;', 'Admin');
                        nameRow.appendChild(badge);
                    }
                    if (SteelAuth.isAdmin) {
                        const renameBtn = el('button', 'background:none;border:none;cursor:pointer;font-size:14px;padding:2px 4px;', '\u270E');
                        renameBtn.title = 'Rename device';
                        renameBtn.addEventListener('click', function() { startRename(id); });
                        nameRow.appendChild(renameBtn);
                    }
                    info.appendChild(nameRow);
                }

                info.appendChild(el('p', 'font-size:11px;color:#888;margin-top:4px;', id));
                row.appendChild(info);

                const actions = el('div', 'display:flex;align-items:center;gap:10px;');
                actions.appendChild(el('span', 'font-size:12px;color:#888;', date));
                if (SteelAuth.isAdmin && !isThis && !d.isAdmin) {
                    const removeBtn = el('button', 'background:none;border:none;cursor:pointer;font-size:16px;', '\uD83D\uDDD1');
                    removeBtn.title = 'Remove device';
                    removeBtn.addEventListener('click', function() { handleRemoveDevice(id); });
                    actions.appendChild(removeBtn);
                }
                row.appendChild(actions);
                card.appendChild(row);
                container.appendChild(card);
            });

            // Auto-focus rename input if editing
            if (editingDeviceId) {
                const input = document.getElementById('renameInput-' + editingDeviceId);
                if (input) { input.focus(); input.select(); }
            }
        });

        // Listen for pending devices
        firebaseDb.ref('jmart-safety/devices/pending').on('value', snap => {
            const container = document.getElementById('pendingDevicesList');
            container.textContent = '';
            if (!snap.exists() || snap.numChildren() === 0) {
                container.appendChild(el('p', 'color:#888;font-size:14px;', 'No pending devices'));
                return;
            }
            snap.forEach(child => {
                const d = child.val();
                const id = child.key;
                const name = d.name || d.type || 'Unknown Device';
                const date = d.requestedAt ? new Date(d.requestedAt).toLocaleDateString('en-AU') : '';

                const card = el('div', 'padding:12px;border-radius:8px;margin-bottom:8px;background:rgba(255,193,7,0.1);border:1px solid rgba(255,193,7,0.3);');
                const row = el('div', 'display:flex;align-items:center;justify-content:space-between;');
                const info = el('div', 'flex:1;');

                if (editingDeviceId === id) {
                    const editRow = el('div', 'display:flex;align-items:center;gap:8px;');
                    const input = el('input', 'flex:1;padding:6px 10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.3);border-radius:6px;color:#fff;font-size:14px;');
                    input.type = 'text'; input.id = 'renameInput-' + id; input.value = name; input.maxLength = 30;
                    input.addEventListener('keydown', function(e) { if (e.key === 'Enter') handleSaveRename(id); if (e.key === 'Escape') cancelRename(); });
                    const saveBtn = el('button', 'padding:4px 10px;background:#4CAF50;border:none;border-radius:6px;color:#fff;cursor:pointer;', '\u2713');
                    saveBtn.addEventListener('click', function() { handleSaveRename(id); });
                    const cancelBtn = el('button', 'padding:4px 10px;background:transparent;border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:#888;cursor:pointer;', '\u2717');
                    cancelBtn.addEventListener('click', function() { cancelRename(); });
                    editRow.appendChild(input); editRow.appendChild(saveBtn); editRow.appendChild(cancelBtn);
                    info.appendChild(editRow);
                } else {
                    const nameRow = el('div', 'display:flex;align-items:center;gap:8px;');
                    nameRow.appendChild(el('strong', 'color:#fff;', name));
                    if (SteelAuth.isAdmin) {
                        const renameBtn = el('button', 'background:none;border:none;cursor:pointer;font-size:14px;padding:2px 4px;', '\u270E');
                        renameBtn.title = 'Rename device';
                        renameBtn.addEventListener('click', function() { startRename(id); });
                        nameRow.appendChild(renameBtn);
                    }
                    info.appendChild(nameRow);
                }

                info.appendChild(el('p', 'font-size:11px;color:#888;margin-top:4px;', 'Requested: ' + date));
                row.appendChild(info);

                if (SteelAuth.isAdmin) {
                    const btnGroup = el('div', 'display:flex;gap:8px;');
                    const approveBtn = el('button', 'padding:6px 14px;background:#4CAF50;border:none;border-radius:6px;color:#fff;cursor:pointer;font-size:13px;font-weight:600;', 'Approve');
                    approveBtn.addEventListener('click', function() { handleApproveDevice(id); });
                    const denyBtn = el('button', 'padding:6px 14px;background:#f44336;border:none;border-radius:6px;color:#fff;cursor:pointer;font-size:13px;font-weight:600;', 'Deny');
                    denyBtn.addEventListener('click', function() { handleDenyDevice(id); });
                    btnGroup.appendChild(approveBtn); btnGroup.appendChild(denyBtn);
                    row.appendChild(btnGroup);
                }
                card.appendChild(row);
                container.appendChild(card);
            });
        });
    }

    async function saveThisDeviceName() {
        const name = document.getElementById('thisDeviceName').value.trim();
        if (!name) { alert('Please enter a device name'); return; }
        if (!firebaseDb) return;
        try {
            await firebaseDb.ref('jmart-safety/devices/approved/' + SteelAuth.deviceId + '/name').set(name);
            document.getElementById('settingsConsole').textContent = '‚úÖ Device name saved: ' + name;
        } catch (error) {
            alert('Failed to save device name');
        }
    }

    function startRename(deviceId) {
        editingDeviceId = deviceId;
        loadSettingsData();
    }

    function cancelRename() {
        editingDeviceId = null;
        loadSettingsData();
    }

    async function handleSaveRename(deviceId) {
        const input = document.getElementById('renameInput-' + deviceId);
        if (!input) return;
        const newName = input.value.trim();
        if (!newName) { alert('Device name cannot be empty'); return; }
        const success = await SteelAuth.renameDevice(deviceId, newName);
        editingDeviceId = null;
        if (!success) {
            alert('Failed to rename device');
        }
    }

    async function handleApproveDevice(deviceId) {
        if (!confirm('Approve this device?')) return;
        const success = await SteelAuth.approveDevice(deviceId);
        if (!success) alert('Failed to approve device');
    }

    async function handleDenyDevice(deviceId) {
        if (!confirm('Deny and remove this device request?')) return;
        const success = await SteelAuth.denyDevice(deviceId);
        if (!success) alert('Failed to deny device');
    }

    async function handleRemoveDevice(deviceId) {
        if (!confirm('Remove this device? It will need to be re-approved.')) return;
        const success = await SteelAuth.removeDevice(deviceId);
        if (!success) alert('Failed to remove device');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // API KEY MANAGEMENT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function saveApiKey() {
        const key = document.getElementById('apiKeyInput').value.trim();
        if (!key || !key.startsWith('sk-')) {
            document.getElementById('apiKeyStatus').textContent = 'Invalid key - must start with sk-';
            document.getElementById('apiKeyStatus').style.color = '#f44336';
            return;
        }
        localStorage.setItem('steel-api-key', key);
        document.getElementById('apiKeyInput').value = '';
        document.getElementById('apiKeyStatus').textContent = 'API key saved securely';
        document.getElementById('apiKeyStatus').style.color = '#4CAF50';
    }

    function getApiKey() {
        return localStorage.getItem('steel-api-key');
    }

    function loadApiKeyStatus() {
        const key = getApiKey();
        const status = document.getElementById('apiKeyStatus');
        if (status) {
            if (key) {
                status.textContent = 'API key configured (sk-...' + key.slice(-4) + ')';
                status.style.color = '#4CAF50';
            } else {
                status.textContent = 'No API key set - Victor & Frank need this to work';
                status.style.color = '#f2994a';
            }
        }
    }

    async function callClaudeAPI(messages, options = {}) {
        const apiKey = getApiKey();
        if (!apiKey) {
            throw new Error('No API key configured. Go to Settings and add your Anthropic API key.');
        }

        const body = {
            model: options.model || 'claude-3-5-haiku-20241022',
            max_tokens: options.maxTokens || 1024,
            messages: messages
        };
        if (options.system) body.system = options.system;
        if (options.tools) body.tools = options.tools;
        if (options.temperature !== undefined) body.temperature = options.temperature;

        const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-api-key': apiKey,
                'anthropic-version': '2023-06-01',
                'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify(body)
        });

        if (!response.ok) {
            const err = await response.json().catch(() => ({}));
            if (response.status === 401) throw new Error('Invalid API key. Check Settings.');
            if (response.status === 429) throw new Error('Rate limited. Wait a moment and try again.');
            throw new Error(err.error?.message || 'API error: ' + response.status);
        }

        return await response.json();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // VICTOR - MSDS FINDER (Firebase-synced across all devices)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let victorProducts = [];
    let victorFirebaseListenerActive = false;
    let victorActiveFilter = 'all'; // 'all', 'current', 'expiring', 'expired'
    let victorAutoUpdateRunning = false;
    let victorAutoUpdateQueue = [];
    const VICTOR_AUTO_UPDATE_COOLDOWN = 7 * 24 * 60 * 60 * 1000; // 7 days between auto-checks for first attempt

    // Check if today falls in the 2nd Sunday window (Sun‚ÄìTue) of the current month
    function victorIsSecondSundayWindow() {
        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth();
        let sundayCount = 0;
        for (let d = 1; d <= 28; d++) {
            if (new Date(year, month, d).getDay() === 0) {
                sundayCount++;
                if (sundayCount === 2) {
                    // 3-day window: 2nd Sunday through Tuesday after
                    return today.getDate() >= d && today.getDate() <= d + 2;
                }
            }
        }
        return false;
    }

    // Pre-loaded SDS data from J&M Artsteel Hub (port 8000)
    const VICTOR_SEED_DATA = [
        { name: '210 METALPRIME', manufacturer: 'Lacnam', msds_url: 'https://www.lacnam.com.au/wp-content/uploads/2021/09/210-Metalprime.pdf', msds_date: '2021-08-20', compliance: 'expired', hazard_class: '', signal_word: '', summary: 'Metal primer for steel preparation', searched: '2026-01-20' },
        { name: 'Weathermax HBR Part A', manufacturer: 'Dulux', msds_url: 'https://go.lupinsys.com/duluxgroup/harms/pm/3c8bb9f28239cf735c4e49d35e57b28d-published/attachment/aus-ghs.pdf', msds_date: '2024-04-01', compliance: 'current', hazard_class: '', signal_word: '', summary: 'High build roof membrane coating - Part A', searched: '2026-01-20' },
        { name: 'Weathermax HBR Accelerator Part C', manufacturer: 'Dulux', msds_url: 'https://go.lupinsys.com/duluxgroup/harms/pm/35f7010af1be44e6a8669efe41e4a83b-published/attachment/aus-ghs.pdf', msds_date: '2025-01-01', compliance: 'current', hazard_class: '', signal_word: '', summary: 'Accelerator component for Weathermax HBR system', searched: '2026-01-20' },
        { name: 'Chemset 101 Plus', manufacturer: 'Ramset', msds_url: 'https://cdn.ramset.com.au/wp-content/uploads/2023/08/ramset_C101C_C101J_SDS_CHEMSET-101-PLUS.pdf', msds_date: '2023-08-01', compliance: 'current', hazard_class: '', signal_word: '', summary: 'Chemical anchor for concrete fixing', searched: '2026-01-20' },
        { name: 'Chemset 801 Xtreme', manufacturer: 'Ramset', msds_url: 'https://cdn.ramset.com.au/wp-content/uploads/2023/08/Ramset_C801_Chemset801Xtrem_SDS.pdf', msds_date: '2022-03-01', compliance: 'current', hazard_class: '', signal_word: '', summary: 'High-performance chemical anchor for structural fixing', searched: '2026-01-20' },
        { name: 'HIT-HY 200-R V3', manufacturer: 'Hilti', msds_url: 'https://productdata.hilti.com/APQ_HC_RAW/IBD_WWI-00000000000005135083_000.pdf', msds_date: '2022-10-25', compliance: 'current', hazard_class: '', signal_word: '', summary: 'Injectable hybrid mortar for rebar and anchor fastening', searched: '2026-01-20' },
        { name: 'Lanko 701 Duragrout', manufacturer: 'Parex Lanko', msds_url: 'https://summitsupplies.com.au/wp-content/uploads/2023/03/Lanko-701-Duragrout-SDS.pdf', msds_date: '2021-12-21', compliance: 'current', hazard_class: '', signal_word: '', summary: 'Non-shrink structural grout for baseplate grouting', searched: '2026-01-20' },
        { name: 'Liquefied Petroleum Gas (LPG)', manufacturer: 'BOC', msds_url: 'https://www.boc-gas.com.au/en/images/Propane-LPG%20SDS_tcm351-496571.pdf', msds_date: '2024-03-01', compliance: 'current', hazard_class: '2.1', signal_word: 'Danger', summary: 'Flammable gas used for oxy cutting and heating', searched: '2026-01-20' },
        { name: 'Penaflow Panel Grout', manufacturer: 'Parchem', msds_url: 'https://www.rlapolymers.com.au/wp-content/uploads/2024/10/penaflow-panel-grout-v2.pdf', msds_date: '2024-10-08', compliance: 'current', hazard_class: '', signal_word: '', summary: 'Flowable cementitious grout for panel connections', searched: '2026-01-20' },
        { name: 'WD-40 Multi Use', manufacturer: 'WD-40', msds_url: 'https://files.wd40.com/pdf/sds/mup/wd-40-multi-use-product-aerosol-low-voc-sds-us-ghs.pdf', msds_date: '2024-11-13', compliance: 'current', hazard_class: '', signal_word: '', summary: 'Multi-purpose lubricant and penetrant spray', searched: '2026-01-20' },
        { name: 'HIT-RE 500 V4', manufacturer: 'Hilti', msds_url: 'https://productdata.hilti.com/APQ_HC_RAW/IBD_WWI-00000000000006652206_000.pdf', msds_date: '2025-04-17', compliance: 'current', hazard_class: '', signal_word: '', summary: 'Epoxy adhesive anchor for heavy-duty structural fixing', searched: '2026-01-21' },
        { name: 'HIT-HY 270', manufacturer: 'Hilti', msds_url: 'https://productdata.hilti.com/APQ_HC_RAW/IBD_WWI-00000000000005135085_000.pdf', msds_date: '2022-12-06', compliance: 'current', hazard_class: '', signal_word: '', summary: 'Hybrid mortar anchor for concrete and masonry', searched: '2026-01-21' },
        { name: 'HIT-MM PLUS', manufacturer: 'Hilti', msds_url: 'https://productdata.hilti.com/APQ_HC_RAW/IBD_WWI-00000000000005930035_000.pdf', msds_date: '2024-06-18', compliance: 'current', hazard_class: '', signal_word: '', summary: 'Multi-purpose mortar for non-cracked concrete anchoring', searched: '2026-01-21' },
        { name: 'HVU2 Anchor Capsule', manufacturer: 'Hilti', msds_url: 'https://productdata.hilti.com/APQ_HC_RAW/IBD_WWI-00000000000005122602_000.pdf', msds_date: '2022-01-10', compliance: 'current', hazard_class: '', signal_word: '', summary: 'Glass capsule adhesive anchor for concrete', searched: '2026-01-21' },
        { name: 'HIT-RE 100', manufacturer: 'Hilti', msds_url: 'https://productdata.hilti.com/APQ_HC_RAW/IBD_WWI-00000000000005135087_000.pdf', msds_date: '2022-12-02', compliance: 'current', hazard_class: '', signal_word: '', summary: 'Epoxy adhesive anchor for standard applications', searched: '2026-01-21' },
        { name: 'HIT-FP 700 R', manufacturer: 'Hilti', msds_url: 'https://productdata.hilti.com/APQ_HC_RAW/IBD_WWI-00000000000006612558_000.pdf', msds_date: '2025-05-20', compliance: 'current', hazard_class: '', signal_word: '', summary: 'Firestop sealant for fire-rated penetrations', searched: '2026-01-21' },
        { name: 'HIT-HY 170', manufacturer: 'Hilti', msds_url: 'https://productdata.hilti.com/APQ_HC_RAW/IBD_WWI-00000000000005114586_000.pdf', msds_date: '2021-09-22', compliance: 'current', hazard_class: '', signal_word: '', summary: 'Hybrid mortar for standard anchoring applications', searched: '2026-01-21' }
    ];

    function victorSaveProducts() {
        if (firebaseDb) {
            try {
                firebaseDb.ref('jmart-safety/victor/products').set(victorProducts);
            } catch (e) { console.warn('Victor Firebase save failed:', e.message); }
        }
        localStorage.setItem('victor-products', JSON.stringify(victorProducts));
    }

    function victorStartSync() {
        if (!firebaseDb || victorFirebaseListenerActive) return;
        victorFirebaseListenerActive = true;
        firebaseDb.ref('jmart-safety/victor/products').on('value', (snap) => {
            const data = snap.val();
            if (data && Array.isArray(data) && data.length > 0) {
                victorProducts = data;
                localStorage.setItem('victor-products', JSON.stringify(data));
            } else {
                // No data or empty array in Firebase - seed with pre-loaded SDS data
                const local = JSON.parse(localStorage.getItem('victor-products') || '[]');
                if (local.length > 0) {
                    victorProducts = local;
                } else {
                    // First time or reset: seed with all saved SDS from J&M Artsteel Hub
                    victorProducts = VICTOR_SEED_DATA.slice();
                    console.log('Victor: Seeded ' + victorProducts.length + ' SDS products from STEEL database');
                }
                firebaseDb.ref('jmart-safety/victor/products').set(victorProducts);
            }
            victorRenderProducts();
            // Kick off auto-update for expiring/expired MSDS (runs once after load, 3s delay)
            if (!victorAutoUpdateRunning) {
                setTimeout(() => victorStartAutoUpdate(), 3000);
            }
        });
    }

    // Calculate compliance status dynamically from msds_date
    // SDS valid for 5 years from issue date; "expiring" = within 1 year of 5-year mark
    function victorCalcCompliance(msdsDate) {
        if (!msdsDate || msdsDate === 'unknown') return 'unknown';
        const issued = new Date(msdsDate);
        if (isNaN(issued.getTime())) return 'unknown';
        const fiveYears = new Date(issued);
        fiveYears.setFullYear(fiveYears.getFullYear() + 5);
        const oneYearBefore = new Date(fiveYears);
        oneYearBefore.setFullYear(oneYearBefore.getFullYear() - 1);
        const today = new Date();
        if (today >= fiveYears) return 'expired';
        if (today >= oneYearBefore) return 'expiring';
        return 'current';
    }

    // Check if MSDS needs update (expiring within 1 year or already expired)
    function victorNeedsUpdate(msdsDate) {
        const status = victorCalcCompliance(msdsDate);
        return status === 'expiring' || status === 'expired';
    }

    // Check if MSDS expires within N months (for 6-month push alert)
    function victorExpiresSoon(msdsDate, months) {
        if (!msdsDate || msdsDate === 'unknown') return false;
        const issued = new Date(msdsDate);
        if (isNaN(issued.getTime())) return false;
        const expiry = new Date(issued);
        expiry.setFullYear(expiry.getFullYear() + 5);
        const today = new Date();
        if (today >= expiry) return true; // already expired
        const diffMs = expiry - today;
        const diffMonths = diffMs / (1000 * 60 * 60 * 24 * 30.44);
        return diffMonths <= months;
    }

    // Manufacturer SDS portal lookup ‚Äî tells Victor WHERE to search
    const VICTOR_SDS_PORTALS = {
        'hilti': { url: 'https://www.hilti.com.au', sds: 'https://productdata.hilti.com', note: 'Search productdata.hilti.com for SDS PDFs' },
        'ramset': { url: 'https://www.ramset.com.au', sds: 'https://cdn.ramset.com.au', note: 'SDS PDFs hosted on cdn.ramset.com.au' },
        'dulux': { url: 'https://www.dulux.com.au', sds: 'https://go.lupinsys.com/duluxgroup', note: 'SDS via Lupinsys portal (go.lupinsys.com/duluxgroup)' },
        'lacnam': { url: 'https://www.lacnam.com.au', sds: 'https://www.lacnam.com.au/wp-content/uploads', note: 'SDS PDFs in lacnam.com.au/wp-content/uploads' },
        'parex': { url: 'https://www.parexgroup.com.au', sds: '', note: 'Search parexgroup.com.au or summitsupplies.com.au' },
        'parex lanko': { url: 'https://www.parexgroup.com.au', sds: '', note: 'Search parexgroup.com.au or summitsupplies.com.au' },
        'boc': { url: 'https://www.boc-gas.com.au', sds: 'https://www.boc-gas.com.au', note: 'SDS on boc-gas.com.au' },
        'parchem': { url: 'https://www.parchem.com.au', sds: 'https://www.rlapolymers.com.au', note: 'SDS via rlapolymers.com.au' },
        'wd-40': { url: 'https://www.wd40.com.au', sds: 'https://files.wd40.com/pdf/sds', note: 'SDS PDFs at files.wd40.com/pdf/sds' },
        'sika': { url: 'https://www.sika.com.au', sds: 'https://aus.sika.com', note: 'Search aus.sika.com for SDS documents' },
        'fosroc': { url: 'https://www.fosroc.com.au', sds: '', note: 'Search fosroc.com.au for SDS' },
        'simpson strong-tie': { url: 'https://www.strongtie.com.au', sds: '', note: 'Search strongtie.com.au for SDS' },
        'chemours': { url: 'https://www.chemours.com', sds: '', note: 'Search chemours.com for SDS' }
    };

    // Look up manufacturer SDS portal info
    function victorGetPortal(manufacturer) {
        if (!manufacturer) return null;
        const mfr = manufacturer.toLowerCase().trim();
        // Direct match
        if (VICTOR_SDS_PORTALS[mfr]) return VICTOR_SDS_PORTALS[mfr];
        // Partial match
        for (const [key, val] of Object.entries(VICTOR_SDS_PORTALS)) {
            if (mfr.includes(key) || key.includes(mfr)) return val;
        }
        return null;
    }

    // Set active filter and re-render
    function victorSetFilter(filter) {
        victorActiveFilter = filter;
        // Update button styles
        ['all', 'current', 'expiring', 'expired'].forEach(f => {
            const btn = document.getElementById('victorFilter' + f.charAt(0).toUpperCase() + f.slice(1));
            if (!btn) return;
            if (f === filter) {
                btn.style.background = f === 'all' ? 'rgba(102,126,234,0.3)' : f === 'current' ? 'rgba(76,175,80,0.2)' : f === 'expiring' ? 'rgba(242,153,74,0.2)' : 'rgba(244,67,54,0.2)';
            } else {
                btn.style.background = 'transparent';
            }
        });
        victorRenderProducts();
    }

    // Update the compliance dashboard counts
    function victorUpdateDashboard() {
        let total = 0, current = 0, expiring = 0, expired = 0, soon = 0;
        victorProducts.forEach(p => {
            total++;
            const status = victorCalcCompliance(p.msds_date);
            if (status === 'current') current++;
            else if (status === 'expiring') expiring++;
            else if (status === 'expired') expired++;
            if (victorExpiresSoon(p.msds_date, 12)) soon++;
        });
        const el = (id, v) => { const e = document.getElementById(id); if (e) e.textContent = v; };
        el('victorCountTotal', total);
        el('victorCountCurrent', current);
        el('victorCountExpiring', expiring);
        el('victorCountExpired', expired);
        // Show action-needed count
        const actionEl = document.getElementById('victorActionNeeded');
        if (actionEl) {
            if (soon > 0) {
                actionEl.style.display = 'block';
                actionEl.innerHTML = '<span style="color:#f2994a;font-weight:600;">' + soon + ' MSDS need updating</span> ‚Äî expiring within 12 months or already expired';
            } else {
                actionEl.style.display = 'none';
            }
        }
    }

    function victorRenderProducts() {
        const list = document.getElementById('victorProductList');
        const empty = document.getElementById('victorEmptyMsg');
        if (!list) return;

        // Update dashboard counts
        victorUpdateDashboard();

        if (victorProducts.length === 0) {
            list.innerHTML = '';
            if (empty) empty.style.display = 'block';
            return;
        }
        if (empty) empty.style.display = 'none';

        // Build indexed list with live compliance
        const indexed = victorProducts.map((p, i) => {
            const liveCompliance = victorCalcCompliance(p.msds_date);
            if (liveCompliance !== 'unknown' && p.compliance !== liveCompliance) {
                p.compliance = liveCompliance;
            }
            return { p, i, compliance: liveCompliance };
        });

        // Sort: expired first, then expiring, then current, then unknown
        const order = { expired: 0, expiring: 1, current: 2, unknown: 3 };
        indexed.sort((a, b) => (order[a.compliance] ?? 3) - (order[b.compliance] ?? 3));

        // Apply status filter
        let filtered = indexed;
        if (victorActiveFilter !== 'all') {
            filtered = indexed.filter(item => item.compliance === victorActiveFilter);
        }

        // Apply text filter
        const filterText = (document.getElementById('victorFilterText')?.value || '').toLowerCase().trim();
        if (filterText) {
            filtered = filtered.filter(item =>
                item.p.name.toLowerCase().includes(filterText) ||
                (item.p.manufacturer || '').toLowerCase().includes(filterText)
            );
        }

        if (filtered.length === 0) {
            list.innerHTML = '<p style="color:#666;font-size:13px;text-align:center;padding:16px;">No MSDS matching filter.</p>';
            return;
        }

        list.innerHTML = filtered.map(({ p, i, compliance }) => {
            const statusColor = compliance === 'current' ? '#4CAF50' : compliance === 'expiring' ? '#f2994a' : compliance === 'expired' ? '#f44336' : '#888';
            const statusLabel = compliance.toUpperCase();
            const needsUpdate = victorNeedsUpdate(p.msds_date);
            const expiresSoon = victorExpiresSoon(p.msds_date, 12);
            const portal = victorGetPortal(p.manufacturer);
            let expiryInfo = '';
            if (p.msds_date && p.msds_date !== 'unknown') {
                const issued = new Date(p.msds_date);
                const expiry = new Date(issued);
                expiry.setFullYear(expiry.getFullYear() + 5);
                const daysLeft = Math.ceil((expiry - new Date()) / (1000 * 60 * 60 * 24));
                if (daysLeft > 0) expiryInfo = 'Expires in ' + daysLeft + ' days';
                else expiryInfo = 'Expired ' + Math.abs(daysLeft) + ' days ago';
            }
            // Auto-update status indicator (replaces manual button)
            const lastChecked = p.lastUpdated ? p.lastUpdated : null;
            const noUpdateFound = p.lastUpdateResult === 'no-update';
            let autoStatus = '';
            if (expiresSoon) {
                if (!lastChecked) {
                    autoStatus = '<br><span style="font-size:10px;color:' + statusColor + ';font-weight:600;">‚è≥ Queued for auto-update</span>';
                } else if (noUpdateFound) {
                    autoStatus = '<br><span style="font-size:10px;color:#888;">Checked: ' + escapeHtml(lastChecked) + ' ‚Äî no newer found, retries 2nd Sunday</span>';
                } else {
                    autoStatus = '<br><span style="font-size:10px;color:#888;">Last checked: ' + escapeHtml(lastChecked) + '</span>';
                }
            }
            return '<div style="background:rgba(255,255,255,0.05);border-radius:8px;padding:12px;margin-bottom:8px;border-left:3px solid ' + statusColor + ';' + (expiresSoon ? 'box-shadow:inset 0 0 0 1px ' + statusColor + '33;' : '') + '">' +
                '<div style="display:flex;justify-content:space-between;align-items:start;">' +
                '<div style="flex:1;min-width:0;">' +
                '<strong style="color:#fff;">' + escapeHtml(p.name) + '</strong>' +
                (p.manufacturer ? '<br><span style="font-size:12px;color:#aaa;">' + escapeHtml(p.manufacturer) + '</span>' : '') +
                (p.summary ? '<br><span style="font-size:11px;color:#888;">' + escapeHtml(p.summary) + '</span>' : '') +
                (p.msds_date ? '<br><span style="font-size:12px;color:#aaa;">MSDS Date: ' + escapeHtml(p.msds_date) + '</span>' : '') +
                (expiryInfo ? '<br><span style="font-size:11px;font-weight:' + (expiresSoon ? '600' : '400') + ';color:' + (expiresSoon || needsUpdate ? statusColor : '#888') + ';">' + expiryInfo + '</span>' : '') +
                (portal && expiresSoon ? '<br><span style="font-size:10px;color:#667eea;">Source: ' + escapeHtml(portal.url) + '</span>' : '') +
                autoStatus +
                '</div>' +
                '<div style="text-align:right;flex-shrink:0;margin-left:8px;">' +
                '<span style="font-size:11px;font-weight:600;color:' + statusColor + ';background:rgba(255,255,255,0.1);padding:2px 8px;border-radius:4px;">' + statusLabel + '</span>' +
                (p.msds_url ? '<br><a href="' + escapeHtml(p.msds_url) + '" target="_blank" style="font-size:12px;color:#667eea;text-decoration:none;">View PDF</a>' : '') +
                '<br><button onclick="victorRemove(' + i + ')" style="font-size:11px;color:#f44336;background:none;border:none;cursor:pointer;margin-top:4px;">Remove</button>' +
                '</div></div></div>';
        }).join('');
    }

    function victorRemove(index) {
        victorProducts.splice(index, 1);
        victorSaveProducts();
        victorRenderProducts();
    }

    function victorLog(msg) {
        const el = document.getElementById('victorConsole');
        if (el) el.textContent = msg;
    }

    // Update/refresh an MSDS ‚Äî re-searches for a newer version
    async function victorUpdate(index, btn) {
        const product = victorProducts[index];
        if (!product) return;

        // Check API key first
        if (!getApiKey()) {
            alert('No API key configured. Go to Settings (‚öôÔ∏è) and add your Anthropic API key first.');
            victorLog('‚ö†Ô∏è API key needed ‚Äî go to Settings to add it');
            return;
        }

        const origText = btn ? btn.innerHTML : '';
        if (btn) { btn.innerHTML = '‚è≥ Searching...'; btn.disabled = true; }

        try {
            // Look up manufacturer SDS portal for targeted searching
            const portal = victorGetPortal(product.manufacturer);
            const portalHint = portal
                ? '\n\nKNOWN SDS SOURCE for ' + product.manufacturer + ':\n' +
                  '- Manufacturer website: ' + portal.url + '\n' +
                  (portal.sds ? '- SDS portal/CDN: ' + portal.sds + '\n' : '') +
                  '- Tip: ' + portal.note + '\n' +
                  '- The current PDF URL is: ' + (product.msds_url || 'unknown') + '\n' +
                  '- Check the same domain/path pattern for an updated version first.\n'
                : '\n\n- The current PDF URL is: ' + (product.msds_url || 'unknown') + '\n' +
                  '- Check the same domain for an updated version first.\n';

            const searchPrompt = 'Find the latest Safety Data Sheet (SDS/MSDS) PDF URL for:\n' +
                'Product: ' + product.name + '\n' +
                'Manufacturer: ' + (product.manufacturer || 'unknown') + '\n\n' +
                'I need the MOST RECENT version of the SDS. The current one is dated ' + (product.msds_date || 'unknown') + ' and may be outdated.' +
                portalHint +
                '\nSearch Strategy:\n' +
                '1. Check the known SDS source/portal listed above FIRST\n' +
                '2. Search the manufacturer official website\n' +
                '3. Look for Australian (.com.au) sources\n' +
                '4. Find direct PDF download links ending in .pdf\n' +
                '5. Prioritize the newest/most recent version available\n' +
                '6. Avoid aggregator sites\n\n' +
                'Return ONLY valid JSON:\n' +
                '{"msds_url":"https://...pdf or NOT_FOUND","msds_date":"YYYY-MM-DD or unknown","hazard_class":"class or unknown","signal_word":"Danger/Warning/None","summary":"brief summary"}';

            const result = await callClaudeAPI(
                [{ role: 'user', content: searchPrompt }],
                { model: 'claude-3-5-haiku-20241022', maxTokens: 1024, tools: [{ type: 'web_search_20250305', name: 'web_search', max_uses: 4 }] }
            );

            let text = '';
            if (result && result.content) {
                for (const block of result.content) {
                    if (block.type === 'text') text += block.text;
                }
            }

            let data;
            try {
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                data = jsonMatch ? JSON.parse(jsonMatch[0]) : null;
            } catch (e) { data = null; }

            if (data && data.msds_url && data.msds_url !== 'NOT_FOUND') {
                // Check if the new MSDS is actually newer
                const oldDate = product.msds_date || '0000-00-00';
                const newDate = data.msds_date || 'unknown';
                const isNewer = newDate !== 'unknown' && newDate > oldDate;

                // Update product with new data
                victorProducts[index].msds_url = data.msds_url;
                if (newDate !== 'unknown') {
                    victorProducts[index].msds_date = newDate;
                    victorProducts[index].compliance = victorCalcCompliance(newDate);
                }
                if (data.summary) victorProducts[index].summary = data.summary;
                if (data.hazard_class && data.hazard_class !== 'unknown') victorProducts[index].hazard_class = data.hazard_class;
                if (data.signal_word && data.signal_word !== 'unknown') victorProducts[index].signal_word = data.signal_word;
                victorProducts[index].lastUpdated = new Date().toISOString().split('T')[0];

                // Track update result for 2nd-Sunday retry logic
                if (isNewer) {
                    victorProducts[index].lastUpdateResult = 'updated';
                    delete victorProducts[index].lastUpdateMonth;
                } else {
                    // Found same/older MSDS ‚Äî schedule for 2nd Sunday retry
                    victorProducts[index].lastUpdateResult = 'no-update';
                    victorProducts[index].lastUpdateMonth = new Date().toISOString().substring(0, 7);
                }

                victorSaveProducts();
                victorRenderProducts();
                victorLog(isNewer
                    ? '‚úÖ Updated ' + product.name + ' ‚Äî new MSDS dated ' + newDate + ' (was ' + oldDate + ')'
                    : '‚úÖ Refreshed ' + product.name + ' ‚Äî MSDS date: ' + newDate + ' (no newer found ‚Äî will retry 2nd Sunday next month)');
            } else {
                // Search failed entirely ‚Äî schedule for 2nd Sunday retry
                victorProducts[index].lastUpdateResult = 'no-update';
                victorProducts[index].lastUpdateMonth = new Date().toISOString().substring(0, 7);
                victorProducts[index].lastUpdated = new Date().toISOString().split('T')[0];
                victorSaveProducts();
                if (btn) { btn.innerHTML = '‚ùå Not found'; setTimeout(() => { btn.innerHTML = origText; btn.disabled = false; }, 2000); }
                victorLog('‚ö†Ô∏è Could not find updated MSDS for ' + product.name + ' ‚Äî will retry 2nd Sunday next month');
            }
        } catch (err) {
            if (btn) { btn.innerHTML = '‚ùå Error'; setTimeout(() => { btn.innerHTML = origText; btn.disabled = false; }, 2000); }
            victorLog('‚ùå Update error: ' + err.message);
        }
    }

    // ‚ïê‚ïê‚ïê VICTOR AUTO-UPDATE ENGINE ‚ïê‚ïê‚ïê
    // Automatically refreshes expiring/expired MSDS without user interaction.
    // Processes one product at a time, skips recently checked ones (7-day cooldown).
    function victorStartAutoUpdate() {
        if (victorAutoUpdateRunning) return;
        if (!getApiKey()) {
            victorLog('üîç Auto-update skipped ‚Äî no API key configured');
            return;
        }

        // Build queue: products expiring within 12 months or already expired
        // - First attempt: normal 7-day cooldown
        // - If no newer MSDS was found: retry only on the 2nd Sunday of each month
        const now = Date.now();
        const currentMonth = new Date().toISOString().substring(0, 7); // e.g. "2026-02"
        const isRetryWindow = victorIsSecondSundayWindow();
        victorAutoUpdateQueue = [];
        victorProducts.forEach((p, i) => {
            if (!victorExpiresSoon(p.msds_date, 12)) return; // only expiring/expired

            // If previous check found no update ‚Äî only retry on 2nd Sunday of a NEW month
            if (p.lastUpdateResult === 'no-update') {
                if (p.lastUpdateMonth === currentMonth) return; // already tried this month
                if (!isRetryWindow) return; // not the 2nd Sunday window
                victorAutoUpdateQueue.push(i);
                return;
            }

            // Normal cooldown for products not yet checked or previously updated
            const lastChecked = p.lastUpdated ? new Date(p.lastUpdated).getTime() : 0;
            if ((now - lastChecked) < VICTOR_AUTO_UPDATE_COOLDOWN) return;
            victorAutoUpdateQueue.push(i);
        });

        if (victorAutoUpdateQueue.length === 0) {
            victorLog('üîç All MSDS up to date ‚Äî nothing to auto-refresh');
            return;
        }

        victorAutoUpdateRunning = true;
        victorLog('üîÑ Auto-updating ' + victorAutoUpdateQueue.length + ' MSDS that need refresh...');
        victorProcessAutoQueue();
    }

    async function victorProcessAutoQueue() {
        if (victorAutoUpdateQueue.length === 0) {
            victorAutoUpdateRunning = false;
            victorLog('‚úÖ Auto-update complete');
            victorUpdateDashboard();
            return;
        }

        const index = victorAutoUpdateQueue.shift();
        const product = victorProducts[index];
        if (!product) { victorProcessAutoQueue(); return; }

        const remaining = victorAutoUpdateQueue.length;
        const compliance = victorCalcCompliance(product.msds_date);
        const icon = compliance === 'expired' ? 'üî¥' : 'üü†';
        victorLog(icon + ' Updating ' + product.name + '... (' + (remaining) + ' remaining)');

        // Re-use the existing victorUpdate function but without a button reference
        await victorUpdate(index, null);

        // Brief pause between requests to avoid rate limiting
        setTimeout(() => victorProcessAutoQueue(), 2000);
    }

    async function victorSearch() {
        const productName = document.getElementById('victorProductName').value.trim();
        const manufacturer = document.getElementById('victorManufacturer').value.trim();
        if (!productName) { alert('Enter a product name'); return; }

        const console_el = document.getElementById('victorConsole');
        const searching = document.getElementById('victorSearching');
        const results = document.getElementById('victorResults');
        const content = document.getElementById('victorResultContent');

        searching.style.display = 'block';
        results.style.display = 'none';
        console_el.textContent = 'üîç Searching for MSDS: ' + productName + '...';

        try {
            // Look up known SDS portal for manufacturer
            const searchPortal = victorGetPortal(manufacturer || productName);
            const searchPortalHint = searchPortal
                ? '\n\nKNOWN SDS SOURCE:\n' +
                  '- Manufacturer website: ' + searchPortal.url + '\n' +
                  (searchPortal.sds ? '- SDS portal/CDN: ' + searchPortal.sds + '\n' : '') +
                  '- Tip: ' + searchPortal.note + '\n'
                : '';

            const searchPrompt = 'Find the Safety Data Sheet (SDS/MSDS) PDF URL for:\n' +
                'Product: ' + productName + '\n' +
                (manufacturer ? 'Manufacturer: ' + manufacturer + '\n' : '') +
                searchPortalHint +
                '\nSearch Strategy:\n' +
                (searchPortal ? '1. Check the known SDS source/portal listed above FIRST\n' : '') +
                (searchPortal ? '2' : '1') + '. Search the manufacturer official website\n' +
                (searchPortal ? '3' : '2') + '. Look for Australian (.com.au) sources\n' +
                (searchPortal ? '4' : '3') + '. Find direct PDF download links ending in .pdf\n' +
                (searchPortal ? '5' : '4') + '. Avoid aggregator sites (Scribd, SlideShare, DocPlayer)\n' +
                '\nReturn a JSON response with EXACTLY this format:\n' +
                '{"msds_url": "https://...pdf or NOT_FOUND", "manufacturer": "detected manufacturer name", "msds_date": "YYYY-MM-DD or unknown", "hazard_class": "hazard class or unknown", "signal_word": "Danger/Warning/None", "summary": "brief 1-2 sentence summary of the product and its hazards"}\n' +
                'Return ONLY valid JSON, nothing else.';

            const result = await callClaudeAPI(
                [{ role: 'user', content: searchPrompt }],
                {
                    model: 'claude-3-5-haiku-20241022',
                    maxTokens: 1024,
                    tools: [{ type: 'web_search_20250305', name: 'web_search', max_uses: 4 }]
                }
            );

            // Extract text from response
            let text = '';
            if (result.content) {
                for (const block of result.content) {
                    if (block.type === 'text') text += block.text;
                }
            }

            // Parse JSON from response
            let data;
            try {
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                data = jsonMatch ? JSON.parse(jsonMatch[0]) : null;
            } catch (e) {
                data = { summary: text, msds_url: 'NOT_FOUND' };
            }

            if (data) {
                const found = data.msds_url && data.msds_url !== 'NOT_FOUND';
                const now = new Date().toISOString().split('T')[0];
                // Use shared compliance calculator (5-year lifespan, 1-year warning window)
                let compliance = victorCalcCompliance(data.msds_date);

                content.innerHTML =
                    '<div style="padding:10px;">' +
                    '<div style="font-size:14px;color:#fff;margin-bottom:8px;"><strong>' + escapeHtml(productName) + '</strong></div>' +
                    (data.manufacturer ? '<p style="font-size:13px;color:#aaa;">Manufacturer: ' + escapeHtml(data.manufacturer) + '</p>' : '') +
                    (data.summary ? '<p style="font-size:13px;color:#ccc;margin-top:8px;">' + escapeHtml(data.summary) + '</p>' : '') +
                    (data.msds_date && data.msds_date !== 'unknown' ? '<p style="font-size:13px;color:#aaa;margin-top:4px;">MSDS Date: ' + escapeHtml(data.msds_date) + ' (' + compliance + ')</p>' : '') +
                    (data.hazard_class && data.hazard_class !== 'unknown' ? '<p style="font-size:13px;color:#aaa;">Hazard: ' + escapeHtml(data.hazard_class) + '</p>' : '') +
                    (data.signal_word && data.signal_word !== 'None' && data.signal_word !== 'unknown' ? '<p style="font-size:13px;color:#f2994a;font-weight:600;">Signal Word: ' + escapeHtml(data.signal_word) + '</p>' : '') +
                    (found ? '<a href="' + escapeHtml(data.msds_url) + '" target="_blank" style="display:inline-block;margin-top:10px;padding:8px 16px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:8px;color:#fff;text-decoration:none;font-size:13px;">üìÑ Open MSDS PDF</a>' : '<p style="color:#f44336;margin-top:8px;">MSDS not found online. Try a different product name or add manually.</p>') +
                    '<br><button onclick="victorSaveResult()" style="margin-top:10px;padding:8px 16px;background:linear-gradient(135deg,#4CAF50,#45a049);border:none;border-radius:8px;color:#fff;cursor:pointer;font-size:13px;">üíæ Save to Tracked Products</button>' +
                    '</div>';

                // Store temp result for saving
                window._victorLastResult = {
                    name: productName,
                    manufacturer: data.manufacturer || manufacturer || '',
                    msds_url: found ? data.msds_url : '',
                    msds_date: data.msds_date !== 'unknown' ? data.msds_date : '',
                    compliance: compliance,
                    hazard_class: data.hazard_class || '',
                    signal_word: data.signal_word || '',
                    summary: data.summary || '',
                    searched: now
                };

                results.style.display = 'block';
                console_el.textContent = found ? '‚úÖ MSDS found for ' + productName : '‚ö†Ô∏è MSDS not found online for ' + productName;
            }
        } catch (error) {
            content.innerHTML = '<p style="color:#f44336;padding:10px;">' + escapeHtml(error.message) + '</p>';
            results.style.display = 'block';
            console_el.textContent = '‚ùå Error: ' + error.message;
        } finally {
            searching.style.display = 'none';
        }
    }

    function victorSaveResult() {
        if (!window._victorLastResult) return;
        victorProducts.unshift(window._victorLastResult);
        victorSaveProducts();
        victorRenderProducts();
        document.getElementById('victorConsole').textContent = 'üíæ Product saved: ' + window._victorLastResult.name;
        window._victorLastResult = null;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FRANK - SWMS GENERATOR (Firebase-synced across all devices)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let frankHistory = [];
    let frankFirebaseListenerActive = false;

    function frankSaveHistory() {
        if (firebaseDb) {
            try {
                firebaseDb.ref('jmart-safety/frank/history').set(frankHistory);
            } catch (e) { console.warn('Frank Firebase save failed:', e.message); }
        }
        localStorage.setItem('frank-history', JSON.stringify(frankHistory));
    }

    function frankStartSync() {
        if (!firebaseDb || frankFirebaseListenerActive) return;
        frankFirebaseListenerActive = true;
        firebaseDb.ref('jmart-safety/frank/history').on('value', (snap) => {
            const data = snap.val();
            if (data && Array.isArray(data)) {
                frankHistory = data;
                localStorage.setItem('frank-history', JSON.stringify(data));
            } else if (data === null) {
                const local = JSON.parse(localStorage.getItem('frank-history') || '[]');
                if (local.length > 0) {
                    frankHistory = local;
                    firebaseDb.ref('jmart-safety/frank/history').set(local);
                }
            }
            frankRenderHistory();
        });
    }

    function frankRenderHistory() {
        const list = document.getElementById('frankRecentList');
        const empty = document.getElementById('frankEmptyMsg');
        if (!list) return;
        if (frankHistory.length === 0) {
            list.innerHTML = '';
            if (empty) empty.style.display = 'block';
            return;
        }
        if (empty) empty.style.display = 'none';
        list.innerHTML = frankHistory.slice(0, 10).map((h, i) =>
            '<div style="background:rgba(16,185,129,0.05);border:1px solid rgba(16,185,129,0.15);border-radius:8px;padding:10px;margin-bottom:6px;cursor:pointer;" onclick="frankShowSaved(' + i + ')">' +
            '<div style="display:flex;justify-content:space-between;align-items:center;">' +
            '<div><strong style="color:#fff;font-size:13px;">' + escapeHtml(h.jobDesc.substring(0, 50)) + (h.jobDesc.length > 50 ? '...' : '') + '</strong>' +
            '<br><span style="font-size:11px;color:#888;">' + escapeHtml(h.date) + (h.jobNumber ? ' | Job #' + escapeHtml(h.jobNumber) : '') + '</span></div>' +
            '<button onclick="event.stopPropagation();frankRemoveHistory(' + i + ')" style="color:#f44336;background:none;border:none;cursor:pointer;font-size:14px;">‚úï</button>' +
            '</div></div>'
        ).join('');
    }

    function frankRemoveHistory(index) {
        frankHistory.splice(index, 1);
        frankSaveHistory();
        frankRenderHistory();
    }

    function frankShowSaved(index) {
        const h = frankHistory[index];
        if (!h) return;
        document.getElementById('frankResultContent').innerHTML = h.html;
        document.getElementById('frankResult').classList.add('active', 'success');
        document.getElementById('frankResult').classList.remove('error');
    }

    // Frank helper functions - Quick Task selection
    function frankSelectTask(taskDesc) {
        document.getElementById('frankJobDesc').value = taskDesc;
        document.querySelectorAll('.frank-quick-btn').forEach(btn => {
            btn.classList.remove('selected');
            if (btn.textContent && taskDesc.toLowerCase().includes(btn.textContent.replace(/^.{2}/, '').trim().toLowerCase().split(' ')[0].toLowerCase())) {
                btn.classList.add('selected');
            }
        });
        frankLog('Selected: ' + taskDesc.substring(0, 50) + '...');
    }

    // Frank helper functions - Worker selection
    function frankSelectAllWorkers() {
        document.querySelectorAll('#frankWorkersGrid input[type="checkbox"]').forEach(cb => cb.checked = true);
        frankUpdateWorkerCount();
    }

    function frankClearAllWorkers() {
        document.querySelectorAll('#frankWorkersGrid input[type="checkbox"]').forEach(cb => cb.checked = false);
        frankUpdateWorkerCount();
    }

    function frankUpdateWorkerCount() {
        const checked = document.querySelectorAll('#frankWorkersGrid input[type="checkbox"]:checked').length;
        document.getElementById('frankWorkerCount').textContent = checked + ' worker' + (checked !== 1 ? 's' : '') + ' selected';
    }

    function frankLog(msg) {
        document.getElementById('frankConsole').innerHTML = 'ü¶∫ ' + msg;
    }

    // Setup worker checkbox listeners on DOM ready
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('#frankWorkersGrid input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', frankUpdateWorkerCount);
        });
    });

    async function frankGenerate() {
        const jobDesc = document.getElementById('frankJobDesc').value.trim();
        const jobNumber = document.getElementById('frankJobNumber').value.trim();
        const location = document.getElementById('frankLocation').value.trim();
        const builder = document.getElementById('frankBuilder').value;

        // Get selected workers from checkboxes
        const workers = [];
        document.querySelectorAll('#frankWorkersGrid input[type="checkbox"]:checked').forEach(cb => {
            workers.push(cb.value);
        });
        const workersStr = workers.join(', ');

        if (!jobDesc || jobDesc.length < 3) {
            frankLog('Please enter a job description or select a quick task!');
            return;
        }

        const btn = document.getElementById('frankGenerateBtn');
        const console_el = document.getElementById('frankConsole');
        const resultEl = document.getElementById('frankResult');
        const content = document.getElementById('frankResultContent');
        const badgesEl = document.getElementById('frankResultBadges');

        // Show progress bar, disable button
        btn.disabled = true;
        btn.textContent = 'ü¶∫ Generating...';
        document.getElementById('frankProgress').classList.add('active');
        resultEl.classList.remove('active', 'success', 'error');
        frankLog('Generating SWMS - this may take 30-60 seconds...');

        // Animate progress bar
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress = Math.min(progress + Math.random() * 5, 90);
            document.getElementById('frankProgressFill').style.width = progress + '%';
        }, 500);

        const today = new Date().toLocaleDateString('en-AU', { day: '2-digit', month: '2-digit', year: 'numeric' });
        const workerList = workers.length > 0 ? workers : [''];

        try {
            const systemPrompt = 'You are FRANK, Australia\'s best AI Safety Manager for steel fabrication. ' +
                'You specialize in creating Safe Work Method Statements (SWMS) for structural steel installation. ' +
                'You ALWAYS reference relevant AS/NZS standards:\n' +
                '- AS/NZS 1554 (Structural Steel Welding)\n- AS 1657 (Fixed Platforms, Walkways, Stairways)\n' +
                '- AS/NZS 4576 (Scaffolding)\n- AS/NZS 1891 (Industrial Fall Arrest)\n' +
                '- AS 2550 (Cranes - Safe Use)\n- AS 4991 (Lifting Equipment)\n\n' +
                'You write clear, actionable safety procedures that protect workers and comply with Australian WHS legislation.';

            const userPrompt = 'Generate a complete SWMS for the following job. Return ONLY valid JSON.\n\n' +
                'Job Description: ' + jobDesc + '\n' +
                (jobNumber ? 'Job Number: ' + jobNumber + '\n' : '') +
                (location ? 'Location: ' + location + '\n' : '') +
                (builder ? 'Builder/Client: ' + builder + '\n' : '') +
                'Date: ' + today + '\n' +
                (workersStr ? 'Workers: ' + workersStr + '\n' : '') +
                '\nReturn JSON with this EXACT format:\n' +
                '{\n' +
                '  "title": "Short SWMS title",\n' +
                '  "detailed_description": "Detailed technical description of the work (2-3 sentences)",\n' +
                '  "high_risk_categories": ["list of applicable high-risk work categories"],\n' +
                '  "ppe_required": ["list of PPE items"],\n' +
                '  "plant_equipment": ["list of plant and equipment"],\n' +
                '  "steps": [\n' +
                '    {\n' +
                '      "step_number": "1",\n' +
                '      "job_step": "Description of step",\n' +
                '      "hazards": "List hazards for this step",\n' +
                '      "risk_level": "H/M/L",\n' +
                '      "controls": "Specific control measures referencing standards"\n' +
                '    }\n' +
                '  ],\n' +
                '  "emergency_procedures": "Site-specific emergency procedures",\n' +
                '  "standards": ["list of applicable AS/NZS standards"]\n' +
                '}\n' +
                'Generate 6-10 detailed steps. Each step must have specific hazards and controls referencing Australian standards.';

            const result = await callClaudeAPI(
                [{ role: 'user', content: userPrompt }],
                {
                    model: 'claude-sonnet-4-5-20250929',
                    maxTokens: 4000,
                    temperature: 0,
                    system: systemPrompt
                }
            );

            clearInterval(progressInterval);
            document.getElementById('frankProgressFill').style.width = '100%';

            let text = '';
            if (result.content) {
                for (const block of result.content) {
                    if (block.type === 'text') text += block.text;
                }
            }

            let data;
            try {
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                data = jsonMatch ? JSON.parse(jsonMatch[0]) : null;
            } catch (e) {
                data = null;
            }

            if (!data || !data.steps) {
                throw new Error('Could not parse SWMS response. Please try again.');
            }

            // Build SWMS HTML display
            let html = '<div id="frankSwmsContent" style="background:#1a1a2e;padding:16px;border-radius:8px;">';
            html += '<div style="text-align:center;border-bottom:2px solid #10b981;padding-bottom:12px;margin-bottom:16px;">';
            html += '<h2 style="color:#fff;margin:0;">SAFE WORK METHOD STATEMENT</h2>';
            html += '<p style="color:#aaa;margin:4px 0;">J&M Artsteel Pty Ltd</p>';
            html += '</div>';

            // Job details table
            html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px;font-size:13px;">';
            html += '<div><span style="color:#888;">Job:</span> <span style="color:#fff;">' + escapeHtml(jobDesc) + '</span></div>';
            html += '<div><span style="color:#888;">Date:</span> <span style="color:#fff;">' + today + '</span></div>';
            if (jobNumber) html += '<div><span style="color:#888;">Job #:</span> <span style="color:#fff;">' + escapeHtml(jobNumber) + '</span></div>';
            if (location) html += '<div><span style="color:#888;">Location:</span> <span style="color:#fff;">' + escapeHtml(location) + '</span></div>';
            if (builder) html += '<div><span style="color:#888;">Builder:</span> <span style="color:#fff;">' + escapeHtml(builder) + '</span></div>';
            if (workersStr) html += '<div><span style="color:#888;">Workers:</span> <span style="color:#fff;">' + escapeHtml(workersStr) + '</span></div>';
            html += '</div>';

            // Description
            if (data.detailed_description) {
                html += '<div style="background:rgba(16,185,129,0.1);padding:10px;border-radius:6px;margin-bottom:12px;font-size:13px;color:#ccc;">' + escapeHtml(data.detailed_description) + '</div>';
            }

            // High risk categories
            if (data.high_risk_categories && data.high_risk_categories.length) {
                html += '<div style="margin-bottom:12px;"><strong style="color:#f2994a;font-size:13px;">High Risk Categories:</strong> <span style="color:#fff;font-size:13px;">' + data.high_risk_categories.map(c => escapeHtml(c)).join(', ') + '</span></div>';
            }

            // PPE
            if (data.ppe_required && data.ppe_required.length) {
                html += '<div style="margin-bottom:12px;"><strong style="color:#4CAF50;font-size:13px;">PPE Required:</strong> <span style="color:#fff;font-size:13px;">' + data.ppe_required.map(p => escapeHtml(p)).join(', ') + '</span></div>';
            }

            // Plant & Equipment
            if (data.plant_equipment && data.plant_equipment.length) {
                html += '<div style="margin-bottom:16px;"><strong style="color:#10b981;font-size:13px;">Plant & Equipment:</strong> <span style="color:#fff;font-size:13px;">' + data.plant_equipment.map(p => escapeHtml(p)).join(', ') + '</span></div>';
            }

            // Steps table
            html += '<div style="overflow-x:auto;">';
            html += '<table style="width:100%;border-collapse:collapse;font-size:12px;margin-bottom:16px;">';
            html += '<thead><tr style="background:rgba(16,185,129,0.2);">' +
                '<th style="padding:8px;color:#10b981;text-align:left;border-bottom:1px solid rgba(255,255,255,0.1);">#</th>' +
                '<th style="padding:8px;color:#10b981;text-align:left;border-bottom:1px solid rgba(255,255,255,0.1);">Job Step</th>' +
                '<th style="padding:8px;color:#10b981;text-align:left;border-bottom:1px solid rgba(255,255,255,0.1);">Hazards</th>' +
                '<th style="padding:8px;color:#10b981;text-align:left;border-bottom:1px solid rgba(255,255,255,0.1);">Risk</th>' +
                '<th style="padding:8px;color:#10b981;text-align:left;border-bottom:1px solid rgba(255,255,255,0.1);">Controls</th>' +
                '</tr></thead><tbody>';
            data.steps.forEach(step => {
                const riskColor = step.risk_level === 'H' ? '#f44336' : step.risk_level === 'M' ? '#f2994a' : '#4CAF50';
                html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.05);">' +
                    '<td style="padding:8px;color:#fff;vertical-align:top;">' + escapeHtml(step.step_number) + '</td>' +
                    '<td style="padding:8px;color:#fff;vertical-align:top;">' + escapeHtml(step.job_step) + '</td>' +
                    '<td style="padding:8px;color:#f2994a;vertical-align:top;">' + escapeHtml(step.hazards) + '</td>' +
                    '<td style="padding:8px;vertical-align:top;"><span style="color:' + riskColor + ';font-weight:600;">' + escapeHtml(step.risk_level) + '</span></td>' +
                    '<td style="padding:8px;color:#4CAF50;vertical-align:top;">' + escapeHtml(step.controls) + '</td>' +
                    '</tr>';
            });
            html += '</tbody></table></div>';

            // Emergency procedures
            if (data.emergency_procedures) {
                html += '<div style="background:rgba(244,67,54,0.1);padding:10px;border-radius:6px;margin-bottom:12px;">' +
                    '<strong style="color:#f44336;font-size:13px;">Emergency Procedures:</strong>' +
                    '<p style="color:#ccc;font-size:13px;margin-top:4px;">' + escapeHtml(data.emergency_procedures) + '</p></div>';
            }

            // Standards
            if (data.standards && data.standards.length) {
                html += '<div style="margin-bottom:12px;"><strong style="color:#888;font-size:12px;">Applicable Standards:</strong> <span style="color:#aaa;font-size:12px;">' + data.standards.map(s => escapeHtml(s)).join(', ') + '</span></div>';
            }

            // Worker sign-off area
            html += '<div style="border-top:1px solid rgba(255,255,255,0.1);padding-top:12px;margin-top:12px;">';
            html += '<strong style="color:#fff;font-size:13px;">Worker Sign-Off</strong>';
            html += '<p style="color:#aaa;font-size:12px;margin-top:4px;">I have read and understand this SWMS. I agree to follow the controls listed.</p>';
            html += '<div style="margin-top:8px;">';
            workerList.forEach(w => {
                html += '<div style="display:flex;justify-content:space-between;border-bottom:1px dotted rgba(255,255,255,0.2);padding:8px 0;font-size:13px;">' +
                    '<span style="color:#fff;">' + escapeHtml(w || '________________') + '</span>' +
                    '<span style="color:#888;">Signature: ________________</span>' +
                    '</div>';
            });
            html += '</div></div>';
            html += '</div>';

            content.innerHTML = html;

            // Show result badges
            let badges = '';
            if (data.title) {
                badges += '<span class="frank-badge">üìã ' + escapeHtml(data.title) + '</span>';
            }
            if (data.high_risk_categories && data.high_risk_categories.length > 0) {
                data.high_risk_categories.forEach(cat => {
                    badges += '<span class="frank-badge">‚ö†Ô∏è ' + escapeHtml(cat) + '</span>';
                });
            }
            if (data.steps) {
                badges += '<span class="frank-badge">üìù ' + data.steps.length + ' steps</span>';
            }
            badgesEl.innerHTML = badges;

            resultEl.classList.add('active', 'success');
            resultEl.classList.remove('error');
            frankLog('SWMS generated: ' + (data.title || jobDesc));

            // Save to history
            frankHistory.unshift({
                jobDesc: jobDesc,
                jobNumber: jobNumber,
                location: location,
                date: today,
                html: html
            });
            if (frankHistory.length > 20) frankHistory = frankHistory.slice(0, 20);
            frankSaveHistory();
            frankRenderHistory();

        } catch (error) {
            clearInterval(progressInterval);
            resultEl.classList.add('active', 'error');
            resultEl.classList.remove('success');
            content.innerHTML = '<p style="color:#f44336;padding:10px;">' + escapeHtml(error.message) + '</p>';
            badgesEl.innerHTML = '';
            frankLog('Error: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'ü¶∫ Generate SWMS';
            document.getElementById('frankProgress').classList.remove('active');
            document.getElementById('frankProgressFill').style.width = '0%';
        }
    }

    function frankPrint() {
        const swmsContent = document.getElementById('frankSwmsContent');
        if (!swmsContent) return;
        const printWindow = window.open('', '_blank');
        printWindow.document.write('<html><head><title>SWMS - J&M Artsteel</title>' +
            '<style>body{font-family:Arial,sans-serif;background:#fff;color:#000;padding:20px;} ' +
            'table{width:100%;border-collapse:collapse;} th,td{border:1px solid #ccc;padding:8px;text-align:left;font-size:12px;} ' +
            'th{background:#f0f0f0;font-weight:bold;} h2{text-align:center;} ' +
            'div{color:#000 !important;} span{color:#000 !important;} strong{color:#000 !important;} p{color:#000 !important;} td{color:#000 !important;}</style></head><body>');
        printWindow.document.write(swmsContent.innerHTML);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.print();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // INITIALIZATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    document.addEventListener('DOMContentLoaded', async () => {
        // Check device authorization first
        const authResult = await SteelAuth.init();
        if (!authResult.approved) {
            SteelAuth.showPendingScreen();
            return; // Don't initialize app if not approved
        }

        // Device approved - initialize app
        hobartUpdate();
        // IGOR dropdowns are already in HTML
        chuckGetLocation(); // Get weather/temp on load
        chuckUpdateSizes(); // Set up size buttons for default type
        chuckCalculate();
        brittanyUpdateSizes(); // Set up size buttons for default type
        brittanyCalculate();
        hannaInit(); // Initialize HANNA receipt scanner
        loadApiKeyStatus(); // Show API key status in settings

        // Start Firebase sync for Victor, Frank & Hanna (real-time across all devices)
        victorStartSync();
        frankStartSync();
        hannaStartSync();
        // Fallback render from localStorage if Firebase hasn't loaded yet
        if (!victorFirebaseListenerActive) {
            const localVictor = JSON.parse(localStorage.getItem('victor-products') || '[]');
            victorProducts = localVictor.length > 0 ? localVictor : VICTOR_SEED_DATA.slice();
            victorRenderProducts();
        }
        if (!frankFirebaseListenerActive) { frankHistory = JSON.parse(localStorage.getItem('frank-history') || '[]'); frankRenderHistory(); }

        // Log access
        console.log('üî© J&M Artsteel Hub loaded. Admin:', SteelAuth.isAdmin);
    });
    </script>
</body>
</html>
