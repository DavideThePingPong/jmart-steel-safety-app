{
  "rules": {
    // DEFAULT DENY â€” anything not explicitly allowed is blocked
    ".read": false,
    ".write": false,

    "jmart-safety": {
      // Config - authenticated devices can read, admins can write (or first setup)
      "config": {
        ".read": "auth != null",
        ".write": "auth != null"
      },

      // Devices - hierarchical structure: devices/approved/{id}, devices/pending/{id}, devices/denied/{id}
      // Any authenticated user can read device info and register/update their own
      "devices": {
        "approved": {
          ".read": "auth != null",
          "$deviceId": {
            ".read": "auth != null",
            ".write": "auth != null"
          }
        },
        "pending": {
          ".read": "auth != null",
          "$deviceId": {
            ".read": "auth != null",
            ".write": "auth != null"
          }
        },
        "denied": {
          ".read": "auth != null",
          "$deviceId": {
            ".read": "auth != null",
            ".write": "auth != null"
          }
        },
        // Legacy flat device entries (for migration)
        "$deviceId": {
          ".read": "auth != null",
          ".write": "auth != null"
        }
      },

      // Forms - any authenticated device can read/write (password is the gate)
      "forms": {
        ".read": "auth != null",
        "$formId": {
          ".write": "auth != null",
          ".validate": "newData.hasChildren(['id', 'type', 'createdAt', 'createdBy']) && newData.child('type').isString() && newData.child('type').val().length < 100 && newData.child('createdBy').isString() && newData.child('createdBy').val().length < 200"
        }
      },

      // Jobs - managed job entries for forms and photo uploads
      "jobs": {
        ".read": "auth != null",
        ".write": "auth != null"
      },

      // Sites - any authenticated device can read/write
      "sites": {
        ".read": "auth != null",
        ".write": "auth != null"
      },

      // Training - any authenticated device can read/write
      "training": {
        ".read": "auth != null",
        "$recordId": {
          ".write": "auth != null",
          ".validate": "newData.hasChildren(['type', 'createdAt']) && newData.child('type').isString() && newData.child('type').val().length < 200"
        }
      },

      // Victor - MSDS products (authenticated devices only)
      "victor": {
        "products": {
          ".read": "auth != null",
          ".write": "auth != null"
        }
      },

      // Frank - SWMS history (authenticated devices only)
      "frank": {
        "history": {
          ".read": "auth != null",
          ".write": "auth != null"
        }
      },

      // Hanna - Receipts (authenticated devices only)
      "hanna": {
        "receipts": {
          ".read": "auth != null",
          ".write": "auth != null"
        }
      },

      // Audit log - any authenticated user can read, append only (no deletes/updates)
      "auditLog": {
        ".read": "auth != null",
        "$logId": {
          ".write": "!data.exists()",
          ".validate": "newData.hasChildren(['action', 'deviceId', 'timestamp']) && newData.child('action').isString() && newData.child('action').val().length < 500 && newData.child('deviceId').isString() && newData.child('timestamp').isNumber()"
        }
      }
    },

    // Signatures - any authenticated device can read/write
    "signatures": {
      "$signatureId": {
        ".read": "auth != null",
        ".write": "auth != null && newData.child('ownerId').val() === auth.uid",
        ".validate": "newData.hasChildren(['ownerId', 'data']) && newData.child('ownerId').isString() && newData.child('data').isString() && newData.child('data').val().length < 500000"
      }
    }
  }
}
