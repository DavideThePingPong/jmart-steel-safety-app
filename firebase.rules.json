{
  "rules": {
    // DEFAULT DENY — anything not explicitly allowed is blocked
    ".read": false,
    ".write": false,

    "jmart-safety": {
      // Admin Auth UIDs — maps Firebase auth UIDs to admin status
      // Only writable by existing admins or during first-device setup (no approved devices yet)
      "adminAuthUids": {
        ".read": "auth != null",
        "$uid": {
          ".write": "auth != null && (root.child('jmart-safety/adminAuthUids/' + auth.uid).exists() || !root.child('jmart-safety/devices/approved').exists())",
          ".validate": "newData.isBoolean()"
        }
      },

      // Config - authenticated devices can read; only admins or first-time setup can write
      "config": {
        ".read": "auth != null",
        ".write": "auth != null && (!data.child('appPasswordHash').exists() || root.child('jmart-safety/adminAuthUids/' + auth.uid).exists())"
      },

      // Devices - hierarchical structure: devices/approved/{id}, devices/pending/{id}, devices/denied/{id}
      "devices": {
        "approved": {
          ".read": "auth != null",
          "$deviceId": {
            ".read": "auth != null",
            // Allow write ONLY if:
            //   (a) No approved devices exist yet (first-device setup), OR
            //   (b) Writer is an existing admin (auth.uid in adminAuthUids), OR
            //   (c) Writer is updating their own existing record (authUid matches)
            ".write": "auth != null && (!root.child('jmart-safety/devices/approved').exists() || root.child('jmart-safety/adminAuthUids/' + auth.uid).exists() || (data.exists() && data.child('authUid').val() === auth.uid))"
          }
        },
        "pending": {
          ".read": "auth != null",
          "$deviceId": {
            ".read": "auth != null",
            // Allow write for:
            //   (a) Self-registration (new data where authUid matches auth.uid), OR
            //   (b) Admin operations (approve/deny/cleanup), OR
            //   (c) Deletion (removing from pending after approval)
            ".write": "auth != null && (root.child('jmart-safety/adminAuthUids/' + auth.uid).exists() || (newData.exists() && newData.child('authUid').val() === auth.uid) || !newData.exists())"
          }
        },
        "denied": {
          ".read": "auth != null",
          "$deviceId": {
            ".read": "auth != null",
            // Only admins can deny devices
            ".write": "auth != null && root.child('jmart-safety/adminAuthUids/' + auth.uid).exists()"
          }
        },
        // Legacy flat device entries (for migration) - admin or self-migration only
        "$deviceId": {
          ".read": "auth != null",
          ".write": "auth != null && (root.child('jmart-safety/adminAuthUids/' + auth.uid).exists() || (data.exists() && data.child('authUid').val() === auth.uid) || !root.child('jmart-safety/devices/approved').exists())"
        }
      },

      // Forms - any authenticated device can read/write (password is the gate)
      "forms": {
        ".read": "auth != null",
        "$formId": {
          ".write": "auth != null",
          ".validate": "newData.hasChildren(['id', 'type', 'createdAt', 'createdBy']) && newData.child('type').isString() && newData.child('type').val().length < 100 && newData.child('createdBy').isString() && newData.child('createdBy').val().length < 200"
        }
      },

      // Jobs - managed job entries for forms and photo uploads
      "jobs": {
        ".read": "auth != null",
        ".write": "auth != null"
      },

      // Sites - any authenticated device can read/write
      "sites": {
        ".read": "auth != null",
        ".write": "auth != null"
      },

      // Training - any authenticated device can read/write
      "training": {
        ".read": "auth != null",
        "$recordId": {
          ".write": "auth != null",
          ".validate": "newData.hasChildren(['type', 'createdAt']) && newData.child('type').isString() && newData.child('type').val().length < 200"
        }
      },

      // Victor - MSDS products (authenticated devices only)
      "victor": {
        "products": {
          ".read": "auth != null",
          ".write": "auth != null"
        }
      },

      // Frank - SWMS history (authenticated devices only)
      "frank": {
        "history": {
          ".read": "auth != null",
          ".write": "auth != null"
        }
      },

      // Hanna - Receipts (authenticated devices only)
      "hanna": {
        "receipts": {
          ".read": "auth != null",
          ".write": "auth != null"
        }
      },

      // Notifications - authenticated devices can read/write
      "notifications": {
        ".read": "auth != null",
        ".write": "auth != null"
      },

      // Audit log - any authenticated user can read, append only (no deletes/updates)
      "auditLog": {
        ".read": "auth != null",
        "$logId": {
          ".write": "!data.exists()",
          ".validate": "newData.hasChildren(['action', 'deviceId', 'timestamp']) && newData.child('action').isString() && newData.child('action').val().length < 500 && newData.child('deviceId').isString() && newData.child('timestamp').isNumber()"
        }
      }
    },

    // Signatures - any authenticated device can read/write
    "signatures": {
      "$signatureId": {
        ".read": "auth != null",
        ".write": "auth != null && newData.child('ownerId').val() === auth.uid",
        ".validate": "newData.hasChildren(['ownerId', 'data']) && newData.child('ownerId').isString() && newData.child('data').isString() && newData.child('data').val().length < 500000"
      }
    }
  }
}
