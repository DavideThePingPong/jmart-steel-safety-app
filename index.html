<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>J&M Artsteel Safety</title>

  <!-- PWA Meta Tags -->
  <meta name="application-name" content="J&M Artsteel Safety">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="J&M Artsteel Safety">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#ea580c">
  <meta name="msapplication-TileColor" content="#ea580c">
  <meta name="msapplication-tap-highlight" content="no">

  <!-- App Description for SEO/Sharing -->
  <meta name="description" content="J&M Artsteel Safety Management App - Pre-Start Checklists, Site Inspections, ITP Forms, Toolbox Talks, and Incident Reports">

  <!-- Favicon and App Icons (Base64 embedded) -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23ea580c'/><text x='50' y='65' font-size='50' text-anchor='middle' fill='white'>üõ°Ô∏è</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' rx='40' fill='%23ea580c'/><text x='90' y='115' font-size='80' text-anchor='middle' fill='white'>üõ°Ô∏è</text></svg>">

  <!-- Manifest for PWA -->
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkpNYXJ0IFN0ZWVsIFNhZmV0eSBBcHAiLAogICJzaG9ydF9uYW1lIjogIkpNYXJ0IFNhZmV0eSIsCiAgImRlc2NyaXB0aW9uIjogIlNhZmV0eSBtYW5hZ2VtZW50IGFwcCBmb3IgSk1hcnQgU3RlZWwgLSBOU1cgT3BlcmF0aW9ucyIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZjNmNGY2IiwKICAidGhlbWVfY29sb3IiOiAiI2VhNTgwYyIsCiAgIm9yaWVudGF0aW9uIjogInBvcnRyYWl0IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sLDxzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTkyIDE5Mic+PHJlY3Qgd2lkdGg9JzE5MicgaGVpZ2h0PScxOTInIHJ4PSc0MCcgZmlsbD0nJTIzZWE1ODBjJy8+PHRleHQgeD0nOTYnIHk9JzEyMCcgZm9udC1zaXplPSc4MCcgdGV4dC1hbmNob3I9J21pZGRsZScgZmlsbD0nd2hpdGUnPvCfm6HvuI88L3RleHQ+PC9zdmc+IiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIiwKICAgICAgInB1cnBvc2UiOiAiYW55IG1hc2thYmxlIgogICAgfQogIF0KfQ==">

  <!-- Scripts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Firebase SDK for Cloud Sync (Database + Auth + photos via Google Drive) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <!-- Google API for Drive Integration -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>

  <script>
    // ========================================
    // FIREBASE CONFIGURATION
    // ========================================
    // TODO: Replace these values with your Firebase config from the Firebase Console
    // Follow the setup guide: Firebase-Setup-Guide.docx
    // ========================================
    const firebaseConfig = {
      apiKey: "AIzaSyAECfytYqggzmQ-Kxm_vqQWlEnBJMXz5H4",
      authDomain: "jmart-steel-safety.firebaseapp.com",
      databaseURL: "https://jmart-steel-safety-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "jmart-steel-safety",
      storageBucket: "jmart-steel-safety.firebasestorage.app",
      messagingSenderId: "920798274486",
      appId: "1:920798274486:web:9d6cdd8853d82280665717"
    };

    // Check if Firebase is configured
    const isFirebaseConfigured = firebaseConfig.apiKey !== "YOUR_API_KEY_HERE";

    // Initialize Firebase only if configured
    let firebaseApp = null;
    let firebaseDb = null;
    let firebaseAuthUid = null;

    if (isFirebaseConfigured) {
      try {
        firebaseApp = firebase.initializeApp(firebaseConfig);
        firebaseDb = firebase.database();
        // Sign in anonymously so security rules can use auth.uid
        firebase.auth().signInAnonymously().then(cred => {
          firebaseAuthUid = cred.user.uid;
          console.log('Firebase connected, auth uid:', firebaseAuthUid);
        }).catch(err => {
          console.warn('Anonymous auth failed (app still works):', err.message);
        });
        console.log('Firebase connected successfully!');
      } catch (error) {
        console.error('Firebase initialization error:', error);
      }
    } else {
      console.log('Firebase not configured - running in local-only mode. See Firebase-Setup-Guide.docx for setup instructions.');
    }

    // ========================================
    // DEVICE AUTHORIZATION SYSTEM
    // ========================================
    // Controls which devices can access the app
    // First device to register becomes admin
    // New devices require admin approval
    // ========================================
    const DeviceAuth = {
      deviceId: null,
      deviceInfo: null,
      isApproved: false,
      isAdmin: false,
      canViewDevices: false,
      canRevokeDevices: false,
      pendingDevices: [],
      approvedDevices: [],
      statusListeners: [],
      notificationListeners: [],

      // Generate unique device fingerprint
      generateDeviceId: function() {
        const stored = localStorage.getItem('jmart-device-id');
        if (stored) {
          this.deviceId = stored;
          return stored;
        }

        // Create fingerprint from browser characteristics
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        ctx.textBaseline = 'top';
        ctx.font = '14px Arial';
        ctx.fillText('JMart Device Fingerprint', 2, 2);
        const canvasData = canvas.toDataURL();

        const fingerprint = [
          navigator.userAgent,
          navigator.language,
          screen.width + 'x' + screen.height,
          screen.colorDepth,
          new Date().getTimezoneOffset(),
          canvasData.slice(-50),
          navigator.hardwareConcurrency || 'unknown',
          navigator.platform
        ].join('|');

        // Simple hash function
        let hash = 0;
        for (let i = 0; i < fingerprint.length; i++) {
          const char = fingerprint.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash;
        }

        this.deviceId = 'DEV-' + Math.abs(hash).toString(36).toUpperCase() + '-' + Date.now().toString(36).toUpperCase();
        localStorage.setItem('jmart-device-id', this.deviceId);
        return this.deviceId;
      },

      // Get device info for display
      getDeviceInfo: function() {
        const ua = navigator.userAgent;
        let deviceType = 'Unknown Device';
        let browser = 'Unknown Browser';

        // Detect device type
        if (/iPhone/i.test(ua)) deviceType = 'iPhone';
        else if (/iPad/i.test(ua)) deviceType = 'iPad';
        else if (/Android/i.test(ua) && /Mobile/i.test(ua)) deviceType = 'Android Phone';
        else if (/Android/i.test(ua)) deviceType = 'Android Tablet';
        else if (/Windows/i.test(ua)) deviceType = 'Windows PC';
        else if (/Mac/i.test(ua)) deviceType = 'Mac';
        else if (/Linux/i.test(ua)) deviceType = 'Linux PC';

        // Detect browser
        if (/Chrome/i.test(ua) && !/Edg/i.test(ua)) browser = 'Chrome';
        else if (/Safari/i.test(ua) && !/Chrome/i.test(ua)) browser = 'Safari';
        else if (/Firefox/i.test(ua)) browser = 'Firefox';
        else if (/Edg/i.test(ua)) browser = 'Edge';

        this.deviceInfo = {
          id: this.deviceId,
          type: deviceType,
          browser: browser,
          screen: screen.width + 'x' + screen.height,
          registeredAt: new Date().toISOString(),
          lastSeen: new Date().toISOString()
        };

        return this.deviceInfo;
      },

      // Initialize device auth
      init: async function() {
        this.generateDeviceId();
        this.getDeviceInfo();
        console.log('Device ID:', this.deviceId);

        if (!firebaseDb || !isFirebaseConfigured) {
          // No Firebase - approve locally (offline mode)
          this.isApproved = true;
          this.isAdmin = true;
          this.notifyStatusListeners();
          return { approved: true, admin: true, offline: true };
        }

        // Check if this device is approved
        const result = await this.checkDeviceStatus();
        return result;
      },

      // Check device status in Firebase
      checkDeviceStatus: async function() {
        if (!firebaseDb) return { approved: false };

        try {
          // MIGRATION: Check for device in old flat structure and migrate
          const oldDeviceSnap = await firebaseDb.ref('jmart-safety/devices/' + this.deviceId).once('value');
          if (oldDeviceSnap.exists()) {
            const oldData = oldDeviceSnap.val();
            // Only migrate if it has status field (old format)
            if (oldData.status && typeof oldData.status === 'string') {
              console.log('üîÑ Migrating device from old path:', oldData.status);
              const targetPath = 'jmart-safety/devices/' + oldData.status + '/' + this.deviceId;
              await firebaseDb.ref(targetPath).set({
                ...oldData,
                id: this.deviceId,
                migratedAt: new Date().toISOString()
              });
              await firebaseDb.ref('jmart-safety/devices/' + this.deviceId).remove();
              console.log('‚úÖ Migration complete for device:', this.deviceId);
            }
          }

          // Also migrate ALL devices in old flat structure (admin cleanup)
          const allDevicesSnap = await firebaseDb.ref('jmart-safety/devices').once('value');
          if (allDevicesSnap.exists()) {
            const allDevices = allDevicesSnap.val();
            for (const [key, value] of Object.entries(allDevices)) {
              if (key === 'pending' || key === 'approved' || key === 'denied') continue;
              if (!value || typeof value !== 'object' || !value.status) continue;
              console.log('üîÑ Migrating device:', key);
              const targetPath = 'jmart-safety/devices/' + value.status + '/' + key;
              await firebaseDb.ref(targetPath).set({ ...value, id: key, migratedAt: new Date().toISOString() });
              await firebaseDb.ref('jmart-safety/devices/' + key).remove();
            }
          }

          // Check approved devices
          const approvedSnap = await firebaseDb.ref('jmart-safety/devices/approved/' + this.deviceId).once('value');
          if (approvedSnap.exists()) {
            const data = approvedSnap.val();
            this.isApproved = true;
            this.isAdmin = data.isAdmin || false;
            this.canViewDevices = data.canViewDevices || false;
            this.canRevokeDevices = data.canRevokeDevices || false;

            // Update last seen and auth UID (links Firebase Auth to device)
            const updates = { lastSeen: new Date().toISOString() };
            if (firebaseAuthUid) updates.authUid = firebaseAuthUid;
            await firebaseDb.ref('jmart-safety/devices/approved/' + this.deviceId).update(updates);

            this.notifyStatusListeners();
            console.log('Device approved, admin:', this.isAdmin, 'canViewDevices:', this.canViewDevices, 'canRevokeDevices:', this.canRevokeDevices);
            return { approved: true, admin: this.isAdmin, canViewDevices: this.canViewDevices, canRevokeDevices: this.canRevokeDevices };
          }

          // Check if any devices exist (first device becomes admin)
          const allApprovedSnap = await firebaseDb.ref('jmart-safety/devices/approved').once('value');
          if (!allApprovedSnap.exists() || allApprovedSnap.numChildren() === 0) {
            // First device - auto approve as admin
            console.log('First device - auto-approving as admin');
            await this.registerAsApproved(true);
            return { approved: true, admin: true, firstDevice: true };
          }

          // Check if already pending
          const pendingSnap = await firebaseDb.ref('jmart-safety/devices/pending/' + this.deviceId).once('value');
          if (!pendingSnap.exists()) {
            // Register as pending
            await this.registerAsPending();
          }

          this.isApproved = false;
          this.notifyStatusListeners();
          return { approved: false, pending: true };

        } catch (error) {
          console.error('Error checking device status:', error);
          return { approved: false, error: error.message };
        }
      },

      // Register device as pending approval
      registerAsPending: async function() {
        if (!firebaseDb) return;

        const deviceData = {
          ...this.deviceInfo,
          authUid: firebaseAuthUid || null,
          requestedAt: new Date().toISOString(),
          status: 'pending'
        };

        await firebaseDb.ref('jmart-safety/devices/pending/' + this.deviceId).set(deviceData);
        console.log('Device registered as pending approval');

        // Notify all admins of new device request
        this.notifyAdminsOfNewDevice(deviceData);
      },

      // Register device as approved
      registerAsApproved: async function(isAdmin = false) {
        if (!firebaseDb) return;

        const deviceData = {
          ...this.deviceInfo,
          authUid: firebaseAuthUid || null,
          isAdmin: isAdmin,
          approvedAt: new Date().toISOString(),
          approvedBy: isAdmin ? 'SYSTEM (First Device)' : 'Admin',
          lastSeen: new Date().toISOString()
        };

        await firebaseDb.ref('jmart-safety/devices/approved/' + this.deviceId).set(deviceData);

        // Remove from pending if exists
        await firebaseDb.ref('jmart-safety/devices/pending/' + this.deviceId).remove();

        this.isApproved = true;
        this.isAdmin = isAdmin;
        this.notifyStatusListeners();
        console.log('Device registered as approved, admin:', isAdmin);
      },

      // Approve a pending device (admin only)
      approveDevice: async function(deviceId, makeAdmin = false) {
        if (!this.isAdmin || !firebaseDb) {
          console.error('Only admins can approve devices');
          return false;
        }

        try {
          // Get pending device data
          const pendingSnap = await firebaseDb.ref('jmart-safety/devices/pending/' + deviceId).once('value');
          if (!pendingSnap.exists()) {
            console.error('Device not found in pending list');
            return false;
          }

          const deviceData = pendingSnap.val();
          const approvedData = {
            ...deviceData,
            isAdmin: makeAdmin,
            approvedAt: new Date().toISOString(),
            approvedBy: this.deviceId,
            status: 'approved'
          };

          // Move to approved
          await firebaseDb.ref('jmart-safety/devices/approved/' + deviceId).set(approvedData);
          await firebaseDb.ref('jmart-safety/devices/pending/' + deviceId).remove();

          console.log('Device approved:', deviceId);
          return true;
        } catch (error) {
          console.error('Error approving device:', error);
          return false;
        }
      },

      // Deny/reject a pending device (admin only)
      denyDevice: async function(deviceId) {
        if (!this.isAdmin || !firebaseDb) {
          console.error('Only admins can deny devices');
          return false;
        }

        try {
          // Remove from pending and add to denied
          const pendingSnap = await firebaseDb.ref('jmart-safety/devices/pending/' + deviceId).once('value');
          if (pendingSnap.exists()) {
            const deviceData = pendingSnap.val();
            await firebaseDb.ref('jmart-safety/devices/denied/' + deviceId).set({
              ...deviceData,
              deniedAt: new Date().toISOString(),
              deniedBy: this.deviceId
            });
            await firebaseDb.ref('jmart-safety/devices/pending/' + deviceId).remove();
          }

          console.log('Device denied:', deviceId);
          return true;
        } catch (error) {
          console.error('Error denying device:', error);
          return false;
        }
      },

      // Revoke an approved device (admin or devices with canRevokeDevices permission)
      revokeDevice: async function(deviceId) {
        if ((!this.isAdmin && !this.canRevokeDevices) || !firebaseDb) {
          console.error('Only admins or devices with revoke permission can revoke devices');
          return false;
        }

        // Cannot revoke self
        if (deviceId === this.deviceId) {
          console.error('Cannot revoke own device');
          return false;
        }

        try {
          await firebaseDb.ref('jmart-safety/devices/approved/' + deviceId).remove();
          console.log('Device revoked:', deviceId);
          return true;
        } catch (error) {
          console.error('Error revoking device:', error);
          return false;
        }
      },

      // Listen for pending device changes (for admin notifications)
      listenForPendingDevices: function(callback) {
        if (!firebaseDb || !this.isAdmin) return () => {};

        const ref = firebaseDb.ref('jmart-safety/devices/pending');

        ref.on('value', (snapshot) => {
          const data = snapshot.val();
          this.pendingDevices = data ? Object.entries(data).map(([id, info]) => ({ id, ...info })) : [];
          callback(this.pendingDevices);
        });

        // Also listen for child_added for new device notifications
        ref.on('child_added', (snapshot) => {
          const newDevice = { id: snapshot.key, ...snapshot.val() };
          this.notifyNotificationListeners('new_device', newDevice);
        });

        return () => {
          ref.off('value');
          ref.off('child_added');
        };
      },

      // Listen for approved devices
      listenForApprovedDevices: function(callback) {
        if (!firebaseDb) return () => {};

        const ref = firebaseDb.ref('jmart-safety/devices/approved');
        ref.on('value', (snapshot) => {
          const data = snapshot.val();
          this.approvedDevices = data ? Object.entries(data).map(([id, info]) => ({ id, ...info })) : [];
          callback(this.approvedDevices);
        });

        return () => ref.off('value');
      },

      // Listen for own device status changes (in case revoked)
      listenForOwnDeviceStatus: function(callback) {
        if (!firebaseDb) return () => {};

        const ref = firebaseDb.ref('jmart-safety/devices/approved/' + this.deviceId);
        ref.on('value', (snapshot) => {
          if (!snapshot.exists() && this.isApproved) {
            // Device was revoked
            this.isApproved = false;
            this.isAdmin = false;
            callback({ revoked: true });
          }
        });

        return () => ref.off('value');
      },

      // Notify admins of new device request
      notifyAdminsOfNewDevice: async function(deviceData) {
        if (!firebaseDb) return;

        // Store notification in Firebase for all admins
        const notification = {
          type: 'new_device_request',
          device: deviceData,
          timestamp: new Date().toISOString(),
          read: false
        };

        await firebaseDb.ref('jmart-safety/notifications').push(notification);
      },

      // Add status listener
      onStatusChange: function(callback) {
        this.statusListeners.push(callback);
        // Immediately call with current status
        callback({ approved: this.isApproved, admin: this.isAdmin });
        return () => {
          this.statusListeners = this.statusListeners.filter(cb => cb !== callback);
        };
      },

      // Notify status listeners
      notifyStatusListeners: function() {
        this.statusListeners.forEach(cb => cb({ approved: this.isApproved, admin: this.isAdmin }));
      },

      // Add notification listener
      onNotification: function(callback) {
        this.notificationListeners.push(callback);
        return () => {
          this.notificationListeners = this.notificationListeners.filter(cb => cb !== callback);
        };
      },

      // Notify notification listeners
      notifyNotificationListeners: function(type, data) {
        this.notificationListeners.forEach(cb => cb(type, data));
      },

      // Request browser notification permission
      requestNotificationPermission: async function() {
        if (!('Notification' in window)) {
          console.log('Browser does not support notifications');
          return false;
        }

        if (Notification.permission === 'granted') {
          return true;
        }

        if (Notification.permission !== 'denied') {
          const permission = await Notification.requestPermission();
          return permission === 'granted';
        }

        return false;
      },

      // Show browser notification for new device
      showBrowserNotification: function(title, body) {
        if (Notification.permission === 'granted') {
          new Notification(title, {
            body: body,
            icon: 'üõ°Ô∏è',
            tag: 'jmart-device-auth',
            requireInteraction: true
          });
        }
      }
    };

    // ========================================
    // GOOGLE DRIVE CONFIGURATION
    // ========================================
    // Get your Client ID from Google Cloud Console:
    // 1. Go to https://console.cloud.google.com/
    // 2. Create project "JMart Safety App"
    // 3. Enable "Google Drive API"
    // 4. Go to "Credentials" ‚Üí Create OAuth Client ID
    // 5. Add authorized origin: https://davidethepingpong.github.io
    // 6. Copy Client ID below
    // ========================================
    const GOOGLE_CLIENT_ID = '920798274486-rh1p59hihjkj9k04qmn5e3rbs57g55q8.apps.googleusercontent.com';
    const GOOGLE_API_KEY = ''; // Optional - only needed for public files
    const DRIVE_FOLDER_NAME = 'JMart Steel';  // Main company folder - consolidated structure
    const DRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.file';

    // ========================================
    // DRIVE FOLDER STRUCTURE CONFIGURATION
    // Unified folder structure for all JMart Steel files
    // ========================================
    const DRIVE_FOLDERS = {
      // Safety forms go into 01_Safety_Compliance subfolders
      forms: {
        'prestart': '01_Safety_Compliance/Pre-Start_Checklists',
        'inspection': '01_Safety_Compliance/Site_Inspections',
        'incident': '01_Safety_Compliance/Incident_Reports',
        'toolbox': '01_Safety_Compliance/Toolbox_Talks',
        'itp': '03_ITPs/General',
        'steel-itp': '03_ITPs/Structural_Steel',
        'training': '05_Training/Certificates'
      },
      // Photos go into project folders
      photos: '02_Projects',  // Will create {ProjectName}/Photos/{Date}/
      // Finance/receipts for future Steel integration
      finance: '11_Finance',
      // AI agent outputs for future Steel integration
      agents: '12_AI_Agents'
    };

    // Check if Google Drive is configured
    const isGoogleDriveConfigured = GOOGLE_CLIENT_ID !== 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com';

    // Google Drive Helper
    const GoogleDriveSync = {
      tokenClient: null,
      accessToken: null,
      folderId: null,
      isInitialized: false,

      // Initialize Google Identity Services
      init: function() {
        if (!isGoogleDriveConfigured) {
          console.log('Google Drive not configured - add your Client ID');
          return;
        }

        try {
          this.tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID,
            scope: DRIVE_SCOPES,
            callback: (response) => {
              if (response.error) {
                console.error('Google Auth error:', response.error);
                return;
              }
              this.accessToken = response.access_token;
              localStorage.setItem('google-drive-token', response.access_token);
              console.log('Google Drive connected!');
              this.getOrCreateFolder();
            },
          });
          this.isInitialized = true;
          console.log('Google Drive initialized');

          // Check for stored token
          const storedToken = localStorage.getItem('google-drive-token');
          if (storedToken) {
            this.accessToken = storedToken;
            this.getOrCreateFolder();
          }
        } catch (error) {
          console.error('Google Drive init error:', error);
        }
      },

      // Request user authorization
      authorize: function() {
        if (!this.isInitialized) {
          alert('Google Drive not configured. Please add your Client ID.');
          return;
        }
        this.tokenClient.requestAccessToken({ prompt: 'consent' });
      },

      // Check if connected
      isConnected: function() {
        return this.accessToken !== null;
      },

      // Wrapper for API calls with automatic token refresh on 401
      apiCall: async function(url, options = {}) {
        if (!this.accessToken) {
          throw new Error('Not connected to Google Drive');
        }

        // Add auth header
        options.headers = {
          ...options.headers,
          'Authorization': `Bearer ${this.accessToken}`
        };

        let response = await fetch(url, options);

        // If token expired (401), try to refresh silently
        if (response.status === 401) {
          console.log('Google Drive token expired, attempting refresh...');
          localStorage.removeItem('google-drive-token');
          this.accessToken = null;

          // Request new token (will trigger callback)
          return new Promise((resolve, reject) => {
            const originalCallback = this.tokenClient.callback;
            this.tokenClient.callback = async (tokenResponse) => {
              if (tokenResponse.error) {
                this.tokenClient.callback = originalCallback;
                reject(new Error('Token refresh failed'));
                return;
              }
              this.accessToken = tokenResponse.access_token;
              localStorage.setItem('google-drive-token', tokenResponse.access_token);
              this.tokenClient.callback = originalCallback;

              // Retry the original request
              options.headers['Authorization'] = `Bearer ${this.accessToken}`;
              try {
                const retryResponse = await fetch(url, options);
                resolve(retryResponse);
              } catch (e) {
                reject(e);
              }
            };
            this.tokenClient.requestAccessToken({ prompt: '' }); // Silent refresh
          });
        }

        return response;
      },

      // Get or create the JMart Safety folder
      getOrCreateFolder: async function() {
        if (!this.accessToken) return null;

        try {
          // Search for existing folder
          const searchResponse = await fetch(
            `https://www.googleapis.com/drive/v3/files?q=name='${DRIVE_FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
            { headers: { 'Authorization': `Bearer ${this.accessToken}` } }
          );
          const searchData = await searchResponse.json();

          if (searchData.files && searchData.files.length > 0) {
            this.folderId = searchData.files[0].id;
            console.log('Found existing Drive folder:', this.folderId);
            return this.folderId;
          }

          // Create new folder
          const createResponse = await fetch('https://www.googleapis.com/drive/v3/files', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${this.accessToken}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              name: DRIVE_FOLDER_NAME,
              mimeType: 'application/vnd.google-apps.folder',
            }),
          });
          const createData = await createResponse.json();
          this.folderId = createData.id;
          console.log('Created Drive folder:', this.folderId);
          return this.folderId;
        } catch (error) {
          console.error('Error getting/creating folder:', error);
          return null;
        }
      },

      // Helper: Get or create nested folder path (e.g., "01_Safety_Compliance/Pre-Start_Checklists")
      getOrCreateNestedFolder: async function(folderPath, parentId = null) {
        if (!this.accessToken) return null;

        const parent = parentId || this.folderId;
        if (!parent) {
          await this.getOrCreateFolder();
        }

        const parts = folderPath.split('/').filter(p => p.trim());
        let currentParent = parent || this.folderId;

        for (const folderName of parts) {
          try {
            // Search for folder
            const searchResponse = await fetch(
              `https://www.googleapis.com/drive/v3/files?q=name='${folderName}' and '${currentParent}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
              { headers: { 'Authorization': `Bearer ${this.accessToken}` } }
            );
            const searchData = await searchResponse.json();

            if (searchData.files && searchData.files.length > 0) {
              currentParent = searchData.files[0].id;
            } else {
              // Create folder
              const createResponse = await fetch('https://www.googleapis.com/drive/v3/files', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${this.accessToken}`,
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  name: folderName,
                  mimeType: 'application/vnd.google-apps.folder',
                  parents: [currentParent],
                }),
              });
              const createData = await createResponse.json();
              currentParent = createData.id;
              console.log(`Created folder: ${folderName}`, currentParent);
            }
          } catch (error) {
            console.error(`Error creating folder ${folderName}:`, error);
            return null;
          }
        }

        return currentParent;
      },

      // Upload a PDF to Google Drive (with optional subfolder)
      uploadPDF: async function(pdfBlob, filename, formType = null) {
        if (!this.accessToken) {
          console.error('Not connected to Google Drive');
          return null;
        }

        if (!this.folderId) {
          await this.getOrCreateFolder();
        }

        try {
          // Determine target folder based on form type
          let targetFolderId = this.folderId;

          if (formType && DRIVE_FOLDERS.forms[formType]) {
            const subfolderPath = DRIVE_FOLDERS.forms[formType];
            targetFolderId = await this.getOrCreateNestedFolder(subfolderPath);
            if (!targetFolderId) {
              console.warn(`Could not create subfolder for ${formType}, using root folder`);
              targetFolderId = this.folderId;
            }
          }

          const metadata = {
            name: filename,
            mimeType: 'application/pdf',
            parents: [targetFolderId],
          };

          const formData = new FormData();
          formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
          formData.append('file', pdfBlob);

          const response = await fetch(
            'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',
            {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${this.accessToken}` },
              body: formData,
            }
          );

          const data = await response.json();
          console.log('Uploaded to Drive:', filename, 'in folder:', formType || 'root', data.id);
          return data;
        } catch (error) {
          console.error('Upload error:', error);
          return null;
        }
      },

      // Upload all forms from today as PDFs
      uploadDailyForms: async function(forms) {
        if (!this.accessToken) {
          console.error('Not connected to Google Drive');
          return { success: false, error: 'Not connected' };
        }

        const today = new Date().toDateString();
        const todaysForms = forms.filter(f => new Date(f.createdAt).toDateString() === today);

        if (todaysForms.length === 0) {
          console.log('No forms to upload today');
          return { success: true, uploaded: 0 };
        }

        const results = [];
        for (const form of todaysForms) {
          try {
            const { doc, filename } = PDFGenerator.generate(form);
            const pdfBlob = doc.output('blob');
            const result = await this.uploadPDF(pdfBlob, filename, form.type);
            if (result) {
              results.push({ form: form.id, filename, driveId: result.id });
            }
          } catch (error) {
            console.error('Error uploading form:', form.id, error);
          }
        }

        console.log(`Uploaded ${results.length}/${todaysForms.length} forms to Drive`);
        return { success: true, uploaded: results.length, total: todaysForms.length, results };
      },

      // Search for files by name pattern
      searchFiles: async function(namePattern) {
        if (!this.accessToken) return [];

        try {
          const query = `name contains '${namePattern}' and '${this.folderId}' in parents and trashed=false`;
          const response = await fetch(
            `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,createdTime)`,
            { headers: { 'Authorization': `Bearer ${this.accessToken}` } }
          );
          const data = await response.json();
          return data.files || [];
        } catch (error) {
          console.error('Search error:', error);
          return [];
        }
      },

      // Delete a file by ID
      deleteFile: async function(fileId) {
        if (!this.accessToken) return false;

        try {
          const response = await fetch(
            `https://www.googleapis.com/drive/v3/files/${fileId}`,
            {
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${this.accessToken}` }
            }
          );
          if (response.ok || response.status === 204) {
            console.log('Deleted file from Drive:', fileId);
            return true;
          }
          return false;
        } catch (error) {
          console.error('Delete error:', error);
          return false;
        }
      },

      // Delete old versions of a form PDF
      deleteOldFormPDFs: async function(formId, siteName) {
        if (!this.accessToken || !this.folderId) return { deleted: 0 };

        try {
          // Search for files matching this form's pattern
          const files = await this.searchFiles(siteName);
          let deleted = 0;

          for (const file of files) {
            const result = await this.deleteFile(file.id);
            if (result) deleted++;
          }

          console.log(`Deleted ${deleted} old PDF(s) for form ${formId}`);
          return { deleted, files };
        } catch (error) {
          console.error('Error deleting old PDFs:', error);
          return { deleted: 0, error };
        }
      },

      // Disconnect
      disconnect: function() {
        this.accessToken = null;
        this.folderId = null;
        localStorage.removeItem('google-drive-token');
        console.log('Disconnected from Google Drive');
      },

      // Get or create a subfolder for job recordings
      getOrCreateRecordingsFolder: async function(siteName, date) {
        if (!this.accessToken) return null;

        try {
          // First ensure main folder exists
          if (!this.folderId) {
            await this.getOrCreateFolder();
          }

          // Create/get "Job Recordings" subfolder
          const recordingsFolderName = 'Job Recordings';
          let recordingsFolderId = null;

          // Search for Job Recordings folder
          const recordingsSearch = await fetch(
            `https://www.googleapis.com/drive/v3/files?q=name='${recordingsFolderName}' and '${this.folderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
            { headers: { 'Authorization': `Bearer ${this.accessToken}` } }
          );
          const recordingsData = await recordingsSearch.json();

          if (recordingsData.files && recordingsData.files.length > 0) {
            recordingsFolderId = recordingsData.files[0].id;
          } else {
            // Create Job Recordings folder
            const createRecordings = await fetch('https://www.googleapis.com/drive/v3/files', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${this.accessToken}`,
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                name: recordingsFolderName,
                mimeType: 'application/vnd.google-apps.folder',
                parents: [this.folderId],
              }),
            });
            const newRecordingsFolder = await createRecordings.json();
            recordingsFolderId = newRecordingsFolder.id;
          }

          // Create/get site subfolder
          const safeSiteName = siteName.replace(/[<>:"/\\|?*]/g, '-');
          let siteFolderId = null;

          const siteSearch = await fetch(
            `https://www.googleapis.com/drive/v3/files?q=name='${safeSiteName}' and '${recordingsFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
            { headers: { 'Authorization': `Bearer ${this.accessToken}` } }
          );
          const siteData = await siteSearch.json();

          if (siteData.files && siteData.files.length > 0) {
            siteFolderId = siteData.files[0].id;
          } else {
            const createSite = await fetch('https://www.googleapis.com/drive/v3/files', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${this.accessToken}`,
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                name: safeSiteName,
                mimeType: 'application/vnd.google-apps.folder',
                parents: [recordingsFolderId],
              }),
            });
            const newSiteFolder = await createSite.json();
            siteFolderId = newSiteFolder.id;
          }

          // Create/get date subfolder
          const dateStr = new Date(date).toLocaleDateString('en-AU').replace(/\//g, '-');
          let dateFolderId = null;

          const dateSearch = await fetch(
            `https://www.googleapis.com/drive/v3/files?q=name='${dateStr}' and '${siteFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
            { headers: { 'Authorization': `Bearer ${this.accessToken}` } }
          );
          const dateData = await dateSearch.json();

          if (dateData.files && dateData.files.length > 0) {
            dateFolderId = dateData.files[0].id;
          } else {
            const createDate = await fetch('https://www.googleapis.com/drive/v3/files', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${this.accessToken}`,
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                name: dateStr,
                mimeType: 'application/vnd.google-apps.folder',
                parents: [siteFolderId],
              }),
            });
            const newDateFolder = await createDate.json();
            dateFolderId = newDateFolder.id;
          }

          console.log('Created/found recordings folder structure:', siteName, dateStr, dateFolderId);
          return dateFolderId;
        } catch (error) {
          console.error('Error creating recordings folder structure:', error);
          return null;
        }
      },

      // Upload a photo to job recordings folder
      uploadJobPhoto: async function(photoData, filename, siteName, date) {
        if (!this.accessToken) {
          console.error('Not connected to Google Drive');
          return null;
        }

        try {
          const folderId = await this.getOrCreateRecordingsFolder(siteName, date);
          if (!folderId) {
            console.error('Could not create recordings folder');
            return null;
          }

          // Convert base64 to blob
          const base64Data = photoData.split(',')[1];
          const byteCharacters = atob(base64Data);
          const byteNumbers = new Array(byteCharacters.length);
          for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
          }
          const byteArray = new Uint8Array(byteNumbers);
          const blob = new Blob([byteArray], { type: 'image/jpeg' });

          const metadata = {
            name: filename,
            mimeType: 'image/jpeg',
            parents: [folderId],
          };

          const formData = new FormData();
          formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
          formData.append('file', blob);

          const response = await fetch(
            'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',
            {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${this.accessToken}` },
              body: formData,
            }
          );

          const data = await response.json();
          console.log('Uploaded photo to Drive:', filename, data.id);
          return data;
        } catch (error) {
          console.error('Upload photo error:', error);
          return null;
        }
      },

      // Upload multiple photos for a job
      uploadJobPhotos: async function(photos, siteName, date) {
        if (!this.accessToken) {
          return { success: false, error: 'Not connected to Google Drive' };
        }

        const results = [];
        for (let i = 0; i < photos.length; i++) {
          const photo = photos[i];
          const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
          const filename = `photo-${i + 1}-${timestamp}.jpg`;
          const result = await this.uploadJobPhoto(photo.data, filename, siteName, date);
          if (result) {
            results.push({ filename, driveId: result.id });
          }
        }

        console.log(`Uploaded ${results.length}/${photos.length} photos to Drive`);
        return { success: true, uploaded: results.length, total: photos.length, results };
      }
    };

    // Initialize Google Drive when API loads
    window.onload = function() {
      if (isGoogleDriveConfigured) {
        // Wait for Google API to load
        if (typeof google !== 'undefined' && google.accounts) {
          GoogleDriveSync.init();
        } else {
          // Retry after a short delay
          setTimeout(() => {
            if (typeof google !== 'undefined' && google.accounts) {
              GoogleDriveSync.init();
            }
          }, 1000);
        }
      }
    };

    // ========================================
    // AUTOMATIC 7PM DAILY BACKUP SCHEDULER
    // ========================================
    const DailyBackupScheduler = {
      checkInterval: null,
      lastBackupDate: localStorage.getItem('last-drive-backup-date'),

      start: function() {
        // Check every minute if it's 7pm
        this.checkInterval = setInterval(() => this.checkAndBackup(), 60000);
        console.log('Daily backup scheduler started - backups at 7:00 PM');

        // Also check immediately in case we missed today's backup
        this.checkAndBackup();
      },

      checkAndBackup: async function() {
        const now = new Date();
        const today = now.toDateString();
        const hour = now.getHours();
        const minute = now.getMinutes();

        // Check if it's 7pm (19:00) and we haven't backed up today
        if (hour === 19 && minute === 0 && this.lastBackupDate !== today) {
          console.log('7pm backup triggered!');
          await this.performBackup();
        }
      },

      performBackup: async function() {
        if (!GoogleDriveSync.isConnected()) {
          console.log('Google Drive not connected - skipping backup');
          return;
        }

        // Get forms from localStorage
        const formsJson = localStorage.getItem('jmart-safety-forms');
        if (!formsJson) {
          console.log('No forms to backup');
          return;
        }

        const forms = JSON.parse(formsJson);
        const result = await GoogleDriveSync.uploadDailyForms(forms);

        if (result.success) {
          this.lastBackupDate = new Date().toDateString();
          localStorage.setItem('last-drive-backup-date', this.lastBackupDate);
          console.log(`Daily backup complete: ${result.uploaded} forms uploaded`);

          // Show notification if available
          if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('JMart Safety Backup', {
              body: `${result.uploaded} forms backed up to Google Drive`,
              icon: 'üõ°Ô∏è'
            });
          }
        }
      },

      // Manual backup trigger
      backupNow: async function() {
        return await this.performBackup();
      },

      stop: function() {
        if (this.checkInterval) {
          clearInterval(this.checkInterval);
          console.log('Daily backup scheduler stopped');
        }
      }
    };

    // Start the scheduler
    DailyBackupScheduler.start();

    // ========================================
    // STORAGE QUOTA MANAGER
    // ========================================
    // Monitors localStorage usage and warns users before quota is exceeded
    const StorageQuotaManager = {
      MAX_STORAGE_MB: 5, // localStorage limit is typically 5-10MB
      WARNING_THRESHOLD: 0.8, // Warn at 80% usage
      listeners: [],

      // Calculate current storage usage
      getUsage: function() {
        let totalBytes = 0;
        for (let key in localStorage) {
          if (localStorage.hasOwnProperty(key)) {
            totalBytes += localStorage[key].length * 2; // UTF-16 = 2 bytes per char
          }
        }
        const totalMB = totalBytes / (1024 * 1024);
        const percentUsed = (totalMB / this.MAX_STORAGE_MB) * 100;
        return {
          bytes: totalBytes,
          megabytes: totalMB.toFixed(2),
          percentUsed: percentUsed.toFixed(1),
          isWarning: percentUsed >= (this.WARNING_THRESHOLD * 100),
          isCritical: percentUsed >= 95
        };
      },

      // Check if we can safely store data of given size
      canStore: function(dataString) {
        const dataBytes = dataString.length * 2;
        const usage = this.getUsage();
        const projectedMB = (usage.bytes + dataBytes) / (1024 * 1024);
        return projectedMB < this.MAX_STORAGE_MB;
      },

      // Notify listeners of storage changes
      notifyListeners: function(usage) {
        this.listeners.forEach(cb => cb(usage));
      },

      // Add listener for storage updates
      onStorageChange: function(callback) {
        this.listeners.push(callback);
        // Immediately call with current usage
        callback(this.getUsage());
        return () => {
          this.listeners = this.listeners.filter(cb => cb !== callback);
        };
      },

      // Clean up old/unnecessary data to free space
      cleanup: function() {
        const keysToRemove = [];
        const now = Date.now();
        const thirtyDaysAgo = now - (30 * 24 * 60 * 60 * 1000);

        // Find old backup and temp keys
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && (key.includes('backup') || key.includes('temp') || key.includes('cache'))) {
            keysToRemove.push(key);
          }
        }

        // Remove old backed-up form records
        try {
          const backedUp = JSON.parse(localStorage.getItem('jmart-backed-up-forms') || '{}');
          const recentBackups = {};
          Object.entries(backedUp).forEach(([id, timestamp]) => {
            if (new Date(timestamp).getTime() > thirtyDaysAgo) {
              recentBackups[id] = timestamp;
            }
          });
          localStorage.setItem('jmart-backed-up-forms', JSON.stringify(recentBackups));
        } catch (e) {
          console.error('Error cleaning backup records:', e);
        }

        // Remove identified keys
        keysToRemove.forEach(key => {
          try {
            localStorage.removeItem(key);
            console.log('Cleaned up storage key:', key);
          } catch (e) {
            console.error('Error removing key:', key, e);
          }
        });

        const freed = keysToRemove.length;
        console.log(`Storage cleanup complete: removed ${freed} items`);
        this.notifyListeners(this.getUsage());
        return { cleaned: freed, usage: this.getUsage() };
      },

      // Safe save with quota handling
      safeSave: function(key, data) {
        const dataString = typeof data === 'string' ? data : JSON.stringify(data);

        if (!this.canStore(dataString)) {
          // Try cleanup first
          this.cleanup();

          if (!this.canStore(dataString)) {
            // Still can't fit - notify user
            const usage = this.getUsage();
            console.error('Storage quota exceeded! Usage:', usage.megabytes, 'MB');
            this.notifyListeners({ ...usage, error: 'quota_exceeded' });
            throw new Error('Storage quota exceeded. Please delete old forms or backup to Google Drive.');
          }
        }

        try {
          localStorage.setItem(key, dataString);
          const usage = this.getUsage();
          if (usage.isWarning) {
            this.notifyListeners(usage);
          }
          return true;
        } catch (e) {
          if (e.name === 'QuotaExceededError') {
            this.cleanup();
            // One more try after cleanup
            localStorage.setItem(key, dataString);
            return true;
          }
          throw e;
        }
      }
    };

    // ========================================
    // AUDIT LOG MANAGER
    // ========================================
    // Tracks all form operations for compliance
    const AuditLogManager = {
      // Log an action
      log: async function(action, details) {
        const logEntry = {
          id: Date.now().toString(36) + '-' + Math.random().toString(36).substr(2, 9),
          action: action, // 'create', 'update', 'delete', 'view', 'export'
          deviceId: DeviceAuthManager.deviceId || 'unknown',
          userName: localStorage.getItem('jmart-user-name') || 'Unknown User',
          timestamp: new Date().toISOString(),
          details: details
        };

        // Save to local audit log
        try {
          const localLog = JSON.parse(localStorage.getItem('jmart-audit-log') || '[]');
          localLog.push(logEntry);
          // Keep last 1000 entries locally
          if (localLog.length > 1000) {
            localLog.splice(0, localLog.length - 1000);
          }
          localStorage.setItem('jmart-audit-log', JSON.stringify(localLog));
        } catch (e) {
          console.error('Error saving audit log locally:', e);
        }

        // Sync to Firebase if connected
        if (firebaseDb && isFirebaseConfigured) {
          try {
            await firebaseDb.ref('jmart-safety/auditLog/' + logEntry.id).set(logEntry);
          } catch (e) {
            console.error('Error syncing audit log to Firebase:', e);
          }
        }

        return logEntry;
      },

      // Get recent audit log entries
      getRecent: function(limit = 50) {
        try {
          const localLog = JSON.parse(localStorage.getItem('jmart-audit-log') || '[]');
          return localLog.slice(-limit).reverse();
        } catch (e) {
          console.error('Error reading audit log:', e);
          return [];
        }
      },

      // Get audit history for a specific form
      getFormHistory: function(formId) {
        try {
          const localLog = JSON.parse(localStorage.getItem('jmart-audit-log') || '[]');
          return localLog.filter(entry => entry.details && entry.details.formId === formId);
        } catch (e) {
          console.error('Error reading form history:', e);
          return [];
        }
      }
    };

    // Firebase sync helper functions with retry queue
    const FirebaseSync = {
      // Retry queue stored in localStorage
      pendingQueue: [],
      retryAttempts: {},
      maxRetries: 5,
      retryDelays: [1000, 5000, 15000, 30000, 60000], // Exponential backoff
      syncListeners: [], // UI callbacks for sync status

      // Initialize - load pending queue from localStorage
      init: function() {
        try {
          const saved = localStorage.getItem('jmart-sync-queue');
          this.pendingQueue = saved ? JSON.parse(saved) : [];
          if (this.pendingQueue.length > 0) {
            console.log(`Found ${this.pendingQueue.length} pending sync items`);
            this.processQueue();
          }
        } catch (e) {
          console.error('Error loading sync queue:', e);
          this.pendingQueue = [];
        }
      },

      // Save queue to localStorage
      saveQueue: function() {
        try {
          localStorage.setItem('jmart-sync-queue', JSON.stringify(this.pendingQueue));
        } catch (e) {
          console.error('Error saving sync queue:', e);
        }
      },

      // Add listener for sync status updates
      onSyncStatusChange: function(callback) {
        this.syncListeners.push(callback);
        return () => {
          this.syncListeners = this.syncListeners.filter(cb => cb !== callback);
        };
      },

      // Notify listeners of status change
      notifyListeners: function(status, details) {
        this.syncListeners.forEach(cb => cb(status, details));
      },

      // Add item to retry queue
      addToQueue: function(type, data) {
        const item = {
          id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
          type,
          data,
          timestamp: new Date().toISOString(),
          attempts: 0
        };
        this.pendingQueue.push(item);
        this.saveQueue();
        this.notifyListeners('queued', { pending: this.pendingQueue.length });
        return item.id;
      },

      // Process the retry queue
      processQueue: async function() {
        if (!navigator.onLine || !this.isConnected()) {
          console.log('Offline - queue processing deferred');
          return;
        }

        const itemsToProcess = [...this.pendingQueue];
        for (const item of itemsToProcess) {
          try {
            await this.executeSync(item);
            // Success - remove from queue
            this.pendingQueue = this.pendingQueue.filter(i => i.id !== item.id);
            this.saveQueue();
            this.notifyListeners('synced', { pending: this.pendingQueue.length, item: item.type });
            console.log(`Sync successful for ${item.type}`);
          } catch (error) {
            item.attempts++;
            if (item.attempts >= this.maxRetries) {
              console.error(`Max retries reached for ${item.type}, keeping in queue for manual retry`);
              this.notifyListeners('failed', { pending: this.pendingQueue.length, error: error.message });
            } else {
              const delay = this.retryDelays[Math.min(item.attempts - 1, this.retryDelays.length - 1)];
              console.log(`Retry ${item.attempts}/${this.maxRetries} for ${item.type} in ${delay}ms`);
              setTimeout(() => this.processQueue(), delay);
            }
            this.saveQueue();
          }
        }
      },

      // Execute a single sync operation (v3: supports granular update/delete)
      executeSync: async function(item) {
        if (!firebaseDb || !isFirebaseConfigured) {
          throw new Error('Firebase not configured');
        }

        // v3 granular operations (path-based)
        if (item.path && item.operation) {
          const ref = firebaseDb.ref(item.path);
          switch (item.operation) {
            case 'set': await ref.set(item.data); break;
            case 'update': await ref.update(item.data); break;
            case 'delete': await ref.remove(); break;
            default: throw new Error(`Unknown operation: ${item.operation}`);
          }
          return;
        }

        // Legacy bulk operations (fallback)
        switch (item.type) {
          case 'forms':
            await firebaseDb.ref('jmart-safety/forms').set(item.data);
            break;
          case 'sites':
            await firebaseDb.ref('jmart-safety/sites').set(item.data);
            break;
          case 'training':
            await firebaseDb.ref('jmart-safety/training').set(item.data);
            break;
          case 'signatures':
            await firebaseDb.ref('signatures').set(item.data);
            break;
          default:
            throw new Error(`Unknown sync type: ${item.type}`);
        }
      },

      // Sync forms to Firebase - v3: granular per-form update() instead of full set()
      syncForms: async function(forms) {
        if (!firebaseDb || !isFirebaseConfigured) {
          this.addToQueue('forms', forms);
          return { success: false, queued: true };
        }
        try {
          const deviceId = localStorage.getItem('jmart-device-id') || 'unknown';
          const updates = {};
          const formsArray = Array.isArray(forms) ? forms : Object.values(forms || {});
          formsArray.forEach(form => {
            const key = form.id || `form-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`;
            updates[key] = {
              ...form,
              _lastModified: Date.now(),
              _modifiedBy: deviceId
            };
          });
          // Single atomic update of all forms (granular keys, no full overwrite)
          await firebaseDb.ref('jmart-safety/forms').update(updates);
          console.log('Forms synced to Firebase (granular):', formsArray.length, 'forms');
          return { success: true };
        } catch (error) {
          console.error('Error syncing forms, adding to retry queue:', error);
          this.addToQueue('forms', forms);
          this.notifyListeners('error', { message: 'Sync failed - will retry automatically' });
          return { success: false, queued: true, error: error.message };
        }
      },

      // Sync sites to Firebase - v3: granular per-site update()
      syncSites: async function(sites) {
        if (!firebaseDb || !isFirebaseConfigured) {
          this.addToQueue('sites', sites);
          return { success: false, queued: true };
        }
        try {
          const sitesArray = Array.isArray(sites) ? sites : Object.values(sites || {});
          const updates = {};
          sitesArray.forEach((site, i) => {
            const key = site.id || `site-${i}`;
            updates[key] = { ...site, _lastModified: Date.now() };
          });
          await firebaseDb.ref('jmart-safety/sites').update(updates);
          console.log('Sites synced to Firebase (granular):', sitesArray.length, 'sites');
          return { success: true };
        } catch (error) {
          console.error('Error syncing sites, adding to retry queue:', error);
          this.addToQueue('sites', sites);
          return { success: false, queued: true, error: error.message };
        }
      },

      // Sync training records to Firebase - v3: granular per-record update()
      syncTraining: async function(training) {
        if (!firebaseDb || !isFirebaseConfigured) {
          this.addToQueue('training', training);
          return { success: false, queued: true };
        }
        try {
          const trainingArray = Array.isArray(training) ? training : Object.values(training || {});
          const updates = {};
          trainingArray.forEach((record, i) => {
            const key = record.id || `training-${i}`;
            updates[key] = { ...record, _lastModified: Date.now() };
          });
          await firebaseDb.ref('jmart-safety/training').update(updates);
          console.log('Training synced to Firebase (granular):', trainingArray.length, 'records');
          return { success: true };
        } catch (error) {
          console.error('Error syncing training, adding to retry queue:', error);
          this.addToQueue('training', training);
          return { success: false, queued: true, error: error.message };
        }
      },

      // Get pending queue count
      getPendingCount: function() {
        return this.pendingQueue.length;
      },

      // Manual retry all pending items
      retryAll: function() {
        this.pendingQueue.forEach(item => item.attempts = 0);
        this.saveQueue();
        this.processQueue();
      },

      // Listen for real-time form updates
      onFormsChange: (callback) => {
        if (!firebaseDb || !isFirebaseConfigured) return () => {};
        const ref = firebaseDb.ref('jmart-safety/forms');
        ref.on('value', (snapshot) => {
          const data = snapshot.val();
          if (data) callback(data);
        }, (error) => {
          console.error('Firebase listener error:', error);
        });
        return () => ref.off();
      },

      // Listen for real-time site updates
      onSitesChange: (callback) => {
        if (!firebaseDb || !isFirebaseConfigured) return () => {};
        const ref = firebaseDb.ref('jmart-safety/sites');
        ref.on('value', (snapshot) => {
          const data = snapshot.val();
          if (data) callback(data);
        }, (error) => {
          console.error('Firebase sites listener error:', error);
        });
        return () => ref.off();
      },

      // Listen for real-time training updates
      onTrainingChange: (callback) => {
        if (!firebaseDb || !isFirebaseConfigured) return () => {};
        const ref = firebaseDb.ref('jmart-safety/training');
        ref.on('value', (snapshot) => {
          const data = snapshot.val();
          if (data) callback(data);
        }, (error) => {
          console.error('Firebase training listener error:', error);
        });
        return () => ref.off();
      },

      // Check if Firebase is configured and connected
      isConnected: () => isFirebaseConfigured && firebaseDb !== null,

      // Firebase database reference (for direct access when needed)
      db: firebaseDb
    };

    // Initialize sync queue on load
    FirebaseSync.init();

    // Expose processQueue for SW background sync triggers
    window.processSyncQueue = () => FirebaseSync.processQueue();

    // Process queue when coming back online
    window.addEventListener('online', () => {
      console.log('Back online - processing sync queue');
      FirebaseSync.processQueue();
    });

    // ========================================
    // SHARED JOBS MANAGER
    // Unified job system for Safety App + Steel agents
    // Jobs stored in Firebase: jmart-safety/jobs/
    // ========================================
    const JobsManager = {
      jobs: [],
      listeners: [],

      // Initialize and load jobs from Firebase
      init: async function() {
        if (!firebaseDb || !isFirebaseConfigured) {
          console.log('JobsManager: Firebase not configured');
          return;
        }

        // Listen for real-time job updates
        firebaseDb.ref('jmart-safety/jobs').on('value', (snapshot) => {
          const data = snapshot.val();
          this.jobs = data ? Object.entries(data).map(([id, job]) => ({ id, ...job })) : [];
          this.notifyListeners();
          console.log('JobsManager: Loaded', this.jobs.length, 'jobs');
        });

        // Migrate old sites to new jobs structure if needed
        this.migrateFromSites();
      },

      // Migrate from old 'sites' structure to new 'jobs' structure
      migrateFromSites: async function() {
        if (!firebaseDb) return;

        try {
          const sitesSnap = await firebaseDb.ref('jmart-safety/sites').once('value');
          const sites = sitesSnap.val();

          if (sites && Array.isArray(sites)) {
            const jobsSnap = await firebaseDb.ref('jmart-safety/jobs').once('value');
            if (!jobsSnap.val()) {
              console.log('JobsManager: Migrating', sites.length, 'sites to jobs...');
              for (const site of sites) {
                if (site && site.name) {
                  await this.addJob({
                    name: site.name,
                    client: site.builder || '',
                    address: site.address || '',
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    source: 'migrated-from-sites'
                  });
                }
              }
              console.log('JobsManager: Migration complete');
            }
          }
        } catch (error) {
          console.error('JobsManager: Migration error:', error);
        }
      },

      // Add a new job
      addJob: async function(jobData) {
        if (!firebaseDb) return null;

        const job = {
          name: jobData.name,
          client: jobData.client || '',
          address: jobData.address || '',
          status: jobData.status || 'active',
          createdAt: jobData.createdAt || new Date().toISOString(),
          updatedAt: new Date().toISOString(),
          source: jobData.source || 'safety-app'
        };

        try {
          const ref = await firebaseDb.ref('jmart-safety/jobs').push(job);
          console.log('JobsManager: Added job', job.name, ref.key);
          return { id: ref.key, ...job };
        } catch (error) {
          console.error('JobsManager: Error adding job:', error);
          return null;
        }
      },

      // Update a job
      updateJob: async function(jobId, updates) {
        if (!firebaseDb || !jobId) return false;

        try {
          updates.updatedAt = new Date().toISOString();
          await firebaseDb.ref(`jmart-safety/jobs/${jobId}`).update(updates);
          console.log('JobsManager: Updated job', jobId);
          return true;
        } catch (error) {
          console.error('JobsManager: Error updating job:', error);
          return false;
        }
      },

      // Get all active jobs
      getActiveJobs: function() {
        return this.jobs.filter(j => j.status === 'active');
      },

      // Get all jobs
      getAllJobs: function() {
        return this.jobs;
      },

      // Find job by name (case-insensitive)
      findByName: function(name) {
        return this.jobs.find(j => j.name.toLowerCase() === name.toLowerCase());
      },

      // Subscribe to job updates
      subscribe: function(callback) {
        this.listeners.push(callback);
        callback(this.jobs); // Initial call
        return () => {
          this.listeners = this.listeners.filter(l => l !== callback);
        };
      },

      // Notify all listeners
      notifyListeners: function() {
        this.listeners.forEach(callback => callback(this.jobs));
      },

      // Get jobs as simple name array (for dropdowns)
      getJobNames: function() {
        return this.getActiveJobs().map(j => j.name);
      }
    };

    // Initialize Jobs Manager
    JobsManager.init();

    // ========================================
    // DEVICE AUTHENTICATION MANAGER
    // ========================================
    const DeviceAuthManager = {
      deviceId: null,
      isAdmin: false,
      pendingDevices: [],
      approvedDevices: [],
      listeners: [],
      APP_PASSWORD_HASH: null, // Will be loaded from Firebase or set on first run

      // Generate unique device ID
      generateDeviceId: function() {
        let storedId = localStorage.getItem('jmart-device-id');
        if (storedId) {
          this.deviceId = storedId;
          return storedId;
        }

        // Generate new unique ID
        const fingerprint = [
          navigator.userAgent,
          navigator.language,
          screen.width + 'x' + screen.height,
          new Date().getTimezoneOffset(),
          Math.random().toString(36).substring(2, 15)
        ].join('|');

        // Simple hash
        let hash = 0;
        for (let i = 0; i < fingerprint.length; i++) {
          const char = fingerprint.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash;
        }

        this.deviceId = 'device_' + Math.abs(hash).toString(36) + '_' + Date.now().toString(36);
        localStorage.setItem('jmart-device-id', this.deviceId);
        return this.deviceId;
      },

      // Hash password using SHA-256-like simple hash (for demo, use proper crypto in production)
      hashPassword: function(password) {
        let hash = 0;
        const str = password + 'jmart_salt_2024';
        for (let i = 0; i < str.length; i++) {
          const char = str.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash;
        }
        return 'hash_' + Math.abs(hash).toString(16);
      },

      // Initialize - check device status
      init: async function() {
        this.generateDeviceId();

        if (!firebaseDb || !isFirebaseConfigured) {
          console.log('Firebase not configured - device auth disabled');
          return { status: 'no-firebase', canAccess: true };
        }

        try {
          // Load password hash from Firebase
          const configSnap = await firebaseDb.ref('jmart-safety/config/appPasswordHash').once('value');
          this.APP_PASSWORD_HASH = configSnap.val();

          // MIGRATION: Check for devices in old flat structure and migrate to hierarchical
          const oldDeviceSnap = await firebaseDb.ref('jmart-safety/devices/' + this.deviceId).once('value');
          if (oldDeviceSnap.exists()) {
            const oldData = oldDeviceSnap.val();
            // Only migrate if it has status field (old format) and not in a subfolder
            if (oldData.status && typeof oldData.status === 'string') {
              console.log('Migrating device from old path to new hierarchical structure:', oldData.status);
              const targetPath = 'jmart-safety/devices/' + oldData.status + '/' + this.deviceId;
              // Copy to new path
              await firebaseDb.ref(targetPath).set({
                ...oldData,
                id: this.deviceId,
                migratedAt: new Date().toISOString(),
                migratedFrom: 'flat-structure'
              });
              // Remove from old path
              await firebaseDb.ref('jmart-safety/devices/' + this.deviceId).remove();
              console.log('Migration complete for device:', this.deviceId);
            }
          }

          // Also migrate any other devices in flat structure (for admin devices)
          // This runs once to clean up all old devices
          const allDevicesSnap = await firebaseDb.ref('jmart-safety/devices').once('value');
          if (allDevicesSnap.exists()) {
            const allDevices = allDevicesSnap.val();
            for (const [key, value] of Object.entries(allDevices)) {
              // Skip hierarchical folders
              if (key === 'pending' || key === 'approved' || key === 'denied') continue;
              // Skip if not an object with status
              if (!value || typeof value !== 'object' || !value.status) continue;

              console.log('Migrating device:', key, 'status:', value.status);
              const targetPath = 'jmart-safety/devices/' + value.status + '/' + key;
              await firebaseDb.ref(targetPath).set({
                ...value,
                id: key,
                migratedAt: new Date().toISOString(),
                migratedFrom: 'flat-structure'
              });
              await firebaseDb.ref('jmart-safety/devices/' + key).remove();
            }
          }

          // Check if this device is registered - use hierarchical paths
          // Check approved devices first
          const approvedSnap = await firebaseDb.ref('jmart-safety/devices/approved/' + this.deviceId).once('value');
          if (approvedSnap.exists()) {
            const deviceData = approvedSnap.val();
            this.isAdmin = deviceData.isAdmin || false;
            return { status: 'approved', canAccess: true, isAdmin: this.isAdmin };
          }

          // Check pending devices
          const pendingSnap = await firebaseDb.ref('jmart-safety/devices/pending/' + this.deviceId).once('value');
          if (pendingSnap.exists()) {
            return { status: 'pending', canAccess: false };
          }

          // Check denied devices
          const deniedSnap = await firebaseDb.ref('jmart-safety/devices/denied/' + this.deviceId).once('value');
          if (deniedSnap.exists()) {
            return { status: 'denied', canAccess: false };
          }

          // New device - not registered
          return { status: 'new', canAccess: false };
        } catch (error) {
          console.error('Device auth error:', error);
          // Allow access on error (offline mode)
          return { status: 'error', canAccess: true };
        }
      },

      // Set initial password (first time setup)
      setPassword: async function(password) {
        if (!firebaseDb) return false;

        const hash = this.hashPassword(password);
        try {
          await firebaseDb.ref('jmart-safety/config/appPasswordHash').set(hash);
          this.APP_PASSWORD_HASH = hash;
          return true;
        } catch (error) {
          console.error('Error setting password:', error);
          return false;
        }
      },

      // Verify password
      verifyPassword: function(password) {
        const hash = this.hashPassword(password);
        return hash === this.APP_PASSWORD_HASH;
      },

      // Register this device (request access) - use same path as DeviceAuth
      registerDevice: async function(deviceName) {
        if (!firebaseDb) return false;

        try {
          // Get device info like DeviceAuth does
          const ua = navigator.userAgent;
          let deviceType = 'Unknown Device';
          let browser = 'Unknown Browser';

          if (/iPhone/i.test(ua)) deviceType = 'iPhone';
          else if (/iPad/i.test(ua)) deviceType = 'iPad';
          else if (/Android/i.test(ua) && /Mobile/i.test(ua)) deviceType = 'Android Phone';
          else if (/Android/i.test(ua)) deviceType = 'Android Tablet';
          else if (/Windows/i.test(ua)) deviceType = 'Windows PC';
          else if (/Mac/i.test(ua)) deviceType = 'Mac';
          else if (/Linux/i.test(ua)) deviceType = 'Linux PC';

          if (/Chrome/i.test(ua) && !/Edg/i.test(ua)) browser = 'Chrome';
          else if (/Safari/i.test(ua) && !/Chrome/i.test(ua)) browser = 'Safari';
          else if (/Firefox/i.test(ua)) browser = 'Firefox';
          else if (/Edg/i.test(ua)) browser = 'Edge';

          // Register to pending path (same as DeviceAuth)
          await firebaseDb.ref('jmart-safety/devices/pending/' + this.deviceId).set({
            id: this.deviceId,
            name: deviceName || 'Unknown Device',
            type: deviceType,
            browser: browser,
            screen: screen.width + 'x' + screen.height,
            status: 'pending',
            requestedAt: new Date().toISOString(),
            registeredAt: new Date().toISOString(),
            lastSeen: new Date().toISOString(),
            userAgent: navigator.userAgent.substring(0, 100)
          });
          return true;
        } catch (error) {
          console.error('Error registering device:', error);
          return false;
        }
      },

      // Approve device as first admin (during initial setup) - use approved path like DeviceAuth
      approveAsAdmin: async function() {
        if (!firebaseDb) return false;

        try {
          // Get device info
          const ua = navigator.userAgent;
          let deviceType = 'Unknown Device';
          let browser = 'Unknown Browser';

          if (/iPhone/i.test(ua)) deviceType = 'iPhone';
          else if (/iPad/i.test(ua)) deviceType = 'iPad';
          else if (/Android/i.test(ua) && /Mobile/i.test(ua)) deviceType = 'Android Phone';
          else if (/Android/i.test(ua)) deviceType = 'Android Tablet';
          else if (/Windows/i.test(ua)) deviceType = 'Windows PC';
          else if (/Mac/i.test(ua)) deviceType = 'Mac';
          else if (/Linux/i.test(ua)) deviceType = 'Linux PC';

          if (/Chrome/i.test(ua) && !/Edg/i.test(ua)) browser = 'Chrome';
          else if (/Safari/i.test(ua) && !/Chrome/i.test(ua)) browser = 'Safari';
          else if (/Firefox/i.test(ua)) browser = 'Firefox';
          else if (/Edg/i.test(ua)) browser = 'Edge';

          // Write to approved path (same as DeviceAuth)
          await firebaseDb.ref('jmart-safety/devices/approved/' + this.deviceId).set({
            id: this.deviceId,
            type: deviceType,
            browser: browser,
            screen: screen.width + 'x' + screen.height,
            isAdmin: true,
            approvedAt: new Date().toISOString(),
            approvedBy: 'SYSTEM (First Device)',
            lastSeen: new Date().toISOString()
          });

          // Remove from pending if exists
          await firebaseDb.ref('jmart-safety/devices/pending/' + this.deviceId).remove();

          this.isAdmin = true;
          return true;
        } catch (error) {
          console.error('Error approving as admin:', error);
          return false;
        }
      },

      // Approve a pending device (admin only) - use same paths as DeviceAuth
      approveDevice: async function(targetDeviceId) {
        if (!firebaseDb || !this.isAdmin) return false;

        try {
          // Get pending device data
          const pendingSnap = await firebaseDb.ref('jmart-safety/devices/pending/' + targetDeviceId).once('value');
          if (!pendingSnap.exists()) {
            console.error('Device not found in pending list');
            return false;
          }

          const deviceData = pendingSnap.val();
          const approvedData = {
            ...deviceData,
            isAdmin: false,
            approvedAt: new Date().toISOString(),
            approvedBy: this.deviceId,
            status: 'approved'
          };

          // Move to approved
          await firebaseDb.ref('jmart-safety/devices/approved/' + targetDeviceId).set(approvedData);
          await firebaseDb.ref('jmart-safety/devices/pending/' + targetDeviceId).remove();

          return true;
        } catch (error) {
          console.error('Error approving device:', error);
          return false;
        }
      },

      // Deny a device (admin only) - use same paths as DeviceAuth
      denyDevice: async function(targetDeviceId) {
        if (!firebaseDb || !this.isAdmin) return false;

        try {
          // Get pending device data
          const pendingSnap = await firebaseDb.ref('jmart-safety/devices/pending/' + targetDeviceId).once('value');
          if (pendingSnap.exists()) {
            const deviceData = pendingSnap.val();
            await firebaseDb.ref('jmart-safety/devices/denied/' + targetDeviceId).set({
              ...deviceData,
              deniedAt: new Date().toISOString(),
              deniedBy: this.deviceId
            });
            await firebaseDb.ref('jmart-safety/devices/pending/' + targetDeviceId).remove();
          }
          return true;
        } catch (error) {
          console.error('Error denying device:', error);
          return false;
        }
      },

      // Remove a device (admin only) - remove from approved path
      removeDevice: async function(targetDeviceId) {
        if (!firebaseDb || !this.isAdmin) return false;

        try {
          await firebaseDb.ref('jmart-safety/devices/approved/' + targetDeviceId).remove();
          return true;
        } catch (error) {
          console.error('Error removing device:', error);
          return false;
        }
      },

      // Rename a device (admin only) - update name in approved or pending path
      renameDevice: async function(targetDeviceId, newName) {
        if (!firebaseDb || !this.isAdmin) return false;
        if (!newName || !newName.trim()) return false;

        try {
          // Try approved path first
          const approvedRef = firebaseDb.ref('jmart-safety/devices/approved/' + targetDeviceId);
          const approvedSnap = await approvedRef.once('value');
          if (approvedSnap.exists()) {
            await approvedRef.child('name').set(newName.trim());
            return true;
          }

          // Try pending path
          const pendingRef = firebaseDb.ref('jmart-safety/devices/pending/' + targetDeviceId);
          const pendingSnap = await pendingRef.once('value');
          if (pendingSnap.exists()) {
            await pendingRef.child('name').set(newName.trim());
            return true;
          }

          return false;
        } catch (error) {
          console.error('Error renaming device:', error);
          return false;
        }
      },

      // Listen for device changes (for admin panel) - listen to both paths like DeviceAuth
      listenToDevices: function(callback) {
        if (!firebaseDb) return () => {};

        const pendingRef = firebaseDb.ref('jmart-safety/devices/pending');
        const approvedRef = firebaseDb.ref('jmart-safety/devices/approved');
        const deniedRef = firebaseDb.ref('jmart-safety/devices/denied');

        const updateDevices = () => {
          callback({
            pending: this.pendingDevices,
            approved: this.approvedDevices,
            denied: this.deniedDevices || []
          });
        };

        pendingRef.on('value', (snapshot) => {
          const data = snapshot.val();
          this.pendingDevices = data ? Object.entries(data).map(([id, info]) => ({ id, ...info })) : [];
          updateDevices();
        });

        approvedRef.on('value', (snapshot) => {
          const data = snapshot.val();
          this.approvedDevices = data ? Object.entries(data).map(([id, info]) => ({ id, ...info })) : [];
          updateDevices();
        });

        deniedRef.on('value', (snapshot) => {
          const data = snapshot.val();
          this.deniedDevices = data ? Object.entries(data).map(([id, info]) => ({ id, ...info })) : [];
          updateDevices();
        });

        return () => {
          pendingRef.off();
          approvedRef.off();
          deniedRef.off();
        };
      },

      // Update last seen timestamp - use approved path
      updateLastSeen: async function() {
        if (!firebaseDb || !this.deviceId) return;

        try {
          await firebaseDb.ref('jmart-safety/devices/approved/' + this.deviceId + '/lastSeen').set(new Date().toISOString());
        } catch (error) {
          // Silently fail
        }
      },

      // Get pending device count (for notification badge)
      getPendingCount: function() {
        return this.pendingDevices.length;
      }
    };

    // ========================================
    // PHOTO UPLOAD MANAGER (Google Drive Only)
    // Uses project-based folder structure:
    // JMart Steel/02_Projects/{JobName}/Photos/{YYYY-MM-DD}/
    // ========================================
    const PhotoUploadManager = {
      // Initialize - just log that we're using Google Drive
      init: function() {
        console.log('PhotoUploadManager initialized - using Google Drive for photo storage');
        console.log('Photo structure: JMart Steel/02_Projects/{Job}/Photos/{Date}/');
      },

      // Get or create project folder with Photos subfolder
      // Structure: 02_Projects/{JobName}/Photos/{Date}/
      getOrCreateJobFolder: async function(jobName) {
        if (!GoogleDriveSync.isConnected()) return null;

        try {
          // Ensure main folder exists
          if (!GoogleDriveSync.folderId) {
            await GoogleDriveSync.getOrCreateFolder();
          }

          const safeJobName = jobName.replace(/[<>:"/\\|?*]/g, '_');

          // Create nested path: 02_Projects/{JobName}/Photos
          const folderPath = `${DRIVE_FOLDERS.photos}/${safeJobName}/Photos`;
          const photosFolderId = await GoogleDriveSync.getOrCreateNestedFolder(folderPath);

          if (photosFolderId) {
            console.log(`Photo folder ready: 02_Projects/${safeJobName}/Photos`);
            return photosFolderId;
          }

          // Fallback: create in root if nested creation fails
          console.warn('Could not create project photo folder, using root');
          return GoogleDriveSync.folderId;
        } catch (error) {
          console.error('Error creating job folder:', error);
          return null;
        }
      },

      // Get or create date subfolder within Photos folder
      getOrCreateDateFolder: async function(photosFolderId) {
        if (!GoogleDriveSync.isConnected() || !photosFolderId) return photosFolderId;

        const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

        try {
          // Search for today's folder
          const dateSearch = await fetch(
            `https://www.googleapis.com/drive/v3/files?q=name='${today}' and '${photosFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
            { headers: { 'Authorization': `Bearer ${GoogleDriveSync.accessToken}` } }
          );
          const dateData = await dateSearch.json();

          if (dateData.files && dateData.files.length > 0) {
            return dateData.files[0].id;
          }

          // Create date folder
          const createDate = await fetch('https://www.googleapis.com/drive/v3/files', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${GoogleDriveSync.accessToken}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              name: today,
              mimeType: 'application/vnd.google-apps.folder',
              parents: [photosFolderId],
            }),
          });
          const dateResult = await createDate.json();
          console.log(`Created date folder: ${today}`);
          return dateResult.id;
        } catch (error) {
          console.error('Error creating date folder:', error);
          return photosFolderId; // Fallback to Photos folder
        }
      },

      // Upload photo to Google Drive
      uploadToDrive: async function(file, jobName) {
        if (!GoogleDriveSync.isConnected()) {
          console.error('Google Drive not connected');
          return null;
        }

        try {
          const jobFolderId = await this.getOrCreateJobFolder(jobName);
          if (!jobFolderId) return null;

          const dateFolderId = await this.getOrCreateDateFolder(jobFolderId);

          const timestamp = Date.now();
          const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
          const filename = `${timestamp}_${safeName}`;

          const metadata = {
            name: filename,
            mimeType: file.type,
            parents: [dateFolderId],
          };

          const formData = new FormData();
          formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
          formData.append('file', file);

          const response = await fetch(
            'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',
            {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${GoogleDriveSync.accessToken}` },
              body: formData,
            }
          );

          const data = await response.json();
          console.log('Uploaded to Drive:', filename, data.id);
          return { fileId: data.id, filename };
        } catch (error) {
          console.error('Drive upload error:', error);
          return null;
        }
      },

      // Upload photo to Google Drive (with offline queue support)
      uploadPhoto: async function(file, jobName, onProgress) {
        const results = {
          drive: null,
          success: false,
          queued: false
        };

        // Check if offline or not connected - queue for later
        if (!navigator.onLine || !GoogleDriveSync.isConnected()) {
          if (onProgress) onProgress('Offline - queueing photo...', 50);
          try {
            await OfflinePhotoQueue.addToQueue(file, jobName);
            results.queued = true;
            results.success = true; // Consider it a success since it's queued
            if (onProgress) onProgress('Photo queued for upload when online', 100);
            console.log(`Photo queued for offline upload: ${file.name}`);
          } catch (e) {
            console.error('Error queueing photo:', e);
            if (onProgress) onProgress('Failed to queue photo', 100);
          }
          return results;
        }

        // Upload to Google Drive
        if (onProgress) onProgress('Uploading to Google Drive...', 30);
        results.drive = await this.uploadToDrive(file, jobName);

        if (onProgress) onProgress('Complete!', 100);

        results.success = results.drive !== null;

        // Log to Firebase for tracking
        if (firebaseDb && results.success) {
          try {
            const uploadLog = {
              jobName,
              filename: file.name,
              size: file.size,
              type: file.type,
              uploadedAt: new Date().toISOString(),
              driveFileId: results.drive ? results.drive.fileId : null,
              deviceId: DeviceAuthManager.deviceId
            };
            await firebaseDb.ref('jmart-safety/photoUploads').push(uploadLog);
          } catch (e) {
            console.error('Error logging upload:', e);
          }
        }

        return results;
      }
    };

    // Initialize Photo Upload Manager
    PhotoUploadManager.init();

    // ========================================
    // OFFLINE PHOTO QUEUE MANAGER
    // Queues photos when offline, uploads when back online
    // ========================================
    const OfflinePhotoQueue = {
      queue: [],
      isProcessing: false,
      listeners: [],

      // Initialize - load queue from localStorage
      init: function() {
        try {
          const saved = localStorage.getItem('jmart-photo-queue');
          this.queue = saved ? JSON.parse(saved) : [];
          if (this.queue.length > 0) {
            console.log(`OfflinePhotoQueue: ${this.queue.length} photos pending`);
            if (navigator.onLine && GoogleDriveSync.isConnected()) {
              this.processQueue();
            }
          }
        } catch (e) {
          console.error('Error loading photo queue:', e);
          this.queue = [];
        }

        // Listen for online events
        window.addEventListener('online', () => {
          console.log('Back online - processing photo queue');
          setTimeout(() => this.processQueue(), 2000); // Wait for Drive reconnection
        });
      },

      // Save queue to localStorage
      saveQueue: function() {
        try {
          localStorage.setItem('jmart-photo-queue', JSON.stringify(this.queue));
        } catch (e) {
          console.error('Error saving photo queue:', e);
        }
      },

      // Add photo to queue (stores as base64)
      addToQueue: async function(file, jobName) {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const item = {
              id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
              jobName,
              filename: file.name,
              type: file.type,
              size: file.size,
              data: e.target.result, // base64
              queuedAt: new Date().toISOString()
            };
            this.queue.push(item);
            this.saveQueue();
            this.notifyListeners();
            console.log(`Photo queued for offline upload: ${file.name}`);
            resolve(item.id);
          };
          reader.readAsDataURL(file);
        });
      },

      // Process the queue
      processQueue: async function() {
        if (this.isProcessing || this.queue.length === 0) return;
        if (!navigator.onLine || !GoogleDriveSync.isConnected()) {
          console.log('Cannot process photo queue - offline or not connected');
          return;
        }

        this.isProcessing = true;
        this.notifyListeners();

        const itemsToProcess = [...this.queue];
        let processed = 0;

        for (const item of itemsToProcess) {
          try {
            // Convert base64 back to blob
            const response = await fetch(item.data);
            const blob = await response.blob();
            const file = new File([blob], item.filename, { type: item.type });

            // Upload to Drive
            const result = await PhotoUploadManager.uploadToDrive(file, item.jobName);

            if (result) {
              // Success - remove from queue
              this.queue = this.queue.filter(q => q.id !== item.id);
              this.saveQueue();
              processed++;
              console.log(`Uploaded queued photo: ${item.filename}`);
            }
          } catch (error) {
            console.error(`Error uploading queued photo ${item.filename}:`, error);
          }
        }

        this.isProcessing = false;
        this.notifyListeners();
        console.log(`Processed ${processed}/${itemsToProcess.length} queued photos`);
      },

      // Get queue count
      getCount: function() {
        return this.queue.length;
      },

      // Subscribe to queue changes
      subscribe: function(callback) {
        this.listeners.push(callback);
        callback(this.queue.length, this.isProcessing);
        return () => {
          this.listeners = this.listeners.filter(l => l !== callback);
        };
      },

      // Notify listeners
      notifyListeners: function() {
        this.listeners.forEach(cb => cb(this.queue.length, this.isProcessing));
      }
    };

    // Initialize Offline Photo Queue
    OfflinePhotoQueue.init();

    // ========================================
    // NETWORK STATUS MANAGER
    // Tracks online/offline status for UI
    // ========================================
    const NetworkStatus = {
      isOnline: navigator.onLine,
      listeners: [],

      init: function() {
        window.addEventListener('online', () => {
          this.isOnline = true;
          this.notifyListeners();
          console.log('Network: Online');
        });

        window.addEventListener('offline', () => {
          this.isOnline = false;
          this.notifyListeners();
          console.log('Network: Offline');
        });
      },

      subscribe: function(callback) {
        this.listeners.push(callback);
        callback(this.isOnline);
        return () => {
          this.listeners = this.listeners.filter(l => l !== callback);
        };
      },

      notifyListeners: function() {
        this.listeners.forEach(cb => cb(this.isOnline));
      }
    };

    // Initialize Network Status
    NetworkStatus.init();

    // ========================================
    // PDF GENERATOR - Professional Layout
    // ========================================
    const PDFGenerator = {
      folderMap: {
        'prestart': 'Pre-Start Checklist',
        'inspection': 'Site Inspection',
        'itp': 'ITP Form',
        'incident': 'Incident Report',
        'toolbox': 'Toolbox Talk',
        'steel-itp': 'Steel ITP',
        'training': 'Training Certificate'
      },

      // Field labels for better display
      fieldLabels: {
        supervisorName: 'Supervisor',
        siteConducted: 'Site',
        builder: 'Builder',
        address: 'Address',
        workAreas: 'Work Areas',
        taskToComplete: 'Tasks This Shift',
        plantEquipment: 'Plant/Equipment Used',
        siteHazards: 'Site Specific Hazards',
        permitsRequired: 'Permits Required',
        highRiskWorks: 'High Risk Works',
        swmsCovered: 'SWMS Covered',
        safetyIssues: 'Safety Issues from Previous Shift',
        workerName: 'Worker Name',
        incidentDate: 'Incident Date',
        incidentTime: 'Incident Time',
        incidentType: 'Incident Type',
        description: 'Description',
        actionTaken: 'Action Taken',
        witnesses: 'Witnesses',
        injuries: 'Injuries',
        topic: 'Topic',
        attendees: 'Attendees',
        keyPoints: 'Key Points',
        location: 'Location',
        inspectorName: 'Inspector',
        notes: 'Notes',
        comments: 'Comments'
      },

      // Checklist item labels - all form types
      checklistLabels: {
        // Site Pre-Start
        s1: 'Site access and egress points clear',
        s2: 'Exclusion zones and barriers in place',
        s3: 'First aid kit available and stocked',
        s4: 'Emergency assembly point identified',
        s5: 'Fire extinguishers available',
        s6: 'Site amenities available',
        s7: 'Electrical leads safe',
        s8: 'Work area clean and tidy',
        s9: 'Weather conditions suitable',
        s10: 'All workers inducted',
        // Crane/Hoist
        c1: 'Visual inspection completed',
        c2: 'Safety devices operational',
        c3: 'Load chart available',
        c4: 'Wire ropes in good condition',
        c5: 'Hooks and latches functioning',
        // Forklift
        f1: 'Pre-operational walk around done',
        f2: 'Tyres in good condition',
        f3: 'Forks not bent or cracked',
        f4: 'Brakes functioning',
        f5: 'Horn and lights working',
        // Vehicle
        v1: 'Lights and indicators working',
        v2: 'Tyres in good condition',
        v3: 'Brakes functioning',
        v4: 'Windscreen clear',
        v5: 'First aid kit present',
        // Welding
        w1: 'Welding leads inspected',
        w2: 'Earth clamp secure',
        w3: 'Gas bottles secured',
        w4: 'Fire extinguisher nearby',
        w5: 'PPE available',
        // Scaffold
        sc1: 'Scaffold tag current',
        sc2: 'Base plates in place',
        sc3: 'Guardrails in place',
        sc4: 'Safe access provided',
        sc5: 'No overloading',
        // Legacy labels
        siteAccess: 'Site access and egress points clear',
        exclusionZones: 'Exclusion zones and barriers in place',
        firstAid: 'First aid kit available and stocked',
        emergencyAssembly: 'Emergency assembly point identified',
        fireExtinguishers: 'Fire extinguishers available',
        amenities: 'Site amenities available',
        ppe: 'PPE requirements confirmed',
        hazards: 'Hazards identified and controlled',
        permits: 'Required permits obtained',
        communication: 'Communication systems working'
      },

      // Colors
      colors: {
        primary: [234, 88, 12],      // Orange
        secondary: [249, 115, 22],   // Light orange
        success: [34, 197, 94],      // Green
        danger: [239, 68, 68],       // Red
        dark: [31, 41, 55],          // Dark gray
        gray: [107, 114, 128],       // Gray
        lightGray: [243, 244, 246],  // Light gray
        white: [255, 255, 255]
      },

      generate: function(form) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 15;
        const contentWidth = pageWidth - (margin * 2);

        const type = form.type || 'unknown';
        const folderName = this.folderMap[type] || type;
        const date = new Date(form.createdAt || Date.now());
        const dateStr = date.toLocaleDateString('en-AU').replace(/\//g, '-');

        let y = 0;

        // Helper: Check page break
        const checkPageBreak = (needed = 20) => {
          if (y > pageHeight - needed - 20) {
            doc.addPage();
            y = 20;
            return true;
          }
          return false;
        };

        // Helper: Draw section header
        const drawSectionHeader = (title) => {
          checkPageBreak(25);
          doc.setFillColor(...this.colors.lightGray);
          doc.roundedRect(margin, y, contentWidth, 10, 2, 2, 'F');
          doc.setTextColor(...this.colors.dark);
          doc.setFontSize(11);
          doc.setFont(undefined, 'bold');
          doc.text(title, margin + 5, y + 7);
          doc.setFont(undefined, 'normal');
          y += 15;
        };

        // Helper: Draw field row
        const drawField = (label, value, fullWidth = false) => {
          if (!value && value !== false && value !== 0) return;
          checkPageBreak(15);

          const displayLabel = this.fieldLabels[label] || label.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());
          const displayValue = String(value);

          doc.setFontSize(9);
          doc.setTextColor(...this.colors.gray);
          doc.text(displayLabel, margin + 3, y);

          doc.setFontSize(10);
          doc.setTextColor(...this.colors.dark);

          const maxWidth = fullWidth ? contentWidth - 6 : contentWidth / 2 - 10;
          const lines = doc.splitTextToSize(displayValue, maxWidth);
          doc.text(lines, margin + 3, y + 5);
          y += 5 + (lines.length * 5) + 3;
        };

        // Helper: Draw two-column field
        const drawFieldPair = (label1, value1, label2, value2) => {
          if ((!value1 && value1 !== false) && (!value2 && value2 !== false)) return;
          checkPageBreak(15);

          const halfWidth = contentWidth / 2;

          if (value1 || value1 === false) {
            const displayLabel1 = this.fieldLabels[label1] || label1.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());
            doc.setFontSize(9);
            doc.setTextColor(...this.colors.gray);
            doc.text(displayLabel1, margin + 3, y);
            doc.setFontSize(10);
            doc.setTextColor(...this.colors.dark);
            doc.text(String(value1), margin + 3, y + 5);
          }

          if (value2 || value2 === false) {
            const displayLabel2 = this.fieldLabels[label2] || label2.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());
            doc.setFontSize(9);
            doc.setTextColor(...this.colors.gray);
            doc.text(displayLabel2, margin + halfWidth + 3, y);
            doc.setFontSize(10);
            doc.setTextColor(...this.colors.dark);
            doc.text(String(value2), margin + halfWidth + 3, y + 5);
          }

          y += 15;
        };

        // Helper: Draw complex field with notes and media
        const drawComplexField = (label, fieldData) => {
          if (!fieldData) return;

          // Get value, notes, and media from field object
          let value = fieldData;
          let notes = [];
          let media = [];

          if (typeof fieldData === 'object' && !Array.isArray(fieldData)) {
            value = fieldData.value || '';
            notes = fieldData.notes || [];
            media = fieldData.media || [];
          }

          if (!value && notes.length === 0 && media.length === 0) return;

          checkPageBreak(25);

          // Draw label
          const displayLabel = this.fieldLabels[label] || label;
          doc.setFontSize(10);
          doc.setFont(undefined, 'bold');
          doc.setTextColor(...this.colors.primary);
          doc.text(displayLabel, margin + 3, y);
          doc.setFont(undefined, 'normal');
          y += 6;

          // Draw value if exists
          if (value) {
            doc.setFontSize(10);
            doc.setTextColor(...this.colors.dark);
            const lines = doc.splitTextToSize(String(value), contentWidth - 10);
            doc.text(lines, margin + 5, y);
            y += lines.length * 5 + 3;
          }

          // Draw notes if any
          if (notes && notes.length > 0) {
            checkPageBreak(15);
            doc.setFontSize(8);
            doc.setTextColor(...this.colors.gray);
            doc.text('Notes:', margin + 5, y);
            y += 4;

            notes.forEach((note, idx) => {
              checkPageBreak(10);
              doc.setFillColor(240, 248, 255); // Light blue background
              const noteLines = doc.splitTextToSize('‚Ä¢ ' + note, contentWidth - 15);
              const noteHeight = noteLines.length * 4 + 4;
              doc.roundedRect(margin + 5, y - 2, contentWidth - 10, noteHeight, 1, 1, 'F');
              doc.setFontSize(9);
              doc.setTextColor(30, 64, 175); // Blue text
              doc.text(noteLines, margin + 8, y + 2);
              y += noteHeight + 2;
            });
          }

          // Draw media/photos if any
          if (media && media.length > 0) {
            checkPageBreak(45);
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(...this.colors.gray);
            doc.text('Attached Photos (' + media.length + '):', margin + 5, y);
            doc.setFont(undefined, 'normal');
            y += 8;

            const imgWidth = 45;
            const imgHeight = 35;
            const imgsPerRow = 3;
            let imgX = margin + 5;
            let imgCount = 0;

            media.forEach((item, idx) => {
              if (item.data && item.data.startsWith('data:image')) {
                try {
                  checkPageBreak(imgHeight + 15);

                  // Detect image format from data URL
                  let imgFormat = 'PNG';
                  if (item.data.includes('image/jpeg') || item.data.includes('image/jpg')) {
                    imgFormat = 'JPEG';
                  } else if (item.data.includes('image/png')) {
                    imgFormat = 'PNG';
                  }

                  // Draw border around image
                  doc.setDrawColor(...this.colors.lightGray);
                  doc.setLineWidth(0.5);
                  doc.roundedRect(imgX - 1, y - 1, imgWidth + 2, imgHeight + 2, 2, 2, 'S');

                  // Add image
                  doc.addImage(item.data, imgFormat, imgX, y, imgWidth, imgHeight);

                  // Add label under image
                  doc.setFontSize(7);
                  doc.setTextColor(...this.colors.dark);
                  const imgLabel = item.name ? item.name.substring(0, 20) : 'Photo ' + (idx + 1);
                  doc.text(imgLabel, imgX, y + imgHeight + 5);

                  imgX += imgWidth + 10;
                  imgCount++;

                  if (imgCount >= imgsPerRow) {
                    imgX = margin + 5;
                    imgCount = 0;
                    y += imgHeight + 12;
                  }
                } catch (e) {
                  // Draw placeholder if image fails
                  doc.setDrawColor(...this.colors.gray);
                  doc.setFillColor(245, 245, 245);
                  doc.roundedRect(imgX, y, imgWidth, imgHeight, 2, 2, 'FD');
                  doc.setFontSize(8);
                  doc.setTextColor(...this.colors.gray);
                  doc.text('Photo ' + (idx + 1), imgX + 10, y + imgHeight/2);
                  imgX += imgWidth + 10;
                  imgCount++;
                }
              }
            });

            if (imgCount > 0) {
              y += imgHeight + 8;
            }
          }

          y += 5;
        };

        // ========== HEADER ==========
        // Orange header bar
        doc.setFillColor(...this.colors.primary);
        doc.rect(0, 0, pageWidth, 32, 'F');

        // Company name
        doc.setTextColor(...this.colors.white);
        doc.setFontSize(20);
        doc.setFont(undefined, 'bold');
        doc.text('JMART STEEL', margin, 14);

        // Form type badge
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(folderName.toUpperCase(), margin, 24);

        // Date/Time on right
        doc.setFontSize(9);
        doc.text(date.toLocaleDateString('en-AU', { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' }), pageWidth - margin, 14, { align: 'right' });
        doc.text(date.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' }), pageWidth - margin, 22, { align: 'right' });

        y = 42;

        // ========== FORM CONTENT ==========
        const data = form.data || {};

        // Site Details Section
        if (data.supervisorName || data.siteConducted || data.builder || data.address || data.preparedBy || data.location) {
          drawSectionHeader('SITE DETAILS');
          drawFieldPair('supervisorName', data.supervisorName || data.preparedBy, 'siteConducted', data.siteConducted);
          drawFieldPair('builder', data.builder, 'address', data.address);
          if (data.location) drawFieldPair('location', data.location, 'jobStructure', data.jobStructure);
          if (data.conductedOn) drawField('conductedOn', new Date(data.conductedOn).toLocaleDateString('en-AU'));
        }

        // Work Information Section (Pre-Start) - with notes and media support
        if (data.workAreas || data.taskToComplete || data.tasksThisShift || data.machineryControls) {
          drawSectionHeader('WORK INFORMATION');
          // Use drawComplexField for fields that can have notes and media
          drawComplexField('Work Areas', data.workAreas);
          drawComplexField('Tasks This Shift', data.tasksThisShift);
          drawComplexField('Machinery & Controls', data.machineryControls);
          if (data.taskToComplete) drawField('taskToComplete', data.taskToComplete, true);
        }

        // Safety Information Section - with notes and media support
        if (data.plantEquipment !== undefined || data.isPlantEquipmentUsed !== undefined || data.siteHazards || data.permitsRequired || data.highRiskWorks !== undefined || data.swmsCovered !== undefined || data.worksCoveredBySWMS !== undefined) {
          drawSectionHeader('SAFETY INFORMATION');
          const plantUsed = data.plantEquipment !== undefined ? data.plantEquipment : data.isPlantEquipmentUsed;
          const swmsCovered = data.swmsCovered !== undefined ? data.swmsCovered : data.worksCoveredBySWMS;
          const safetyIssues = data.safetyIssues !== undefined ? data.safetyIssues : data.hasSafetyIssues;
          drawFieldPair('Plant/Equipment Used', plantUsed ? 'Yes' : 'No', 'High Risk Works', data.highRiskWorks ? 'Yes' : 'No');
          drawFieldPair('Works Covered by SWMS', swmsCovered ? 'Yes' : 'No', 'Safety Issues', safetyIssues ? 'Yes' : 'No');
          // Use drawComplexField for fields that can have notes and media
          drawComplexField('Site Hazards', data.siteHazards);
          drawComplexField('Permits Required', data.permitsRequired);
          drawComplexField('Safety Issues Previous Shift', data.safetyIssuesPreviousShift);
          if (data.translatorRequired !== undefined) drawField('Translator Required', data.translatorRequired ? 'Yes' : 'No');
          if (data.translatorName) drawField('Translator Name', data.translatorName);
        }

        // Checklist Section (handles both 'checklist' and 'checks' objects)
        const checklistData = data.checklist || data.checks;
        if (checklistData && typeof checklistData === 'object') {
          // Determine header based on form type
          const checklistHeader = data.checkType ? data.checkType.toUpperCase() + ' CHECKLIST' : 'SAFETY CHECKLIST';
          drawSectionHeader(checklistHeader);

          const checklistItems = Object.entries(checklistData);
          const colWidth = contentWidth / 2;
          let col = 0;
          let startY = y;

          checklistItems.forEach(([key, value], index) => {
            const itemLabel = this.checklistLabels[key] || key.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());
            const xPos = margin + (col * colWidth) + 3;

            // Checkbox
            doc.setDrawColor(...this.colors.gray);
            doc.setLineWidth(0.3);
            doc.rect(xPos, y - 3, 4, 4);

            if (value === true || value === 'yes' || value === 'Yes') {
              doc.setFillColor(...this.colors.success);
              doc.rect(xPos + 0.5, y - 2.5, 3, 3, 'F');
              doc.setTextColor(...this.colors.success);
              doc.setFontSize(8);
              doc.text('‚úì', xPos + 1, y + 0.5);
            } else if (value === false || value === 'no' || value === 'No') {
              doc.setFillColor(...this.colors.danger);
              doc.rect(xPos + 0.5, y - 2.5, 3, 3, 'F');
              doc.setTextColor(...this.colors.danger);
              doc.setFontSize(8);
              doc.text('‚úó', xPos + 1, y + 0.5);
            }

            doc.setTextColor(...this.colors.dark);
            doc.setFontSize(9);
            const truncLabel = itemLabel.length > 35 ? itemLabel.substring(0, 35) + '...' : itemLabel;
            doc.text(truncLabel, xPos + 7, y);

            col++;
            if (col >= 2) {
              col = 0;
              y += 8;
              checkPageBreak(10);
            }
          });

          if (col !== 0) y += 8;
          y += 5;
        }

        // Incident-specific fields
        if (type === 'incident') {
          if (data.incidentDate || data.incidentTime || data.incidentType) {
            drawSectionHeader('INCIDENT DETAILS');
            drawFieldPair('incidentDate', data.incidentDate, 'incidentTime', data.incidentTime);
            if (data.incidentType) drawField('incidentType', data.incidentType, true);
          }
          if (data.description) {
            drawSectionHeader('DESCRIPTION');
            drawField('description', data.description, true);
          }
          if (data.actionTaken) {
            drawSectionHeader('ACTION TAKEN');
            drawField('actionTaken', data.actionTaken, true);
          }
          if (data.injuries) drawField('injuries', data.injuries, true);
          if (data.witnesses) drawField('witnesses', data.witnesses, true);
        }

        // Toolbox-specific fields
        if (type === 'toolbox') {
          if (data.topic || data.topics) {
            drawSectionHeader('TOOLBOX TALK DETAILS');
            if (data.topics && Array.isArray(data.topics)) {
              drawField('Topics Covered', data.topics.join(', '), true);
            }
            if (data.topic) drawField('topic', data.topic, true);
            if (data.otherTopic) drawField('Other Topic', data.otherTopic, true);
          }
          if (data.correctiveAction) drawField('Corrective Action', data.correctiveAction, true);
          if (data.feedbackResponses) drawField('Feedback & Responses', data.feedbackResponses, true);
          if (data.keyPoints) drawField('keyPoints', data.keyPoints, true);
          if (data.attendees) drawField('attendees', data.attendees, true);
        }

        // ITP-specific fields (Glass and Steel ITP)
        if (type === 'itp' || type === 'steel-itp') {
          // Pre-Construction
          if (data.preConstructionMeeting !== undefined || data.preConstMeeting !== undefined ||
              data.highRiskWorkshop !== undefined || data.shopdrawingsApproved !== undefined) {
            drawSectionHeader('PRE-CONSTRUCTION');
            drawFieldPair('Pre-Construction Meeting', data.preConstructionMeeting || data.preConstMeeting, 'High Risk Workshop', data.highRiskWorkshop);
            drawFieldPair('Shop Drawings Approved', data.shopdrawingsApproved, 'All Items Signed Off', data.allItemsSignedOff);
            if (data.shopdrawingRevision) drawField('Shop Drawing Revision', data.shopdrawingRevision, true);
          }

          // Fabrication (Steel ITP)
          if (data.materialsOrdered !== undefined || data.materialsCorrect !== undefined) {
            drawSectionHeader('FABRICATION');
            drawFieldPair('Materials Ordered', data.materialsOrdered, 'Materials Correct', data.materialsCorrect);
            drawFieldPair('Visual Check', data.visualCheck, 'Shop Drawings Current', data.shopdrawingsCurrent);
            drawFieldPair('Setout Correct', data.setoutCorrect, 'Tack Weld', data.tackWeld);
            drawFieldPair('Fully Welded', data.fullyWelded, 'Pack Load', data.packLoad);
          }

          // Surface Finish (Steel ITP)
          if (data.finishConfirmed !== undefined || data.deliveryBooked !== undefined) {
            drawSectionHeader('SURFACE FINISH');
            drawFieldPair('Finish Confirmed', data.finishConfirmed, 'Delivery Booked', data.deliveryBooked);
            drawFieldPair('Sent to Painter', data.sentToPainter, 'Delivery Vehicle', data.deliveryVehicle);
            if (data.afterDeliveryFinish) drawField('After Delivery Finish', data.afterDeliveryFinish);
          }

          // Glass Specification (Glass ITP)
          if (data.orderedGlassFrom || data.glassSpecification) {
            drawSectionHeader('GLASS SPECIFICATION');
            drawFieldPair('Ordered Glass From', data.orderedGlassFrom, 'Glass Specification', data.glassSpecification);
            drawFieldPair('Glass Free From Damage', data.glassFreeFromDamage ? 'Yes' : 'No', 'Specification of Fixings', data.specificationOfFixings);
          }

          // Installation
          if (data.installationMethod || data.setoutCompletedBy || data.surveyorMeasurements !== undefined) {
            drawSectionHeader('INSTALLATION');
            drawFieldPair('Setout Completed By', data.setoutCompletedBy, 'Installation Method', data.installationMethod);
            drawFieldPair('Drawings Confirmed', data.drawingsConfirmed, 'Surveyor Measurements', data.surveyorMeasurements);
            if (data.surveyorName) drawField('Surveyor Name', data.surveyorName);
            if (data.clashesDetected) drawField('Clashes Detected', data.clashesDetected);
          }

          // Glass Installation (Glass ITP)
          if (data.glassInstalledCorrectRL !== undefined || data.glassLockedWedgedGlued !== undefined) {
            drawSectionHeader('GLASS INSTALLATION');
            drawFieldPair('Glass Installed Correct RL', data.glassInstalledCorrectRL ? 'Yes' : 'No', 'Glass Locked/Wedged/Glued', data.glassLockedWedgedGlued ? 'Yes' : 'No');
            if (data.removeWedgesCaulk) drawField('Remove Wedges & Caulk', data.removeWedgesCaulk);
          }

          // Anchoring & Fixing (Steel ITP)
          if (data.chemicalAnchors !== undefined || data.anchorsInstalled !== undefined) {
            drawSectionHeader('ANCHORING & FIXING');
            drawFieldPair('Chemical Anchors', data.chemicalAnchors, 'Anchors Installed', data.anchorsInstalled);
            drawFieldPair('Level & Plumb', data.levelPlumb, 'Bolts Torqued', data.boltsTorqued);
            drawFieldPair('Welding Completed', data.weldingCompleted, 'Grouting Completed', data.groutingCompleted);
          }

          // Handrail (Glass ITP)
          if (data.handrailSpecConfirmed !== undefined || data.spigotsCouplingsTight !== undefined) {
            drawSectionHeader('HANDRAIL');
            drawFieldPair('Handrail Spec Confirmed', data.handrailSpecConfirmed ? 'Yes' : 'No', 'Spigots/Couplings Tight', data.spigotsCouplingsTight ? 'Yes' : 'No');
            drawFieldPair('Handrail Compliant Height', data.handrailCompliantHeight ? 'Yes' : 'No', 'Thread on Fixings', data.threadOnFixings ? 'Yes' : 'No');
            if (data.fullWeldingJunctions !== undefined) drawField('Full Welding Junctions', data.fullWeldingJunctions ? 'Yes' : 'No');
          }

          // Quality Check
          if (data.itemsChecked !== undefined || data.finishAcceptable !== undefined || data.allGlassNoDefects !== undefined) {
            drawSectionHeader('QUALITY CHECK');
            drawFieldPair('Items Checked', data.itemsChecked, 'Finish Acceptable', data.finishAcceptable);
            drawFieldPair('Fixings Torqued', data.fixingsTorqued, 'All Glass No Defects', data.allGlassNoDefects ? 'Yes' : 'No');
            drawFieldPair('All Handrail No Defects', data.allHandrailNoDefects ? 'Yes' : 'No', 'Balustrade As Per Design', data.balustradeAsPerDesign ? 'Yes' : 'No');
          }

          // Weld Testing (Steel ITP)
          if (data.weldTestingBooked !== undefined || data.weldsPassed !== undefined) {
            drawSectionHeader('WELD TESTING');
            drawFieldPair('Weld Testing Booked', data.weldTestingBooked, 'Welds Passed', data.weldsPassed);
            if (data.testingIssues) drawField('Testing Issues', data.testingIssues, true);
          }

          // Final Check & Handover
          if (data.colourConfirmed !== undefined || data.handoverAccepted !== undefined) {
            drawSectionHeader('FINAL CHECK & HANDOVER');
            drawFieldPair('Colour Confirmed', data.colourConfirmed, 'Defects Checked', data.defectsChecked);
            if (data.handoverAccepted !== undefined) drawField('Handover Accepted', data.handoverAccepted);
          }

          // Future Correspondence
          if (data.futureCorrespondence) {
            drawSectionHeader('NOTES & CORRESPONDENCE');
            drawField('Items for Future Correspondence', data.futureCorrespondence, true);
          }
        }

        // Inspection-specific fields
        if (type === 'inspection') {
          if (data.inspectionItems && typeof data.inspectionItems === 'object') {
            drawSectionHeader('INSPECTION ITEMS');
            Object.entries(data.inspectionItems).forEach(([key, value]) => {
              if (value !== undefined && value !== null) {
                const itemLabel = key.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());
                drawField(itemLabel, value);
              }
            });
          }
        }

        // Notes/Comments
        if (data.notes || data.comments) {
          drawSectionHeader('NOTES');
          if (data.notes) drawField('notes', data.notes, true);
          if (data.comments) drawField('comments', data.comments, true);
        }

        // Workers Section (legacy array format)
        if (data.workers && Array.isArray(data.workers) && data.workers.length > 0) {
          drawSectionHeader('WORKERS ON SITE');
          data.workers.forEach((worker, idx) => {
            checkPageBreak(25);
            doc.setFontSize(10);
            doc.setTextColor(...this.colors.dark);
            doc.text((idx + 1) + '. ' + (worker.name || 'Worker ' + (idx + 1)), margin + 3, y);
            y += 6;

            // Draw signature if exists
            if (worker.signature && worker.signature.startsWith('data:image')) {
              try {
                doc.addImage(worker.signature, 'PNG', margin + 5, y, 40, 15);
                y += 18;
              } catch (e) {
                doc.setFontSize(8);
                doc.setTextColor(...this.colors.gray);
                doc.text('[Signature recorded]', margin + 5, y + 5);
                y += 10;
              }
            }
          });
        }

        // Team Signatures Section (object format: { 'Name': signatureData })
        if (data.signatures && typeof data.signatures === 'object' && !Array.isArray(data.signatures)) {
          const signedMembers = Object.entries(data.signatures).filter(([name, sig]) => sig && sig.startsWith && sig.startsWith('data:image'));

          if (signedMembers.length > 0) {
            checkPageBreak(40);
            drawSectionHeader('TEAM SIGNATURES');

            // Draw signatures in a 2-column grid for better layout
            const sigWidth = 55;
            const sigHeight = 22;
            const colWidth = contentWidth / 2;
            let col = 0;
            let rowStartY = y;

            signedMembers.forEach(([name, signature], idx) => {
              const xPos = margin + (col * colWidth);

              // Check if we need a new page
              if (col === 0) {
                checkPageBreak(sigHeight + 15);
                rowStartY = y;
              }

              // Draw signature box with border
              doc.setDrawColor(...this.colors.lightGray);
              doc.setLineWidth(0.3);
              doc.roundedRect(xPos + 2, rowStartY, sigWidth, sigHeight, 2, 2, 'S');

              // Draw signature image
              try {
                doc.addImage(signature, 'PNG', xPos + 4, rowStartY + 2, sigWidth - 6, sigHeight - 8);
              } catch (e) {
                doc.setFontSize(8);
                doc.setTextColor(...this.colors.gray);
                doc.text('[Signature]', xPos + 10, rowStartY + sigHeight / 2);
              }

              // Draw name below signature
              doc.setFontSize(9);
              doc.setTextColor(...this.colors.dark);
              doc.setFont(undefined, 'bold');
              doc.text(name, xPos + 2, rowStartY + sigHeight + 5);
              doc.setFont(undefined, 'normal');

              col++;
              if (col >= 2) {
                col = 0;
                y = rowStartY + sigHeight + 12;
              }
            });

            // Ensure y is updated if we ended on an odd column
            if (col !== 0) {
              y = rowStartY + sigHeight + 12;
            }
            y += 5;
          }
        }

        // Translator Signature Section
        if (data.translatorSignature && data.translatorSignature.startsWith('data:image')) {
          checkPageBreak(40);
          drawSectionHeader('TRANSLATOR SIGNATURE');
          try {
            doc.addImage(data.translatorSignature, 'PNG', margin + 3, y, 50, 20);
            y += 25;
            if (data.translatorName) {
              doc.setFontSize(9);
              doc.setTextColor(...this.colors.gray);
              doc.text('Translator: ' + data.translatorName, margin + 3, y);
              y += 5;
            }
          } catch (e) {
            doc.setFontSize(9);
            doc.setTextColor(...this.colors.gray);
            doc.text('[Translator signature recorded]', margin + 3, y);
            y += 10;
          }
        }

        // Completed By Signature Section (for inspections)
        if (data.completedBySignature && data.completedBySignature.startsWith('data:image')) {
          checkPageBreak(40);
          drawSectionHeader('COMPLETED BY');
          try {
            doc.addImage(data.completedBySignature, 'PNG', margin + 3, y, 50, 20);
            y += 25;
            if (data.completedBy) {
              doc.setFontSize(9);
              doc.setTextColor(...this.colors.gray);
              doc.text(data.completedBy, margin + 3, y);
              y += 5;
            }
          } catch (e) {
            doc.setFontSize(9);
            doc.setTextColor(...this.colors.gray);
            doc.text('[Signature recorded]', margin + 3, y);
            y += 10;
          }
        }

        // Manager Signature Section (for Steel ITP)
        if (data.managerSignature && data.managerSignature.startsWith('data:image')) {
          checkPageBreak(40);
          drawSectionHeader('MANAGER APPROVAL');
          try {
            doc.addImage(data.managerSignature, 'PNG', margin + 3, y, 50, 20);
            y += 25;
            if (data.managerName) {
              doc.setFontSize(9);
              doc.setTextColor(...this.colors.gray);
              doc.text(data.managerName, margin + 3, y);
              y += 5;
            }
          } catch (e) {
            doc.setFontSize(9);
            doc.setTextColor(...this.colors.gray);
            doc.text('[Manager signature recorded]', margin + 3, y);
            y += 10;
          }
        }

        // Builder Signature Section (for Steel ITP and Glass ITP)
        if (data.builderSignature && data.builderSignature.startsWith('data:image')) {
          checkPageBreak(40);
          drawSectionHeader('BUILDER SIGN-OFF');
          try {
            doc.addImage(data.builderSignature, 'PNG', margin + 3, y, 50, 20);
            y += 25;
            if (data.builderName || data.builderSignoffName) {
              doc.setFontSize(9);
              doc.setTextColor(...this.colors.gray);
              doc.text(data.builderName || data.builderSignoffName, margin + 3, y);
              y += 5;
            }
          } catch (e) {
            doc.setFontSize(9);
            doc.setTextColor(...this.colors.gray);
            doc.text('[Builder signature recorded]', margin + 3, y);
            y += 10;
          }
        }

        // Main Signature Section (legacy)
        if (data.signature && data.signature.startsWith('data:image')) {
          checkPageBreak(40);
          drawSectionHeader('SIGNATURE');
          try {
            doc.addImage(data.signature, 'PNG', margin + 3, y, 50, 20);
            y += 25;
            if (data.supervisorName) {
              doc.setFontSize(9);
              doc.setTextColor(...this.colors.gray);
              doc.text(data.supervisorName, margin + 3, y);
              y += 5;
            }
          } catch (e) {
            doc.setFontSize(9);
            doc.setTextColor(...this.colors.gray);
            doc.text('[Digital signature recorded]', margin + 3, y);
            y += 10;
          }
        }

        // ========== FOOTER ==========
        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
          doc.setPage(i);

          // Footer line
          doc.setDrawColor(...this.colors.lightGray);
          doc.setLineWidth(0.5);
          doc.line(margin, pageHeight - 15, pageWidth - margin, pageHeight - 15);

          // Footer text
          doc.setFontSize(8);
          doc.setTextColor(...this.colors.gray);
          doc.text('J&M Artsteel Safety App', margin, pageHeight - 8);
          doc.text('Page ' + i + ' of ' + totalPages, pageWidth / 2, pageHeight - 8, { align: 'center' });
          doc.text('Generated: ' + new Date().toLocaleString('en-AU'), pageWidth - margin, pageHeight - 8, { align: 'right' });
        }

        // Generate filename
        const siteName = data.siteConducted || data.site || data.siteLocation || data.jobName || 'Form';
        const safeSiteName = siteName.toString().replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '-').substring(0, 30);
        const safeFormType = folderName.replace(/[^a-zA-Z0-9]/g, '-');
        const filename = safeSiteName + '_' + safeFormType + '_' + dateStr + '.pdf';

        return { doc, filename, folderName };
      },

      download: function(form) {
        const { doc, filename } = this.generate(form);
        doc.save(filename);
        return filename;
      }
    };
  </script>

  <style>
    /* Base styles */
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    * {
      -webkit-tap-highlight-color: transparent;
      box-sizing: border-box;
    }

    /* Safe area padding for notched devices */
    .safe-top { padding-top: env(safe-area-inset-top); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }

    /* Smooth scrolling */
    html { scroll-behavior: smooth; }

    /* Better touch targets */
    button, select, input, textarea {
      min-height: 44px;
      font-size: 16px; /* Prevents zoom on iOS */
    }

    /* Loading spinner */
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #ea580c;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Pull to refresh indicator */
    .pull-indicator {
      transition: transform 0.2s ease;
    }

    /* Prevent text selection on buttons */
    button {
      -webkit-user-select: none;
      user-select: none;
    }

    /* Better focus states for accessibility */
    button:focus, input:focus, select:focus, textarea:focus {
      outline: 2px solid #ea580c;
      outline-offset: 2px;
    }

    /* Hide scrollbar but keep functionality */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* Install prompt banner */
    .install-banner {
      position: fixed;
      bottom: 70px;
      left: 10px;
      right: 10px;
      background: linear-gradient(135deg, #ea580c 0%, #dc2626 100%);
      color: white;
      padding: 12px 16px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 1000;
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp {
      from { transform: translateY(100px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* Offline indicator */
    .offline-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #fbbf24;
      color: #92400e;
      text-align: center;
      padding: 8px;
      font-size: 14px;
      font-weight: 500;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <!-- Form Validation Service v3 (WHS compliance, adapted from src-v3/services/formValidation.js) -->
  <script>
    window.formValidator = (function() {
      // Validate a value is present
      function isPresent(val) {
        if (val === undefined || val === null || val === '') return false;
        if (Array.isArray(val) && val.length === 0) return false;
        return true;
      }

      // Validate date is not in future
      function dateNotFuture(dateStr) {
        if (!dateStr) return null;
        const d = new Date(dateStr);
        const today = new Date(); today.setHours(23,59,59,999);
        if (d > today) return 'Date cannot be in the future';
        return null;
      }

      // Toolbox talk validation
      function validateToolbox(form) {
        const errors = [];
        if (!isPresent(form.siteConducted)) errors.push('Site/Location is required');
        if (!isPresent(form.preparedBy)) errors.push('Presented By is required');
        if (!isPresent(form.topics || form.selectedTopics)) errors.push('At least one topic must be selected');
        const signedCount = form.signatures ? Object.values(form.signatures).filter(s => s !== null).length : 0;
        if (signedCount === 0) errors.push('At least one attendee must sign on');
        return errors;
      }

      // Inspection validation
      function validateInspection(form) {
        const errors = [];
        if (!isPresent(form.siteConducted)) errors.push('Site/Location is required');
        if (!isPresent(form.preparedBy)) errors.push('Prepared By is required');
        if (!isPresent(form.completedBy)) errors.push('Completed By is required');
        // Check at least some inspection items answered
        if (form.inspectionItems) {
          const answered = Object.values(form.inspectionItems).filter(v => v !== null && v !== undefined).length;
          const total = Object.keys(form.inspectionItems).length;
          if (answered < total) errors.push('All ' + total + ' inspection items must be completed (' + answered + ' done)');
        }
        return errors;
      }

      // ITP (Glass) validation
      function validateITP(form) {
        const errors = [];
        if (!isPresent(form.siteConducted)) errors.push('Site/Location is required');
        if (!isPresent(form.preparedBy)) errors.push('Prepared By is required');
        if (!isPresent(form.builderSignoffName)) errors.push('Builder name is required');
        if (!isPresent(form.builderSignature)) errors.push('Builder signature is required');
        return errors;
      }

      // Steel ITP validation
      function validateSteelITP(form) {
        const errors = [];
        if (!isPresent(form.siteConducted)) errors.push('Site/Location is required');
        if (!isPresent(form.preparedBy)) errors.push('Prepared By is required');
        if (!isPresent(form.managerName)) errors.push('Manager name is required');
        if (!isPresent(form.managerSignature)) errors.push('Manager signature is required');
        return errors;
      }

      // Check if incident is notifiable (WHS Act 2011)
      function isNotifiableIncident(incident) {
        const notifiable = ['death','serious injury','dangerous incident','hospitalization','amputation','serious burns','spinal injury','loss of consciousness'];
        const text = ((incident.incidentType || '') + ' ' + (incident.severity || '') + ' ' + (incident.description || '')).toLowerCase();
        return notifiable.some(t => text.includes(t));
      }

      return {
        validateToolbox: validateToolbox,
        validateInspection: validateInspection,
        validateITP: validateITP,
        validateSteelITP: validateSteelITP,
        isNotifiableIncident: isNotifiableIncident,
        isPresent: isPresent,
        dateNotFuture: dateNotFuture
      };
    })();
  </script>

  <script type="text/babel">
    const { useState, useRef, useEffect, useMemo } = React;
    const {
      Shield, ClipboardCheck, AlertTriangle, Users, Plus, ChevronRight, ChevronLeft,
      Check, X, Calendar, User, MapPin, Building, Wrench, AlertCircle, CheckCircle,
      Home, Menu, Bell, Settings, Trash2, Phone, Edit3, Copy, Clock, Download,
      FileText, Camera, Image, StickyNote, Clipboard
    } = lucide;

    // Icon component wrapper
    function Icon({ icon, size = 24, className = "" }) {
      const ref = useRef(null);
      useEffect(() => {
        if (ref.current && icon) {
          ref.current.innerHTML = '';
          const svg = icon;
          svg.setAttribute('width', size);
          svg.setAttribute('height', size);
          if (className) {
            className.split(' ').forEach(c => c && svg.classList.add(c));
          }
          ref.current.appendChild(svg.cloneNode(true));
        }
      }, [icon, size, className]);
      return <span ref={ref} style={{display: 'inline-flex', alignItems: 'center'}}></span>;
    }

    // Simple icon rendering function
    function LucideIcon({ name, size = 24, className = "" }) {
      const iconRef = useRef(null);
      useEffect(() => {
        if (iconRef.current) {
          iconRef.current.innerHTML = '';
          lucide.createIcons({
            icons: { [name]: lucide.icons[name] },
            attrs: { width: size, height: size, class: className }
          });
        }
      }, [name, size, className]);
      return <i ref={iconRef} data-lucide={name} style={{width: size, height: size}}></i>;
    }

    // Signature Pad Component
    function SignaturePad({ onSave, onCancel, name }) {
      const canvasRef = useRef(null);
      const [isDrawing, setIsDrawing] = useState(false);
      const [hasSignature, setHasSignature] = useState(false);
      const [showSavedOptions, setShowSavedOptions] = useState(false);

      // Get saved signatures from localStorage
      const savedSignatures = useMemo(() => {
        try {
          const saved = localStorage.getItem('jmart-team-signatures');
          return saved ? JSON.parse(saved) : {};
        } catch (e) {
          return {};
        }
      }, []);

      // Check if this person has a saved signature
      const hasSavedSignature = savedSignatures[name] && savedSignatures[name].startsWith('data:image');

      const getCoordinates = (e) => {
        const canvas = canvasRef.current;
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        if (e.touches) {
          return { x: (e.touches[0].clientX - rect.left) * scaleX, y: (e.touches[0].clientY - rect.top) * scaleY };
        }
        return { x: (e.clientX - rect.left) * scaleX, y: (e.clientY - rect.top) * scaleY };
      };

      const startDrawing = (e) => {
        e.preventDefault();
        const ctx = canvasRef.current.getContext('2d');
        const { x, y } = getCoordinates(e);
        ctx.beginPath();
        ctx.moveTo(x, y);
        setIsDrawing(true);
      };

      const draw = (e) => {
        if (!isDrawing) return;
        e.preventDefault();
        const ctx = canvasRef.current.getContext('2d');
        const { x, y } = getCoordinates(e);
        ctx.lineTo(x, y);
        ctx.strokeStyle = '#1a1a1a';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.stroke();
        setHasSignature(true);
      };

      const stopDrawing = () => setIsDrawing(false);
      const clearSignature = () => {
        const ctx = canvasRef.current.getContext('2d');
        ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);
        setHasSignature(false);
      };
      const saveSignature = () => onSave(canvasRef.current.toDataURL('image/png'));

      // SIGNATURE SECURITY: Require verification before using saved signatures
      const [verificationCode, setVerificationCode] = useState('');
      const [showVerification, setShowVerification] = useState(false);
      const [selectedMember, setSelectedMember] = useState(null);
      const [verificationError, setVerificationError] = useState('');

      // Generate a simple verification code based on name (last 4 chars of name hash)
      const getVerificationCode = (memberName) => {
        let hash = 0;
        const str = memberName.toLowerCase().replace(/\s/g, '');
        for (let i = 0; i < str.length; i++) {
          hash = ((hash << 5) - hash) + str.charCodeAt(i);
          hash = hash & hash;
        }
        return Math.abs(hash % 10000).toString().padStart(4, '0');
      };

      // Use saved signature - requires verification
      const useSavedSignature = () => {
        if (hasSavedSignature) {
          setSelectedMember(name);
          setShowVerification(true);
          setVerificationError('');
        }
      };

      // Use another team member's saved signature - DISABLED for security
      // Each person must sign their own signature
      const useOtherSignature = (memberName) => {
        // SECURITY FIX: Do not allow using other people's signatures
        // Instead, show a message that each person must sign their own
        alert(`Security Notice: ${memberName} must sign their own signature. Please have them sign directly on this device.`);
        setShowSavedOptions(false);
      };

      // Verify and apply signature
      const verifyAndApplySignature = () => {
        if (!selectedMember) return;

        const expectedCode = getVerificationCode(selectedMember);
        if (verificationCode === expectedCode) {
          // Verification passed - apply signature with audit log
          AuditLogManager.log('signature_used', {
            signerName: selectedMember,
            usedBy: DeviceAuthManager.deviceId,
            method: 'saved_signature',
            timestamp: new Date().toISOString()
          });
          onSave(savedSignatures[selectedMember]);
          setShowVerification(false);
          setVerificationCode('');
        } else {
          setVerificationError('Incorrect code. Please enter your personal verification code.');
        }
      };

      // Get list of team members with saved signatures (for display only)
      const membersWithSignatures = Object.entries(savedSignatures)
        .filter(([_, sig]) => sig && sig.startsWith('data:image'))
        .map(([memberName]) => memberName);

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl w-full max-w-md">
            <div className="p-4 border-b">
              <h3 className="font-semibold text-gray-800">Sign: {name}</h3>
              <p className="text-sm text-gray-500">Draw your signature below or use a saved one</p>
            </div>

            {/* Verification Modal */}
            {showVerification && (
              <div className="p-4 bg-amber-50 border-b border-amber-200">
                <p className="text-sm text-amber-800 mb-2 font-medium">üîê Signature Verification Required</p>
                <p className="text-xs text-amber-700 mb-3">
                  To use {selectedMember}'s saved signature, please enter your personal verification code.
                  <br/>
                  <span className="text-amber-600">(Hint: Your code is based on your name)</span>
                </p>
                <input
                  type="text"
                  inputMode="numeric"
                  pattern="[0-9]*"
                  maxLength={4}
                  value={verificationCode}
                  onChange={(e) => setVerificationCode(e.target.value.replace(/\D/g, ''))}
                  placeholder="Enter 4-digit code"
                  className="w-full border border-amber-300 rounded-lg px-3 py-2 mb-2 text-center text-lg tracking-widest"
                />
                {verificationError && (
                  <p className="text-red-600 text-sm mb-2">{verificationError}</p>
                )}
                <div className="flex gap-2">
                  <button
                    onClick={() => { setShowVerification(false); setVerificationCode(''); setVerificationError(''); }}
                    className="flex-1 border border-gray-300 text-gray-700 py-2 rounded-lg"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={verifyAndApplySignature}
                    className="flex-1 bg-amber-600 text-white py-2 rounded-lg font-medium"
                  >
                    Verify & Sign
                  </button>
                </div>
              </div>
            )}

            {/* Saved Signature Option - only show if not in verification mode */}
            {hasSavedSignature && !showVerification && (
              <div className="p-4 bg-green-50 border-b border-green-100">
                <p className="text-sm text-green-700 mb-2">‚úì {name} has a saved signature</p>
                <button
                  onClick={useSavedSignature}
                  className="w-full bg-green-600 text-white py-2 rounded-lg font-medium flex items-center justify-center gap-2"
                >
                  <span>‚úçÔ∏è</span> Use Saved Signature (requires verification)
                </button>
              </div>
            )}

            {/* Info about signature security */}
            {membersWithSignatures.length > 1 && !showVerification && (
              <div className="px-4 pt-3">
                <p className="text-xs text-gray-500 italic">
                  üîí Security: Each team member must sign their own signature.
                  Saved signatures require verification before use.
                </p>
              </div>
            )}

            <div className="p-4">
              <p className="text-xs text-gray-500 mb-2">Or draw a new signature:</p>
              <div className="border-2 border-gray-300 rounded-lg bg-gray-50 relative">
                <canvas ref={canvasRef} width={350} height={150} className="w-full touch-none"
                  onMouseDown={startDrawing} onMouseMove={draw} onMouseUp={stopDrawing} onMouseLeave={stopDrawing}
                  onTouchStart={startDrawing} onTouchMove={draw} onTouchEnd={stopDrawing} />
                <div className="absolute bottom-2 left-2 right-2 border-t border-gray-400"></div>
                <span className="absolute bottom-3 left-3 text-xs text-gray-400">Sign here</span>
              </div>
            </div>
            <div className="p-4 border-t flex gap-3">
              <button onClick={clearSignature} className="flex-1 border border-gray-300 text-gray-700 py-2 rounded-lg">Clear</button>
              <button onClick={onCancel} className="flex-1 border border-gray-300 text-gray-700 py-2 rounded-lg">Cancel</button>
              <button onClick={saveSignature} disabled={!hasSignature} className="flex-1 bg-green-600 text-white py-2 rounded-lg disabled:bg-gray-300">Save</button>
            </div>
          </div>
        </div>
      );
    }

    // Note Media Box Component
    function NoteMediaBox({ label, iconName, value, notes, media, onValueChange, onAddNote, onAddMedia, onRemoveNote, onRemoveMedia }) {
      const cameraInputRef = useRef(null);
      const galleryInputRef = useRef(null);
      const [showNoteInput, setShowNoteInput] = useState(false);
      const [newNote, setNewNote] = useState('');

      const handleAddNote = () => {
        if (newNote.trim()) {
          onAddNote(newNote.trim());
          setNewNote('');
          setShowNoteInput(false);
        }
      };

      const handleMediaCapture = (e) => {
        const files = e.target.files;
        console.log('handleMediaCapture called, files:', files?.length);
        if (files && files.length > 0) {
          Array.from(files).forEach(file => {
            console.log('Processing file:', file.name, 'type:', file.type, 'size:', file.size);

            // Compress image before storing to avoid localStorage quota issues on mobile
            const compressImage = (file, maxWidth = 1200, quality = 0.7) => {
              return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                  console.log('FileReader loaded, data length:', event.target.result?.length);

                  // For mobile compatibility, use createImageBitmap if available (better for large images)
                  if (typeof createImageBitmap !== 'undefined') {
                    createImageBitmap(file).then(bitmap => {
                      console.log('ImageBitmap created:', bitmap.width, 'x', bitmap.height);
                      const canvas = document.createElement('canvas');
                      let width = bitmap.width;
                      let height = bitmap.height;

                      // Scale down if larger than maxWidth
                      if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                      }

                      canvas.width = width;
                      canvas.height = height;
                      const ctx = canvas.getContext('2d');
                      ctx.drawImage(bitmap, 0, 0, width, height);
                      bitmap.close(); // Free memory

                      const compressedData = canvas.toDataURL('image/jpeg', quality);
                      console.log('Compressed via ImageBitmap, data length:', compressedData?.length);
                      resolve(compressedData);
                    }).catch(err => {
                      console.error('ImageBitmap error, falling back to Image:', err);
                      // Fallback to Image approach
                      useImageFallback(event.target.result, maxWidth, quality, resolve);
                    });
                  } else {
                    // Fallback for browsers without createImageBitmap
                    useImageFallback(event.target.result, maxWidth, quality, resolve);
                  }
                };
                reader.onerror = (err) => {
                  console.error('Error reading file:', file.name, err);
                  resolve(null);
                };
                reader.readAsDataURL(file);
              });
            };

            // Fallback function using Image element
            const useImageFallback = (dataUrl, maxWidth, quality, resolve) => {
              const img = new Image();
              img.onload = () => {
                console.log('Image loaded:', img.width, 'x', img.height);
                try {
                  const canvas = document.createElement('canvas');
                  let width = img.width;
                  let height = img.height;

                  if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                  }

                  canvas.width = width;
                  canvas.height = height;
                  const ctx = canvas.getContext('2d');
                  ctx.drawImage(img, 0, 0, width, height);

                  const compressedData = canvas.toDataURL('image/jpeg', quality);
                  console.log('Compressed via Image, data length:', compressedData?.length);
                  resolve(compressedData);
                } catch (err) {
                  console.error('Canvas error:', err);
                  resolve(dataUrl); // Use original if canvas fails
                }
              };
              img.onerror = (err) => {
                console.error('Image load error:', err);
                resolve(dataUrl); // Use original if image fails to load
              };
              // Set crossOrigin before src to avoid CORS issues
              img.crossOrigin = 'anonymous';
              img.src = dataUrl;
            };

            compressImage(file).then(compressedData => {
              console.log('compressImage resolved, data:', compressedData ? 'yes' : 'no');
              if (compressedData) {
                console.log('Calling onAddMedia with data');
                onAddMedia({ name: file.name, type: 'image/jpeg', data: compressedData });
              } else {
                console.error('No compressed data returned for', file.name);
              }
            }).catch(err => {
              console.error('compressImage error:', err);
            });
          });
        }
        e.target.value = '';
      };

      return (
        <div className="bg-white rounded-xl p-4 shadow-sm space-y-3">
          <h4 className="font-semibold text-gray-800 text-orange-600">{label}</h4>
          <textarea value={value} onChange={(e) => onValueChange(e.target.value)}
            className="w-full border border-gray-300 rounded-lg p-3 text-sm min-h-[80px]"
            placeholder={`Enter ${label.toLowerCase()}...`} />
          <div className="flex gap-2">
            <button onClick={() => setShowNoteInput(!showNoteInput)}
              className="flex-1 bg-blue-50 border border-blue-200 text-blue-700 py-2 px-3 rounded-lg text-sm font-medium">
              üìù Add Note
            </button>
            <button onClick={() => cameraInputRef.current?.click()}
              className="flex-1 bg-purple-50 border border-purple-200 text-purple-700 py-2 px-3 rounded-lg text-sm font-medium">
              üì∑ Camera
            </button>
            <button onClick={() => galleryInputRef.current?.click()}
              className="flex-1 bg-green-50 border border-green-200 text-green-700 py-2 px-3 rounded-lg text-sm font-medium">
              üñºÔ∏è Gallery
            </button>
            {/* Camera input - with capture attribute to open camera */}
            <input ref={cameraInputRef} type="file" accept="image/*" capture="environment" onChange={handleMediaCapture} className="hidden" />
            {/* Gallery input - without capture attribute to open photo library */}
            <input ref={galleryInputRef} type="file" accept="image/*" multiple onChange={handleMediaCapture} className="hidden" />
          </div>
          {showNoteInput && (
            <div className="flex gap-2">
              <input type="text" value={newNote} onChange={(e) => setNewNote(e.target.value)}
                className="flex-1 border border-gray-300 rounded-lg p-2 text-sm" placeholder="Type your note..."
                onKeyPress={(e) => e.key === 'Enter' && handleAddNote()} />
              <button onClick={handleAddNote} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">Add</button>
            </div>
          )}
          {notes && notes.length > 0 && (
            <div className="space-y-2">
              <p className="text-xs font-medium text-gray-500 uppercase">Notes:</p>
              {notes.map((note, idx) => (
                <div key={idx} className="flex items-start justify-between bg-blue-50 p-2 rounded-lg">
                  <p className="text-sm text-blue-800">{note}</p>
                  <button onClick={() => onRemoveNote(idx)} className="text-blue-500 ml-2">‚úï</button>
                </div>
              ))}
            </div>
          )}
          {media && media.length > 0 && (
            <div className="space-y-2">
              <p className="text-xs font-medium text-gray-500 uppercase">Photos:</p>
              <div className="grid grid-cols-3 gap-2">
                {media.map((item, idx) => (
                  <div key={idx} className="relative">
                    <img src={item.data} alt={item.name} className="w-full h-20 object-cover rounded-lg" />
                    <button onClick={() => onRemoveMedia(idx)} className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs">‚úï</button>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      );
    }

    // Login Screen Component
    function LoginScreen({ onAuthenticated, authStatus }) {
      const [password, setPassword] = useState('');
      const [deviceName, setDeviceName] = useState('');
      const [error, setError] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const [isFirstSetup, setIsFirstSetup] = useState(false);
      const [newPassword, setNewPassword] = useState('');
      const [confirmPassword, setConfirmPassword] = useState('');

      useEffect(() => {
        // Check if this is first time setup (no password set)
        if (!DeviceAuthManager.APP_PASSWORD_HASH) {
          setIsFirstSetup(true);
        }
      }, []);

      const handleFirstSetup = async () => {
        if (newPassword.length < 4) {
          setError('Password must be at least 4 characters');
          return;
        }
        if (newPassword !== confirmPassword) {
          setError('Passwords do not match');
          return;
        }

        setIsLoading(true);
        setError('');

        try {
          // Set the password
          await DeviceAuthManager.setPassword(newPassword);

          // Register this device as admin
          await DeviceAuthManager.registerDevice(deviceName || 'Admin Device');
          await DeviceAuthManager.approveAsAdmin();

          onAuthenticated(true);
        } catch (err) {
          setError('Setup failed. Please try again.');
        }

        setIsLoading(false);
      };

      const handleLogin = async () => {
        if (!password) {
          setError('Please enter the password');
          return;
        }

        setIsLoading(true);
        setError('');

        if (DeviceAuthManager.verifyPassword(password)) {
          // Password correct - register device if new
          const status = await DeviceAuthManager.init();

          if (status.status === 'new') {
            // Register as pending
            await DeviceAuthManager.registerDevice(deviceName || 'Unknown Device');
            setError('');
            // Force re-render with pending status
            onAuthenticated(false, 'pending');
          } else if (status.status === 'approved') {
            onAuthenticated(true);
          } else if (status.status === 'pending') {
            onAuthenticated(false, 'pending');
          } else if (status.status === 'denied') {
            setError('This device has been denied access. Contact your administrator.');
          }
        } else {
          setError('Incorrect password');
        }

        setIsLoading(false);
      };

      // First time setup screen
      if (isFirstSetup) {
        return (
          <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
              <div className="text-center mb-6">
                <div className="w-20 h-20 bg-orange-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                  <span className="text-4xl">üõ°Ô∏è</span>
                </div>
                <h1 className="text-2xl font-bold text-gray-800">J&M Artsteel Safety</h1>
                <p className="text-gray-500 mt-2">First Time Setup</p>
              </div>

              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Device Name</label>
                  <input
                    type="text"
                    value={deviceName}
                    onChange={(e) => setDeviceName(e.target.value)}
                    placeholder="e.g. Jeff's iPhone"
                    className="w-full border border-gray-300 rounded-lg p-3 text-lg"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Set App Password</label>
                  <input
                    type="password"
                    value={newPassword}
                    onChange={(e) => setNewPassword(e.target.value)}
                    placeholder="Create a password"
                    className="w-full border border-gray-300 rounded-lg p-3 text-lg"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                  <input
                    type="password"
                    value={confirmPassword}
                    onChange={(e) => setConfirmPassword(e.target.value)}
                    placeholder="Confirm password"
                    className="w-full border border-gray-300 rounded-lg p-3 text-lg"
                    onKeyPress={(e) => e.key === 'Enter' && handleFirstSetup()}
                  />
                </div>

                {error && (
                  <div className="bg-red-50 border border-red-200 text-red-700 p-3 rounded-lg text-sm">
                    {error}
                  </div>
                )}

                <button
                  onClick={handleFirstSetup}
                  disabled={isLoading}
                  className="w-full bg-orange-600 text-white py-3 rounded-lg font-semibold text-lg hover:bg-orange-700 disabled:bg-gray-400"
                >
                  {isLoading ? '‚è≥ Setting up...' : 'üîê Complete Setup'}
                </button>

                <p className="text-xs text-gray-500 text-center">
                  This password will be required for all devices accessing the app.
                  Share it only with authorized team members.
                </p>
              </div>
            </div>
          </div>
        );
      }

      // Pending approval screen
      if (authStatus === 'pending') {
        return (
          <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md text-center">
              <div className="w-20 h-20 bg-yellow-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                <span className="text-4xl">‚è≥</span>
              </div>
              <h1 className="text-2xl font-bold text-gray-800">Awaiting Approval</h1>
              <p className="text-gray-500 mt-2 mb-6">
                Your device is waiting for admin approval.
                Please ask Jeff or your supervisor to approve this device.
              </p>

              <div className="bg-gray-50 rounded-lg p-4 mb-4">
                <p className="text-sm text-gray-600">Device ID:</p>
                <p className="font-mono text-xs text-gray-800 break-all">{DeviceAuthManager.deviceId}</p>
              </div>

              <button
                onClick={() => window.location.reload()}
                className="w-full bg-orange-600 text-white py-3 rounded-lg font-semibold"
              >
                üîÑ Check Again
              </button>
            </div>
          </div>
        );
      }

      // Normal login screen
      return (
        <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
            <div className="text-center mb-6">
              <div className="w-20 h-20 bg-orange-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                <span className="text-4xl">üõ°Ô∏è</span>
              </div>
              <h1 className="text-2xl font-bold text-gray-800">J&M Artsteel Safety</h1>
              <p className="text-gray-500 mt-2">Enter password to access</p>
            </div>

            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Device Name (optional)</label>
                <input
                  type="text"
                  value={deviceName}
                  onChange={(e) => setDeviceName(e.target.value)}
                  placeholder="e.g. Scott's iPad"
                  className="w-full border border-gray-300 rounded-lg p-3"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  placeholder="Enter app password"
                  className="w-full border border-gray-300 rounded-lg p-3 text-lg"
                  onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                />
              </div>

              {error && (
                <div className="bg-red-50 border border-red-200 text-red-700 p-3 rounded-lg text-sm">
                  {error}
                </div>
              )}

              <button
                onClick={handleLogin}
                disabled={isLoading}
                className="w-full bg-orange-600 text-white py-3 rounded-lg font-semibold text-lg hover:bg-orange-700 disabled:bg-gray-400"
              >
                {isLoading ? '‚è≥ Checking...' : 'üîì Enter App'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // App Wrapper with Authentication
    function AppWithAuth() {
      const [authState, setAuthState] = useState('loading'); // 'loading', 'authenticated', 'unauthenticated', 'pending'
      const [isAdmin, setIsAdmin] = useState(false);

      useEffect(() => {
        checkAuth();
      }, []);

      const checkAuth = async () => {
        // Check if Firebase is configured
        if (!isFirebaseConfigured || !firebaseDb) {
          // No Firebase = no auth required (local mode)
          setAuthState('authenticated');
          return;
        }

        const status = await DeviceAuthManager.init();
        console.log('Device auth status:', status);

        if (status.canAccess) {
          setIsAdmin(DeviceAuthManager.isAdmin);
          setAuthState('authenticated');

          // Update last seen
          DeviceAuthManager.updateLastSeen();
        } else if (status.status === 'pending') {
          setAuthState('pending');
        } else if (status.status === 'new' && !DeviceAuthManager.APP_PASSWORD_HASH) {
          // First time setup
          setAuthState('unauthenticated');
        } else {
          setAuthState('unauthenticated');
        }
      };

      const handleAuthenticated = (success, newStatus) => {
        if (success) {
          setIsAdmin(DeviceAuthManager.isAdmin);
          setAuthState('authenticated');
        } else if (newStatus === 'pending') {
          setAuthState('pending');
        }
      };

      if (authState === 'loading') {
        return (
          <div className="min-h-screen bg-gray-100 flex items-center justify-center">
            <div className="text-center">
              <div className="w-16 h-16 bg-orange-500 rounded-2xl flex items-center justify-center mx-auto mb-4 animate-pulse">
                <span className="text-3xl">üõ°Ô∏è</span>
              </div>
              <p className="text-gray-600">Loading...</p>
            </div>
          </div>
        );
      }

      if (authState === 'unauthenticated' || authState === 'pending') {
        return <LoginScreen onAuthenticated={handleAuthenticated} authStatus={authState} />;
      }

      return <JMartSteelSafetyApp isAdmin={isAdmin} />;
    }

    // Main App
    function JMartSteelSafetyApp({ isAdmin = false }) {
      const [currentView, setCurrentView] = useState('dashboard');
      const [menuOpen, setMenuOpen] = useState(false);
      const [forms, setForms] = useState([]);
      const [sites, setSites] = useState([]);
      const [isOnline, setIsOnline] = useState(navigator.onLine);
      const [showInstallPrompt, setShowInstallPrompt] = useState(false);
      const [deferredPrompt, setDeferredPrompt] = useState(null);
      const [lastSynced, setLastSynced] = useState(null);
      const [syncStatus, setSyncStatus] = useState(FirebaseSync.isConnected() ? 'synced' : 'local'); // 'synced', 'syncing', 'offline', 'local', 'pending', 'error'
      const [pendingSyncCount, setPendingSyncCount] = useState(FirebaseSync.getPendingCount());
      const [pendingPhotoCount, setPendingPhotoCount] = useState(OfflinePhotoQueue.getCount());
      const [syncError, setSyncError] = useState(null);
      const [showSyncBanner, setShowSyncBanner] = useState(!FirebaseSync.isConnected());
      const [successModal, setSuccessModal] = useState(null); // { form, type } for PDF download modal
      const [viewFormModal, setViewFormModal] = useState(null); // Form being viewed
      const [deleteConfirmModal, setDeleteConfirmModal] = useState(null); // Form to delete
      const [editingForm, setEditingForm] = useState(null); // Form being edited
      const [updateConfirmModal, setUpdateConfirmModal] = useState(null); // { form, formType, formData } for update confirmation
      const [isUpdating, setIsUpdating] = useState(false); // Loading state during update
      const [backedUpForms, setBackedUpForms] = useState(() => {
        const saved = localStorage.getItem('jmart-backed-up-forms');
        return saved ? JSON.parse(saved) : [];
      });
      const [savedSignatures, setSavedSignatures] = useState(() => {
        const saved = localStorage.getItem('jmart-team-signatures');
        return saved ? JSON.parse(saved) : {};
      });
      const isInitialLoad = useRef(true);
      const deletingFormRef = useRef(false); // Track when we're deleting to prevent Firebase restore

      // Device Authorization State
      const [deviceAuthStatus, setDeviceAuthStatus] = useState('checking'); // 'checking', 'approved', 'pending', 'denied'
      const [isDeviceAdmin, setIsDeviceAdmin] = useState(false);
      const [canViewDevices, setCanViewDevices] = useState(false);
      const [canRevokeDevices, setCanRevokeDevices] = useState(false);
      const [pendingDevices, setPendingDevices] = useState([]);
      const [approvedDevices, setApprovedDevices] = useState([]);
      const [newDeviceNotification, setNewDeviceNotification] = useState(null);

      // Initialize Device Authorization
      useEffect(() => {
        const initDeviceAuth = async () => {
          const result = await DeviceAuth.init();

          if (result.approved) {
            setDeviceAuthStatus('approved');
            setIsDeviceAdmin(result.admin);
            setCanViewDevices(result.canViewDevices || result.admin); // Admins can always view
            setCanRevokeDevices(result.canRevokeDevices || result.admin); // Admins can always revoke

            // If admin, enable notifications for new device requests
            if (result.admin) {
              DeviceAuth.requestNotificationPermission();

              // Listen for new device notifications (admin only)
              DeviceAuth.onNotification((type, data) => {
                if (type === 'new_device') {
                  setNewDeviceNotification(data);
                  DeviceAuth.showBrowserNotification(
                    'New Device Request',
                    `${data.type} (${data.browser}) wants to access J&M Artsteel Safety`
                  );
                  // Auto-dismiss after 10 seconds
                  setTimeout(() => setNewDeviceNotification(null), 10000);
                }
              });
            }

            // If admin or can view/revoke devices, listen for device lists
            if (result.admin || result.canViewDevices || result.canRevokeDevices) {
              // Listen for pending device requests
              DeviceAuth.listenForPendingDevices((devices) => {
                setPendingDevices(devices);
              });

              // Listen for approved devices (for settings display)
              DeviceAuth.listenForApprovedDevices((devices) => {
                setApprovedDevices(devices);
              });
            }

            // Listen for own device being revoked
            DeviceAuth.listenForOwnDeviceStatus((status) => {
              if (status.revoked) {
                setDeviceAuthStatus('denied');
                alert('Your device access has been revoked by an administrator.');
              }
            });
          } else {
            setDeviceAuthStatus('pending');

            // Poll for approval every 5 seconds
            const pollInterval = setInterval(async () => {
              const checkResult = await DeviceAuth.checkDeviceStatus();
              if (checkResult.approved) {
                setDeviceAuthStatus('approved');
                setIsDeviceAdmin(checkResult.admin);
                clearInterval(pollInterval);
                window.location.reload(); // Reload to fully initialize
              }
            }, 5000);

            return () => clearInterval(pollInterval);
          }
        };

        initDeviceAuth();
      }, []);

      // Load saved data from localStorage first, then listen to Firebase
      useEffect(() => {
        // Load local data first (for offline support)
        const savedForms = localStorage.getItem('jmart-safety-forms');
        let localForms = [];
        if (savedForms) {
          try {
            localForms = JSON.parse(savedForms);
            setForms(localForms);
            console.log('Loaded from localStorage:', localForms.length, 'forms');
          } catch (e) {
            console.error('Error parsing localStorage forms:', e);
          }
        }

        const savedSites = localStorage.getItem('jmart-safety-sites');
        if (savedSites) {
          try {
            setSites(JSON.parse(savedSites));
          } catch (e) {
            console.error('Error parsing localStorage sites:', e);
          }
        }

        const lastSync = localStorage.getItem('jmart-last-sync');
        if (lastSync) setLastSynced(lastSync);

        // If Firebase is connected, listen for real-time updates
        if (FirebaseSync.isConnected()) {
          const unsubForms = FirebaseSync.onFormsChange((firebaseForms) => {
            const formsArray = Array.isArray(firebaseForms) ? firebaseForms : Object.values(firebaseForms || {});
            console.log('Firebase forms received:', formsArray.length, 'forms');

            // If we just deleted a form, use Firebase data as source of truth (don't merge)
            if (deletingFormRef.current) {
              console.log('Delete operation in progress - using Firebase as source of truth');
              deletingFormRef.current = false;
              setForms(formsArray);
              localStorage.setItem('jmart-safety-forms', JSON.stringify(formsArray));
              setSyncStatus('synced');
              setLastSynced(new Date().toISOString());
              return;
            }

            // CONFLICT RESOLUTION: Merge with timestamp-based conflict handling
            // This prevents data loss and resolves concurrent edits properly
            if (formsArray.length > 0) {
              const mergedForms = [];
              const formMap = new Map();

              // First, add all Firebase forms to the map
              formsArray.forEach(form => {
                formMap.set(form.id, { ...form, source: 'firebase' });
              });

              // Then, merge local forms with conflict resolution
              localForms.forEach(localForm => {
                const existingForm = formMap.get(localForm.id);
                if (!existingForm) {
                  // New local form not in Firebase - add it
                  formMap.set(localForm.id, { ...localForm, source: 'local' });
                } else {
                  // CONFLICT: Same form exists in both - resolve by timestamp
                  const localTime = new Date(localForm.updatedAt || localForm.createdAt).getTime();
                  const remoteTime = new Date(existingForm.updatedAt || existingForm.createdAt).getTime();

                  if (localTime > remoteTime) {
                    // Local is newer - use local version
                    console.log(`Conflict resolved for ${localForm.id}: local wins (${new Date(localTime).toISOString()} > ${new Date(remoteTime).toISOString()})`);
                    formMap.set(localForm.id, { ...localForm, source: 'local-wins' });
                  } else if (localTime < remoteTime) {
                    // Firebase is newer - keep Firebase version
                    console.log(`Conflict resolved for ${localForm.id}: firebase wins (${new Date(remoteTime).toISOString()} > ${new Date(localTime).toISOString()})`);
                  } else {
                    // Same timestamp - prefer version with higher version number
                    const localVersion = localForm.version || 1;
                    const remoteVersion = existingForm.version || 1;
                    if (localVersion > remoteVersion) {
                      formMap.set(localForm.id, { ...localForm, source: 'local-version' });
                    }
                  }
                }
              });

              // Convert map back to array and sort
              formMap.forEach(form => mergedForms.push(form));
              mergedForms.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
              setForms(mergedForms);
              localStorage.setItem('jmart-safety-forms', JSON.stringify(mergedForms));
              console.log('Merged forms with conflict resolution:', mergedForms.length, 'total');
            } else if (localForms.length > 0) {
              // Firebase is empty but we have local data - push to Firebase
              console.log('Firebase empty, pushing local forms to Firebase');
              FirebaseSync.syncForms(localForms);
            }

            setSyncStatus('synced');
            setLastSynced(new Date().toISOString());
          });

          const unsubSites = FirebaseSync.onSitesChange((firebaseSites) => {
            const sitesArray = Array.isArray(firebaseSites) ? firebaseSites : Object.values(firebaseSites || {});
            if (sitesArray.length > 0) {
              setSites(sitesArray);
              localStorage.setItem('jmart-safety-sites', JSON.stringify(sitesArray));
            }
          });

          // Mark initial load as complete after a short delay
          setTimeout(() => {
            isInitialLoad.current = false;
          }, 1000);

          return () => {
            unsubForms();
            unsubSites();
          };
        } else {
          isInitialLoad.current = false;
        }
      }, []);

      // Save forms to localStorage and sync to Firebase
      useEffect(() => {
        // Always save to localStorage when forms change (except on initial empty load)
        if (!isInitialLoad.current) {
          localStorage.setItem('jmart-safety-forms', JSON.stringify(forms));
          localStorage.setItem('jmart-last-sync', new Date().toISOString());
          setLastSynced(new Date().toISOString());
          console.log('Forms saved to localStorage:', forms.length, 'forms');

          // Sync to Firebase if connected and we have forms
          if (FirebaseSync.isConnected() && isOnline && forms.length > 0) {
            setSyncStatus('syncing');
            FirebaseSync.syncForms(forms).then(() => {
              setSyncStatus('synced');
              console.log('Forms synced to Firebase:', forms.length, 'forms');
            }).catch((err) => {
              setSyncStatus('offline');
              console.error('Firebase sync failed:', err);
            });
          }
        }
      }, [forms, isOnline]);

      // Save sites to localStorage and sync to Firebase
      useEffect(() => {
        if (sites.length > 0 && !isInitialLoad.current) {
          localStorage.setItem('jmart-safety-sites', JSON.stringify(sites));

          // Sync to Firebase if connected
          if (FirebaseSync.isConnected() && isOnline) {
            FirebaseSync.syncSites(sites);
          }
        }
      }, [sites, isOnline]);

      // Online/Offline detection
      useEffect(() => {
        const handleOnline = () => setIsOnline(true);
        const handleOffline = () => setIsOnline(false);
        window.addEventListener('online', handleOnline);
        window.addEventListener('offline', handleOffline);
        return () => {
          window.removeEventListener('online', handleOnline);
          window.removeEventListener('offline', handleOffline);
        };
      }, []);

      // Sync status listener - updates UI when sync queue changes
      useEffect(() => {
        const unsubscribe = FirebaseSync.onSyncStatusChange((status, details) => {
          setPendingSyncCount(details?.pending || 0);
          if (status === 'synced' && details?.pending === 0) {
            setSyncStatus('synced');
            setSyncError(null);
          } else if (status === 'queued' || (details?.pending > 0)) {
            setSyncStatus('pending');
          } else if (status === 'error' || status === 'failed') {
            setSyncStatus('error');
            setSyncError(details?.message || details?.error || 'Sync failed');
          }
        });
        return unsubscribe;
      }, []);

      // Photo queue listener - updates UI when offline photos are queued/uploaded
      useEffect(() => {
        const unsubscribe = OfflinePhotoQueue.subscribe((count, isProcessing) => {
          setPendingPhotoCount(count);
        });
        return unsubscribe;
      }, []);

      // PWA Install prompt
      useEffect(() => {
        const handler = (e) => {
          e.preventDefault();
          setDeferredPrompt(e);
          // Show install prompt after 30 seconds if not dismissed
          const dismissed = localStorage.getItem('jmart-install-dismissed');
          if (!dismissed) {
            setTimeout(() => setShowInstallPrompt(true), 30000);
          }
        };
        window.addEventListener('beforeinstallprompt', handler);
        return () => window.removeEventListener('beforeinstallprompt', handler);
      }, []);

      const handleInstall = async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          if (outcome === 'accepted') {
            setShowInstallPrompt(false);
          }
          setDeferredPrompt(null);
        }
      };

      const dismissInstall = () => {
        setShowInstallPrompt(false);
        localStorage.setItem('jmart-install-dismissed', 'true');
      };

      const addForm = (formType, formData) => {
        try {
          // Generate unique ID with collision prevention (timestamp + random)
          const uniqueId = Date.now().toString(36) + '-' + Math.random().toString(36).substr(2, 9);
          const newForm = {
            id: uniqueId,
            type: formType,
            data: formData,
            createdAt: new Date().toISOString(),
            // AUDIT TRAIL: Track who created this form
            createdBy: DeviceAuthManager.deviceId || 'unknown',
            createdByName: localStorage.getItem('jmart-user-name') || 'Unknown User',
            version: 1,
            status: 'completed'
          };
          console.log('addForm called, current forms:', forms.length, 'isInitialLoad:', isInitialLoad.current);

          // Use functional update to ensure we get latest forms state
          setForms(prevForms => {
            const updatedForms = [newForm, ...prevForms];
            console.log('setForms update, new length:', updatedForms.length);

            // Immediately save to localStorage as backup with error handling
            try {
              const dataToSave = JSON.stringify(updatedForms);
              console.log('Data size:', Math.round(dataToSave.length / 1024), 'KB');
              localStorage.setItem('jmart-safety-forms', dataToSave);
              console.log('Immediately saved to localStorage');
            } catch (storageErr) {
              console.error('localStorage save error:', storageErr);
              // If localStorage is full, try removing old backup data
              if (storageErr.name === 'QuotaExceededError') {
                try {
                  // Remove any backup keys that might be taking space
                  const keysToRemove = [];
                  for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.includes('backup') || key.includes('temp')) {
                      keysToRemove.push(key);
                    }
                  }
                  keysToRemove.forEach(key => localStorage.removeItem(key));
                  // Try saving again
                  localStorage.setItem('jmart-safety-forms', JSON.stringify(updatedForms));
                  console.log('Saved after cleanup');
                } catch (retryErr) {
                  console.error('Failed to save even after cleanup:', retryErr);
                  alert('Storage full! Please delete some old forms to save new ones.');
                }
              }
            }

            // Immediately sync to Firebase
            if (FirebaseSync.isConnected()) {
              FirebaseSync.syncForms(updatedForms).then(() => {
                console.log('Immediately synced to Firebase');
              }).catch(err => console.error('Firebase sync error:', err));
            }

            return updatedForms;
          });

          // Auto-download PDF with date and job name
          setTimeout(() => {
            try {
              const filename = PDFGenerator.download(newForm);
              markAsBackedUp(newForm.id);
              console.log('Auto-saved PDF:', filename);
            } catch (pdfErr) {
              console.error('PDF generation error:', pdfErr);
            }
          }, 500);

          // AUDIT LOG: Record form creation
          AuditLogManager.log('create', {
            formId: newForm.id,
            formType: formType,
            site: formData.siteConducted || formData.site || 'Unknown',
            action: 'Form created'
          });

          // Show success modal
          setSuccessModal({ form: newForm, type: formType });
        } catch (err) {
          console.error('Error saving form:', err);
          alert('Error saving form: ' + err.message + '. Please try again.');
        }
      };

      // Show confirmation modal before updating
      const updateForm = (formId, formType, formData) => {
        console.log('updateForm called - showing confirmation for id:', formId);
        const updatedForm = {
          id: formId,
          type: formType,
          data: formData,
          createdAt: editingForm?.createdAt,
          createdBy: editingForm?.createdBy,
          createdByName: editingForm?.createdByName,
          updatedAt: new Date().toISOString(),
          // AUDIT TRAIL: Track who modified this form
          modifiedBy: DeviceAuthManager.deviceId || 'unknown',
          modifiedByName: localStorage.getItem('jmart-user-name') || 'Unknown User',
          version: (editingForm?.version || 1) + 1,
          // Keep history of previous versions for audit
          previousVersion: editingForm ? {
            data: editingForm.data,
            modifiedAt: editingForm.updatedAt || editingForm.createdAt,
            modifiedBy: editingForm.modifiedBy || editingForm.createdBy
          } : null,
          status: 'completed'
        };
        setUpdateConfirmModal({ form: updatedForm, formType, formData, originalForm: editingForm });
      };

      // Go back to editing mode
      const continueEditing = () => {
        setUpdateConfirmModal(null);
        // Stay in edit mode - editingForm is still set
      };

      // Confirm and sync the update
      const confirmUpdate = async () => {
        if (!updateConfirmModal) return;

        setIsUpdating(true);
        const { form, formType, formData, originalForm } = updateConfirmModal;
        const siteName = formData.siteConducted || formData.site || '';

        try {
          // 1. Delete old PDFs from Google Drive (if connected)
          if (GoogleDriveSync.isConnected() && siteName) {
            console.log('Searching for old PDFs to delete...');
            await GoogleDriveSync.deleteOldFormPDFs(form.id, siteName);
          }

          // 2. Update form in state and localStorage
          setForms(prevForms => {
            const updatedForms = prevForms.map(f => {
              if (f.id === form.id) {
                return {
                  ...f,
                  data: formData,
                  updatedAt: new Date().toISOString()
                };
              }
              return f;
            });

            // Save to localStorage
            localStorage.setItem('jmart-safety-forms', JSON.stringify(updatedForms));
            console.log('Updated form saved to localStorage');

            // 3. Sync to Firebase
            if (FirebaseSync.isConnected()) {
              FirebaseSync.syncForms(updatedForms).then(() => {
                console.log('Updated form synced to Firebase');
              }).catch(err => console.error('Firebase sync error:', err));
            }

            return updatedForms;
          });

          // 4. Download new PDF
          const filename = PDFGenerator.download(form);
          markAsBackedUp(form.id);
          console.log('Downloaded updated PDF:', filename);

          // 5. Upload new PDF to Google Drive (if connected)
          if (GoogleDriveSync.isConnected()) {
            const { doc } = PDFGenerator.generate(form);
            const pdfBlob = doc.output('blob');
            await GoogleDriveSync.uploadPDF(pdfBlob, filename, form.type);
            console.log('Uploaded new PDF to Drive:', form.type);
          }

          // Clear states and show success
          setUpdateConfirmModal(null);
          setEditingForm(null);
          setIsUpdating(false);
          setSuccessModal({ form, type: formType, wasUpdated: true });

        } catch (error) {
          console.error('Error during update:', error);
          setIsUpdating(false);
          alert('Error updating form. Please try again.');
        }
      };

      // Cancel update and go back to dashboard
      const cancelUpdate = () => {
        setUpdateConfirmModal(null);
        setEditingForm(null);
        setCurrentView('dashboard');
      };

      const handleDownloadPDF = () => {
        if (successModal?.form) {
          const filename = PDFGenerator.download(successModal.form);
          markAsBackedUp(successModal.form.id);
          console.log('Downloaded and backed up:', filename);
        }
      };

      const closeSuccessModal = () => {
        setSuccessModal(null);
        setEditingForm(null);
        setCurrentView('dashboard');
      };

      // Mark form as backed up (after PDF download)
      const markAsBackedUp = (formId) => {
        const newBackedUp = [...backedUpForms, formId];
        setBackedUpForms(newBackedUp);
        localStorage.setItem('jmart-backed-up-forms', JSON.stringify(newBackedUp));
      };

      // Update team signatures
      const updateSignatures = (newSignatures) => {
        setSavedSignatures(newSignatures);
        localStorage.setItem('jmart-team-signatures', JSON.stringify(newSignatures));
        // Sync to Firebase
        if (FirebaseSync.isConnected()) {
          FirebaseSync.db.ref('signatures').set(newSignatures);
        }
      };

      // Download PDF and mark as backed up
      const handleDownloadAndBackup = () => {
        if (successModal?.form) {
          const filename = PDFGenerator.download(successModal.form);
          markAsBackedUp(successModal.form.id);
          console.log('Downloaded and marked as backed up:', filename);
        }
      };

      // Delete form (with backup check)
      const deleteForm = (formId) => {
        // Find the form being deleted for audit log
        const deletedForm = forms.find(f => f.id === formId);

        const updatedForms = forms.filter(f => f.id !== formId);
        setForms(updatedForms);
        setDeleteConfirmModal(null);
        setViewFormModal(null);

        // AUDIT LOG: Record form deletion
        AuditLogManager.log('delete', {
          formId: formId,
          formType: deletedForm?.type || 'unknown',
          site: deletedForm?.data?.siteConducted || deletedForm?.data?.site || 'Unknown',
          originalCreatedBy: deletedForm?.createdBy,
          originalCreatedAt: deletedForm?.createdAt,
          action: 'Form deleted'
        });

        // Immediately save to localStorage
        localStorage.setItem('jmart-safety-forms', JSON.stringify(updatedForms));
        console.log('Form deleted, saved to localStorage:', updatedForms.length, 'forms remaining');

        // Set flag to prevent Firebase listener from restoring deleted form
        deletingFormRef.current = true;

        // Sync deletion to Firebase
        if (FirebaseSync.isConnected()) {
          FirebaseSync.syncForms(updatedForms).then(() => {
            console.log('Deletion synced to Firebase');
          }).catch(err => {
            console.error('Failed to sync deletion to Firebase:', err);
            deletingFormRef.current = false; // Reset flag on error
          });
        } else {
          deletingFormRef.current = false; // Reset flag if not connected
        }
      };

      // Check if form is backed up
      const isFormBackedUp = (formId) => backedUpForms.includes(formId);

      const previousPrestarts = forms.filter(f => f.type === 'prestart');

      const navItems = [
        { id: 'dashboard', label: 'Dashboard', emoji: 'üè†' },
        { id: 'training', label: 'Training', emoji: 'üéì' },
        { id: 'recordings', label: 'Recordings', emoji: 'üì∏' },
        { id: 'prestart', label: 'Pre-Start Checks', emoji: 'üìã' },
        { id: 'steel-itp', label: 'Steel ITP', emoji: 'üî©' },
        { id: 'inspection', label: 'Site Inspection', emoji: 'üîç' },
        { id: 'itp', label: 'ITP Form', emoji: 'üìù' },
        { id: 'incidents', label: 'Incident Reports', emoji: '‚ö†Ô∏è' },
        { id: 'toolbox', label: 'Toolbox Talks', emoji: 'üë•' },
        { id: 'emergency', label: 'Emergency Info', emoji: 'üìû' },
        { id: 'settings', label: 'Settings', emoji: '‚öôÔ∏è' },
      ];

      // Show loading while checking device authorization
      if (deviceAuthStatus === 'checking') {
        return (
          <div className="min-h-screen bg-gray-100 flex items-center justify-center">
            <div className="text-center">
              <div className="text-6xl mb-4">üõ°Ô∏è</div>
              <h2 className="text-xl font-bold text-gray-800">J&M Artsteel Safety</h2>
              <p className="text-gray-600 mt-2">Verifying device authorization...</p>
              <div className="mt-4">
                <div className="animate-spin inline-block w-8 h-8 border-4 border-orange-500 border-t-transparent rounded-full"></div>
              </div>
            </div>
          </div>
        );
      }

      // Show pending approval screen if device is not approved
      if (deviceAuthStatus === 'pending' || deviceAuthStatus === 'denied') {
        return (
          <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-xl max-w-md w-full overflow-hidden">
              <div className={`p-6 text-center ${deviceAuthStatus === 'denied' ? 'bg-red-500' : 'bg-orange-500'} text-white`}>
                <div className="text-6xl mb-4">{deviceAuthStatus === 'denied' ? 'üö´' : 'üîê'}</div>
                <h2 className="text-2xl font-bold">
                  {deviceAuthStatus === 'denied' ? 'Access Denied' : 'Authorization Required'}
                </h2>
              </div>
              <div className="p-6 space-y-4">
                {deviceAuthStatus === 'pending' ? (
                  <>
                    <p className="text-gray-600 text-center">
                      This device is not yet authorized to access J&M Artsteel Safety.
                    </p>
                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                      <p className="text-yellow-800 font-medium text-center">Waiting for Admin Approval</p>
                      <p className="text-yellow-700 text-sm text-center mt-1">
                        Your request has been sent. An administrator will review it shortly.
                      </p>
                    </div>
                    <div className="bg-gray-50 rounded-lg p-4 space-y-2">
                      <p className="text-sm text-gray-500">Your Device:</p>
                      <p className="font-medium text-gray-800">{DeviceAuth.deviceInfo?.type} ({DeviceAuth.deviceInfo?.browser})</p>
                      <p className="text-xs text-gray-400">ID: {DeviceAuth.deviceId}</p>
                    </div>
                    <div className="flex items-center justify-center gap-2 text-sm text-gray-500">
                      <div className="animate-pulse w-2 h-2 bg-orange-500 rounded-full"></div>
                      <span>Checking for approval...</span>
                    </div>
                  </>
                ) : (
                  <>
                    <p className="text-gray-600 text-center">
                      Your device access has been denied or revoked by an administrator.
                    </p>
                    <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                      <p className="text-red-800 text-center">
                        Please contact your administrator if you believe this is an error.
                      </p>
                    </div>
                  </>
                )}
                <button
                  onClick={() => window.location.reload()}
                  className="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-medium hover:bg-gray-300 transition"
                >
                  Refresh
                </button>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-100 flex flex-col safe-top">
          {/* New Device Request Notification for Admins */}
          {newDeviceNotification && isDeviceAdmin && (
            <div className="fixed top-4 left-4 right-4 bg-blue-600 text-white p-4 rounded-xl shadow-lg z-[200] animate-pulse">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <span className="text-2xl">üì±</span>
                  <div>
                    <p className="font-semibold">New Device Request!</p>
                    <p className="text-sm text-blue-100">
                      {newDeviceNotification.type} ({newDeviceNotification.browser}) wants access
                    </p>
                  </div>
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={async () => {
                      await DeviceAuth.approveDevice(newDeviceNotification.id);
                      setNewDeviceNotification(null);
                    }}
                    className="bg-green-500 text-white px-3 py-1 rounded-lg text-sm font-medium hover:bg-green-600"
                  >
                    Approve
                  </button>
                  <button
                    onClick={async () => {
                      await DeviceAuth.denyDevice(newDeviceNotification.id);
                      setNewDeviceNotification(null);
                    }}
                    className="bg-red-500 text-white px-3 py-1 rounded-lg text-sm font-medium hover:bg-red-600"
                  >
                    Deny
                  </button>
                  <button
                    onClick={() => setNewDeviceNotification(null)}
                    className="text-white opacity-70 px-2"
                  >
                    ‚úï
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Pending Devices Banner for Admins */}
          {pendingDevices.length > 0 && isDeviceAdmin && !newDeviceNotification && (
            <div
              onClick={() => setCurrentView('settings')}
              className="bg-blue-500 text-white p-2 text-center cursor-pointer hover:bg-blue-600 transition"
            >
              <span className="text-sm font-medium">
                üì± {pendingDevices.length} device(s) waiting for approval - Tap to review
              </span>
            </div>
          )}

          {/* Offline Banner */}
          {!isOnline && (
            <div className="offline-banner">
              ‚ö†Ô∏è You're offline - Data will sync when connected
            </div>
          )}

          {/* Success Modal with PDF Download */}
          {successModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] p-4">
              <div className="bg-white rounded-2xl max-w-sm w-full shadow-2xl overflow-hidden">
                <div className="bg-green-500 text-white p-6 text-center">
                  <div className="text-5xl mb-3">‚úÖ</div>
                  <h2 className="text-xl font-bold">Form Submitted!</h2>
                  <p className="text-green-100 text-sm mt-1">
                    {PDFGenerator.folderMap[successModal.type] || successModal.type}
                  </p>
                </div>
                <div className="p-6 space-y-4">
                  <p className="text-gray-600 text-center text-sm">
                    Your form has been saved{FirebaseSync.isConnected() ? ' and synced to the cloud' : ''}.
                  </p>
                  <button
                    onClick={handleDownloadPDF}
                    className="w-full bg-orange-600 text-white py-4 rounded-xl font-semibold flex items-center justify-center gap-2 hover:bg-orange-700 transition"
                  >
                    <span className="text-xl">üì•</span>
                    Download PDF
                  </button>
                  <p className="text-xs text-gray-400 text-center">
                    Save to Google Drive / JMart Steel / Safety Forms
                  </p>
                  <button
                    onClick={closeSuccessModal}
                    className="w-full bg-gray-100 text-gray-700 py-3 rounded-xl font-medium hover:bg-gray-200 transition"
                  >
                    Back to Dashboard
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* View Form Modal */}
          {viewFormModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] p-4">
              <div className="bg-white rounded-2xl max-w-md w-full shadow-2xl max-h-[80vh] overflow-hidden flex flex-col">
                <div className="bg-orange-600 text-white p-4 flex items-center justify-between">
                  <h2 className="text-lg font-bold">
                    {PDFGenerator.folderMap[viewFormModal.type] || viewFormModal.type}
                  </h2>
                  <button onClick={() => setViewFormModal(null)} className="text-white text-2xl">&times;</button>
                </div>
                <div className="flex-1 overflow-y-auto p-4 space-y-3">
                  <div className="text-sm text-gray-500">
                    {new Date(viewFormModal.createdAt).toLocaleDateString('en-AU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
                    {' at '}
                    {new Date(viewFormModal.createdAt).toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' })}
                  </div>
                  {viewFormModal.data && Object.entries(viewFormModal.data).map(([key, value]) => {
                    if (!value || typeof value === 'object') return null;
                    const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                    return (
                      <div key={key} className="border-b border-gray-100 pb-2">
                        <p className="text-xs text-gray-500">{label}</p>
                        <p className="text-sm text-gray-800">{String(value)}</p>
                      </div>
                    );
                  })}
                </div>
                <div className="p-4 border-t border-gray-200 space-y-2">
                  <button
                    onClick={() => {
                      setEditingForm(viewFormModal);
                      setViewFormModal(null);
                      setCurrentView(viewFormModal.type);
                    }}
                    className="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
                  >
                    <span>‚úèÔ∏è</span> Modify Form
                  </button>
                  <button
                    onClick={() => {
                      PDFGenerator.download(viewFormModal);
                      markAsBackedUp(viewFormModal.id);
                    }}
                    className="w-full bg-orange-600 text-white py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
                  >
                    <span>üì•</span> Download PDF
                  </button>
                  <button
                    onClick={() => setDeleteConfirmModal(viewFormModal)}
                    className="w-full bg-red-100 text-red-600 py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
                  >
                    <span>üóëÔ∏è</span> Delete Form
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Delete Confirmation Modal */}
          {deleteConfirmModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[110] p-4">
              <div className="bg-white rounded-2xl max-w-sm w-full shadow-2xl overflow-hidden">
                <div className="bg-red-500 text-white p-4 text-center">
                  <span className="text-4xl">‚ö†Ô∏è</span>
                  <h2 className="text-lg font-bold mt-2">Delete Form?</h2>
                </div>
                <div className="p-4 space-y-4">
                  {!isFormBackedUp(deleteConfirmModal.id) ? (
                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                      <p className="text-yellow-800 text-sm font-medium">This form has NOT been backed up!</p>
                      <p className="text-yellow-700 text-xs mt-1">Download the PDF first to save a copy.</p>
                    </div>
                  ) : (
                    <div className="bg-green-50 border border-green-200 rounded-lg p-3">
                      <p className="text-green-800 text-sm">‚úì This form has been backed up</p>
                    </div>
                  )}
                  <div className="space-y-2">
                    {!isFormBackedUp(deleteConfirmModal.id) && (
                      <button
                        onClick={() => {
                          PDFGenerator.download(deleteConfirmModal);
                          markAsBackedUp(deleteConfirmModal.id);
                        }}
                        className="w-full bg-orange-600 text-white py-3 rounded-xl font-semibold"
                      >
                        üì• Download PDF First
                      </button>
                    )}
                    <button
                      onClick={() => deleteForm(deleteConfirmModal.id)}
                      className="w-full bg-red-600 text-white py-3 rounded-xl font-semibold"
                    >
                      üóëÔ∏è Delete Permanently
                    </button>
                    <button
                      onClick={() => setDeleteConfirmModal(null)}
                      className="w-full bg-gray-100 text-gray-700 py-3 rounded-xl font-medium"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Update Confirmation Modal */}
          {updateConfirmModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[120] p-4">
              <div className="bg-white rounded-2xl max-w-sm w-full shadow-2xl overflow-hidden">
                <div className="bg-blue-600 text-white p-4 text-center">
                  <span className="text-4xl">üîÑ</span>
                  <h2 className="text-lg font-bold mt-2">Update Form?</h2>
                </div>
                <div className="p-4 space-y-4">
                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p className="text-blue-800 text-sm font-medium">You've made changes to this form.</p>
                    <p className="text-blue-700 text-xs mt-1">
                      {GoogleDriveSync.isConnected()
                        ? 'This will update Firebase and replace the old PDF on Google Drive.'
                        : 'This will update the form in Firebase.'}
                    </p>
                  </div>

                  {updateConfirmModal.formData?.siteConducted && (
                    <div className="bg-gray-50 rounded-lg p-3">
                      <p className="text-gray-600 text-xs">Site</p>
                      <p className="text-gray-800 font-medium">{updateConfirmModal.formData.siteConducted}</p>
                    </div>
                  )}

                  <div className="space-y-2">
                    <button
                      onClick={confirmUpdate}
                      disabled={isUpdating}
                      className="w-full bg-green-600 text-white py-3 rounded-xl font-semibold disabled:bg-gray-400 flex items-center justify-center gap-2"
                    >
                      {isUpdating ? (
                        <>
                          <span className="animate-spin">‚è≥</span> Updating...
                        </>
                      ) : (
                        <>
                          <span>‚úì</span> Yes, Replace Old Version
                        </>
                      )}
                    </button>
                    <button
                      onClick={continueEditing}
                      disabled={isUpdating}
                      className="w-full bg-blue-100 text-blue-700 py-3 rounded-xl font-semibold disabled:bg-gray-200"
                    >
                      ‚úèÔ∏è Keep Editing
                    </button>
                    <button
                      onClick={cancelUpdate}
                      disabled={isUpdating}
                      className="w-full bg-gray-100 text-gray-700 py-3 rounded-xl font-medium disabled:bg-gray-200"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Sync Error/Pending Banner */}
          {(syncStatus === 'error' || (syncStatus === 'pending' && pendingSyncCount > 0)) && (
            <div className={`fixed bottom-20 left-3 right-3 ${syncStatus === 'error' ? 'bg-red-600' : 'bg-yellow-600'} text-white p-3 rounded-xl shadow-lg z-50`}>
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <span className="text-xl">{syncStatus === 'error' ? '‚ö†Ô∏è' : 'üîÑ'}</span>
                  <div>
                    <p className="font-semibold text-sm">
                      {syncStatus === 'error' ? 'Sync Failed' : `${pendingSyncCount} form(s) waiting to sync`}
                    </p>
                    <p className="text-xs opacity-80">
                      {syncStatus === 'error' ? (syncError || 'Will retry automatically when online') : 'Will sync when connection is restored'}
                    </p>
                  </div>
                </div>
                <button
                  onClick={() => { FirebaseSync.retryAll(); setSyncStatus('syncing'); }}
                  className="bg-white text-gray-800 px-3 py-1 rounded-lg text-sm font-semibold"
                >
                  Retry Now
                </button>
              </div>
            </div>
          )}

          {/* Firebase Setup Banner */}
          {showSyncBanner && !FirebaseSync.isConnected() && (
            <div className="fixed bottom-20 left-3 right-3 bg-blue-600 text-white p-3 rounded-xl shadow-lg z-50 flex items-center justify-between">
              <div className="flex items-center gap-2">
                <span className="text-xl">‚òÅÔ∏è</span>
                <div>
                  <p className="font-semibold text-sm">Enable Cloud Sync</p>
                  <p className="text-xs opacity-80">Sync data across all devices</p>
                </div>
              </div>
              <div className="flex gap-2">
                <button onClick={() => setShowSyncBanner(false)} className="text-white opacity-70 px-2 py-1 text-sm">Later</button>
                <button onClick={() => { setCurrentView('settings'); setShowSyncBanner(false); }} className="bg-white text-blue-600 px-3 py-1 rounded-lg text-sm font-semibold">Setup</button>
              </div>
            </div>
          )}

          {/* Install Prompt Banner */}
          {showInstallPrompt && (
            <div className="install-banner">
              <div className="flex items-center gap-3">
                <span className="text-2xl">üì≤</span>
                <div>
                  <p className="font-semibold text-sm">Install J&M Artsteel Safety</p>
                  <p className="text-xs opacity-80">Quick access from home screen</p>
                </div>
              </div>
              <div className="flex gap-2">
                <button onClick={dismissInstall} className="text-white opacity-70 px-2 py-1 text-sm">Later</button>
                <button onClick={handleInstall} className="bg-white text-orange-600 px-3 py-1 rounded-lg text-sm font-semibold">Install</button>
              </div>
            </div>
          )}

          <header className="bg-orange-600 text-white p-4 flex items-center justify-between shadow-lg sticky top-0 z-50 safe-top">
            <button onClick={() => setMenuOpen(!menuOpen)} className="p-2 hover:bg-orange-700 rounded-lg text-xl" aria-label="Menu">‚ò∞</button>
            <div className="flex items-center gap-2">
              <span className="text-2xl">üõ°Ô∏è</span>
              <div>
                <h1 className="font-bold text-lg leading-tight">J&M Artsteel</h1>
                <p className="text-xs text-orange-200">
                  {!isOnline ? 'üì¥ Offline Mode' :
                   syncStatus === 'error' ? '‚ö†Ô∏è Sync Error' :
                   pendingPhotoCount > 0 ? `üì∑ ${pendingPhotoCount} photo${pendingPhotoCount > 1 ? 's' : ''} queued` :
                   syncStatus === 'pending' ? `üîÑ ${pendingSyncCount} pending` :
                   syncStatus === 'synced' ? '‚òÅÔ∏è Synced' :
                   syncStatus === 'syncing' ? 'üîÑ Syncing...' :
                   syncStatus === 'local' ? 'üíæ Local Only' : 'Safety Management'}
                </p>
              </div>
            </div>
            <div className="flex items-center gap-1">
              {pendingPhotoCount > 0 && <span className="text-blue-300 text-sm animate-pulse">‚óè</span>}
              {syncStatus === 'synced' && pendingPhotoCount === 0 && <span className="text-green-300 text-sm">‚óè</span>}
              {syncStatus === 'syncing' && <span className="text-yellow-300 text-sm animate-pulse">‚óè</span>}
              {syncStatus === 'pending' && <span className="text-yellow-300 text-sm animate-pulse">‚óè</span>}
              {syncStatus === 'error' && <span className="text-red-400 text-sm">‚óè</span>}
              {!isOnline && <span className="text-yellow-300 text-sm">‚óè</span>}
            </div>
          </header>

          {menuOpen && (
            <div className="fixed inset-0 z-40 flex">
              <div className="fixed inset-0 bg-black bg-opacity-50" onClick={() => setMenuOpen(false)}></div>
              <div className="relative w-72 bg-white shadow-xl">
                <div className="p-4 bg-orange-600 text-white">
                  <p className="font-semibold">J&M Artsteel</p>
                  <p className="text-sm text-orange-200">NSW Operations</p>
                </div>
                <nav className="p-2">
                  {navItems.map((item) => (
                    <button key={item.id} onClick={() => { setCurrentView(item.id); setMenuOpen(false); }}
                      className={`w-full flex items-center gap-3 p-3 rounded-lg text-left ${currentView === item.id ? 'bg-orange-100 text-orange-600' : 'text-gray-700 hover:bg-gray-100'}`}>
                      <span>{item.emoji}</span>
                      <span className="font-medium">{item.label}</span>
                    </button>
                  ))}
                </nav>
              </div>
            </div>
          )}

          <main className="flex-1 p-4 pb-20">
            {currentView === 'dashboard' && <Dashboard setCurrentView={setCurrentView} forms={forms} onViewForm={setViewFormModal} isFormBackedUp={isFormBackedUp} sites={sites} />}
            {currentView === 'training' && <TrainingView />}
            {currentView === 'prestart' && <PrestartView onSubmit={(data) => addForm('prestart', data)} onUpdate={updateForm} editingForm={editingForm?.type === 'prestart' ? editingForm : null} previousPrestarts={previousPrestarts} sites={sites} />}
            {currentView === 'steel-itp' && <SteelITPView onSubmit={(data) => addForm('steel-itp', data)} onUpdate={updateForm} editingForm={editingForm?.type === 'steel-itp' ? editingForm : null} sites={sites} />}
            {currentView === 'inspection' && <SubcontractorInspectionView onSubmit={(data) => addForm('inspection', data)} onUpdate={updateForm} editingForm={editingForm?.type === 'inspection' ? editingForm : null} sites={sites} />}
            {currentView === 'itp' && <ITPFormView onSubmit={(data) => addForm('itp', data)} onUpdate={updateForm} editingForm={editingForm?.type === 'itp' ? editingForm : null} sites={sites} />}
            {currentView === 'incidents' && <IncidentView onSubmit={(data) => addForm('incident', data)} onUpdate={updateForm} editingForm={editingForm?.type === 'incident' ? editingForm : null} />}
            {currentView === 'toolbox' && <ToolboxView onSubmit={(data) => addForm('toolbox', data)} onUpdate={updateForm} editingForm={editingForm?.type === 'toolbox' ? editingForm : null} sites={sites} />}
            {currentView === 'emergency' && <EmergencyView />}
            {currentView === 'settings' && <SettingsView sites={sites} onUpdateSites={setSites} signatures={savedSignatures} onUpdateSignatures={updateSignatures} isAdmin={isAdmin} isDeviceAdmin={isDeviceAdmin} canViewDevices={canViewDevices} canRevokeDevices={canRevokeDevices} pendingDevices={pendingDevices} approvedDevices={approvedDevices} />}
            {currentView === 'recordings' && <RecordingsView forms={forms} sites={sites} />}
          </main>

          <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around py-2 px-1 z-30">
            {[
              { id: 'dashboard', emoji: 'üè†', label: 'Home' },
              { id: 'training', emoji: 'üéì', label: 'Training' },
              { id: 'prestart', emoji: 'üìã', label: 'Pre-Start' },
              { id: 'incidents', emoji: '‚ö†Ô∏è', label: 'Incidents' },
              { id: 'emergency', emoji: 'üìû', label: 'Emergency' },
            ].map((item) => (
              <button key={item.id} onClick={() => setCurrentView(item.id)}
                className={`flex flex-col items-center p-2 rounded-lg ${currentView === item.id ? 'text-orange-600' : 'text-gray-500'}`}>
                <span className="text-xl">{item.emoji}</span>
                <span className="text-xs mt-1">{item.label}</span>
              </button>
            ))}
          </nav>
        </div>
      );
    }

    // Dashboard
    function Dashboard({ setCurrentView, forms, onViewForm, isFormBackedUp, sites = [] }) {
      const todayDate = new Date().toLocaleDateString('en-AU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
      const [showPhotoMenu, setShowPhotoMenu] = useState(false);
      const [selectedJob, setSelectedJob] = useState(null);
      const [uploadProgress, setUploadProgress] = useState(null);
      const [uploadStatus, setUploadStatus] = useState(null);
      const [menuStep, setMenuStep] = useState('jobs'); // 'jobs' or 'capture'
      const cameraInputRef = useRef(null);
      const galleryInputRef = useRef(null);

      const formTypeLabels = {
        'prestart': { label: 'Pre-Start', emoji: 'üìã', color: 'bg-green-500' },
        'inspection': { label: 'Site Inspection', emoji: 'üîç', color: 'bg-blue-500' },
        'itp': { label: 'ITP Form', emoji: 'üìù', color: 'bg-indigo-500' },
        'incident': { label: 'Incident', emoji: '‚ö†Ô∏è', color: 'bg-red-500' },
        'toolbox': { label: 'Toolbox Talk', emoji: 'üë•', color: 'bg-purple-500' },
        'steel-itp': { label: 'Steel ITP', emoji: 'üî©', color: 'bg-slate-600' }
      };

      const defaultSites = ['Site 1 - Sydney CBD', 'Site 2 - Parramatta', 'Site 3 - North Sydney'];
      const allJobs = sites.length > 0 ? sites : defaultSites;

      const recentForms = forms.slice(0, 10); // Show last 10 forms

      const handleJobSelect = (job) => {
        setSelectedJob(job);
        setMenuStep('capture');
      };

      const handleCameraClick = () => {
        setShowPhotoMenu(false);
        setTimeout(() => cameraInputRef.current?.click(), 100);
      };

      const handleGalleryClick = () => {
        setShowPhotoMenu(false);
        setTimeout(() => galleryInputRef.current?.click(), 100);
      };

      const handleBackToJobs = () => {
        setMenuStep('jobs');
        setSelectedJob(null);
      };

      const handlePhotoCapture = async (e) => {
        const files = e.target.files;
        if (!files || files.length === 0 || !selectedJob) {
          console.log('No files or job selected', { files: files?.length, selectedJob });
          return;
        }

        setUploadProgress(`Uploading ${files.length} photo(s)...`);
        setUploadStatus(null);

        let successCount = 0;
        let failCount = 0;
        let errorMessages = [];

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          try {
            setUploadProgress(`Uploading ${i + 1}/${files.length}: ${file.name}`);

            const result = await PhotoUploadManager.uploadPhoto(
              file,
              selectedJob,
              (message, percent) => setUploadProgress(`${i + 1}/${files.length}: ${message}`)
            );

            console.log('Upload result:', result);

            if (result.success) {
              successCount++;
            } else {
              failCount++;
              errorMessages.push(`${file.name}: Upload failed`);
            }
          } catch (error) {
            console.error('Upload error:', error);
            failCount++;
            errorMessages.push(`${file.name}: ${error.message}`);
          }
        }

        // Show result
        if (successCount > 0 && failCount === 0) {
          setUploadStatus({ type: 'success', message: `‚úÖ ${successCount} photo(s) uploaded to ${selectedJob}` });
        } else if (successCount > 0 && failCount > 0) {
          setUploadStatus({ type: 'warning', message: `‚ö†Ô∏è ${successCount} uploaded, ${failCount} failed` });
        } else {
          setUploadStatus({ type: 'error', message: `‚ùå Upload failed. ${errorMessages[0] || 'Check console for details'}` });
        }

        setUploadProgress(null);
        setSelectedJob(null);
        setMenuStep('jobs');

        // Clear file input
        e.target.value = '';

        // Auto-hide status after 8 seconds
        setTimeout(() => setUploadStatus(null), 8000);
      };

      return (
        <div className="space-y-6">
          {/* Photo Upload Inputs (hidden) */}
          <input
            ref={cameraInputRef}
            type="file"
            accept="image/*"
            capture="environment"
            onChange={handlePhotoCapture}
            className="hidden"
          />
          <input
            ref={galleryInputRef}
            type="file"
            accept="image/*"
            multiple
            onChange={handlePhotoCapture}
            className="hidden"
          />

          {/* Upload Status Banner */}
          {uploadProgress && (
            <div className="bg-blue-50 border border-blue-200 rounded-xl p-3 flex items-center gap-3">
              <div className="animate-spin w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full"></div>
              <span className="text-blue-700 text-sm">{uploadProgress}</span>
            </div>
          )}

          {uploadStatus && (
            <div className={`rounded-xl p-3 ${
              uploadStatus.type === 'success' ? 'bg-green-50 border border-green-200 text-green-700' :
              uploadStatus.type === 'warning' ? 'bg-yellow-50 border border-yellow-200 text-yellow-700' :
              'bg-red-50 border border-red-200 text-red-700'
            }`}>
              <span className="text-sm">{uploadStatus.message}</span>
            </div>
          )}

          <div className="bg-gradient-to-r from-orange-500 to-orange-600 rounded-xl p-4 text-white relative">
            {/* Photo Upload Button */}
            <div className="absolute top-3 right-3">
              <button
                onClick={() => { setShowPhotoMenu(!showPhotoMenu); setMenuStep('jobs'); }}
                className="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center text-xl backdrop-blur-sm"
              >
                üì∑
              </button>

              {/* Photo Menu */}
              {showPhotoMenu && (
                <div className="absolute top-12 right-0 bg-white rounded-xl shadow-lg border border-gray-200 w-72 max-h-96 overflow-y-auto z-50">
                  {menuStep === 'jobs' ? (
                    <>
                      <div className="p-3 border-b border-gray-100">
                        <p className="text-sm font-semibold text-gray-800">üì∑ Upload Site Photos</p>
                        <p className="text-xs text-gray-500">Select which job these photos belong to</p>
                      </div>
                      <div className="p-2 max-h-60 overflow-y-auto">
                        {allJobs.map((job, idx) => (
                          <button
                            key={idx}
                            onClick={() => handleJobSelect(job)}
                            className="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-orange-50 rounded-lg flex items-center gap-2"
                          >
                            <span className="text-lg">üèóÔ∏è</span>
                            <span className="truncate">{job}</span>
                            <span className="ml-auto text-gray-400">‚Üí</span>
                          </button>
                        ))}
                      </div>
                    </>
                  ) : (
                    <>
                      <div className="p-3 border-b border-gray-100">
                        <button onClick={handleBackToJobs} className="text-orange-600 text-sm flex items-center gap-1 mb-2">
                          ‚Üê Back
                        </button>
                        <p className="text-sm font-semibold text-gray-800">Upload to: {selectedJob}</p>
                      </div>
                      <div className="p-3 space-y-2">
                        <button
                          onClick={handleCameraClick}
                          className="w-full bg-purple-600 text-white py-3 px-4 rounded-lg font-medium flex items-center justify-center gap-2 hover:bg-purple-700"
                        >
                          <span className="text-xl">üì∏</span>
                          Take Photo
                        </button>
                        <button
                          onClick={handleGalleryClick}
                          className="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-medium flex items-center justify-center gap-2 hover:bg-green-700"
                        >
                          <span className="text-xl">üñºÔ∏è</span>
                          Choose from Gallery
                        </button>
                        <p className="text-xs text-gray-500 text-center mt-2">
                          Gallery allows multiple photos
                        </p>
                      </div>
                    </>
                  )}
                </div>
              )}
            </div>

            <h2 className="text-xl font-bold">Welcome Back!</h2>
            <p className="text-orange-100 text-sm mt-1">Stay safe on site today</p>
            <div className="mt-3 flex items-center gap-2 text-sm">
              <span>üìÖ</span>
              <span>{todayDate}</span>
            </div>
          </div>

          <div className="grid grid-cols-5 gap-2">
            <div className="bg-white rounded-xl p-2 shadow-sm">
              <div className="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center mb-1">
                <span className="text-white font-bold text-xs">{forms.filter(f => f.type === 'prestart').length}</span>
              </div>
              <p className="text-gray-600 text-xs">Pre-Start</p>
            </div>
            <div className="bg-white rounded-xl p-2 shadow-sm">
              <div className="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center mb-1">
                <span className="text-white font-bold text-xs">{forms.filter(f => f.type === 'inspection').length}</span>
              </div>
              <p className="text-gray-600 text-xs">Inspect</p>
            </div>
            <div className="bg-white rounded-xl p-2 shadow-sm">
              <div className="w-8 h-8 bg-indigo-500 rounded-lg flex items-center justify-center mb-1">
                <span className="text-white font-bold text-xs">{forms.filter(f => f.type === 'itp').length}</span>
              </div>
              <p className="text-gray-600 text-xs">ITP</p>
            </div>
            <div className="bg-white rounded-xl p-2 shadow-sm">
              <div className="w-8 h-8 bg-red-500 rounded-lg flex items-center justify-center mb-1">
                <span className="text-white font-bold text-xs">{forms.filter(f => f.type === 'incident').length}</span>
              </div>
              <p className="text-gray-600 text-xs">Incident</p>
            </div>
            <div className="bg-white rounded-xl p-2 shadow-sm">
              <div className="w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center mb-1">
                <span className="text-white font-bold text-xs">{forms.filter(f => f.type === 'toolbox').length}</span>
              </div>
              <p className="text-gray-600 text-xs">Toolbox</p>
            </div>
          </div>

          <div>
            <h3 className="font-semibold text-gray-800 mb-3">Quick Actions</h3>
            <div className="grid grid-cols-3 gap-2">
              <button onClick={() => setCurrentView('prestart')} className="bg-white rounded-xl p-2 shadow-sm flex flex-col items-center gap-1 hover:shadow-md">
                <div className="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-lg">üìã</div>
                <span className="text-xs font-medium text-gray-700 text-center">Pre-Start</span>
              </button>
              <button onClick={() => setCurrentView('recordings')} className="bg-white rounded-xl p-2 shadow-sm flex flex-col items-center gap-1 hover:shadow-md border-2 border-teal-200">
                <div className="w-10 h-10 bg-teal-500 rounded-full flex items-center justify-center text-lg">üì∏</div>
                <span className="text-xs font-medium text-gray-700 text-center">Recordings</span>
              </button>
              <button onClick={() => setCurrentView('steel-itp')} className="bg-white rounded-xl p-2 shadow-sm flex flex-col items-center gap-1 hover:shadow-md">
                <div className="w-10 h-10 bg-slate-600 rounded-full flex items-center justify-center text-lg">üî©</div>
                <span className="text-xs font-medium text-gray-700 text-center">Steel ITP</span>
              </button>
              <button onClick={() => setCurrentView('inspection')} className="bg-white rounded-xl p-2 shadow-sm flex flex-col items-center gap-1 hover:shadow-md">
                <div className="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-lg">üîç</div>
                <span className="text-xs font-medium text-gray-700 text-center">Inspect</span>
              </button>
              <button onClick={() => setCurrentView('itp')} className="bg-white rounded-xl p-2 shadow-sm flex flex-col items-center gap-1 hover:shadow-md">
                <div className="w-10 h-10 bg-indigo-500 rounded-full flex items-center justify-center text-lg">üìù</div>
                <span className="text-xs font-medium text-gray-700 text-center">ITP</span>
              </button>
              <button onClick={() => setCurrentView('incidents')} className="bg-white rounded-xl p-2 shadow-sm flex flex-col items-center gap-1 hover:shadow-md">
                <div className="w-10 h-10 bg-red-500 rounded-full flex items-center justify-center text-lg">‚ö†Ô∏è</div>
                <span className="text-xs font-medium text-gray-700 text-center">Incident</span>
              </button>
            </div>
          </div>

          {/* Recent Forms */}
          {recentForms.length > 0 && (
            <div>
              <h3 className="font-semibold text-gray-800 mb-3">Recent Forms</h3>
              <div className="space-y-2">
                {recentForms.map(form => {
                  const typeInfo = formTypeLabels[form.type] || { label: form.type, emoji: 'üìÑ', color: 'bg-gray-500' };
                  const formDate = new Date(form.createdAt);
                  const isBackedUp = isFormBackedUp(form.id);
                  return (
                    <button
                      key={form.id}
                      onClick={() => onViewForm(form)}
                      className="w-full bg-white rounded-xl p-3 shadow-sm flex items-center gap-3 hover:shadow-md transition text-left"
                    >
                      <div className={`w-10 h-10 ${typeInfo.color} rounded-lg flex items-center justify-center text-lg`}>
                        {typeInfo.emoji}
                      </div>
                      <div className="flex-1 min-w-0">
                        <p className="font-medium text-gray-800 text-sm truncate">
                          {form.data?.siteConducted || form.data?.site || form.data?.siteLocation || typeInfo.label}
                        </p>
                        <p className="text-xs text-gray-500">
                          {formDate.toLocaleDateString('en-AU')} {formDate.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' })}
                        </p>
                      </div>
                      <div className="flex items-center gap-2">
                        {isBackedUp && <span className="text-green-500 text-xs">‚úì Saved</span>}
                        <span className="text-gray-400">‚Ä∫</span>
                      </div>
                    </button>
                  );
                })}
              </div>
            </div>
          )}

          <div className="bg-yellow-50 border border-yellow-200 rounded-xl p-4">
            <div className="flex items-start gap-3">
              <span className="text-2xl">‚ö†Ô∏è</span>
              <div>
                <h4 className="font-semibold text-yellow-800">Daily Safety Reminder</h4>
                <p className="text-sm text-yellow-700 mt-1">Always wear appropriate PPE including safety glasses, steel-capped boots, and high-vis clothing when on site.</p>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Training View Component
    function TrainingView() {
      const [selectedCourse, setSelectedCourse] = useState(null);
      const [currentQuestion, setCurrentQuestion] = useState(0);
      const [answers, setAnswers] = useState({});
      const [showResults, setShowResults] = useState(false);
      const [showSignature, setShowSignature] = useState(false);
      const [workerName, setWorkerName] = useState('');
      const [showCertificate, setShowCertificate] = useState(false);
      const [signatureData, setSignatureData] = useState(null);
      const [showQRCode, setShowQRCode] = useState(false);
      const [viewingStandards, setViewingStandards] = useState(null);
      const [completedCourses, setCompletedCourses] = useState(() => {
        const saved = localStorage.getItem('jmart-completed-training');
        return saved ? JSON.parse(saved) : [];
      });

      const courses = [
        {
          id: 'manual-handling',
          title: 'Manual Handling / ‰∫∫Â∑•Êê¨Ëøê',
          description: 'Learn safe lifting techniques and prevent workplace injuries / Â≠¶‰π†ÂÆâÂÖ®Êê¨ËøêÊäÄÊúØÔºåÈ¢ÑÈò≤Â∑•‰º§',
          duration: '15 min',
          image: 'üèãÔ∏è',
          standards: [
            { code: 'Safe Work Australia - Hazardous Manual Tasks COP 2018', url: 'https://www.safeworkaustralia.gov.au/doc/model-code-practice-hazardous-manual-tasks' },
            { code: 'AS/NZS 4422:1996 - Manual Handling', url: 'https://www.standards.org.au/' }
          ],
          questions: [
            {
              question: 'What is the recommended maximum weight for one person to lift without assistance? / Âª∫ËÆÆ‰∏Ä‰∫∫Êê¨ËøêÁöÑÊúÄÂ§ßÈáçÈáèÊòØÂ§öÂ∞ëÔºü',
              options: ['10kg / 10ÂÖ¨Êñ§', '16kg / 16ÂÖ¨Êñ§', '25kg / 25ÂÖ¨Êñ§', '35kg / 35ÂÖ¨Êñ§'],
              correct: 2,
              explanation: 'Safe Work Australia recommends a maximum of 25kg for most workers in ideal conditions. / Êæ≥Â§ßÂà©‰∫öÂÆâÂÖ®Â∑•‰ΩúÂ±ÄÂª∫ËÆÆÂú®ÁêÜÊÉ≥Êù°‰ª∂‰∏ãÔºåÂ§ßÂ§öÊï∞Â∑•‰∫∫ÊúÄÂ§öÊê¨Ëøê25ÂÖ¨Êñ§„ÄÇ'
            },
            {
              question: 'Before lifting a heavy object, you should: / Êê¨ËøêÈáçÁâ©ÂâçÔºå‰Ω†Â∫îËØ•Ôºö',
              options: ['Lift quickly to get it over with / Âø´ÈÄüÊê¨Ëµ∑Êù•ÂÆåÊàê‰ªªÂä°', 'Assess the load and plan your lift / ËØÑ‰º∞Ë¥üËΩΩÂπ∂ËÆ°ÂàíÊê¨Ëøê', 'Always use your back muscles / ÊÄªÊòØÁî®ËÉåÈÉ®ËÇåËÇâ', 'Hold your breath / Â±è‰ΩèÂëºÂê∏'],
              correct: 1,
              explanation: 'Always assess the load, check the path, and plan your lift before moving any object. / Âú®Êê¨Ëøê‰ªª‰ΩïÁâ©ÂìÅÂâçÔºåÂßãÁªàËØÑ‰º∞Ë¥üËΩΩ„ÄÅÊ£ÄÊü•Ë∑ØÂæÑÂπ∂ËÆ°ÂàíÊê¨Ëøê„ÄÇ'
            },
            {
              question: 'When lifting, you should bend at your: / Êê¨ËøêÊó∂Ôºå‰Ω†Â∫îËØ•ÂºØÊõ≤Ôºö',
              options: ['Back / ËÉåÈÉ®', 'Waist / ËÖ∞ÈÉ®', 'Knees and hips / ËÜùÁõñÂíåËáÄÈÉ®', 'Shoulders / ËÇ©ËÜÄ'],
              correct: 2,
              explanation: 'Bending at the knees and hips keeps your back straight and uses your stronger leg muscles. / ÂºØÊõ≤ËÜùÁõñÂíåËáÄÈÉ®ÂèØ‰ª•‰øùÊåÅËÉåÈÉ®Êå∫Áõ¥ÔºåÂπ∂‰ΩøÁî®Êõ¥Âº∫Â£ÆÁöÑËÖøÈÉ®ËÇåËÇâ„ÄÇ'
            },
            {
              question: 'How close should you hold a load to your body when carrying? / Êê¨ËøêÊó∂Â∫îËØ•ÊääË¥üËΩΩÈù†Ë∫´‰ΩìÂ§öËøëÔºü',
              options: ['At arm\'s length / ÊâãËáÇÈïøÂ∫¶', 'As close as possible / Â∞ΩÂèØËÉΩÈù†Ëøë', 'It doesn\'t matter / Êó†ÊâÄË∞ì', 'About 30cm away / Á∫¶30ÂéòÁ±≥Ëøú'],
              correct: 1,
              explanation: 'Holding loads close to your body reduces strain on your back and gives you better control. / Â∞ÜË¥üËΩΩÈù†ËøëË∫´‰ΩìÂèØ‰ª•ÂáèÂ∞ëËÉåÈÉ®ÂéãÂäõÔºåÂπ∂Áªô‰Ω†Êõ¥Â•ΩÁöÑÊéßÂà∂„ÄÇ'
            },
            {
              question: 'If a load is too heavy, you should: / Â¶ÇÊûúË¥üËΩΩÂ§™ÈáçÔºå‰Ω†Â∫îËØ•Ôºö',
              options: ['Try harder / Êõ¥Âä†Âä™Âäõ', 'Use a team lift or mechanical aid / ‰ΩøÁî®Âõ¢ÈòüÊê¨ËøêÊàñÊú∫Ê¢∞ËæÖÂä©', 'Drag it instead / Êîπ‰∏∫ÊãñÊãΩ', 'Lift in stages / ÂàÜÈò∂ÊÆµÊê¨Ëøê'],
              correct: 1,
              explanation: 'Always use team lifting or mechanical aids like trolleys for loads that are too heavy. / ÂØπ‰∫éËøáÈáçÁöÑË¥üËΩΩÔºåÂßãÁªà‰ΩøÁî®Âõ¢ÈòüÊê¨ËøêÊàñÊâãÊé®ËΩ¶Á≠âÊú∫Ê¢∞ËæÖÂä©Â∑•ÂÖ∑„ÄÇ'
            },
            {
              question: 'What is the best foot position when lifting? / Êê¨ËøêÊó∂ÊúÄ‰Ω≥ÁöÑËÑöÈÉ®ÂßøÂäøÊòØ‰ªÄ‰πàÔºü',
              options: ['Feet together / ÂèåËÑöÂπ∂Êã¢', 'Feet shoulder-width apart, one slightly forward / ÂèåËÑö‰∏éËÇ©ÂêåÂÆΩÔºå‰∏ÄËÑöÁ®çÂêëÂâç', 'Standing on tiptoes / Ë∏ÆËÑöÁ´ôÁ´ã', 'Legs crossed / ÂèåËÖø‰∫§Âèâ'],
              correct: 1,
              explanation: 'A stable base with feet shoulder-width apart and one foot slightly forward provides the best balance. / ÂèåËÑö‰∏éËÇ©ÂêåÂÆΩ„ÄÅ‰∏ÄËÑöÁ®çÂêëÂâçÁöÑÁ®≥ÂÆöÂßøÂäøÊèê‰æõÊúÄ‰Ω≥Âπ≥Ë°°„ÄÇ'
            },
            {
              question: 'Twisting while carrying a load is dangerous because: / Êê¨ËøêÊó∂Êâ≠ËΩ¨Ë∫´‰ΩìÂæàÂç±Èô©ÔºåÂõ†‰∏∫Ôºö',
              options: ['It makes you dizzy / ‰ºöËÆ©‰Ω†Â§¥Êôï', 'It puts excessive strain on your spine / ‰ºöÂØπËÑäÊü±ÈÄ†ÊàêËøáÂ∫¶ÂéãÂäõ', 'It\'s not dangerous / ‰∏çÂç±Èô©', 'It wastes time / Êµ™Ë¥πÊó∂Èó¥'],
              correct: 1,
              explanation: 'Twisting under load can cause serious spinal injuries. Move your feet to turn instead. / Ë¥üÈáçÊâ≠ËΩ¨ÂèØËÉΩÂØºËá¥‰∏•ÈáçÁöÑËÑäÊü±Êçü‰º§„ÄÇÂ∫îËØ•ÁßªÂä®ËÑöÊ≠•Êù•ËΩ¨Âêë„ÄÇ'
            },
            {
              question: 'What should you do if you experience back pain after lifting? / Â¶ÇÊûúÊê¨ËøêÂêéËÉåÈÉ®ÁñºÁóõÔºå‰Ω†Â∫îËØ•ÊÄé‰πàÂÅöÔºü',
              options: ['Ignore it and continue working / ÂøΩÁï•Âπ∂ÁªßÁª≠Â∑•‰Ωú', 'Report it and seek first aid / Êä•ÂëäÂπ∂ÂØªÊ±ÇÊÄ•Êïë', 'Take painkillers and keep working / ÂêÉÊ≠¢ÁóõËçØÁªßÁª≠Â∑•‰Ωú', 'Wait until after your shift / Á≠âÂà∞‰∏ãÁè≠Âêé'],
              correct: 1,
              explanation: 'Always report injuries immediately. Early treatment prevents more serious damage. / ÂßãÁªàÁ´ãÂç≥Êä•ÂëäÂèó‰º§„ÄÇÊó©ÊúüÊ≤ªÁñóÂèØ‰ª•Èò≤Ê≠¢Êõ¥‰∏•ÈáçÁöÑÊçü‰º§„ÄÇ'
            }
          ]
        },
        {
          id: 'working-at-heights',
          title: 'Working at Heights / È´òÁ©∫‰Ωú‰∏ö',
          description: 'Safety procedures for elevated work areas / È´òÁ©∫‰Ωú‰∏öÂå∫ÂüüÁöÑÂÆâÂÖ®Á®ãÂ∫è',
          duration: '20 min',
          image: 'ü™ú',
          standards: [
            { code: 'Safe Work Australia - Managing Falls COP 2022', url: 'https://www.safeworkaustralia.gov.au/doc/model-code-practice-managing-risk-falls-workplaces' },
            { code: 'AS/NZS 1891.4 - Industrial Fall Arrest Systems', url: 'https://www.standards.org.au/' },
            { code: 'AS/NZS 1892.1 - Portable Ladders', url: 'https://www.standards.org.au/' }
          ],
          questions: [
            {
              question: 'At what height does work become "working at heights" in Australia? / Âú®Êæ≥Â§ßÂà©‰∫öÔºåÂ§öÈ´òÁÆó"È´òÁ©∫‰Ωú‰∏ö"Ôºü',
              options: ['1 metre / 1Á±≥', '2 metres / 2Á±≥', '3 metres / 3Á±≥', 'Any height where you could be injured by a fall / ‰ªª‰ΩïÂèØËÉΩÂõ†Ë∑åËêΩÂèó‰º§ÁöÑÈ´òÂ∫¶'],
              correct: 3,
              explanation: 'Working at heights is any work where a person could fall and be injured, regardless of the height. / È´òÁ©∫‰Ωú‰∏öÊòØÊåá‰ªª‰ΩïÂèØËÉΩË∑åËêΩÂπ∂Âèó‰º§ÁöÑÂ∑•‰ΩúÔºåÊó†ËÆ∫È´òÂ∫¶Â¶Ç‰Ωï„ÄÇ'
            },
            {
              question: 'What is the hierarchy of control for fall prevention? / È¢ÑÈò≤Ë∑åËêΩÁöÑÊéßÂà∂Â±ÇÁ∫ßÊòØ‰ªÄ‰πàÔºü',
              options: ['PPE first, then eliminate / ÂÖàÁî®PPEÔºåÂÜçÊ∂àÈô§', 'Eliminate, substitute, isolate, admin controls, PPE / Ê∂àÈô§„ÄÅÊõø‰ª£„ÄÅÈöîÁ¶ª„ÄÅÁÆ°ÁêÜÊéßÂà∂„ÄÅPPE', 'Admin controls only / ‰ªÖÁÆ°ÁêÜÊéßÂà∂', 'Just use harnesses / Âè™Áî®ÂÆâÂÖ®Â∏¶'],
              correct: 1,
              explanation: 'Always try to eliminate the risk first, then substitute, isolate, use admin controls, and finally PPE as last resort. / ÂßãÁªàÂÖàÂ∞ùËØïÊ∂àÈô§È£éÈô©ÔºåÁÑ∂ÂêéÊõø‰ª£„ÄÅÈöîÁ¶ª„ÄÅ‰ΩøÁî®ÁÆ°ÁêÜÊéßÂà∂ÔºåÊúÄÂêéÂ∞ÜPPE‰Ωú‰∏∫ÊúÄÂêéÊâãÊÆµ„ÄÇ'
            },
            {
              question: 'Before using a ladder, you should: / ‰ΩøÁî®Ê¢ØÂ≠êÂâçÔºå‰Ω†Â∫îËØ•Ôºö',
              options: ['Just climb up quickly / Âø´ÈÄüÁà¨‰∏äÂéª', 'Inspect it for damage and ensure it\'s the right type / Ê£ÄÊü•ÊòØÂê¶ÊçüÂùèÂπ∂Á°Æ‰øùÁ±ªÂûãÊ≠£Á°Æ', 'Only check if it looks old / Âè™ÊúâÁúãËµ∑Êù•ÊóßÊâçÊ£ÄÊü•', 'Ladders don\'t need inspection / Ê¢ØÂ≠ê‰∏çÈúÄË¶ÅÊ£ÄÊü•'],
              correct: 1,
              explanation: 'Always inspect ladders for damage, check the rating, and ensure it\'s suitable for the task. / ÂßãÁªàÊ£ÄÊü•Ê¢ØÂ≠êÊòØÂê¶ÊçüÂùèÔºåÊ£ÄÊü•È¢ùÂÆöÂÄºÔºåÂπ∂Á°Æ‰øùÈÄÇÂêàËØ•‰ªªÂä°„ÄÇ'
            },
            {
              question: 'What is the correct angle for a ladder against a wall? / Ê¢ØÂ≠êÈù†Â¢ôÁöÑÊ≠£Á°ÆËßíÂ∫¶ÊòØÂ§öÂ∞ëÔºü',
              options: ['Straight up (90 degrees) / ÂûÇÁõ¥Ôºà90Â∫¶Ôºâ', '1:4 ratio (75 degrees) / 1:4ÊØî‰æãÔºà75Â∫¶Ôºâ', 'As steep as possible / Â∞ΩÂèØËÉΩÈô°', 'Lying almost flat / Âá†‰πéÂπ≥Êîæ'],
              correct: 1,
              explanation: 'The 1:4 ratio (for every 4m up, 1m out at base) provides the safest angle. / 1:4ÊØî‰æãÔºàÊØè‰∏äÂçá4Á±≥ÔºåÂ∫ïÈÉ®Â§ñÁßª1Á±≥ÔºâÊèê‰æõÊúÄÂÆâÂÖ®ÁöÑËßíÂ∫¶„ÄÇ'
            },
            {
              question: 'When must you use a harness and lanyard? / ‰ªÄ‰πàÊó∂ÂÄôÂøÖÈ°ª‰ΩøÁî®ÂÆâÂÖ®Â∏¶ÂíåÁ≥ªÁª≥Ôºü',
              options: ['Only if you feel scared / Âè™ÊúâÊÑüÂà∞ÂÆ≥ÊÄïÊó∂', 'When there\'s no edge protection and you could fall 2m+ / ÂΩìÊ≤°ÊúâËæπÁºò‰øùÊä§‰∏îÂèØËÉΩË∑åËêΩ2Á±≥‰ª•‰∏äÊó∂', 'Harnesses are optional / ÂÆâÂÖ®Â∏¶ÊòØÂèØÈÄâÁöÑ', 'Only on roofs / Âè™Âú®Â±ãÈ°∂‰∏ä'],
              correct: 1,
              explanation: 'Fall arrest systems are required when other controls cannot adequately protect against falls. / ÂΩìÂÖ∂‰ªñÊéßÂà∂Êé™ÊñΩÊó†Ê≥ïÂÖÖÂàÜ‰øùÊä§Èò≤Ê≠¢Ë∑åËêΩÊó∂ÔºåÈúÄË¶Å‰ΩøÁî®Èò≤Âù†ËêΩÁ≥ªÁªü„ÄÇ'
            }
          ]
        },
        {
          id: 'ppe',
          title: 'Personal Protective Equipment / ‰∏™‰∫∫Èò≤Êä§Ë£ÖÂ§á',
          description: 'Proper selection and use of PPE / Ê≠£Á°ÆÈÄâÊã©Âíå‰ΩøÁî®PPE',
          duration: '10 min',
          image: 'ü¶∫',
          standards: [
            { code: 'AS/NZS 1337.1 - Eye & Face Protectors', url: 'https://www.standards.org.au/' },
            { code: 'AS/NZS 2210.3 - Safety Footwear', url: 'https://www.standards.org.au/' },
            { code: 'AS/NZS 1801 - Occupational Helmets', url: 'https://www.standards.org.au/' },
            { code: 'AS/NZS 4602.1 - High Visibility Clothing', url: 'https://www.standards.org.au/' }
          ],
          questions: [
            {
              question: 'PPE should be used: / PPEÂ∫îËØ•Áî®‰∫éÔºö',
              options: ['As the first line of defence / ‰Ωú‰∏∫Á¨¨‰∏ÄÈÅìÈò≤Á∫ø', 'Only when convenient / Âè™Âú®Êñπ‰æøÊó∂', 'As a last resort after other controls / ‰Ωú‰∏∫ÂÖ∂‰ªñÊéßÂà∂Êé™ÊñΩÂêéÁöÑÊúÄÂêéÊâãÊÆµ', 'Only for dangerous jobs / Âè™Áî®‰∫éÂç±Èô©Â∑•‰Ωú'],
              correct: 2,
              explanation: 'PPE is the last line of defence in the hierarchy of controls, not the first. / PPEÊòØÊéßÂà∂Â±ÇÁ∫ß‰∏≠ÁöÑÊúÄÂêé‰∏ÄÈÅìÈò≤Á∫øÔºåËÄåÈùûÁ¨¨‰∏ÄÈÅì„ÄÇ'
            },
            {
              question: 'Hard hats should be replaced: / ÂÆâÂÖ®Â∏ΩÂ∫îËØ•Âú®‰ΩïÊó∂Êõ¥Êç¢Ôºö',
              options: ['Never, they last forever / Ê∞∏Ëøú‰∏çÁî®ÔºåÂÆÉ‰ª¨Ê∞∏‰πÖËÄêÁî®', 'Only if cracked / Âè™ÊúâÁ†¥Ë£ÇÊó∂', 'After any significant impact or as per manufacturer guidelines / ‰ªª‰ΩïÈáçÂ§ßÊíûÂáªÂêéÊàñÊåâÂà∂ÈÄ†ÂïÜÊåáÂçó', 'Every 10 years / ÊØè10Âπ¥'],
              correct: 2,
              explanation: 'Hard hats must be replaced after any impact, if damaged, or as specified by the manufacturer (usually 2-5 years). / ÂÆâÂÖ®Â∏ΩÂøÖÈ°ªÂú®‰ªª‰ΩïÊíûÂáªÂêé„ÄÅÊçüÂùèÊó∂ÊàñÊåâÂà∂ÈÄ†ÂïÜËßÑÂÆöÔºàÈÄöÂ∏∏2-5Âπ¥ÔºâÊõ¥Êç¢„ÄÇ'
            },
            {
              question: 'Safety glasses should: / ÂÆâÂÖ®ÁúºÈïúÂ∫îËØ•Ôºö',
              options: ['Fit loosely for comfort / ÊùæÊùæÂú∞Êà¥ÁùÄËàíÊúç', 'Fit snugly and have side protection / Á¥ßË¥¥Âπ∂Êúâ‰æßÈù¢‰øùÊä§', 'Be worn only sometimes / Âè™ÂÅ∂Â∞îÊà¥', 'Only be clear lenses / Âè™Áî®ÈÄèÊòéÈïúÁâá'],
              correct: 1,
              explanation: 'Safety glasses must fit properly and provide adequate coverage including side protection. / ÂÆâÂÖ®ÁúºÈïúÂøÖÈ°ªÊ≠£Á°Æ‰Ω©Êà¥ÔºåÂπ∂Êèê‰æõÂåÖÊã¨‰æßÈù¢‰øùÊä§Âú®ÂÜÖÁöÑË∂≥Â§üË¶ÜÁõñ„ÄÇ'
            },
            {
              question: 'Who is responsible for maintaining PPE? / Ë∞ÅË¥üË¥£Áª¥Êä§PPEÔºü',
              options: ['Only the employer / Âè™ÊúâÈõá‰∏ª', 'Only the worker / Âè™ÊúâÂ∑•‰∫∫', 'Both employer and worker have responsibilities / Èõá‰∏ªÂíåÂ∑•‰∫∫ÈÉΩÊúâË¥£‰ªª', 'No one / Ê≤°Êúâ‰∫∫'],
              correct: 2,
              explanation: 'Employers must provide and maintain PPE, while workers must use it properly and report damage. / Èõá‰∏ªÂøÖÈ°ªÊèê‰æõÂíåÁª¥Êä§PPEÔºåËÄåÂ∑•‰∫∫ÂøÖÈ°ªÊ≠£Á°Æ‰ΩøÁî®Âπ∂Êä•ÂëäÊçüÂùè„ÄÇ'
            },
            {
              question: 'What class of safety boots is required for construction? / Âª∫Á≠ëÂ∑•Âú∞ÈúÄË¶Å‰ªÄ‰πàÁ±ªÂûãÁöÑÂÆâÂÖ®Èù¥Ôºü',
              options: ['Any comfortable shoes / ‰ªª‰ΩïËàíÈÄÇÁöÑÈûãÂ≠ê', 'Steel cap boots meeting AS/NZS 2210.3 / Á¨¶ÂêàAS/NZS 2210.3ÁöÑÈí¢Â§¥Èù¥', 'Rubber boots only / Âè™Áî®Ê©°ËÉ∂Èù¥', 'Sneakers with good grip / Èò≤ÊªëËøêÂä®Èûã'],
              correct: 1,
              explanation: 'Construction sites typically require safety footwear meeting Australian Standards with toe protection. / Âª∫Á≠ëÂ∑•Âú∞ÈÄöÂ∏∏ÈúÄË¶ÅÁ¨¶ÂêàÊæ≥Â§ßÂà©‰∫öÊ†áÂáÜÂπ∂ÊúâËÑöË∂æ‰øùÊä§ÁöÑÂÆâÂÖ®Èûã„ÄÇ'
            }
          ]
        },
        {
          id: 'hazard-identification',
          title: 'Hazard Identification / Âç±ÂÆ≥ËØÜÂà´',
          description: 'Identifying and reporting workplace hazards / ËØÜÂà´ÂíåÊä•ÂëäÂ∑•‰ΩúÂú∫ÊâÄÂç±ÂÆ≥',
          duration: '15 min',
          image: '‚ö†Ô∏è',
          standards: [
            { code: 'Safe Work Australia - Risk Management COP 2022', url: 'https://www.safeworkaustralia.gov.au/doc/model-code-practice-how-manage-work-health-and-safety-risks' },
            { code: 'AS/NZS ISO 31000 - Risk Management', url: 'https://www.standards.org.au/' },
            { code: 'WHS Act 2011 - Duty of Care', url: 'https://www.safeworkaustralia.gov.au/law-and-regulation/model-whs-laws' }
          ],
          questions: [
            {
              question: 'A hazard is: / Âç±ÂÆ≥ÊòØÔºö',
              options: ['An accident that happened / Â∑≤ÂèëÁîüÁöÑ‰∫ãÊïÖ', 'Something that could cause harm / ÂèØËÉΩÈÄ†Êàê‰º§ÂÆ≥ÁöÑ‰∏úË•ø', 'A type of PPE / ‰∏ÄÁßçPPE', 'A safety meeting / ÂÆâÂÖ®‰ºöËÆÆ'],
              correct: 1,
              explanation: 'A hazard is anything with the potential to cause harm, injury, or illness. / Âç±ÂÆ≥ÊòØ‰ªª‰ΩïÂèØËÉΩÈÄ†Êàê‰º§ÂÆ≥„ÄÅÂèó‰º§ÊàñÁñæÁóÖÁöÑ‰∫ãÁâ©„ÄÇ'
            },
            {
              question: 'Who is responsible for identifying hazards? / Ë∞ÅË¥üË¥£ËØÜÂà´Âç±ÂÆ≥Ôºü',
              options: ['Only supervisors / Âè™Êúâ‰∏ªÁÆ°', 'Only safety officers / Âè™ÊúâÂÆâÂÖ®Âëò', 'Everyone on site / Áé∞Âú∫ÊØè‰∏™‰∫∫', 'Only management / Âè™ÊúâÁÆ°ÁêÜÂ±Ç'],
              correct: 2,
              explanation: 'Everyone has a responsibility to identify and report hazards in their workplace. / ÊØè‰∏™‰∫∫ÈÉΩÊúâË¥£‰ªªËØÜÂà´ÂíåÊä•ÂëäÂ∑•‰ΩúÂú∫ÊâÄÁöÑÂç±ÂÆ≥„ÄÇ'
            },
            {
              question: 'When you identify a hazard, you should: / ÂΩì‰Ω†ËØÜÂà´Âà∞Âç±ÂÆ≥Êó∂Ôºå‰Ω†Â∫îËØ•Ôºö',
              options: ['Ignore it if it\'s not your area / Â¶ÇÊûú‰∏çÊòØ‰Ω†ÁöÑÂå∫ÂüüÂ∞±ÂøΩÁï•', 'Report it immediately to your supervisor / Á´ãÂç≥Âêë‰∏ªÁÆ°Êä•Âëä', 'Wait until the safety meeting / Á≠âÂà∞ÂÆâÂÖ®‰ºöËÆÆ', 'Only report serious hazards / Âè™Êä•Âëä‰∏•ÈáçÂç±ÂÆ≥'],
              correct: 1,
              explanation: 'All hazards should be reported immediately so they can be assessed and controlled. / ÊâÄÊúâÂç±ÂÆ≥ÈÉΩÂ∫îÁ´ãÂç≥Êä•ÂëäÔºå‰ª•‰æøËøõË°åËØÑ‰º∞ÂíåÊéßÂà∂„ÄÇ'
            },
            {
              question: 'A risk assessment considers: / È£éÈô©ËØÑ‰º∞ËÄÉËôëÔºö',
              options: ['Only the likelihood of harm / Âè™ËÄÉËôë‰º§ÂÆ≥ÁöÑÂèØËÉΩÊÄß', 'Only the severity of harm / Âè™ËÄÉËôë‰º§ÂÆ≥ÁöÑ‰∏•ÈáçÁ®ãÂ∫¶', 'Both likelihood and severity of harm / ÂêåÊó∂ËÄÉËôë‰º§ÂÆ≥ÁöÑÂèØËÉΩÊÄßÂíå‰∏•ÈáçÁ®ãÂ∫¶', 'Only financial impact / Âè™ËÄÉËôëË¥¢Âä°ÂΩ±Âìç'],
              correct: 2,
              explanation: 'Risk is assessed by considering both how likely harm is to occur and how severe it would be. / È£éÈô©ÊòØÈÄöËøáËÄÉËôë‰º§ÂÆ≥ÂèëÁîüÁöÑÂèØËÉΩÊÄßÂíå‰∏•ÈáçÁ®ãÂ∫¶Êù•ËØÑ‰º∞ÁöÑ„ÄÇ'
            },
            {
              question: 'JSA stands for: / JSA‰ª£Ë°®Ôºö',
              options: ['Job Safety Analysis / Â∑•‰ΩúÂÆâÂÖ®ÂàÜÊûê', 'Just Safety Awareness / ‰ªÖÂÆâÂÖ®ÊÑèËØÜ', 'Joint Safety Agreement / ËÅîÂêàÂÆâÂÖ®ÂçèËÆÆ', 'Job Start Approval / Â∑•‰ΩúÂºÄÂßãÊâπÂáÜ'],
              correct: 0,
              explanation: 'A Job Safety Analysis breaks down tasks to identify hazards and controls for each step. / Â∑•‰ΩúÂÆâÂÖ®ÂàÜÊûêÂàÜËß£‰ªªÂä°‰ª•ËØÜÂà´ÊØè‰∏™Ê≠•È™§ÁöÑÂç±ÂÆ≥ÂíåÊéßÂà∂Êé™ÊñΩ„ÄÇ'
            }
          ]
        },
        {
          id: 'hot-works',
          title: 'Hot Works Safety / ÁÉ≠Â∑•‰Ωú‰∏öÂÆâÂÖ®',
          description: 'Welding, grinding & oxy cutting - Australian Standards compliant / ÁÑäÊé•„ÄÅÊâìÁ£®ÂíåÊ∞ßÊ∞îÂàáÂâ≤ - Á¨¶ÂêàÊæ≥Â§ßÂà©‰∫öÊ†áÂáÜ',
          duration: '25 min',
          image: 'üî•',
          standards: [
            { code: 'AS 1674.1 - Safety in Welding (Fire Precautions)', url: 'https://www.standards.org.au/' },
            { code: 'AS/NZS 1338.1 - Welding Helmets', url: 'https://www.standards.org.au/' },
            { code: 'AS/NZS 1337.1 - Eye & Face Protectors', url: 'https://www.standards.org.au/' },
            { code: 'AS 4839-2001 - Oxy-Fuel Gas Systems', url: 'https://www.standards.org.au/' },
            { code: 'AS 4332-2004 - Gas Cylinder Storage', url: 'https://www.standards.org.au/' }
          ],
          questions: [
            {
              question: 'Under AS 1674.1, a Hot Work Permit is required when: / Ê†πÊçÆAS 1674.1Ôºå‰ΩïÊó∂ÈúÄË¶ÅÁÉ≠Â∑•‰ΩúËÆ∏ÂèØËØÅÔºö',
              options: ['Only for indoor welding / ‰ªÖÂÆ§ÂÜÖÁÑäÊé•', 'Any work that produces flames, sparks or heat / ‰ªª‰Ωï‰∫ßÁîüÁÅ´ÁÑ∞„ÄÅÁÅ´Ëä±ÊàñÁÉ≠ÈáèÁöÑÂ∑•‰Ωú', 'Only when working near flammables / ‰ªÖÂú®ÊòìÁáÉÁâ©ÈôÑËøëÂ∑•‰ΩúÊó∂', 'Only for certified welders / ‰ªÖÊåÅËØÅÁÑäÂ∑•'],
              correct: 1,
              explanation: 'AS 1674.1 requires a Hot Work Permit for any work producing flames, sparks, or heat that could ignite nearby materials. / AS 1674.1Ë¶ÅÊ±Ç‰ªª‰Ωï‰∫ßÁîüÁÅ´ÁÑ∞„ÄÅÁÅ´Ëä±ÊàñÂèØËÉΩÁÇπÁáÉÈôÑËøëÊùêÊñôÁöÑÁÉ≠ÈáèÁöÑÂ∑•‰ΩúÈÉΩÈúÄË¶ÅÁÉ≠Â∑•‰ΩúËÆ∏ÂèØËØÅ„ÄÇ'
            },
            {
              question: 'According to AS/NZS 1338.1, auto-darkening welding helmets must have a minimum shade of: / Ê†πÊçÆAS/NZS 1338.1ÔºåËá™Âä®ÂèòÂÖâÁÑäÊé•Â§¥ÁõîÂøÖÈ°ªÂÖ∑ÊúâÊúÄ‰ΩéÈÅÆÂÖâÂ∫¶Ôºö',
              options: ['Shade 5 / 5Âè∑', 'Shade 8 / 8Âè∑', 'Shade 10 / 10Âè∑', 'Shade 14 / 14Âè∑'],
              correct: 2,
              explanation: 'AS/NZS 1338.1 specifies welding helmets must have minimum shade 10 for arc welding to protect against UV and infrared radiation. / AS/NZS 1338.1ËßÑÂÆöÁîµÂºßÁÑäÊé•Â§¥ÁõîÂøÖÈ°ªËá≥Â∞ëÊúâ10Âè∑ÈÅÆÂÖâÂ∫¶Ôºå‰ª•‰øùÊä§ÂÖçÂèóÁ¥´Â§ñÁ∫øÂíåÁ∫¢Â§ñËæêÂ∞Ñ„ÄÇ'
            },
            {
              question: 'When grinding steel, what eye protection standard applies? / ÊâìÁ£®Èí¢ÊùêÊó∂ÔºåÈÄÇÁî®‰ªÄ‰πàÁúºÈÉ®‰øùÊä§Ê†áÂáÜÔºü',
              options: ['AS/NZS 1337.1 - High Impact Rated / AS/NZS 1337.1 - È´òÂÜ≤ÂáªÁ≠âÁ∫ß', 'AS 1674.1', 'AS 4839-2001', 'No specific standard applies / Ê≤°ÊúâÁâπÂÆöÊ†áÂáÜÈÄÇÁî®'],
              correct: 0,
              explanation: 'AS/NZS 1337.1 requires high-impact rated safety glasses or face shields for grinding to protect against flying particles. / AS/NZS 1337.1Ë¶ÅÊ±ÇÊâìÁ£®Êó∂‰ΩøÁî®È´òÂÜ≤ÂáªÁ≠âÁ∫ßÁöÑÂÆâÂÖ®ÁúºÈïúÊàñÈù¢ÁΩ©Ôºå‰ª•‰øùÊä§ÂÖçÂèóÈ£ûÊ∫ÖÈ¢óÁ≤í‰º§ÂÆ≥„ÄÇ'
            },
            {
              question: 'AS 4839-2001 requires flashback arrestors on oxy-acetylene equipment at: / AS 4839-2001Ë¶ÅÊ±ÇÊ∞ß‰πôÁÇîËÆæÂ§á‰∏äÁöÑÂõûÁÅ´Èò≤Ê≠¢Âô®ÂÆâË£ÖÂú®Ôºö',
              options: ['Only the torch / ‰ªÖÂú®ÁÑäÊû™', 'Only the regulators / ‰ªÖÂú®Ë∞ÉËäÇÂô®', 'Both torch and regulator ends / ÁÑäÊû™ÂíåË∞ÉËäÇÂô®‰∏§Á´Ø', 'They are optional / ÂÆÉ‰ª¨ÊòØÂèØÈÄâÁöÑ'],
              correct: 2,
              explanation: 'AS 4839-2001 mandates flashback arrestors at BOTH the torch handle AND the regulator to prevent flashback explosions. / AS 4839-2001ËßÑÂÆöÁÑäÊû™ÊâãÊüÑÂíåË∞ÉËäÇÂô®‰∏§Á´ØÈÉΩÂøÖÈ°ªÂÆâË£ÖÂõûÁÅ´Èò≤Ê≠¢Âô®Ôºå‰ª•Èò≤Ê≠¢ÂõûÁÅ´ÁàÜÁÇ∏„ÄÇ'
            },
            {
              question: 'The maximum working pressure for acetylene is: / ‰πôÁÇîÁöÑÊúÄÂ§ßÂ∑•‰ΩúÂéãÂäõÊòØÔºö',
              options: ['5 psi / 5 psi', '10 psi / 10 psi', '15 psi / 15 psi', '25 psi / 25 psi'],
              correct: 2,
              explanation: 'Acetylene becomes unstable above 15 psi (103 kPa) and can spontaneously decompose. Never exceed this limit. / ‰πôÁÇîÂú®Ë∂ÖËøá15 psiÔºà103 kPaÔºâÊó∂ÂèòÂæó‰∏çÁ®≥ÂÆöÔºåÂèØËÉΩËá™ÂèëÂàÜËß£„ÄÇÂàáÂãøË∂ÖËøáÊ≠§ÈôêÂà∂„ÄÇ'
            },
            {
              question: 'Under AS 4332-2004, the minimum separation between oxygen and fuel gas cylinders in storage is: / Ê†πÊçÆAS 4332-2004ÔºåÂÇ®Â≠òÊó∂Ê∞ßÊ∞îÂíåÁáÉÊ∞îÈí¢Áì∂‰πãÈó¥ÁöÑÊúÄÂ∞èÈó¥ÈöîÊòØÔºö',
              options: ['1 metre / 1Á±≥', '2 metres / 2Á±≥', '3 metres / 3Á±≥', '5 metres / 5Á±≥'],
              correct: 2,
              explanation: 'AS 4332-2004 requires a minimum 3-metre separation between oxygen and fuel gas cylinders, or a fire-resistant barrier. / AS 4332-2004Ë¶ÅÊ±ÇÊ∞ßÊ∞îÂíåÁáÉÊ∞îÈí¢Áì∂‰πãÈó¥Ëá≥Â∞ëÈó¥Èöî3Á±≥ÔºåÊàñËÆæÁΩÆÈò≤ÁÅ´Â±èÈöú„ÄÇ'
            },
            {
              question: 'Before starting hot work, the area must be cleared of combustibles for a radius of: / ÂºÄÂßãÁÉ≠Â∑•‰Ωú‰∏öÂâçÔºåÂøÖÈ°ªÊ∏ÖÈô§ÂèØÁáÉÁâ©ÁöÑÂçäÂæÑ‰∏∫Ôºö',
              options: ['3 metres / 3Á±≥', '6 metres / 6Á±≥', '10 metres / 10Á±≥', '15 metres / 15Á±≥'],
              correct: 2,
              explanation: 'A minimum 10-metre radius should be cleared of combustible materials, or they must be protected with fire-resistant covers. / Â∫îÊ∏ÖÈô§Ëá≥Â∞ë10Á±≥ÂçäÂæÑÂÜÖÁöÑÂèØÁáÉÊùêÊñôÔºåÊàñÁî®Èò≤ÁÅ´Ë¶ÜÁõñÁâ©‰øùÊä§ÂÆÉ‰ª¨„ÄÇ'
            },
            {
              question: 'A fire watch must remain at the hot work area after work completion for: / ÁÉ≠Â∑•‰Ωú‰∏öÂÆåÊàêÂêéÔºåÈò≤ÁÅ´ÁõëÊä§‰∫∫ÂøÖÈ°ªÂú®Â∑•‰ΩúÂå∫ÂüüÂÅúÁïôÔºö',
              options: ['15 minutes / 15ÂàÜÈíü', '30 minutes / 30ÂàÜÈíü', '60 minutes / 60ÂàÜÈíü', '2 hours / 2Â∞èÊó∂'],
              correct: 1,
              explanation: 'Fire watch must continue for at least 30 minutes after hot work completion to detect any smouldering materials. / ÁÉ≠Â∑•‰Ωú‰∏öÂÆåÊàêÂêéÔºåÈò≤ÁÅ´ÁõëÊä§ÂøÖÈ°ªÊåÅÁª≠Ëá≥Â∞ë30ÂàÜÈíüÔºå‰ª•Ê£ÄÊµã‰ªª‰ΩïÈò¥ÁáÉÊùêÊñô„ÄÇ'
            },
            {
              question: 'When welding galvanized steel, you must: / ÁÑäÊé•ÈïÄÈîåÈí¢Êó∂Ôºå‰Ω†ÂøÖÈ°ªÔºö',
              options: ['Weld faster to reduce fumes / Âø´ÈÄüÁÑäÊé•‰ª•ÂáèÂ∞ëÁÉüÈõæ', 'Use respiratory protection and ensure ventilation / ‰ΩøÁî®ÂëºÂê∏‰øùÊä§Ë£ÖÁΩÆÂπ∂Á°Æ‰øùÈÄöÈ£é', 'Only weld outdoors / Âè™Âú®ÂÆ§Â§ñÁÑäÊé•', 'Apply anti-spatter spray / ‰ΩøÁî®Èò≤È£ûÊ∫ÖÂñ∑ÂâÇ'],
              correct: 1,
              explanation: 'Welding galvanized steel releases zinc oxide fumes. Use appropriate respiratory protection (P2 minimum) and ensure adequate ventilation. / ÁÑäÊé•ÈïÄÈîåÈí¢‰ºöÈáäÊîæÊ∞ßÂåñÈîåÁÉüÈõæ„ÄÇ‰ΩøÁî®ÈÄÇÂΩìÁöÑÂëºÂê∏‰øùÊä§Ë£ÖÁΩÆÔºàËá≥Â∞ëP2Á∫ßÂà´ÔºâÂπ∂Á°Æ‰øùÂÖÖÂàÜÈÄöÈ£é„ÄÇ'
            },
            {
              question: 'The correct way to open a gas cylinder valve is: / ÊâìÂºÄÊ∞îÁì∂ÈòÄÈó®ÁöÑÊ≠£Á°ÆÊñπÊ≥ïÊòØÔºö',
              options: ['Fully open quickly / Âø´ÈÄüÂÆåÂÖ®ÊâìÂºÄ', 'Open slowly, stand to the side / ÁºìÊÖ¢ÊâìÂºÄÔºåÁ´ôÂú®‰æßÈù¢', 'Open halfway only / Âè™ÊâìÂºÄ‰∏ÄÂçä', 'Open with the regulator attached first / ÂÖàËøûÊé•Ë∞ÉËäÇÂô®ÂÜçÊâìÂºÄ'],
              correct: 1,
              explanation: 'Always stand to the side and open cylinder valves slowly to prevent sudden pressure surges and allow for controlled gas flow. / ÂßãÁªàÁ´ôÂú®‰æßÈù¢ÁºìÊÖ¢ÊâìÂºÄÈí¢Áì∂ÈòÄÈó®Ôºå‰ª•Èò≤Ê≠¢Á™ÅÁÑ∂ÁöÑÂéãÂäõÊøÄÂ¢ûÂπ∂ÂÖÅËÆ∏ÂèóÊéßÁöÑÊ∞î‰ΩìÊµÅÂä®„ÄÇ'
            },
            {
              question: 'If an angle grinder disc is cracked or chipped, you should: / Â¶ÇÊûúËßíÁ£®Êú∫Á†ÇËΩÆÁâáÁ†¥Ë£ÇÊàñÁº∫ÊçüÔºå‰Ω†Â∫îËØ•Ôºö',
              options: ['Use it carefully at lower speed / ‰ΩéÈÄüÂ∞èÂøÉ‰ΩøÁî®', 'Mark it and continue for the current job / Ê†áËÆ∞ÂêéÁªßÁª≠ÂΩìÂâçÂ∑•‰Ωú', 'Remove and destroy it immediately / Á´ãÂç≥Âèñ‰∏ãÂπ∂ÈîÄÊØÅ', 'Apply tape to reinforce it / Áî®ËÉ∂Â∏¶Âä†Âõ∫'],
              correct: 2,
              explanation: 'Damaged discs can shatter at high speed causing serious injury. Remove and destroy any cracked or chipped discs immediately. / ÊçüÂùèÁöÑÁ†ÇËΩÆÁâáÂèØËÉΩÂú®È´òÈÄü‰∏ãÁ†¥Á¢éÈÄ†Êàê‰∏•Èáç‰º§ÂÆ≥„ÄÇÁ´ãÂç≥Âèñ‰∏ãÂπ∂ÈîÄÊØÅ‰ªª‰ΩïÁ†¥Ë£ÇÊàñÁº∫ÊçüÁöÑÁ†ÇËΩÆÁâá„ÄÇ'
            },
            {
              question: 'The correct PPE for hot works includes: / ÁÉ≠Â∑•‰Ωú‰∏öÁöÑÊ≠£Á°ÆPPEÂåÖÊã¨Ôºö',
              options: ['Safety glasses only / ‰ªÖÂÆâÂÖ®ÁúºÈïú', 'Gloves and long sleeves / ÊâãÂ•óÂíåÈïøË¢ñ', 'Welding helmet, leather gloves, fire-resistant clothing, safety boots / ÁÑäÊé•Â§¥Áõî„ÄÅÁöÆÊâãÂ•ó„ÄÅÈò≤ÁÅ´ÊúçË£Ö„ÄÅÂÆâÂÖ®Èù¥', 'Hard hat and hi-vis / ÂÆâÂÖ®Â∏ΩÂíåÂèçÂÖâÊúç'],
              correct: 2,
              explanation: 'Full PPE includes: appropriate eye protection, leather welding gloves, fire-resistant clothing, leather apron, and steel-capped boots. / ÂÆåÊï¥ÁöÑPPEÂåÖÊã¨ÔºöÈÄÇÂΩìÁöÑÁúºÈÉ®‰øùÊä§„ÄÅÁöÆÈù©ÁÑäÊé•ÊâãÂ•ó„ÄÅÈò≤ÁÅ´ÊúçË£Ö„ÄÅÁöÆÈù©Âõ¥Ë£ôÂíåÈí¢Â§¥Èù¥„ÄÇ'
            },
            {
              question: 'When oxy-cutting, the flame should be adjusted to: / Ê∞ßÊ∞îÂàáÂâ≤Êó∂ÔºåÁÅ´ÁÑ∞Â∫îË∞ÉËäÇ‰∏∫Ôºö',
              options: ['A large orange flame / Â§ßÁöÑÊ©ôËâ≤ÁÅ´ÁÑ∞', 'A neutral flame with equal cone / Á≠âÊØî‰æãÈî•ÂΩ¢ÁöÑ‰∏≠ÊÄßÁÅ´ÁÑ∞', 'Maximum oxygen for speed / ÊúÄÂ§ßÊ∞ßÊ∞î‰ª•ÊèêÈ´òÈÄüÂ∫¶', 'Minimum flame to save gas / ÊúÄÂ∞èÁÅ´ÁÑ∞‰ª•ËäÇÁúÅÊ∞î‰Ωì'],
              correct: 1,
              explanation: 'A neutral flame (equal acetylene and oxygen) provides the cleanest cut. Adjust until the inner cone is clearly defined. / ‰∏≠ÊÄßÁÅ´ÁÑ∞Ôºà‰πôÁÇîÂíåÊ∞ßÊ∞îÁõ∏Á≠âÔºâÊèê‰æõÊúÄÂπ≤ÂáÄÁöÑÂàáÂâ≤„ÄÇË∞ÉËäÇÁõ¥Âà∞ÂÜÖÈî•Ê∏ÖÊô∞ÂèØËßÅ„ÄÇ'
            },
            {
              question: 'Gas cylinders must be stored: / Ê∞îÁì∂ÂøÖÈ°ªÂÇ®Â≠òÔºö',
              options: ['Lying flat for stability / Âπ≥Êîæ‰ª•‰øùÊåÅÁ®≥ÂÆö', 'Upright and secured with chains or straps / Áõ¥Á´ãÂπ∂Áî®ÈìæÊù°ÊàñÁªëÂ∏¶Âõ∫ÂÆö', 'In direct sunlight for visibility / Âú®Èò≥ÂÖâÁõ¥Â∞Ñ‰∏ã‰ª•‰æøÂèØËßÅ', 'Near emergency exits for quick access / Âú®Á¥ßÊÄ•Âá∫Âè£ÈôÑËøë‰ª•‰æøÂø´ÈÄüÂèñÁî®'],
              correct: 1,
              explanation: 'Cylinders must be stored upright and secured to prevent falling. Keep away from heat sources and direct sunlight. / Ê∞îÁì∂ÂøÖÈ°ªÁõ¥Á´ãÂ≠òÊîæÂπ∂Âõ∫ÂÆö‰ª•Èò≤ÂÄæÂÄí„ÄÇËøúÁ¶ªÁÉ≠Ê∫êÂíåÈò≥ÂÖâÁõ¥Â∞Ñ„ÄÇ'
            },
            {
              question: 'The 2025 Australian WHS exposure standard for aluminium welding fumes is: / 2025Âπ¥Êæ≥Â§ßÂà©‰∫öWHSÈìùÁÑäÊé•ÁÉüÈõæÊö¥Èú≤Ê†áÂáÜÊòØÔºö',
              options: ['1 mg/m¬≥', '2 mg/m¬≥', '5 mg/m¬≥', '10 mg/m¬≥'],
              correct: 0,
              explanation: 'The workplace exposure standard for welding fumes (including aluminium) is 1 mg/m¬≥ TWA, requiring adequate ventilation or RPE. / ÁÑäÊé•ÁÉüÈõæÔºàÂåÖÊã¨ÈìùÔºâÁöÑÂ∑•‰ΩúÂú∫ÊâÄÊö¥Èú≤Ê†áÂáÜÊòØ1 mg/m¬≥ TWAÔºåÈúÄË¶ÅÂÖÖÂàÜÈÄöÈ£éÊàñ‰ΩøÁî®ÂëºÂê∏Èò≤Êä§ËÆæÂ§á„ÄÇ'
            },
            {
              question: 'If a flashback occurs during oxy-acetylene work, the FIRST action is: / Â¶ÇÊûúÊ∞ß‰πôÁÇî‰Ωú‰∏ö‰∏≠ÂèëÁîüÂõûÁÅ´ÔºåÁ¨¨‰∏ÄÊ≠•ÊòØÔºö',
              options: ['Turn off the torch valves / ÂÖ≥Èó≠ÁÑäÊû™ÈòÄÈó®', 'Turn off the cylinder valves immediately / Á´ãÂç≥ÂÖ≥Èó≠Èí¢Áì∂ÈòÄÈó®', 'Run water over the hoses / Áî®Ê∞¥ÂÜ≤Ê¥óËΩØÁÆ°', 'Call emergency services / ÂëºÂè´Á¥ßÊÄ•ÊúçÂä°'],
              correct: 1,
              explanation: 'In a flashback, immediately close the cylinder valves (oxygen first, then fuel). The flashback arrestors should prevent flame reaching cylinders. / ÂèëÁîüÂõûÁÅ´Êó∂ÔºåÁ´ãÂç≥ÂÖ≥Èó≠Èí¢Áì∂ÈòÄÈó®ÔºàÂÖàÂÖ≥Ê∞ßÊ∞îÔºåÂÜçÂÖ≥ÁáÉÊ∞îÔºâ„ÄÇÂõûÁÅ´Èò≤Ê≠¢Âô®Â∫îÈò≤Ê≠¢ÁÅ´ÁÑ∞Âà∞ËææÈí¢Áì∂„ÄÇ'
            }
          ]
        },
        {
          id: 'glass-suction-cups',
          title: 'Glass Suction Cups / ÁéªÁíÉÂê∏Áõò',
          description: 'Safe use of manual glass suction cups and suckers / ÊâãÂä®ÁéªÁíÉÂê∏ÁõòÁöÑÂÆâÂÖ®‰ΩøÁî®',
          duration: '10 min',
          image: 'ü™ü',
          standards: [
            { code: 'Safe Work Australia - Hazardous Manual Tasks COP', url: 'https://www.safeworkaustralia.gov.au/doc/model-code-practice-hazardous-manual-tasks' },
            { code: 'AS 4991 - Lifting Equipment for Glass', url: 'https://www.standards.org.au/' },
            { code: 'Manufacturer Guidelines - Trojan Tools', url: 'https://www.trojantools.com.au/' }
          ],
          questions: [
            {
              question: 'Before using a suction cup, what should you always do first? / ‰ΩøÁî®Âê∏ÁõòÂâçÔºå‰Ω†Â∫îËØ•È¶ñÂÖàÂÅö‰ªÄ‰πàÔºü',
              options: ['Just start using it / Áõ¥Êé•ÂºÄÂßã‰ΩøÁî®', 'Inspect for wear, cracks or damage / Ê£ÄÊü•Á£®Êçü„ÄÅË£ÇÁºùÊàñÊçüÂùè', 'Wet it with water / Áî®Ê∞¥ÂºÑÊπø', 'Heat it up / Âä†ÁÉ≠'],
              correct: 1,
              explanation: 'Before each use, check the suction cup for any signs of wear, cracks, or damage. Ensure the rubber pad is clean. / ÊØèÊ¨°‰ΩøÁî®ÂâçÔºåÊ£ÄÊü•Âê∏ÁõòÊòØÂê¶ÊúâÁ£®Êçü„ÄÅË£ÇÁºùÊàñÊçüÂùèÁöÑËøπË±°„ÄÇÁ°Æ‰øùÊ©°ËÉ∂Âû´Ê∏ÖÊ¥Å„ÄÇ'
            },
            {
              question: 'The glass surface should be: / ÁéªÁíÉË°®Èù¢Â∫îËØ•ÊòØÔºö',
              options: ['Wet and oily / ÊΩÆÊπøÂíåÊ≤πËÖªÁöÑ', 'Clean, dry and free from dust / Ê∏ÖÊ¥Å„ÄÅÂπ≤Áá•‰∏îÊó†ÁÅ∞Â∞ò', 'Warm to the touch / Êë∏Ëµ∑Êù•Ê∏©ÁÉ≠', 'Rough textured / Á≤óÁ≥ôÁ∫πÁêÜÁöÑ'],
              correct: 1,
              explanation: 'A clean, dry surface free from dust, oil or contaminants ensures a better seal and reduces slippage risk. / Ê∏ÖÊ¥Å„ÄÅÂπ≤Áá•„ÄÅÊó†ÁÅ∞Â∞ò„ÄÅÊ≤πËÑÇÊàñÊ±°ÊüìÁâ©ÁöÑË°®Èù¢ÂèØÁ°Æ‰øùÊõ¥Â•ΩÁöÑÂØÜÂ∞ÅÂπ∂Èôç‰ΩéÊªëËÑ±È£éÈô©„ÄÇ'
            },
            {
              question: 'After applying the suction cup, what should you do before lifting? / ÂÆâË£ÖÂê∏ÁõòÂêéÔºåÊèêËµ∑ÂâçÂ∫îËØ•ÂÅö‰ªÄ‰πàÔºü',
              options: ['Immediately lift the glass / Á´ãÂç≥ÊèêËµ∑ÁéªÁíÉ', 'Test the seal with a gentle tug / ËΩªËΩªÊãâÂä®ÊµãËØïÂØÜÂ∞Å', 'Twist it back and forth / Êù•ÂõûÊâ≠Âä®', 'Wait 10 minutes / Á≠âÂæÖ10ÂàÜÈíü'],
              correct: 1,
              explanation: 'Gently tug on the suction cup to ensure it has a secure grip. If loose, repeat the application process. / ËΩªËΩªÊãâÂä®Âê∏Áõò‰ª•Á°Æ‰øùÂÖ∂Áâ¢Âõ∫ÊäìÁ¥ß„ÄÇÂ¶ÇÊûúÊùæÂä®ÔºåËØ∑ÈáçÂ§çÂÆâË£ÖËøáÁ®ã„ÄÇ'
            },
            {
              question: 'What is the static load rating for a Trojan Double Cup Suction Holder? / TrojanÂèåÊùØÂê∏ÁõòÁöÑÈùôÊÄÅË¥üËΩΩÈ¢ùÂÆöÂÄºÊòØÂ§öÂ∞ëÔºü',
              options: ['20kg / 20ÂÖ¨Êñ§', '40kg / 40ÂÖ¨Êñ§', '60kg / 60ÂÖ¨Êñ§', '100kg / 100ÂÖ¨Êñ§'],
              correct: 2,
              explanation: 'The Trojan Double Cup Suction Holder has a static load rating of 60kg for safe handling of materials. / TrojanÂèåÊùØÂê∏ÁõòÁöÑÈùôÊÄÅË¥üËΩΩÈ¢ùÂÆöÂÄº‰∏∫60ÂÖ¨Êñ§ÔºåÂèØÂÆâÂÖ®Êê¨ËøêÊùêÊñô„ÄÇ'
            },
            {
              question: 'How should you clean the suction cup rubber pad after use? / ‰ΩøÁî®ÂêéÂ¶Ç‰ΩïÊ∏ÖÊ¥ÅÂê∏ÁõòÊ©°ËÉ∂Âû´Ôºü',
              options: ['With harsh chemicals / Áî®Âº∫ÂäõÂåñÂ≠¶ÂìÅ', 'With mild detergent and water / Áî®Ê∏©ÂíåÊ¥óÊ∂§ÂâÇÂíåÊ∞¥', 'With abrasive materials / Áî®Á†îÁ£®ÊùêÊñô', 'No cleaning needed / ‰∏çÈúÄË¶ÅÊ∏ÖÊ¥Å'],
              correct: 1,
              explanation: 'Clean with mild detergent and water. Avoid harsh chemicals or abrasives that could damage the rubber. / Áî®Ê∏©ÂíåÊ¥óÊ∂§ÂâÇÂíåÊ∞¥Ê∏ÖÊ¥Å„ÄÇÈÅøÂÖç‰ΩøÁî®ÂèØËÉΩÊçüÂùèÊ©°ËÉ∂ÁöÑÂº∫ÂäõÂåñÂ≠¶ÂìÅÊàñÁ†îÁ£®ÊùêÊñô„ÄÇ'
            },
            {
              question: 'Where should suction cups be stored? / Âê∏ÁõòÂ∫îËØ•Â≠òÊîæÂú®Âì™ÈáåÔºü',
              options: ['In direct sunlight / Èò≥ÂÖâÁõ¥Â∞ÑÂ§Ñ', 'In a cool, dry place away from sunlight / Èò¥ÂáâÂπ≤Áá•„ÄÅÈÅøÂÖçÈò≥ÂÖâÁõ¥Â∞ÑÁöÑÂú∞Êñπ', 'In water / Ê∞¥‰∏≠', 'Outside in the weather / Êà∑Â§ñÊö¥Èú≤Âú®Â§©Ê∞î‰∏≠'],
              correct: 1,
              explanation: 'Store in a cool, dry place away from direct sunlight. Heat and UV rays can degrade the rubber material. / Â≠òÊîæÂú®Èò¥ÂáâÂπ≤Áá•„ÄÅÈÅøÂÖçÈò≥ÂÖâÁõ¥Â∞ÑÁöÑÂú∞Êñπ„ÄÇÈ´òÊ∏©ÂíåÁ¥´Â§ñÁ∫ø‰ºöÈôçËß£Ê©°ËÉ∂ÊùêÊñô„ÄÇ'
            },
            {
              question: 'When moving materials with suction cups, you should: / ‰ΩøÁî®Âê∏ÁõòÁßªÂä®ÊùêÊñôÊó∂Ôºå‰Ω†Â∫îËØ•Ôºö',
              options: ['Move quickly to get it done / Âø´ÈÄüÁßªÂä®‰ª•ÂÆåÊàê‰ªªÂä°', 'Move slowly and smoothly with safe lifting techniques / ‰ΩøÁî®ÂÆâÂÖ®Êê¨ËøêÊäÄÊúØÁºìÊÖ¢Âπ≥Á®≥ÁßªÂä®', 'Swing the material around / ÊëÜÂä®ÊùêÊñô', 'Drag it across surfaces / Âú®Ë°®Èù¢‰∏äÊãñÊãΩ'],
              correct: 1,
              explanation: 'Handle materials slowly and smoothly, using safe lifting techniques to avoid injury or damage. / ÁºìÊÖ¢Âπ≥Á®≥Âú∞Êê¨ËøêÊùêÊñôÔºå‰ΩøÁî®ÂÆâÂÖ®Êê¨ËøêÊäÄÊúØ‰ª•ÈÅøÂÖçÂèó‰º§ÊàñÊçüÂùè„ÄÇ'
            },
            {
              question: 'When should you replace a suction cup? / ‰ΩïÊó∂Â∫îËØ•Êõ¥Êç¢Âê∏ÁõòÔºü',
              options: ['Only when it completely fails / Âè™ÊúâÂÆåÂÖ®Â§±ÊïàÊó∂', 'When you notice cracks, deformations or loss of suction / ÂΩì‰Ω†ÂèëÁé∞Ë£ÇÁºù„ÄÅÂèòÂΩ¢ÊàñÂê∏Âäõ‰∏ãÈôçÊó∂', 'Every week / ÊØèÂë®', 'Never, they last forever / Ê∞∏Ëøú‰∏çÁî®ÔºåÂÆÉ‰ª¨Ê∞∏‰πÖËÄêÁî®'],
              correct: 1,
              explanation: 'Replace immediately if you notice any cracks, deformations, or loss of suction capability. / Â¶ÇÊûúÂèëÁé∞‰ªª‰ΩïË£ÇÁºù„ÄÅÂèòÂΩ¢ÊàñÂê∏Âäõ‰∏ãÈôçÔºåËØ∑Á´ãÂç≥Êõ¥Êç¢„ÄÇ'
            }
          ]
        }
      ];

      const handleAnswer = (questionIndex, answerIndex) => {
        setAnswers({...answers, [questionIndex]: answerIndex});
      };

      const calculateScore = () => {
        if (!selectedCourse) return 0;
        let correct = 0;
        selectedCourse.questions.forEach((q, i) => {
          if (answers[i] === q.correct) correct++;
        });
        return Math.round((correct / selectedCourse.questions.length) * 100);
      };

      const completeCourse = () => {
        const score = calculateScore();
        if (score >= 80) {
          const newCompleted = [...completedCourses, {
            courseId: selectedCourse.id,
            completedAt: new Date().toISOString(),
            score: score
          }];
          setCompletedCourses(newCompleted);
          localStorage.setItem('jmart-completed-training', JSON.stringify(newCompleted));
        }
        setShowResults(true);
      };

      const resetCourse = () => {
        setSelectedCourse(null);
        setCurrentQuestion(0);
        setAnswers({});
        setShowResults(false);
      };

      const isCompleted = (courseId) => completedCourses.some(c => c.courseId === courseId);

      // Generate PDF Certificate using jsPDF - PROFESSIONAL DESIGN
      const generateCertificate = () => {
        try {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
          });

          const pageWidth = doc.internal.pageSize.getWidth();  // 210mm
          const pageHeight = doc.internal.pageSize.getHeight(); // 297mm
          const margin = 15;

          const now = new Date();
          const dateStr = now.toLocaleDateString('en-AU', { day: 'numeric', month: 'long', year: 'numeric' });
          const certId = 'JMS-' + now.getFullYear() + '-' + Math.random().toString(36).substr(2, 8).toUpperCase();

          // Professional Color Palette
          const navy = [15, 23, 42];
          const gold = [212, 175, 55];
          const darkGold = [180, 140, 40];
          const orange = [234, 88, 12];
          const darkOrange = [194, 65, 12];
          const white = [255, 255, 255];
          const lightGray = [248, 250, 252];
          const medGray = [100, 116, 139];
          const darkGray = [51, 65, 85];
          const green = [22, 163, 74];
          const lightGreen = [240, 253, 244];

          // === ELEGANT BORDER DESIGN ===
          // Outer gold border
          doc.setDrawColor(...gold);
          doc.setLineWidth(1.5);
          doc.rect(margin - 3, margin - 3, pageWidth - margin * 2 + 6, pageHeight - margin * 2 + 6);

          // Inner navy border
          doc.setDrawColor(...navy);
          doc.setLineWidth(0.5);
          doc.rect(margin, margin, pageWidth - margin * 2, pageHeight - margin * 2);

          // Corner decorations (small gold squares)
          doc.setFillColor(...gold);
          const cornerSize = 4;
          doc.rect(margin - 3, margin - 3, cornerSize, cornerSize, 'F');
          doc.rect(pageWidth - margin - 1, margin - 3, cornerSize, cornerSize, 'F');
          doc.rect(margin - 3, pageHeight - margin - 1, cornerSize, cornerSize, 'F');
          doc.rect(pageWidth - margin - 1, pageHeight - margin - 1, cornerSize, cornerSize, 'F');

          // === HEADER BANNER ===
          let y = margin + 5;

          // Navy header background
          doc.setFillColor(...navy);
          doc.rect(margin, margin, pageWidth - margin * 2, 35, 'F');

          // Company name
          doc.setFontSize(32);
          doc.setTextColor(...white);
          doc.setFont(undefined, 'bold');
          doc.text('JMART STEEL', pageWidth / 2, y + 12, { align: 'center' });

          // Gold underline
          doc.setDrawColor(...gold);
          doc.setLineWidth(1);
          doc.line(pageWidth / 2 - 45, y + 17, pageWidth / 2 + 45, y + 17);

          // Subtitle
          doc.setFontSize(11);
          doc.setTextColor(...gold);
          doc.setFont(undefined, 'normal');
          doc.text('CERTIFICATE OF COMPLETION', pageWidth / 2, y + 25, { align: 'center' });

          y = margin + 45;

          // === CERTIFICATE BODY ===
          doc.setFontSize(11);
          doc.setTextColor(...medGray);
          doc.setFont(undefined, 'normal');
          doc.text('This is to certify that', pageWidth / 2, y, { align: 'center' });
          y += 12;

          // Worker Name - prominent
          doc.setFontSize(28);
          doc.setTextColor(...navy);
          doc.setFont(undefined, 'bold');
          doc.text(workerName || 'Worker Name', pageWidth / 2, y, { align: 'center' });
          y += 10;

          // Gold line under name
          doc.setDrawColor(...gold);
          doc.setLineWidth(0.8);
          doc.line(pageWidth / 2 - 50, y, pageWidth / 2 + 50, y);
          y += 8;

          doc.setFontSize(11);
          doc.setTextColor(...medGray);
          doc.setFont(undefined, 'normal');
          doc.text('has successfully completed the safety training course', pageWidth / 2, y, { align: 'center' });
          y += 12;

          // Course Title - prominent orange
          const courseTitle = selectedCourse.title.split(' / ')[0];
          doc.setFontSize(20);
          doc.setTextColor(...orange);
          doc.setFont(undefined, 'bold');
          doc.text(courseTitle, pageWidth / 2, y, { align: 'center' });
          y += 12;

          // Score badge - green pill
          doc.setFillColor(...green);
          const badgeWidth = 55;
          const badgeHeight = 10;
          doc.roundedRect(pageWidth / 2 - badgeWidth / 2, y - 7, badgeWidth, badgeHeight, 5, 5, 'F');
          doc.setFontSize(11);
          doc.setTextColor(...white);
          doc.setFont(undefined, 'bold');
          doc.text('PASSED  ‚Ä¢  100%', pageWidth / 2, y, { align: 'center' });
          y += 14;

          // === INFO ROW ===
          const leftCol = pageWidth / 3;
          const rightCol = (pageWidth / 3) * 2;

          doc.setFillColor(...lightGray);
          doc.roundedRect(margin + 10, y - 4, pageWidth - margin * 2 - 20, 18, 2, 2, 'F');

          doc.setFontSize(8);
          doc.setTextColor(...medGray);
          doc.setFont(undefined, 'normal');
          doc.text('DATE COMPLETED', leftCol, y + 2, { align: 'center' });
          doc.text('COURSE DURATION', rightCol, y + 2, { align: 'center' });

          doc.setFontSize(11);
          doc.setTextColor(...navy);
          doc.setFont(undefined, 'bold');
          doc.text(dateStr, leftCol, y + 10, { align: 'center' });
          doc.text(selectedCourse.duration + '  ‚Ä¢  ' + selectedCourse.questions.length + ' Questions', rightCol, y + 10, { align: 'center' });
          y += 22;

          // === ASSESSMENT RESULTS SECTION ===
          const questionCount = selectedCourse.questions.length;
          const rowsNeeded = Math.ceil(questionCount / 2);
          const questionsBoxHeight = rowsNeeded * 7 + 18;

          // Light green background with border
          doc.setFillColor(...lightGreen);
          doc.roundedRect(margin + 10, y, pageWidth - margin * 2 - 20, questionsBoxHeight, 3, 3, 'F');
          doc.setDrawColor(...green);
          doc.setLineWidth(0.3);
          doc.roundedRect(margin + 10, y, pageWidth - margin * 2 - 20, questionsBoxHeight, 3, 3, 'S');

          // Header
          doc.setFontSize(10);
          doc.setTextColor(...green);
          doc.setFont(undefined, 'bold');
          doc.text('ASSESSMENT COMPLETED  ‚Äî  ALL QUESTIONS CORRECT', pageWidth / 2, y + 8, { align: 'center' });

          // Questions in two columns
          const col1X = margin + 18;
          const col2X = pageWidth / 2 + 5;
          let qY = y + 16;

          doc.setFontSize(7.5);
          selectedCourse.questions.forEach((q, idx) => {
            const questionText = q.question.split(' / ')[0];
            const truncatedQ = questionText.length > 48 ? questionText.substring(0, 45) + '...' : questionText;
            const xPos = idx % 2 === 0 ? col1X : col2X;
            const yPos = qY + Math.floor(idx / 2) * 7;

            // Green checkmark
            doc.setTextColor(...green);
            doc.setFont(undefined, 'bold');
            doc.text('‚úì', xPos, yPos);

            // Question text
            doc.setTextColor(...darkGray);
            doc.setFont(undefined, 'normal');
            doc.text('Q' + (idx + 1) + ': ' + truncatedQ, xPos + 5, yPos);
          });

          y += questionsBoxHeight + 6;

          // === AUSTRALIAN STANDARDS SECTION ===
          const standardsCount = selectedCourse.standards ? selectedCourse.standards.length : 1;
          const standardsBoxHeight = standardsCount * 6 + 18;

          // Dark orange/burnt orange background
          doc.setFillColor(...darkOrange);
          doc.roundedRect(margin + 10, y, pageWidth - margin * 2 - 20, standardsBoxHeight, 3, 3, 'F');

          // Gold accent line at top
          doc.setDrawColor(...gold);
          doc.setLineWidth(1.5);
          doc.line(margin + 10, y, pageWidth - margin - 10, y);

          // Header
          doc.setFontSize(11);
          doc.setTextColor(...white);
          doc.setFont(undefined, 'bold');
          doc.text('AUSTRALIAN STANDARDS REFERENCED', pageWidth / 2, y + 9, { align: 'center' });

          // Standards list
          doc.setFontSize(8.5);
          doc.setFont(undefined, 'normal');
          let stdY = y + 17;
          if (selectedCourse.standards && selectedCourse.standards.length > 0) {
            selectedCourse.standards.forEach((s) => {
              doc.text('‚Ä¢  ' + s.code, pageWidth / 2, stdY, { align: 'center' });
              stdY += 6;
            });
          } else {
            doc.text('‚Ä¢  Safe Work Australia - General WHS Guidelines', pageWidth / 2, stdY, { align: 'center' });
          }

          y += standardsBoxHeight + 12;

          // === SIGNATURE SECTION ===
          const sigY = y;
          const sigLeftCol = pageWidth / 4 + 5;
          const sigRightCol = (pageWidth / 4) * 3 - 5;

          // Left - Worker Signature
          doc.setFontSize(8);
          doc.setTextColor(...medGray);
          doc.setFont(undefined, 'normal');
          doc.text('WORKER SIGNATURE', sigLeftCol, sigY, { align: 'center' });

          // Signature image
          if (signatureData) {
            try {
              doc.addImage(signatureData, 'PNG', sigLeftCol - 25, sigY + 3, 50, 18);
            } catch (e) {
              console.log('Could not add worker signature:', e);
            }
          }

          // Signature line
          doc.setDrawColor(...navy);
          doc.setLineWidth(0.5);
          doc.line(sigLeftCol - 35, sigY + 24, sigLeftCol + 35, sigY + 24);

          // Name
          doc.setFontSize(10);
          doc.setTextColor(...navy);
          doc.setFont(undefined, 'bold');
          doc.text(workerName || 'Worker Name', sigLeftCol, sigY + 32, { align: 'center' });

          // Right - Authorizing Signature
          doc.setFontSize(8);
          doc.setTextColor(...medGray);
          doc.setFont(undefined, 'normal');
          doc.text('AUTHORIZED BY', sigRightCol, sigY, { align: 'center' });

          // Try to get Scott's signature
          let scottSigAdded = false;
          try {
            const teamSigs = localStorage.getItem('jmart-team-signatures');
            if (teamSigs) {
              const sigs = JSON.parse(teamSigs);
              if (sigs['Scott Seeho'] && sigs['Scott Seeho'].startsWith('data:image')) {
                doc.addImage(sigs['Scott Seeho'], 'PNG', sigRightCol - 25, sigY + 3, 50, 18);
                scottSigAdded = true;
              }
            }
          } catch (e) {
            console.log('Could not add Scott signature:', e);
          }

          // Signature line
          doc.line(sigRightCol - 35, sigY + 24, sigRightCol + 35, sigY + 24);

          // Name and title
          doc.setFontSize(10);
          doc.setTextColor(...navy);
          doc.setFont(undefined, 'bold');
          doc.text('Scott Seeho', sigRightCol, sigY + 32, { align: 'center' });

          doc.setFontSize(8);
          doc.setTextColor(...medGray);
          doc.setFont(undefined, 'normal');
          doc.text('General Manager  ‚Ä¢  J&M Artsteel', sigRightCol, sigY + 38, { align: 'center' });

          // === FOOTER ===
          // Gold line above footer
          doc.setDrawColor(...gold);
          doc.setLineWidth(0.5);
          doc.line(margin + 20, pageHeight - 28, pageWidth - margin - 20, pageHeight - 28);

          doc.setFontSize(7);
          doc.setTextColor(...medGray);
          doc.setFont(undefined, 'normal');
          doc.text('Certificate ID: ' + certId, pageWidth / 2, pageHeight - 22, { align: 'center' });
          doc.text('This certificate confirms completion of safety training in accordance with Work Health & Safety requirements.', pageWidth / 2, pageHeight - 17, { align: 'center' });
          doc.text('Valid for 12 months from date of issue.  ‚Ä¢  J&M Artsteel Pty Ltd  ‚Ä¢  ABN XX XXX XXX XXX', pageWidth / 2, pageHeight - 12, { align: 'center' });

          // Save the PDF
          const fileName = 'JMart-Certificate-' + selectedCourse.id + '-' + workerName.replace(/\s+/g, '-') + '.pdf';
          doc.save(fileName);

        } catch (error) {
          console.error('Error generating certificate PDF:', error);
          alert('Error generating certificate. Please try again.');
        }
      };

      // Get QR Code URL for sharing - always use the GitHub Pages URL
      const getAppUrl = () => 'https://davidethepingpong.github.io/jmart-steel-safety-app/index.html';

      // Course List View
      if (!selectedCourse) {
        return (
          <div className="space-y-4">
            {showQRCode && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowQRCode(false)}>
                <div className="bg-white rounded-xl p-6 max-w-sm text-center" onClick={e => e.stopPropagation()}>
                  <h3 className="font-bold text-lg mb-3">üì± Share J&M Artsteel Safety App</h3>
                  <p className="text-sm text-gray-600 mb-4">Workers can scan this QR code to install the Safety App on their phone</p>
                  <div className="bg-gray-100 p-4 rounded-lg mb-4">
                    <img src={'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(getAppUrl())} alt="QR Code" className="mx-auto" />
                  </div>
                  <div className="bg-gray-50 p-3 rounded-lg text-xs break-all text-gray-600 mb-4">{getAppUrl()}</div>
                  <button onClick={() => {navigator.clipboard.writeText(getAppUrl()); alert('Link copied!');}} className="w-full bg-orange-600 text-white p-3 rounded-lg font-semibold mb-2">üìã Copy Link</button>
                  <button onClick={() => setShowQRCode(false)} className="w-full bg-gray-200 p-3 rounded-lg font-semibold">Close</button>
                </div>
              </div>
            )}

            {viewingStandards && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setViewingStandards(null)}>
                <div className="bg-white rounded-xl p-4 max-w-md w-full max-h-[80vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                  <h3 className="font-bold text-lg mb-3">üìã {viewingStandards.title} - Standards</h3>
                  <p className="text-sm text-gray-600 mb-4">This training references the following Australian Standards:</p>
                  <div className="space-y-3">
                    {viewingStandards.standards && viewingStandards.standards.map((s, i) => (
                      <a key={i} href={s.url} target="_blank" rel="noopener noreferrer" className="block bg-blue-50 p-3 rounded-lg hover:bg-blue-100 transition-colors">
                        <p className="font-medium text-blue-800 text-sm">{s.code}</p>
                        <p className="text-xs text-blue-600 mt-1">üîó View Standard ‚Üí</p>
                      </a>
                    ))}
                  </div>
                  <button onClick={() => setViewingStandards(null)} className="w-full bg-gray-200 p-3 rounded-lg font-semibold mt-4">Close</button>
                </div>
              </div>
            )}

            <div className="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-4 rounded-xl">
              <div className="flex items-center justify-between">
                <div>
                  <h2 className="text-xl font-bold">üìö Training Courses</h2>
                  <p className="text-sm opacity-90 mt-1">Complete courses to stay safe on site</p>
                </div>
                <button onClick={() => setShowQRCode(true)} className="bg-white bg-opacity-20 p-2 rounded-lg hover:bg-opacity-30" title="Share with workers">
                  <span className="text-2xl">üì±</span>
                </button>
              </div>
            </div>

            <div className="grid gap-3">
              {courses.map(course => (
                <div key={course.id} className="bg-white p-4 rounded-xl shadow-sm">
                  <div className="flex items-center gap-4">
                    <div className="text-4xl">{course.image}</div>
                    <div className="flex-1">
                      <div className="flex items-center gap-2">
                        <h3 className="font-semibold text-gray-900">{course.title}</h3>
                        {isCompleted(course.id) && <span className="text-green-500 text-lg">‚úÖ</span>}
                      </div>
                      <p className="text-sm text-gray-600">{course.description}</p>
                      <p className="text-xs text-gray-400 mt-1">‚è±Ô∏è {course.duration} ‚Ä¢ {course.questions.length} questions</p>
                    </div>
                  </div>
                  <div className="flex gap-2 mt-3">
                    <button onClick={() => setSelectedCourse(course)} className="flex-1 bg-orange-600 text-white p-2 rounded-lg font-semibold text-sm">
                      Start Course ‚ñ∂
                    </button>
                    {course.standards && (
                      <button onClick={() => setViewingStandards(course)} className="bg-blue-100 text-blue-700 p-2 rounded-lg text-sm font-medium">
                        üìã Standards
                      </button>
                    )}
                  </div>
                </div>
              ))}
            </div>

            {completedCourses.length > 0 && (
              <div className="bg-green-50 border border-green-200 p-4 rounded-xl mt-4">
                <h3 className="font-semibold text-green-800">üéâ Completed Training</h3>
                <p className="text-sm text-green-600">{completedCourses.length} of {courses.length} courses completed</p>
              </div>
            )}
          </div>
        );
      }

      // Results View
      if (showResults) {
        const score = calculateScore();
        const passed = score >= 80;

        // Show signature pad
        if (showSignature) {
          return (
            <SignaturePad
              name={workerName}
              onSave={(sig) => {
                setSignatureData(sig);
                setShowSignature(false);
                setShowCertificate(true);
              }}
              onCancel={() => setShowSignature(false)}
            />
          );
        }

        // Show certificate ready screen
        if (showCertificate) {
          return (
            <div className="space-y-4">
              <div className="bg-green-500 text-white p-6 rounded-xl text-center">
                <div className="text-6xl mb-4">üéì</div>
                <h2 className="text-2xl font-bold">Certificate Ready!</h2>
                <p className="mt-2">Your training certificate has been prepared</p>
              </div>

              <div className="bg-white rounded-xl p-4 space-y-4">
                <div className="text-center">
                  <p className="text-4xl mb-2">{selectedCourse.image}</p>
                  <h3 className="font-bold text-lg">{selectedCourse.title}</h3>
                  <p className="text-green-600 font-semibold">Score: {score}% ‚úì</p>
                </div>

                <div className="border-t pt-4">
                  <p className="text-sm text-gray-600 mb-2"><strong>Worker:</strong> {workerName}</p>
                  <p className="text-sm text-gray-600 mb-2"><strong>Date:</strong> {new Date().toLocaleDateString('en-AU')}</p>
                  {signatureData && (
                    <div className="mt-3">
                      <p className="text-xs text-gray-500 mb-1">Signature:</p>
                      <img src={signatureData} alt="Signature" className="h-12 border rounded" />
                    </div>
                  )}
                </div>

                {selectedCourse.standards && (
                  <div className="bg-blue-50 p-3 rounded-lg">
                    <p className="text-xs font-semibold text-blue-800 mb-2">üìã Standards Referenced:</p>
                    {selectedCourse.standards.map((s, i) => (
                      <p key={i} className="text-xs text-blue-700">‚Ä¢ {s.code}</p>
                    ))}
                  </div>
                )}
              </div>

              <button onClick={generateCertificate} className="w-full bg-green-600 text-white p-4 rounded-xl font-semibold">
                üì• Download Certificate
              </button>

              <button onClick={resetCourse} className="w-full bg-gray-200 text-gray-700 p-4 rounded-xl font-semibold">
                Back to Courses
              </button>
            </div>
          );
        }

        return (
          <div className="space-y-4">
            <div className={`${passed ? 'bg-green-500' : 'bg-red-500'} text-white p-6 rounded-xl text-center`}>
              <div className="text-6xl mb-4">{passed ? 'üéâ' : 'üìö'}</div>
              <h2 className="text-2xl font-bold">{passed ? 'Congratulations!' : 'Keep Learning!'}</h2>
              <p className="text-4xl font-bold mt-2">{score}%</p>
              <p className="mt-2">{passed ? 'You passed the course!' : 'You need 80% to pass. Try again!'}</p>
            </div>

            {passed && (
              <div className="bg-white rounded-xl p-4 space-y-3">
                <h3 className="font-semibold">üìù Sign & Get Certificate</h3>
                <p className="text-sm text-gray-600">Enter your name and sign to receive your training certificate.</p>
                <input
                  type="text"
                  placeholder="Enter your full name"
                  value={workerName}
                  onChange={(e) => setWorkerName(e.target.value)}
                  className="w-full p-3 border rounded-lg"
                />
                <button
                  onClick={() => setShowSignature(true)}
                  disabled={!workerName.trim()}
                  className={`w-full p-3 rounded-lg font-semibold ${workerName.trim() ? 'bg-blue-600 text-white' : 'bg-gray-300 text-gray-500'}`}
                >
                  ‚úçÔ∏è Sign Certificate
                </button>
              </div>
            )}

            <div className="bg-white rounded-xl p-4 space-y-3">
              <h3 className="font-semibold">Review Your Answers</h3>
              {selectedCourse.questions.map((q, i) => (
                <div key={i} className={`p-3 rounded-lg ${answers[i] === q.correct ? 'bg-green-50' : 'bg-red-50'}`}>
                  <p className="font-medium text-sm">{q.question}</p>
                  <p className="text-xs mt-1">Your answer: {q.options[answers[i]]}</p>
                  {answers[i] !== q.correct && (
                    <p className="text-xs text-green-700 mt-1">Correct: {q.options[q.correct]}</p>
                  )}
                  <p className="text-xs text-gray-500 mt-1 italic">{q.explanation}</p>
                </div>
              ))}
            </div>

            <button onClick={resetCourse} className="w-full bg-orange-600 text-white p-4 rounded-xl font-semibold">
              Back to Courses
            </button>
          </div>
        );
      }

      // Quiz View
      const question = selectedCourse.questions[currentQuestion];
      const progress = ((currentQuestion + 1) / selectedCourse.questions.length) * 100;

      return (
        <div className="space-y-4">
          <div className="bg-white rounded-xl p-4 shadow-sm">
            <div className="flex items-center justify-between mb-2">
              <button onClick={resetCourse} className="text-gray-500">‚úï Exit</button>
              <span className="text-sm text-gray-500">{currentQuestion + 1} / {selectedCourse.questions.length}</span>
            </div>
            <div className="w-full bg-gray-200 rounded-full h-2">
              <div className="bg-orange-500 h-2 rounded-full transition-all" style={{width: `${progress}%`}}></div>
            </div>
          </div>

          <div className="bg-white rounded-xl p-4 shadow-sm">
            <div className="text-center mb-4">
              <span className="text-4xl">{selectedCourse.image}</span>
              <h2 className="font-bold text-lg mt-2">{selectedCourse.title}</h2>
            </div>

            <div className="bg-gray-50 p-4 rounded-lg mb-4">
              <p className="font-medium text-gray-900">{question.question}</p>
            </div>

            <div className="space-y-2">
              {question.options.map((option, i) => (
                <button
                  key={i}
                  onClick={() => handleAnswer(currentQuestion, i)}
                  className={`w-full p-3 rounded-lg text-left transition-colors ${
                    answers[currentQuestion] === i
                      ? 'bg-orange-500 text-white'
                      : 'bg-gray-100 hover:bg-gray-200'
                  }`}
                >
                  {option}
                </button>
              ))}
            </div>
          </div>

          <div className="flex gap-3">
            {currentQuestion > 0 && (
              <button
                onClick={() => setCurrentQuestion(currentQuestion - 1)}
                className="flex-1 bg-gray-200 p-4 rounded-xl font-semibold"
              >
                ‚Üê Previous
              </button>
            )}
            {currentQuestion < selectedCourse.questions.length - 1 ? (
              <button
                onClick={() => setCurrentQuestion(currentQuestion + 1)}
                disabled={answers[currentQuestion] === undefined}
                className={`flex-1 p-4 rounded-xl font-semibold ${
                  answers[currentQuestion] !== undefined
                    ? 'bg-orange-600 text-white'
                    : 'bg-gray-300 text-gray-500'
                }`}
              >
                Next ‚Üí
              </button>
            ) : (
              <button
                onClick={completeCourse}
                disabled={answers[currentQuestion] === undefined}
                className={`flex-1 p-4 rounded-xl font-semibold ${
                  answers[currentQuestion] !== undefined
                    ? 'bg-green-600 text-white'
                    : 'bg-gray-300 text-gray-500'
                }`}
              >
                Complete ‚úì
              </button>
            )}
          </div>
        </div>
      );
    }

    // Pre-Start View
    function PrestartView({ onSubmit, onUpdate, editingForm, previousPrestarts = [], sites = [] }) {
      const isEditing = !!editingForm;
      const editData = editingForm?.data || {};

      const [step, setStep] = useState(isEditing ? 2 : 1);
      const [checkType, setCheckType] = useState(editData.type || null);
      const [checks, setChecks] = useState(editData.checks || {});
      const [notes, setNotes] = useState(editData.notes || '');
      const [submitted, setSubmitted] = useState(false);
      const [signingWorker, setSigningWorker] = useState(null);
      const [showPreviousList, setShowPreviousList] = useState(false);
      const [supervisorName, setSupervisorName] = useState(editData.supervisorName || '');
      const [siteConducted, setSiteConducted] = useState(editData.siteConducted || '');
      const [builder, setBuilder] = useState(editData.builder || '');
      const [address, setAddress] = useState(editData.address || '');
      const [isLocating, setIsLocating] = useState(false);
      const [formDate, setFormDate] = useState(editData.date ? new Date(editData.date) : new Date());

      // Helper to ensure media fields have proper structure
      const ensureMediaStructure = (data) => ({
        value: data?.value || '',
        notes: Array.isArray(data?.notes) ? data.notes : [],
        media: Array.isArray(data?.media) ? data.media : []
      });

      const [workAreas, setWorkAreas] = useState(ensureMediaStructure(editData.workAreas));
      const [tasksThisShift, setTasksThisShift] = useState(ensureMediaStructure(editData.tasksThisShift));
      const [machineryControls, setMachineryControls] = useState(ensureMediaStructure(editData.machineryControls));
      const [siteHazards, setSiteHazards] = useState(ensureMediaStructure(editData.siteHazards));
      const [permitsRequired, setPermitsRequired] = useState(ensureMediaStructure(editData.permitsRequired));

      // New fields
      const [isPlantEquipmentUsed, setIsPlantEquipmentUsed] = useState(editData.isPlantEquipmentUsed ?? null); // yes/no
      const [highRiskWorks, setHighRiskWorks] = useState(editData.highRiskWorks ?? null); // yes/no/na
      const [worksCoveredBySWMS, setWorksCoveredBySWMS] = useState(editData.worksCoveredBySWMS ?? null); // yes/no/na
      const [hasSafetyIssues, setHasSafetyIssues] = useState(editData.hasSafetyIssues ?? null); // yes/no
      const [safetyIssuesPreviousShift, setSafetyIssuesPreviousShift] = useState(ensureMediaStructure(editData.safetyIssuesPreviousShift));
      const [translatorRequired, setTranslatorRequired] = useState(editData.translatorRequired ?? null); // yes/no
      const [translatorSignature, setTranslatorSignature] = useState(editData.translatorSignature || null);
      const [translatorName, setTranslatorName] = useState(editData.translatorName || '');
      const [signingTranslator, setSigningTranslator] = useState(false);

      const [signatures, setSignatures] = useState(editData.signatures || {
        'Jeff Fu': null, 'Scott Seeho': null, 'Davide Casolini': null,
        'Zonggang Jiang': null, 'Leon Yu': null, 'Wang Jia': null, 'Gen Bao': null,
      });

      const displayDate = formDate.toLocaleDateString('en-AU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
      const displayTime = formDate.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });
      const builders = ['Fdc Fitout and Refurbishment', 'Fdc Construction', 'Hunter Mason', 'Built', 'Landlease'];
      const defaultSites = ['Site 1 - Sydney CBD', 'Site 2 - Parramatta', 'Site 3 - North Sydney', 'Site 4 - Chatswood', 'Site 5 - Liverpool'];
      const sitesList = sites.length > 0 ? sites : defaultSites;
      const teamMembers = ['Jeff Fu', 'Scott Seeho', 'Davide Casolini', 'Zonggang Jiang', 'Leon Yu', 'Wang Jia', 'Gen Bao'];

      const checklistTypes = [
        { id: 'site', label: 'Site Pre-Start', emoji: 'üèóÔ∏è', color: 'bg-blue-500' },
        { id: 'crane', label: 'Crane/Hoist', emoji: 'üèóÔ∏è', color: 'bg-orange-500' },
        { id: 'forklift', label: 'Forklift', emoji: 'üöú', color: 'bg-green-500' },
        { id: 'vehicle', label: 'Vehicle', emoji: 'üöó', color: 'bg-purple-500' },
        { id: 'welding', label: 'Welding Equipment', emoji: 'üî•', color: 'bg-red-500' },
        { id: 'scaffold', label: 'Scaffold', emoji: 'ü™ú', color: 'bg-yellow-500' },
      ];

      const checklistItems = {
        site: [
          { id: 's1', text: 'Site access and egress points clear' },
          { id: 's2', text: 'Exclusion zones and barriers in place' },
          { id: 's3', text: 'First aid kit available and stocked' },
          { id: 's4', text: 'Emergency assembly point identified' },
          { id: 's5', text: 'Fire extinguishers available' },
          { id: 's6', text: 'Site amenities available' },
          { id: 's7', text: 'Electrical leads safe' },
          { id: 's8', text: 'Work area clean and tidy' },
          { id: 's9', text: 'Weather conditions suitable' },
          { id: 's10', text: 'All workers inducted' },
        ],
        crane: [
          { id: 'c1', text: 'Visual inspection completed' },
          { id: 'c2', text: 'Safety devices operational' },
          { id: 'c3', text: 'Load chart available' },
          { id: 'c4', text: 'Wire ropes in good condition' },
          { id: 'c5', text: 'Hooks and latches functioning' },
        ],
        forklift: [
          { id: 'f1', text: 'Pre-operational walk around done' },
          { id: 'f2', text: 'Tyres in good condition' },
          { id: 'f3', text: 'Forks not bent or cracked' },
          { id: 'f4', text: 'Brakes functioning' },
          { id: 'f5', text: 'Horn and lights working' },
        ],
        vehicle: [
          { id: 'v1', text: 'Lights and indicators working' },
          { id: 'v2', text: 'Tyres in good condition' },
          { id: 'v3', text: 'Brakes functioning' },
          { id: 'v4', text: 'Windscreen clear' },
          { id: 'v5', text: 'First aid kit present' },
        ],
        welding: [
          { id: 'w1', text: 'Welding leads inspected' },
          { id: 'w2', text: 'Earth clamp secure' },
          { id: 'w3', text: 'Gas bottles secured' },
          { id: 'w4', text: 'Fire extinguisher nearby' },
          { id: 'w5', text: 'PPE available' },
        ],
        scaffold: [
          { id: 'sc1', text: 'Scaffold tag current' },
          { id: 'sc2', text: 'Base plates in place' },
          { id: 'sc3', text: 'Guardrails in place' },
          { id: 'sc4', text: 'Safe access provided' },
          { id: 'sc5', text: 'No overloading' },
        ],
      };

      const getLocation = () => {
        setIsLocating(true);
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            async (position) => {
              try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.coords.latitude}&lon=${position.coords.longitude}`);
                const data = await response.json();
                setAddress(data.display_name || `${position.coords.latitude}, ${position.coords.longitude}`);
              } catch (e) {
                setAddress(`${position.coords.latitude}, ${position.coords.longitude}`);
              }
              setIsLocating(false);
            },
            () => { alert('Unable to get location'); setIsLocating(false); },
            { enableHighAccuracy: true, timeout: 10000 }
          );
        }
      };

      // Validation for Pre-Start form - WHS compliance required fields
      const [validationErrors, setValidationErrors] = useState([]);

      const validateForm = () => {
        const errors = [];
        const signedCount = Object.values(signatures).filter(s => s !== null).length;

        // Required fields for WHS compliance
        if (!siteConducted) errors.push('Site/Location is required');
        if (!supervisorName) errors.push('Supervisor name is required');
        if (siteHazards.value === '' && siteHazards.notes.length === 0) errors.push('Site hazards must be identified');
        if (highRiskWorks === null) errors.push('High-risk works question must be answered');
        if (worksCoveredBySWMS === null) errors.push('SWMS coverage question must be answered');
        if (highRiskWorks === 'yes' && worksCoveredBySWMS !== 'yes') errors.push('High-risk works require SWMS coverage');
        if (isPlantEquipmentUsed === null) errors.push('Plant/equipment question must be answered');
        if (signedCount === 0) errors.push('At least one worker must sign on');

        // Checklist completion check
        const items = checklistItems[checkType] || [];
        const completedItems = Object.keys(checks).length;
        if (completedItems < items.length) errors.push(`All ${items.length} checklist items must be completed (${completedItems} done)`);

        return errors;
      };

      const handleSubmit = () => {
        const errors = validateForm();
        if (errors.length > 0) {
          setValidationErrors(errors);
          return;
        }
        setValidationErrors([]);

        const formData = {
          type: checkType, checks, notes, signatures, supervisorName, siteConducted, builder, address,
          workAreas, tasksThisShift, machineryControls, siteHazards, permitsRequired,
          isPlantEquipmentUsed, highRiskWorks, worksCoveredBySWMS, hasSafetyIssues, safetyIssuesPreviousShift,
          translatorRequired, translatorSignature, translatorName,
          date: formDate.toISOString()
        };

        if (isEditing && onUpdate) {
          // When editing, the confirmation modal will handle the flow
          onUpdate(editingForm.id, 'prestart', formData);
          // Don't set submitted - the modal will handle navigation
        } else {
          onSubmit(formData);
          setSubmitted(true);
        }
      };

      const resetForm = () => {
        setStep(1); setCheckType(null); setChecks({}); setNotes('');
        setSupervisorName(''); setSiteConducted(''); setBuilder(''); setAddress('');
        setWorkAreas({ value: '', notes: [], media: [] });
        setTasksThisShift({ value: '', notes: [], media: [] });
        setMachineryControls({ value: '', notes: [], media: [] });
        setSiteHazards({ value: '', notes: [], media: [] });
        setPermitsRequired({ value: '', notes: [], media: [] });
        setIsPlantEquipmentUsed(null);
        setHighRiskWorks(null);
        setWorksCoveredBySWMS(null);
        setHasSafetyIssues(null);
        setSafetyIssuesPreviousShift({ value: '', notes: [], media: [] });
        setTranslatorRequired(null);
        setTranslatorSignature(null);
        setTranslatorName('');
        setSigningTranslator(false);
        setSignatures({ 'Jeff Fu': null, 'Scott Seeho': null, 'Davide Casolini': null, 'Zonggang Jiang': null, 'Leon Yu': null, 'Wang Jia': null, 'Gen Bao': null });
        setSubmitted(false);
      };

      if (submitted) {
        const signedCount = Object.values(signatures).filter(s => s !== null).length;
        return (
          <div className="text-center py-12">
            <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl">‚úÖ</div>
            <h2 className="text-2xl font-bold text-gray-800 mb-2">{isEditing ? 'Pre-Start Updated!' : 'Pre-Start Complete!'}</h2>
            <p className="text-gray-600 mb-2">{isEditing ? 'Your changes have been saved.' : 'Your checklist has been recorded.'}</p>
            <p className="text-sm text-gray-500 mb-6">{signedCount} worker(s) signed on</p>
            <button onClick={resetForm} className="bg-orange-600 text-white px-6 py-3 rounded-lg font-semibold">{isEditing ? 'Back to Dashboard' : 'Start Another Check'}</button>
          </div>
        );
      }

      // Function to load data from a previous prestart
      const loadFromPrevious = (previousForm) => {
        const data = previousForm.data;

        // Set checklist type and move to step 2
        setCheckType(data.type);

        // Copy site details
        setSupervisorName(data.supervisorName || '');
        setSiteConducted(data.siteConducted || '');
        setBuilder(data.builder || '');
        setAddress(data.address || '');

        // Copy work context fields (with media)
        setWorkAreas(ensureMediaStructure(data.workAreas));
        setTasksThisShift(ensureMediaStructure(data.tasksThisShift));
        setMachineryControls(ensureMediaStructure(data.machineryControls));
        setSiteHazards(ensureMediaStructure(data.siteHazards));
        setPermitsRequired(ensureMediaStructure(data.permitsRequired));

        // Copy yes/no fields
        setIsPlantEquipmentUsed(data.isPlantEquipmentUsed ?? null);
        setHighRiskWorks(data.highRiskWorks ?? null);
        setWorksCoveredBySWMS(data.worksCoveredBySWMS ?? null);

        // Copy checklist checks
        setChecks(data.checks || {});

        // Reset fields that should be fresh for new form
        setFormDate(new Date()); // Current date/time
        setHasSafetyIssues(null); // Reset safety issues question
        setSafetyIssuesPreviousShift({ value: '', notes: [], media: [] }); // Clear safety issues
        setNotes(''); // Clear notes
        setTranslatorRequired(null);
        setTranslatorSignature(null);
        setTranslatorName('');
        setSignatures({ 'Jeff Fu': null, 'Scott Seeho': null, 'Davide Casolini': null, 'Zonggang Jiang': null, 'Leon Yu': null, 'Wang Jia': null, 'Gen Bao': null }); // Clear all signatures

        // Close modal and go to step 2
        setShowPreviousList(false);
        setStep(2);
      };

      if (step === 1) {
        return (
          <div className="space-y-4">
            {/* Previous Prestarts Modal */}
            {showPreviousList && (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl w-full max-w-md max-h-[80vh] overflow-hidden flex flex-col">
                  <div className="p-4 border-b flex items-center justify-between">
                    <h3 className="text-lg font-bold text-gray-800">Load from Previous</h3>
                    <button onClick={() => setShowPreviousList(false)} className="text-gray-500 text-xl">‚úï</button>
                  </div>
                  <div className="overflow-y-auto flex-1 p-4">
                    {previousPrestarts.length === 0 ? (
                      <div className="text-center py-8 text-gray-500">
                        <p>No previous prestarts found.</p>
                        <p className="text-sm mt-2">Complete a prestart first to use this feature.</p>
                      </div>
                    ) : (
                      <div className="space-y-3">
                        <p className="text-sm text-gray-600 mb-3">Select a previous prestart to copy. Signatures and date will be reset.</p>
                        {previousPrestarts.slice(0, 20).map((form) => {
                          const formDate = new Date(form.data.date || form.createdAt);
                          const typeInfo = checklistTypes.find(t => t.id === form.data.type);
                          return (
                            <button
                              key={form.id}
                              onClick={() => loadFromPrevious(form)}
                              className="w-full bg-gray-50 hover:bg-orange-50 border border-gray-200 hover:border-orange-300 rounded-xl p-4 text-left transition-colors"
                            >
                              <div className="flex items-start gap-3">
                                <div className={`w-10 h-10 ${typeInfo?.color || 'bg-gray-500'} rounded-full flex items-center justify-center text-lg flex-shrink-0`}>
                                  {typeInfo?.emoji || 'üìã'}
                                </div>
                                <div className="flex-1 min-w-0">
                                  <p className="font-semibold text-gray-800 truncate">{form.data.siteConducted || 'Unknown Site'}</p>
                                  <p className="text-sm text-gray-600 truncate">{typeInfo?.label || 'Pre-Start'} ‚Ä¢ {form.data.builder || 'No builder'}</p>
                                  <p className="text-xs text-gray-400 mt-1">
                                    {formDate.toLocaleDateString('en-AU', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' })}
                                  </p>
                                </div>
                              </div>
                            </button>
                          );
                        })}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}

            <div className="bg-white rounded-xl p-4 shadow-sm">
              <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">üìã Pre-Start Checklists</h2>
              <p className="text-gray-500 text-sm mt-1">Select the type of pre-start check</p>
            </div>

            {/* Load from Previous Button */}
            {previousPrestarts.length > 0 && (
              <button
                onClick={() => setShowPreviousList(true)}
                className="w-full bg-blue-50 hover:bg-blue-100 border-2 border-dashed border-blue-300 hover:border-blue-400 rounded-xl p-4 flex items-center justify-center gap-3 transition-colors"
              >
                <span className="text-2xl">üìÑ</span>
                <div className="text-left">
                  <p className="font-semibold text-blue-700">Copy from Previous Prestart</p>
                  <p className="text-sm text-blue-600">Same job, different day? Load previous details</p>
                </div>
              </button>
            )}

            <div className="grid grid-cols-2 gap-3">
              {checklistTypes.map((type) => (
                <button key={type.id} onClick={() => { setCheckType(type.id); setStep(2); }}
                  className="bg-white rounded-xl p-4 shadow-sm flex flex-col items-center gap-3 hover:shadow-md">
                  <div className={`w-14 h-14 ${type.color} rounded-full flex items-center justify-center text-2xl`}>{type.emoji}</div>
                  <span className="font-medium text-gray-700 text-center">{type.label}</span>
                </button>
              ))}
            </div>
          </div>
        );
      }

      const items = checklistItems[checkType] || [];
      const allChecked = items.every(item => checks[item.id] !== undefined);
      const signedCount = Object.values(signatures).filter(s => s !== null).length;

      if (step === 2) {
        return (
          <div className="space-y-4">
            {signingWorker && <SignaturePad name={signingWorker} onSave={(data) => { setSignatures({...signatures, [signingWorker]: data}); setSigningWorker(null); }} onCancel={() => setSigningWorker(null)} />}

            {isEditing && (
              <div className="bg-blue-100 border border-blue-300 rounded-xl p-3 flex items-center gap-2">
                <span className="text-blue-600 text-xl">‚úèÔ∏è</span>
                <div>
                  <p className="text-blue-800 font-semibold">Editing Mode</p>
                  <p className="text-blue-600 text-sm">Modify this form and save your changes</p>
                </div>
              </div>
            )}

            <div className="bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-4 text-white">
              <div className="flex items-center gap-2 mb-2">
                <span>üìÖ</span>
                <span className="font-bold text-lg">{displayDate}</span>
                <span className="text-sm opacity-80">at {displayTime}</span>
              </div>
              {isEditing && (
                <div className="flex gap-2 mt-2">
                  <input
                    type="date"
                    value={formDate.toISOString().split('T')[0]}
                    onChange={(e) => {
                      const newDate = new Date(formDate);
                      const [year, month, day] = e.target.value.split('-');
                      newDate.setFullYear(parseInt(year), parseInt(month) - 1, parseInt(day));
                      setFormDate(newDate);
                    }}
                    className="flex-1 bg-white/20 text-white border border-white/30 rounded-lg p-2 text-sm"
                  />
                  <input
                    type="time"
                    value={formDate.toTimeString().slice(0,5)}
                    onChange={(e) => {
                      const newDate = new Date(formDate);
                      const [hours, minutes] = e.target.value.split(':');
                      newDate.setHours(parseInt(hours), parseInt(minutes));
                      setFormDate(newDate);
                    }}
                    className="bg-white/20 text-white border border-white/30 rounded-lg p-2 text-sm"
                  />
                </div>
              )}
            </div>

            <div className="bg-white rounded-xl p-4 shadow-sm">
              <div className="flex items-center justify-between">
                <h2 className="text-xl font-bold text-gray-800">{checklistTypes.find(t => t.id === checkType)?.label}</h2>
                <button onClick={() => setStep(1)} className="text-gray-500 text-xl">‚úï</button>
              </div>
            </div>

            <div className="bg-white rounded-xl p-4 shadow-sm space-y-4">
              <h3 className="font-semibold text-gray-800">Site Details</h3>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">üë§ Supervisor Name *</label>
                <select value={supervisorName} onChange={(e) => setSupervisorName(e.target.value)}
                  className="w-full border border-gray-300 rounded-lg p-3 bg-white">
                  <option value="">Select Supervisor</option>
                  <option value="Jeff Fu">Jeff Fu</option>
                  <option value="Scott Seeho">Scott Seeho</option>
                  <option value="Davide Casolini">Davide Casolini</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Site Conducted *</label>
                <select value={siteConducted} onChange={(e) => setSiteConducted(e.target.value)} className="w-full border border-gray-300 rounded-lg p-3 bg-white">
                  <option value="">Select Site</option>
                  {sitesList.map((site) => <option key={site} value={site}>{site}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Builder *</label>
                <select value={builder} onChange={(e) => setBuilder(e.target.value)} className="w-full border border-gray-300 rounded-lg p-3 bg-white">
                  <option value="">Select Builder</option>
                  {builders.map((b) => <option key={b} value={b}>{b}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">üìç Address *</label>
                <div className="flex gap-2">
                  <input type="text" value={address} onChange={(e) => setAddress(e.target.value)}
                    className="flex-1 border border-gray-300 rounded-lg p-3" placeholder="Enter site address" />
                  <button onClick={getLocation} disabled={isLocating}
                    className="bg-blue-600 text-white px-4 rounded-lg disabled:bg-blue-400">
                    {isLocating ? '...' : 'üìç'}
                  </button>
                </div>
              </div>
            </div>

            <NoteMediaBox label="Work Areas" value={workAreas.value} notes={workAreas.notes} media={workAreas.media}
              onValueChange={(val) => setWorkAreas(prev => ({...prev, value: val}))}
              onAddNote={(note) => setWorkAreas(prev => ({...prev, notes: [...prev.notes, note]}))}
              onAddMedia={(item) => { console.log('Work Areas onAddMedia called with:', item?.name); setWorkAreas(prev => ({...prev, media: [...prev.media, item]})); }}
              onRemoveNote={(idx) => setWorkAreas(prev => ({...prev, notes: prev.notes.filter((_, i) => i !== idx)}))}
              onRemoveMedia={(idx) => setWorkAreas(prev => ({...prev, media: prev.media.filter((_, i) => i !== idx)}))} />

            <NoteMediaBox label="Task to be Completed this Shift" value={tasksThisShift.value} notes={tasksThisShift.notes} media={tasksThisShift.media}
              onValueChange={(val) => setTasksThisShift(prev => ({...prev, value: val}))}
              onAddNote={(note) => setTasksThisShift(prev => ({...prev, notes: [...prev.notes, note]}))}
              onAddMedia={(item) => { console.log('Tasks onAddMedia called with:', item?.name); setTasksThisShift(prev => ({...prev, media: [...prev.media, item]})); }}
              onRemoveNote={(idx) => setTasksThisShift(prev => ({...prev, notes: prev.notes.filter((_, i) => i !== idx)}))}
              onRemoveMedia={(idx) => setTasksThisShift(prev => ({...prev, media: prev.media.filter((_, i) => i !== idx)}))} />

            {/* Is Plant/Equipment to be used? */}
            <div className="bg-white rounded-xl p-4 shadow-sm">
              <h4 className="font-semibold text-gray-800 mb-3">üöú Is Plant/Equipment to be used?</h4>
              <div className="flex gap-3">
                <button onClick={() => setIsPlantEquipmentUsed(true)}
                  className={`flex-1 py-3 rounded-lg font-medium border-2 ${isPlantEquipmentUsed === true ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 text-gray-700'}`}>
                  Yes
                </button>
                <button onClick={() => setIsPlantEquipmentUsed(false)}
                  className={`flex-1 py-3 rounded-lg font-medium border-2 ${isPlantEquipmentUsed === false ? 'bg-red-500 border-red-500 text-white' : 'border-gray-300 text-gray-700'}`}>
                  No
                </button>
              </div>
            </div>

            {/* Conditional Machinery Controls - only shows if Plant/Equipment is Yes */}
            {isPlantEquipmentUsed === true && (
              <NoteMediaBox label="Controls Required for Machinery / Plants" value={machineryControls.value} notes={machineryControls.notes} media={machineryControls.media}
                onValueChange={(val) => setMachineryControls(prev => ({...prev, value: val}))}
                onAddNote={(note) => setMachineryControls(prev => ({...prev, notes: [...prev.notes, note]}))}
                onAddMedia={(item) => { console.log('Machinery onAddMedia called with:', item?.name); setMachineryControls(prev => ({...prev, media: [...prev.media, item]})); }}
                onRemoveNote={(idx) => setMachineryControls(prev => ({...prev, notes: prev.notes.filter((_, i) => i !== idx)}))}
                onRemoveMedia={(idx) => setMachineryControls(prev => ({...prev, media: prev.media.filter((_, i) => i !== idx)}))} />
            )}

            {/* Site Specific Hazards - text box only */}
            <div className="bg-white rounded-xl p-4 shadow-sm">
              <h4 className="font-semibold text-gray-800 text-orange-600 mb-3">Site Specific Hazards</h4>
              <textarea value={siteHazards.value} onChange={(e) => setSiteHazards(prev => ({...prev, value: e.target.value}))}
                className="w-full border border-gray-300 rounded-lg p-3 text-sm min-h-[80px]"
                placeholder="Enter site specific hazards..." />
            </div>

            {/* Site Specific Permits Required - text box only */}
            <div className="bg-white rounded-xl p-4 shadow-sm">
              <h4 className="font-semibold text-gray-800 text-orange-600 mb-3">Site Specific Permits Required</h4>
              <textarea value={permitsRequired.value} onChange={(e) => setPermitsRequired(prev => ({...prev, value: e.target.value}))}
                className="w-full border border-gray-300 rounded-lg p-3 text-sm min-h-[80px]"
                placeholder="Enter permits required..." />
            </div>

            {/* High Risk Works? */}
            <div className="bg-white rounded-xl p-4 shadow-sm">
              <h4 className="font-semibold text-gray-800 mb-3">‚ö†Ô∏è High Risk Works?</h4>
              <div className="flex gap-3">
                <button onClick={() => setHighRiskWorks('yes')}
                  className={`flex-1 py-3 rounded-lg font-medium border-2 ${highRiskWorks === 'yes' ? 'bg-red-500 border-red-500 text-white' : 'border-gray-300 text-gray-700'}`}>
                  Yes
                </button>
                <button onClick={() => setHighRiskWorks('no')}
                  className={`flex-1 py-3 rounded-lg font-medium border-2 ${highRiskWorks === 'no' ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 text-gray-700'}`}>
                  No
                </button>
                <button onClick={() => setHighRiskWorks('na')}
                  className={`flex-1 py-3 rounded-lg font-medium border-2 ${highRiskWorks === 'na' ? 'bg-gray-500 border-gray-500 text-white' : 'border-gray-300 text-gray-700'}`}>
                  N/A
                </button>
              </div>
            </div>

            {/* Works performed are covered by SWMS? */}
            <div className="bg-white rounded-xl p-4 shadow-sm">
              <h4 className="font-semibold text-gray-800 mb-3">üìã Works performed are covered by SWMS?</h4>
              <div className="flex gap-3">
                <button onClick={() => setWorksCoveredBySWMS('yes')}
                  className={`flex-1 py-3 rounded-lg font-medium border-2 ${worksCoveredBySWMS === 'yes' ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 text-gray-700'}`}>
                  Yes
                </button>
                <button onClick={() => setWorksCoveredBySWMS('no')}
                  className={`flex-1 py-3 rounded-lg font-medium border-2 ${worksCoveredBySWMS === 'no' ? 'bg-red-500 border-red-500 text-white' : 'border-gray-300 text-gray-700'}`}>
                  No
                </button>
                <button onClick={() => setWorksCoveredBySWMS('na')}
                  className={`flex-1 py-3 rounded-lg font-medium border-2 ${worksCoveredBySWMS === 'na' ? 'bg-gray-500 border-gray-500 text-white' : 'border-gray-300 text-gray-700'}`}>
                  N/A
                </button>
              </div>
            </div>

            {/* Safety issues/incidents from previous shift */}
            <div className="bg-white rounded-xl p-4 shadow-sm">
              <h4 className="font-semibold text-gray-800 mb-3">‚ö†Ô∏è Safety Issues/Incidents from Previous Shift or Industry Safety Notices?</h4>
              <div className="flex gap-3">
                <button onClick={() => setHasSafetyIssues(true)}
                  className={`flex-1 py-3 rounded-lg font-medium border-2 ${hasSafetyIssues === true ? 'bg-red-500 border-red-500 text-white' : 'border-gray-300 text-gray-700'}`}>
                  Yes
                </button>
                <button onClick={() => { setHasSafetyIssues(false); setSafetyIssuesPreviousShift({ value: '', notes: [], media: [] }); }}
                  className={`flex-1 py-3 rounded-lg font-medium border-2 ${hasSafetyIssues === false ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 text-gray-700'}`}>
                  No
                </button>
              </div>
            </div>

            {/* Conditional Safety Issues Box - only shows if Yes */}
            {hasSafetyIssues === true && (
              <NoteMediaBox label="Safety Issues/Incidents Details" value={safetyIssuesPreviousShift.value} notes={safetyIssuesPreviousShift.notes} media={safetyIssuesPreviousShift.media}
                onValueChange={(val) => setSafetyIssuesPreviousShift(prev => ({...prev, value: val}))}
                onAddNote={(note) => setSafetyIssuesPreviousShift(prev => ({...prev, notes: [...prev.notes, note]}))}
                onAddMedia={(item) => { console.log('Safety Issues onAddMedia called with:', item?.name); setSafetyIssuesPreviousShift(prev => ({...prev, media: [...prev.media, item]})); }}
                onRemoveNote={(idx) => setSafetyIssuesPreviousShift(prev => ({...prev, notes: prev.notes.filter((_, i) => i !== idx)}))}
                onRemoveMedia={(idx) => setSafetyIssuesPreviousShift(prev => ({...prev, media: prev.media.filter((_, i) => i !== idx)}))} />
            )}

            <div className="bg-white rounded-xl shadow-sm divide-y">
              {items.map((item, idx) => (
                <div key={item.id} className="p-4">
                  <div className="flex items-start justify-between gap-3">
                    <span className="text-gray-700">{idx + 1}. {item.text}</span>
                    <div className="flex gap-2">
                      <button onClick={() => setChecks({...checks, [item.id]: true})}
                        className={`w-10 h-10 rounded-lg flex items-center justify-center border-2 ${checks[item.id] === true ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300'}`}>‚úì</button>
                      <button onClick={() => setChecks({...checks, [item.id]: false})}
                        className={`w-10 h-10 rounded-lg flex items-center justify-center border-2 ${checks[item.id] === false ? 'bg-red-500 border-red-500 text-white' : 'border-gray-300'}`}>‚úï</button>
                    </div>
                  </div>
                </div>
              ))}
            </div>

            <div className="bg-white rounded-xl p-4 shadow-sm">
              <label className="block text-sm font-medium text-gray-700 mb-2">Notes / Issues</label>
              <textarea value={notes} onChange={(e) => setNotes(e.target.value)}
                className="w-full border border-gray-300 rounded-lg p-3" rows={3} placeholder="Record any issues..." />
            </div>

            <button onClick={() => setStep(3)} disabled={!allChecked || !supervisorName || !siteConducted || !builder || !address}
              className="w-full bg-orange-600 text-white py-4 rounded-xl font-semibold disabled:bg-gray-300">
              Next: Worker Sign-On ‚Üí
            </button>
          </div>
        );
      }

      if (step === 3) {
        return (
          <div className="space-y-4">
            {signingWorker && <SignaturePad name={signingWorker} onSave={(data) => { setSignatures({...signatures, [signingWorker]: data}); setSigningWorker(null); }} onCancel={() => setSigningWorker(null)} />}
            {signingTranslator && <SignaturePad name={translatorName || "Translator"} onSave={(data) => { setTranslatorSignature(data); setSigningTranslator(false); }} onCancel={() => setSigningTranslator(false)} />}

            <div className="bg-white rounded-xl p-4 shadow-sm">
              <div className="flex items-center justify-between">
                <h2 className="text-xl font-bold text-gray-800">Worker Sign-On</h2>
                <button onClick={() => setStep(2)} className="text-gray-500">‚Üê Back</button>
              </div>
              <p className="text-gray-500 text-sm mt-1">Tap on a signature box to sign</p>
            </div>

            {/* Translator Required? */}
            <div className="bg-white rounded-xl p-4 shadow-sm">
              <h4 className="font-semibold text-gray-800 mb-3">üåê Translator Required?</h4>
              <div className="flex gap-3 mb-4">
                <button onClick={() => setTranslatorRequired(true)}
                  className={`flex-1 py-3 rounded-lg font-medium border-2 ${translatorRequired === true ? 'bg-blue-500 border-blue-500 text-white' : 'border-gray-300 text-gray-700'}`}>
                  Yes
                </button>
                <button onClick={() => { setTranslatorRequired(false); setTranslatorSignature(null); setTranslatorName(''); }}
                  className={`flex-1 py-3 rounded-lg font-medium border-2 ${translatorRequired === false ? 'bg-gray-500 border-gray-500 text-white' : 'border-gray-300 text-gray-700'}`}>
                  No
                </button>
              </div>

              {/* Translator Signoff - only shows if Translator Required is Yes */}
              {translatorRequired === true && (
                <div className="border-t pt-4 space-y-3">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Translator Name *</label>
                    <input type="text" value={translatorName} onChange={(e) => setTranslatorName(e.target.value)}
                      className="w-full border border-gray-300 rounded-lg p-3" placeholder="Enter translator name" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Translator Signature *</label>
                    {translatorSignature ? (
                      <div className="relative inline-block">
                        <div className="border-2 border-green-500 rounded-lg p-2 bg-green-50 h-20 w-40">
                          <img src={translatorSignature} alt="translator signature" className="h-full w-full object-contain" />
                        </div>
                        <button onClick={() => setTranslatorSignature(null)}
                          className="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full text-sm">‚úï</button>
                      </div>
                    ) : (
                      <button onClick={() => setSigningTranslator(true)}
                        className="h-20 w-40 border-2 border-dashed border-blue-300 rounded-lg text-blue-500 hover:border-blue-500">
                        Tap to sign
                      </button>
                    )}
                  </div>
                </div>
              )}
            </div>

            <div className="bg-white rounded-xl shadow-sm divide-y">
              {teamMembers.map((name) => (
                <div key={name} className="p-4 flex items-center justify-between">
                  <span className="font-medium text-gray-800">{name}</span>
                  {signatures[name] ? (
                    <div className="relative">
                      <div className="border-2 border-green-500 rounded-lg p-2 bg-green-50 h-16 w-32">
                        <img src={signatures[name]} alt="signature" className="h-full w-full object-contain" />
                      </div>
                      <button onClick={() => setSignatures({...signatures, [name]: null})}
                        className="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full text-sm">‚úï</button>
                    </div>
                  ) : (
                    <button onClick={() => setSigningWorker(name)}
                      className="h-16 w-32 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-orange-500">
                      Tap to sign
                    </button>
                  )}
                </div>
              ))}
            </div>

            <div className="bg-blue-50 border border-blue-200 rounded-xl p-4">
              <p className="text-blue-800 font-medium">{signedCount} of {teamMembers.length} workers signed</p>
            </div>

            {/* Validation Errors */}
            {validationErrors.length > 0 && (
              <div className="bg-red-50 border border-red-300 rounded-xl p-4">
                <p className="text-red-800 font-semibold mb-2">‚ö†Ô∏è Cannot submit - please fix these issues:</p>
                <ul className="text-red-700 text-sm space-y-1">
                  {validationErrors.map((err, i) => <li key={i}>‚Ä¢ {err}</li>)}
                </ul>
              </div>
            )}

            <div className="flex gap-3">
              <button onClick={() => { setValidationErrors([]); setStep(2); }} className="flex-1 border border-gray-300 text-gray-700 py-4 rounded-xl font-semibold">‚Üê Back</button>
              <button onClick={handleSubmit} className="flex-1 bg-green-600 text-white py-4 rounded-xl font-semibold">
                {isEditing ? '‚úì Update Pre-Start' : '‚úì Complete Pre-Start'}
              </button>
            </div>
          </div>
        );
      }

      return null;
    }

    // Incident View
    function IncidentView({ onSubmit }) {
      const [step, setStep] = useState(1);
      const [formData, setFormData] = useState({
        type: '', date: new Date().toISOString().split('T')[0], time: new Date().toTimeString().slice(0, 5),
        location: '', description: '', injuries: 'none', injuryDetails: '', witnesses: '', immediateActions: '', reportedBy: '',
      });
      const [reporterSignature, setReporterSignature] = useState(null);
      const [signingReporter, setSigningReporter] = useState(false);
      const [validationError, setValidationError] = useState('');

      const incidentTypes = [
        { id: 'nearmiss', label: 'Near Miss', description: 'Could have caused injury', color: 'bg-yellow-500' },
        { id: 'injury', label: 'Injury', description: 'Resulted in injury', color: 'bg-red-500' },
        { id: 'damage', label: 'Property Damage', description: 'Equipment/property damage', color: 'bg-orange-500' },
        { id: 'environmental', label: 'Environmental', description: 'Spill/leak/environmental', color: 'bg-green-500' },
      ];

      const handleIncidentSubmit = () => {
        if (!reporterSignature) {
          setValidationError('Signature is required to submit an incident report');
          return;
        }
        if (!formData.reportedBy) {
          setValidationError('Reporter name is required');
          return;
        }
        if (!formData.immediateActions) {
          setValidationError('Immediate actions taken must be documented');
          return;
        }
        setValidationError('');
        onSubmit({ ...formData, reporterSignature });
        setStep(4);
      };

      if (step === 4) {
        return (
          <div className="text-center py-12">
            <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl">‚úÖ</div>
            <h2 className="text-2xl font-bold text-gray-800 mb-2">Report Submitted!</h2>
            <p className="text-gray-600 mb-6">Reference: INC-{Date.now().toString().slice(-6)}</p>
            <button onClick={() => setStep(1)} className="bg-orange-600 text-white px-6 py-3 rounded-lg font-semibold">Submit Another</button>
          </div>
        );
      }

      return (
        <div className="space-y-4">
          <div className="bg-white rounded-xl p-4 shadow-sm">
            <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">‚ö†Ô∏è Incident / Near Miss Report</h2>
            <p className="text-gray-500 text-sm mt-1">Report all incidents within 24 hours</p>
          </div>

          {step === 1 && (
            <div className="space-y-3">
              {incidentTypes.map((type) => (
                <button key={type.id} onClick={() => { setFormData({...formData, type: type.id}); setStep(2); }}
                  className="w-full bg-white rounded-xl p-4 shadow-sm flex items-center gap-4">
                  <div className={`w-12 h-12 ${type.color} rounded-full flex items-center justify-center text-white text-xl`}>‚ö†Ô∏è</div>
                  <div className="text-left">
                    <p className="font-semibold text-gray-800">{type.label}</p>
                    <p className="text-sm text-gray-500">{type.description}</p>
                  </div>
                </button>
              ))}
            </div>
          )}

          {step === 2 && (
            <div className="bg-white rounded-xl p-4 shadow-sm space-y-4">
              <h3 className="font-semibold text-gray-800">Incident Details</h3>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Date *</label>
                  <input type="date" value={formData.date} onChange={(e) => setFormData({...formData, date: e.target.value})} className="w-full border rounded-lg p-3" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Time *</label>
                  <input type="time" value={formData.time} onChange={(e) => setFormData({...formData, time: e.target.value})} className="w-full border rounded-lg p-3" />
                </div>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Location *</label>
                <input type="text" value={formData.location} onChange={(e) => setFormData({...formData, location: e.target.value})} className="w-full border rounded-lg p-3" placeholder="Where did this occur?" />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Description *</label>
                <textarea value={formData.description} onChange={(e) => setFormData({...formData, description: e.target.value})} className="w-full border rounded-lg p-3" rows={4} placeholder="Describe what happened..." />
              </div>
              <div className="flex gap-3">
                <button onClick={() => setStep(1)} className="flex-1 border border-gray-300 text-gray-700 py-3 rounded-lg">Back</button>
                <button onClick={() => setStep(3)} disabled={!formData.location || !formData.description} className="flex-1 bg-orange-600 text-white py-3 rounded-lg disabled:bg-gray-300">Next</button>
              </div>
            </div>
          )}

          {step === 3 && (
            <div className="bg-white rounded-xl p-4 shadow-sm space-y-4">
              <h3 className="font-semibold text-gray-800">Additional Information</h3>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Reported By *</label>
                <input type="text" value={formData.reportedBy} onChange={(e) => setFormData({...formData, reportedBy: e.target.value})} className="w-full border rounded-lg p-3" placeholder="Your name" />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Witnesses (if any)</label>
                <input type="text" value={formData.witnesses} onChange={(e) => setFormData({...formData, witnesses: e.target.value})} className="w-full border rounded-lg p-3" placeholder="Names of any witnesses" />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Immediate Actions Taken *</label>
                <textarea value={formData.immediateActions} onChange={(e) => setFormData({...formData, immediateActions: e.target.value})} className="w-full border rounded-lg p-3" rows={3} placeholder="What actions were taken immediately after the incident?" />
              </div>

              {/* Reporter Signature - REQUIRED */}
              <div className="border-t pt-4">
                <label className="block text-sm font-medium text-gray-700 mb-2">Reporter Signature * <span className="text-red-500 text-xs">(Required for submission)</span></label>
                {reporterSignature ? (
                  <div className="relative inline-block">
                    <div className="border-2 border-green-500 rounded-lg p-2 bg-green-50">
                      <img src={reporterSignature} alt="signature" className="h-16 object-contain" />
                    </div>
                    <button onClick={() => setReporterSignature(null)}
                      className="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full text-sm">‚úï</button>
                  </div>
                ) : (
                  <button onClick={() => setSigningReporter(true)}
                    className="w-full h-20 border-2 border-dashed border-red-300 rounded-lg text-red-500 hover:border-red-500 bg-red-50 font-medium">
                    ‚úçÔ∏è Tap to Sign (Required)
                  </button>
                )}
              </div>

              {/* Validation Error */}
              {validationError && (
                <div className="bg-red-50 border border-red-300 rounded-lg p-3">
                  <p className="text-red-700 text-sm">‚ö†Ô∏è {validationError}</p>
                </div>
              )}

              <div className="flex gap-3">
                <button onClick={() => { setValidationError(''); setStep(2); }} className="flex-1 border border-gray-300 text-gray-700 py-3 rounded-lg">Back</button>
                <button onClick={handleIncidentSubmit} className="flex-1 bg-red-600 text-white py-3 rounded-lg">Submit Report</button>
              </div>
            </div>
          )}

          {/* Signature Pad Modal */}
          {signingReporter && (
            <SignaturePad
              name={formData.reportedBy || "Reporter"}
              onSave={(sig) => { setReporterSignature(sig); setSigningReporter(false); }}
              onCancel={() => setSigningReporter(false)}
            />
          )}
        </div>
      );
    }

    // Toolbox View
    function ToolboxView({ onSubmit, sites = [] }) {
      const [step, setStep] = useState(1);
      const [signingWorker, setSigningWorker] = useState(null);
      const [siteConducted, setSiteConducted] = useState('');
      const [builder, setBuilder] = useState('');
      const [address, setAddress] = useState('');
      const [isLocating, setIsLocating] = useState(false);
      const [preparedBy, setPreparedBy] = useState('');
      const [selectedTopics, setSelectedTopics] = useState([]);
      const [otherTopic, setOtherTopic] = useState('');
      const [correctiveAction, setCorrectiveAction] = useState('');
      const [feedbackResponses, setFeedbackResponses] = useState('');
      const [signatures, setSignatures] = useState({ 'Jeff Fu': null, 'Scott Seeho': null, 'Davide Casolini': null, 'Zonggang Jiang': null, 'Leon Yu': null, 'Wang Jia': null, 'Gen Bao': null });
      const [validationErrors, setValidationErrors] = useState([]);

      const todayDate = new Date().toLocaleDateString('en-AU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
      const teamMembers = ['Jeff Fu', 'Scott Seeho', 'Davide Casolini', 'Zonggang Jiang', 'Leon Yu', 'Wang Jia', 'Gen Bao'];
      const preparers = ['Jeff Fu', 'Scott Seeho', 'Davide Casolini'];
      const builders = ['Fdc Fitout and Refurbishment', 'Fdc Construction', 'Hunter Mason', 'Built', 'Landlease'];
      const defaultSites = ['Site 1 - Sydney CBD', 'Site 2 - Parramatta', 'Site 3 - North Sydney', 'Site 4 - Chatswood', 'Site 5 - Liverpool'];
      const sitesList = sites.length > 0 ? sites : defaultSites;

      const topics = [
        'Manual Handling', 'Working at Heights', 'Hot Work Safety', 'PPE Requirements',
        'Emergency Procedures', 'Electrical Safety', 'Housekeeping', 'Slips, Trips & Falls',
        'Fire Safety', 'First Aid', 'Hazard Identification', 'Risk Assessment',
        'Confined Spaces', 'Scaffolding Safety', 'Crane & Lifting Operations', 'Welding Safety',
        'Chemical Handling', 'Noise & Hearing Protection', 'Sun & Heat Safety', 'Mental Health & Wellbeing',
        'Tool Safety', 'Mobile Plant Safety', 'Traffic Management', 'Asbestos Awareness',
        'Lock Out Tag Out (LOTO)', 'Incident Reporting', 'Near Miss Reporting', 'Safe Work Method Statements (SWMS)'
      ];

      const signedCount = Object.values(signatures).filter(s => s !== null).length;

      const toggleTopic = (topic) => {
        if (selectedTopics.includes(topic)) {
          setSelectedTopics(selectedTopics.filter(t => t !== topic));
        } else {
          setSelectedTopics([...selectedTopics, topic]);
        }
      };

      const getLocation = () => {
        setIsLocating(true);
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            async (position) => {
              try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.coords.latitude}&lon=${position.coords.longitude}`);
                const data = await response.json();
                setAddress(data.display_name || `${position.coords.latitude}, ${position.coords.longitude}`);
              } catch (e) {
                setAddress(`${position.coords.latitude}, ${position.coords.longitude}`);
              }
              setIsLocating(false);
            },
            () => { alert('Unable to get location'); setIsLocating(false); },
            { enableHighAccuracy: true, timeout: 10000 }
          );
        }
      };

      const handleSubmit = () => {
        const errors = window.formValidator.validateToolbox({
          siteConducted, preparedBy, topics: selectedTopics, signatures
        });
        if (errors.length > 0) {
          setValidationErrors(errors);
          return;
        }
        setValidationErrors([]);
        onSubmit({
          siteConducted, builder, address, preparedBy,
          topics: selectedTopics, otherTopic, correctiveAction, feedbackResponses,
          signatures, date: new Date().toISOString()
        });
        setStep(3);
      };

      const resetForm = () => {
        setStep(1);
        setSiteConducted(''); setBuilder(''); setAddress(''); setPreparedBy('');
        setSelectedTopics([]); setOtherTopic(''); setCorrectiveAction(''); setFeedbackResponses('');
        setSignatures({ 'Jeff Fu': null, 'Scott Seeho': null, 'Davide Casolini': null, 'Zonggang Jiang': null, 'Leon Yu': null, 'Wang Jia': null, 'Gen Bao': null });
      };

      if (step === 3) {
        return (
          <div className="text-center py-12">
            <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl">‚úÖ</div>
            <h2 className="text-2xl font-bold text-gray-800 mb-2">Toolbox Talk Recorded!</h2>
            <p className="text-gray-600 mb-6">{signedCount} attendees signed on</p>
            <button onClick={resetForm} className="bg-orange-600 text-white px-6 py-3 rounded-lg font-semibold">Record Another</button>
          </div>
        );
      }

      return (
        <div className="space-y-4">
          {signingWorker && <SignaturePad name={signingWorker} onSave={(data) => { setSignatures({...signatures, [signingWorker]: data}); setSigningWorker(null); }} onCancel={() => setSigningWorker(null)} />}

          {/* Date Banner */}
          <div className="bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl p-4 text-white">
            <div className="flex items-center gap-2">
              <span>üìÖ</span>
              <span className="font-bold text-lg">{todayDate}</span>
            </div>
          </div>

          <div className="bg-white rounded-xl p-4 shadow-sm">
            <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">üë• Toolbox Talk</h2>
            <p className="text-gray-500 text-sm mt-1">Daily safety briefing record</p>
          </div>

          {step === 1 && (
            <div className="space-y-4">
              {/* Site Details */}
              <div className="bg-white rounded-xl p-4 shadow-sm space-y-4">
                <h3 className="font-semibold text-gray-800">Site Details</h3>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Site Conducted *</label>
                  <select value={siteConducted} onChange={(e) => setSiteConducted(e.target.value)} className="w-full border border-gray-300 rounded-lg p-3 bg-white">
                    <option value="">Select Site</option>
                    {sitesList.map((site) => <option key={site} value={site}>{site}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Builder *</label>
                  <select value={builder} onChange={(e) => setBuilder(e.target.value)} className="w-full border border-gray-300 rounded-lg p-3 bg-white">
                    <option value="">Select Builder</option>
                    {builders.map((b) => <option key={b} value={b}>{b}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">üìç Site Address *</label>
                  <div className="flex gap-2">
                    <input type="text" value={address} onChange={(e) => setAddress(e.target.value)}
                      className="flex-1 border border-gray-300 rounded-lg p-3" placeholder="Enter site address" />
                    <button onClick={getLocation} disabled={isLocating}
                      className="bg-blue-600 text-white px-4 rounded-lg disabled:bg-blue-400">
                      {isLocating ? '...' : 'üìç'}
                    </button>
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Prepared By *</label>
                  <select value={preparedBy} onChange={(e) => setPreparedBy(e.target.value)} className="w-full border border-gray-300 rounded-lg p-3 bg-white">
                    <option value="">Select Preparer</option>
                    {preparers.map((p) => <option key={p} value={p}>{p}</option>)}
                  </select>
                </div>
              </div>

              {/* Topics Discussed */}
              <div className="bg-white rounded-xl p-4 shadow-sm">
                <h3 className="font-semibold text-gray-800 mb-3">üìã Topics Discussed</h3>
                <p className="text-sm text-gray-500 mb-3">Select all topics covered in this toolbox talk</p>
                <div className="grid grid-cols-2 gap-2">
                  {topics.map((topic) => (
                    <button key={topic} onClick={() => toggleTopic(topic)}
                      className={`p-2 rounded-lg text-sm text-left border-2 ${selectedTopics.includes(topic) ? 'bg-purple-100 border-purple-500 text-purple-700' : 'border-gray-200 text-gray-700'}`}>
                      {selectedTopics.includes(topic) ? '‚úì ' : ''}{topic}
                    </button>
                  ))}
                </div>
                <div className="mt-4">
                  <label className="block text-sm font-medium text-gray-700 mb-2">Other Topics</label>
                  <textarea value={otherTopic} onChange={(e) => setOtherTopic(e.target.value)}
                    className="w-full border border-gray-300 rounded-lg p-3 text-sm" rows={2}
                    placeholder="Enter any other topics discussed..." />
                </div>
              </div>

              {/* Corrective Action Required */}
              <div className="bg-white rounded-xl p-4 shadow-sm">
                <h4 className="font-semibold text-gray-800 text-orange-600 mb-3">Corrective Action Required</h4>
                <textarea value={correctiveAction} onChange={(e) => setCorrectiveAction(e.target.value)}
                  className="w-full border border-gray-300 rounded-lg p-3 text-sm min-h-[80px]"
                  placeholder="Enter any corrective actions required..." />
              </div>

              {/* Feedback and Responses */}
              <div className="bg-white rounded-xl p-4 shadow-sm">
                <h4 className="font-semibold text-gray-800 text-orange-600 mb-3">Feedback and Responses</h4>
                <textarea value={feedbackResponses} onChange={(e) => setFeedbackResponses(e.target.value)}
                  className="w-full border border-gray-300 rounded-lg p-3 text-sm min-h-[80px]"
                  placeholder="Enter feedback and responses from attendees..." />
              </div>

              <button onClick={() => setStep(2)}
                disabled={!siteConducted || !builder || !address || !preparedBy || selectedTopics.length === 0}
                className="w-full bg-orange-600 text-white py-4 rounded-xl font-semibold disabled:bg-gray-300">
                Next: Attendance & Signatures ‚Üí
              </button>
            </div>
          )}

          {step === 2 && (
            <div className="space-y-4">
              <div className="bg-white rounded-xl p-4 shadow-sm">
                <div className="flex items-center justify-between">
                  <h2 className="text-xl font-bold text-gray-800">Attendance & Signatures</h2>
                  <button onClick={() => setStep(1)} className="text-gray-500">‚Üê Back</button>
                </div>
                <p className="text-gray-500 text-sm mt-1">Tap on a signature box to sign</p>
              </div>

              <div className="bg-purple-50 border border-purple-200 rounded-xl p-3">
                <p className="text-sm text-purple-800"><strong>Topics:</strong> {selectedTopics.join(', ')}</p>
                {otherTopic && <p className="text-sm text-purple-800 mt-1"><strong>Other:</strong> {otherTopic}</p>}
              </div>

              <div className="bg-white rounded-xl shadow-sm divide-y">
                {teamMembers.map((name) => (
                  <div key={name} className="p-4 flex items-center justify-between">
                    <span className="font-medium text-gray-800">{name}</span>
                    {signatures[name] ? (
                      <div className="relative">
                        <div className="border-2 border-green-500 rounded-lg p-2 bg-green-50 h-16 w-32">
                          <img src={signatures[name]} alt="signature" className="h-full w-full object-contain" />
                        </div>
                        <button onClick={() => setSignatures({...signatures, [name]: null})}
                          className="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full text-sm">‚úï</button>
                      </div>
                    ) : (
                      <button onClick={() => setSigningWorker(name)}
                        className="h-16 w-32 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-purple-500">
                        Tap to sign
                      </button>
                    )}
                  </div>
                ))}
              </div>

              <div className="bg-blue-50 border border-blue-200 rounded-xl p-4">
                <p className="text-blue-800 font-medium">{signedCount} of {teamMembers.length} attendees signed</p>
              </div>

              {validationErrors.length > 0 && (
                <div className="bg-red-50 border border-red-200 rounded-xl p-4">
                  <p className="text-red-800 font-semibold mb-2">Please fix the following:</p>
                  {validationErrors.map((e, i) => <p key={i} className="text-red-700 text-sm">‚Ä¢ {e}</p>)}
                </div>
              )}

              <div className="flex gap-3">
                <button onClick={() => setStep(1)} className="flex-1 border border-gray-300 text-gray-700 py-4 rounded-xl font-semibold">‚Üê Back</button>
                <button onClick={handleSubmit} disabled={signedCount === 0} className="flex-1 bg-green-600 text-white py-4 rounded-xl font-semibold disabled:bg-gray-300">
                  ‚úì Complete Toolbox Talk
                </button>
              </div>
            </div>
          )}
        </div>
      );
    }

    // Subcontractor Site Inspection View
    function SubcontractorInspectionView({ onSubmit, sites = [] }) {
      const [step, setStep] = useState(1);
      const [submitted, setSubmitted] = useState(false);
      const [siteConducted, setSiteConducted] = useState('');
      const [preparedBy, setPreparedBy] = useState('');
      const [location, setLocation] = useState('');
      const [isLocating, setIsLocating] = useState(false);
      const [completedBy, setCompletedBy] = useState('');
      const [completedBySignature, setCompletedBySignature] = useState(null);
      const [signingInspector, setSigningInspector] = useState(false);
      const [validationErrors, setValidationErrors] = useState([]);

      // Inspection items with Yes/No/N/A
      const [inspectionItems, setInspectionItems] = useState({
        siteBoxes: null,
        electricalLeads: null,
        toolsRetagging: null,
        exclusionZones: null,
        permitsCompleted: null,
        permitsActive: null,
        penetrationsCovered: null,
        equipmentInspection: null,
        workerSafetyConcerns: null,
        builderRequests: null,
      });

      const todayDate = new Date().toLocaleDateString('en-AU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
      const preparers = ['Jeff Fu', 'Scott Seeho', 'Davide Casolini'];
      const inspectors = ['Scott Seeho', 'Davide Casolini'];
      const defaultSites = ['Site 1 - Sydney CBD', 'Site 2 - Parramatta', 'Site 3 - North Sydney', 'Site 4 - Chatswood', 'Site 5 - Liverpool'];
      const sitesList = sites.length > 0 ? sites : defaultSites;

      const inspectionQuestions = [
        { id: 'siteBoxes', text: 'Site boxes in good condition and lockable' },
        { id: 'electricalLeads', text: 'Electrical leads and tools are tagged and tested up to date' },
        { id: 'toolsRetagging', text: 'Tools or Equipment needed retagging or testing soon' },
        { id: 'exclusionZones', text: 'Exclusion zones set up around work areas (as required)' },
        { id: 'permitsCompleted', text: 'Permits are completed (as required)' },
        { id: 'permitsActive', text: 'Permits Active during inspection' },
        { id: 'penetrationsCovered', text: 'Penetrations are covered or have barriers around them' },
        { id: 'equipmentInspection', text: 'Equipment onsite has recent inspection completed' },
        { id: 'workerSafetyConcerns', text: 'Any worker reports of safety concerns or improvements' },
        { id: 'builderRequests', text: 'Any request from Builder' },
      ];

      const getLocation = () => {
        setIsLocating(true);
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            async (position) => {
              try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.coords.latitude}&lon=${position.coords.longitude}`);
                const data = await response.json();
                setLocation(data.display_name || `${position.coords.latitude}, ${position.coords.longitude}`);
              } catch (e) {
                setLocation(`${position.coords.latitude}, ${position.coords.longitude}`);
              }
              setIsLocating(false);
            },
            () => { alert('Unable to get location'); setIsLocating(false); },
            { enableHighAccuracy: true, timeout: 10000 }
          );
        }
      };

      const setInspectionValue = (id, value) => {
        setInspectionItems({ ...inspectionItems, [id]: value });
      };

      const allAnswered = Object.values(inspectionItems).every(v => v !== null);

      const handleSubmit = () => {
        const errors = window.formValidator.validateInspection({
          siteConducted, preparedBy, completedBy, inspectionItems
        });
        if (errors.length > 0) {
          setValidationErrors(errors);
          return;
        }
        setValidationErrors([]);
        onSubmit({
          siteConducted, preparedBy, location, completedBy, completedBySignature, inspectionItems,
          date: new Date().toISOString()
        });
        setSubmitted(true);
      };

      const resetForm = () => {
        setSiteConducted(''); setPreparedBy(''); setLocation(''); setCompletedBy('');
        setCompletedBySignature(null); setSigningInspector(false);
        setInspectionItems({
          siteBoxes: null, electricalLeads: null, toolsRetagging: null, exclusionZones: null,
          permitsCompleted: null, permitsActive: null, penetrationsCovered: null,
          equipmentInspection: null, workerSafetyConcerns: null, builderRequests: null,
        });
        setSubmitted(false);
      };

      if (submitted) {
        return (
          <div className="text-center py-12">
            <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl">‚úÖ</div>
            <h2 className="text-2xl font-bold text-gray-800 mb-2">Inspection Complete!</h2>
            <p className="text-gray-600 mb-6">Site inspection has been recorded.</p>
            <button onClick={resetForm} className="bg-orange-600 text-white px-6 py-3 rounded-lg font-semibold">Start Another Inspection</button>
          </div>
        );
      }

      return (
        <div className="space-y-4">
          {signingInspector && <SignaturePad name={completedBy || "Inspector"} onSave={(data) => { setCompletedBySignature(data); setSigningInspector(false); }} onCancel={() => setSigningInspector(false)} />}

          {/* Date Banner */}
          <div className="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-4 text-white">
            <div className="flex items-center gap-2">
              <span>üìÖ</span>
              <span className="font-bold text-lg">{todayDate}</span>
            </div>
          </div>

          <div className="bg-white rounded-xl p-4 shadow-sm">
            <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">üîç Subcontractor Site Inspection</h2>
            <p className="text-gray-500 text-sm mt-1">Complete site safety inspection</p>
          </div>

          {/* Site Details */}
          <div className="bg-white rounded-xl p-4 shadow-sm space-y-4">
            <h3 className="font-semibold text-gray-800">Site Details</h3>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Site Conducted *</label>
              <select value={siteConducted} onChange={(e) => setSiteConducted(e.target.value)} className="w-full border border-gray-300 rounded-lg p-3 bg-white">
                <option value="">Select Site</option>
                {sitesList.map((site) => <option key={site} value={site}>{site}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Prepared By *</label>
              <select value={preparedBy} onChange={(e) => setPreparedBy(e.target.value)} className="w-full border border-gray-300 rounded-lg p-3 bg-white">
                <option value="">Select Preparer</option>
                {preparers.map((p) => <option key={p} value={p}>{p}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">üìç Location *</label>
              <div className="flex gap-2">
                <input type="text" value={location} onChange={(e) => setLocation(e.target.value)}
                  className="flex-1 border border-gray-300 rounded-lg p-3" placeholder="Enter location" />
                <button onClick={getLocation} disabled={isLocating}
                  className="bg-blue-600 text-white px-4 rounded-lg disabled:bg-blue-400">
                  {isLocating ? '...' : 'üìç'}
                </button>
              </div>
            </div>
          </div>

          {/* Inspection Questions */}
          <div className="bg-white rounded-xl p-4 shadow-sm">
            <h3 className="font-semibold text-gray-800 mb-4">üìã Inspection Checklist</h3>
            <div className="space-y-4">
              {inspectionQuestions.map((item, idx) => (
                <div key={item.id} className="border-b border-gray-100 pb-4 last:border-0 last:pb-0">
                  <p className="text-gray-700 mb-2 text-sm">{idx + 1}. {item.text}</p>
                  <div className="flex gap-2">
                    <button onClick={() => setInspectionValue(item.id, 'yes')}
                      className={`flex-1 py-2 rounded-lg font-medium text-sm border-2 ${inspectionItems[item.id] === 'yes' ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 text-gray-700'}`}>
                      Yes
                    </button>
                    <button onClick={() => setInspectionValue(item.id, 'no')}
                      className={`flex-1 py-2 rounded-lg font-medium text-sm border-2 ${inspectionItems[item.id] === 'no' ? 'bg-red-500 border-red-500 text-white' : 'border-gray-300 text-gray-700'}`}>
                      No
                    </button>
                    <button onClick={() => setInspectionValue(item.id, 'na')}
                      className={`flex-1 py-2 rounded-lg font-medium text-sm border-2 ${inspectionItems[item.id] === 'na' ? 'bg-gray-500 border-gray-500 text-white' : 'border-gray-300 text-gray-700'}`}>
                      N/A
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Inspection Completed By */}
          <div className="bg-white rounded-xl p-4 shadow-sm space-y-4">
            <h3 className="font-semibold text-gray-800">‚úÖ Inspection Completed By *</h3>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Name *</label>
              <select value={completedBy} onChange={(e) => { setCompletedBy(e.target.value); setCompletedBySignature(null); }} className="w-full border border-gray-300 rounded-lg p-3 bg-white">
                <option value="">Select Inspector</option>
                {inspectors.map((i) => <option key={i} value={i}>{i}</option>)}
              </select>
            </div>
            {completedBy && (
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Signature *</label>
                {completedBySignature ? (
                  <div className="relative inline-block">
                    <div className="border-2 border-green-500 rounded-lg p-2 bg-green-50 h-20 w-40">
                      <img src={completedBySignature} alt="inspector signature" className="h-full w-full object-contain" />
                    </div>
                    <button onClick={() => setCompletedBySignature(null)}
                      className="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full text-sm">‚úï</button>
                  </div>
                ) : (
                  <button onClick={() => setSigningInspector(true)}
                    className="h-20 w-40 border-2 border-dashed border-blue-300 rounded-lg text-blue-500 hover:border-blue-500">
                    Tap to sign
                  </button>
                )}
              </div>
            )}
          </div>

          {validationErrors.length > 0 && (
            <div className="bg-red-50 border border-red-200 rounded-xl p-4">
              <p className="text-red-800 font-semibold mb-2">Please fix the following:</p>
              {validationErrors.map((e, i) => <p key={i} className="text-red-700 text-sm">‚Ä¢ {e}</p>)}
            </div>
          )}

          <button onClick={handleSubmit}
            disabled={!siteConducted || !preparedBy || !location || !allAnswered || !completedBy || !completedBySignature}
            className="w-full bg-green-600 text-white py-4 rounded-xl font-semibold disabled:bg-gray-300">
            ‚úì Complete Inspection
          </button>
        </div>
      );
    }

    // ITP Form View
    function ITPFormView({ onSubmit, sites = [] }) {
      const [page, setPage] = useState(1);
      const [submitted, setSubmitted] = useState(false);
      const [signingPerson, setSigningPerson] = useState(null);
      const [validationErrors, setValidationErrors] = useState([]);

      // Page 1 - Title Page
      const [siteConducted, setSiteConducted] = useState('');
      const [conductedOn, setConductedOn] = useState(new Date().toISOString().slice(0, 16));
      const [preparedBy, setPreparedBy] = useState('');
      const [location, setLocation] = useState('');
      const [isLocating, setIsLocating] = useState(false);

      // Page 2 - Inspection Items
      const [preConstructionMeeting, setPreConstructionMeeting] = useState('');
      const [highRiskWorkshop, setHighRiskWorkshop] = useState(null);
      const [shopdrawingsApproved, setShopdrawingsApproved] = useState(null);
      const [allItemsSignedOff, setAllItemsSignedOff] = useState(null);

      // Procurement section
      const [shopdrawingRevision, setShopdrawingRevision] = useState('');
      const [orderedGlassFrom, setOrderedGlassFrom] = useState('');
      const [glassSpecification, setGlassSpecification] = useState('');

      // Installation of Glass section
      const [glassFreeFromDamage, setGlassFreeFromDamage] = useState(null);
      const [specificationOfFixings, setSpecificationOfFixings] = useState('');
      const [setoutCompletedBy, setSetoutCompletedBy] = useState('');
      const [installationMethod, setInstallationMethod] = useState('');
      const [glassInstalledCorrectRL, setGlassInstalledCorrectRL] = useState(null);
      const [glassLockedWedgedGlued, setGlassLockedWedgedGlued] = useState(null);
      const [removeWedgesCaulk, setRemoveWedgesCaulk] = useState('');

      // Installation of Handrails section
      const [handrailSpecConfirmed, setHandrailSpecConfirmed] = useState(null);
      const [spigotsCouplingsTight, setSpigotsCouplingsTight] = useState(null);
      const [handrailCompliantHeight, setHandrailCompliantHeight] = useState(null);
      const [threadOnFixings, setThreadOnFixings] = useState(null);
      const [fullWeldingJunctions, setFullWeldingJunctions] = useState(null);

      // Handover section
      const [allGlassNoDefects, setAllGlassNoDefects] = useState(null);
      const [allHandrailNoDefects, setAllHandrailNoDefects] = useState(null);
      const [balustradeAsPerDesign, setBalustradeAsPerDesign] = useState(null);

      // Page 3 - Sign off
      const [builderSignoffName, setBuilderSignoffName] = useState('');
      const [builderSignature, setBuilderSignature] = useState(null);
      const [futureCorrespondence, setFutureCorrespondence] = useState('');

      const todayDate = new Date().toLocaleDateString('en-AU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
      const preparers = ['Jeff Fu', 'Scott Seeho', 'Davide Casolini'];
      const defaultSites = ['Site 1 - Sydney CBD', 'Site 2 - Parramatta', 'Site 3 - North Sydney'];
      const sitesList = sites.length > 0 ? sites : defaultSites;

      const getLocation = () => {
        setIsLocating(true);
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            async (position) => {
              try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.coords.latitude}&lon=${position.coords.longitude}`);
                const data = await response.json();
                setLocation(data.display_name || `${position.coords.latitude}, ${position.coords.longitude}`);
              } catch (e) {
                setLocation(`${position.coords.latitude}, ${position.coords.longitude}`);
              }
              setIsLocating(false);
            },
            () => { alert('Unable to get location'); setIsLocating(false); },
            { enableHighAccuracy: true, timeout: 10000 }
          );
        }
      };

      // Yes/No/NA Button Component
      const YesNoNAButtons = ({ value, onChange, label }) => (
        <div className="bg-white rounded-xl p-4 shadow-sm">
          <p className="text-gray-700 mb-3 font-medium">{label}</p>
          <div className="flex gap-2">
            <button onClick={() => onChange('yes')}
              className={`flex-1 py-2 rounded-lg font-medium text-sm border-2 ${value === 'yes' ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 text-gray-700'}`}>
              Yes
            </button>
            <button onClick={() => onChange('no')}
              className={`flex-1 py-2 rounded-lg font-medium text-sm border-2 ${value === 'no' ? 'bg-red-500 border-red-500 text-white' : 'border-gray-300 text-gray-700'}`}>
              No
            </button>
            <button onClick={() => onChange('na')}
              className={`flex-1 py-2 rounded-lg font-medium text-sm border-2 ${value === 'na' ? 'bg-gray-500 border-gray-500 text-white' : 'border-gray-300 text-gray-700'}`}>
              N/A
            </button>
          </div>
        </div>
      );

      // Text Input Box Component
      const TextInputBox = ({ value, onChange, label, placeholder }) => (
        <div className="bg-white rounded-xl p-4 shadow-sm">
          <p className="text-gray-700 mb-2 font-medium">{label}</p>
          <input type="text" value={value} onChange={(e) => onChange(e.target.value)}
            className="w-full border border-gray-300 rounded-lg p-3 text-sm" placeholder={placeholder || "Tap to edit"} />
        </div>
      );

      // Section Header Component
      const SectionHeader = ({ title, progress }) => (
        <div className="bg-indigo-400 rounded-xl p-3 flex justify-between items-center">
          <div className="flex items-center gap-2">
            <span className="text-white">‚ñº</span>
            <span className="text-white font-medium">{title}</span>
          </div>
          {progress && <span className="text-white text-sm">{progress}</span>}
        </div>
      );

      const handleSubmit = () => {
        const errors = window.formValidator.validateITP({
          siteConducted, preparedBy, builderSignoffName, builderSignature
        });
        if (errors.length > 0) {
          setValidationErrors(errors);
          return;
        }
        setValidationErrors([]);
        onSubmit({
          siteConducted, conductedOn, preparedBy, location,
          preConstructionMeeting, highRiskWorkshop, shopdrawingsApproved, allItemsSignedOff,
          shopdrawingRevision, orderedGlassFrom, glassSpecification,
          glassFreeFromDamage, specificationOfFixings, setoutCompletedBy, installationMethod,
          glassInstalledCorrectRL, glassLockedWedgedGlued, removeWedgesCaulk,
          handrailSpecConfirmed, spigotsCouplingsTight, handrailCompliantHeight, threadOnFixings, fullWeldingJunctions,
          allGlassNoDefects, allHandrailNoDefects, balustradeAsPerDesign,
          builderSignoffName, builderSignature, futureCorrespondence,
          date: new Date().toISOString()
        });
        setSubmitted(true);
      };

      const resetForm = () => {
        setPage(1); setSubmitted(false);
        setSiteConducted(''); setConductedOn(new Date().toISOString().slice(0, 16)); setPreparedBy(''); setLocation('');
        setPreConstructionMeeting(''); setHighRiskWorkshop(null); setShopdrawingsApproved(null); setAllItemsSignedOff(null);
        setShopdrawingRevision(''); setOrderedGlassFrom(''); setGlassSpecification('');
        setGlassFreeFromDamage(null); setSpecificationOfFixings(''); setSetoutCompletedBy(''); setInstallationMethod('');
        setGlassInstalledCorrectRL(null); setGlassLockedWedgedGlued(null); setRemoveWedgesCaulk('');
        setHandrailSpecConfirmed(null); setSpigotsCouplingsTight(null); setHandrailCompliantHeight(null);
        setThreadOnFixings(null); setFullWeldingJunctions(null);
        setAllGlassNoDefects(null); setAllHandrailNoDefects(null); setBalustradeAsPerDesign(null);
        setBuilderSignoffName(''); setBuilderSignature(null); setFutureCorrespondence('');
      };

      if (submitted) {
        return (
          <div className="text-center py-12">
            <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl">‚úÖ</div>
            <h2 className="text-2xl font-bold text-gray-800 mb-2">ITP Form Complete!</h2>
            <p className="text-gray-600 mb-6">Inspection Test Plan has been recorded.</p>
            <button onClick={resetForm} className="bg-orange-600 text-white px-6 py-3 rounded-lg font-semibold">Start New ITP</button>
          </div>
        );
      }

      return (
        <div className="space-y-4">
          {signingPerson && <SignaturePad name={signingPerson} onSave={(data) => { setBuilderSignature(data); setSigningPerson(null); }} onCancel={() => setSigningPerson(null)} />}

          {/* Header */}
          <div className="bg-white rounded-xl p-4 shadow-sm">
            <div className="flex justify-between items-center">
              <div>
                <h2 className="text-xl font-bold text-gray-800">üìù ITP Form</h2>
                <p className="text-gray-500 text-sm">Page {page}/3</p>
              </div>
            </div>
          </div>

          {/* Page 1 - Title Page */}
          {page === 1 && (
            <div className="space-y-4">
              <div className="bg-gradient-to-r from-indigo-500 to-indigo-600 rounded-xl p-4 text-white">
                <p className="font-bold text-lg">Title Page</p>
                <p className="text-indigo-200 text-sm">Page 1/3</p>
              </div>

              <div className="bg-white rounded-xl p-4 shadow-sm space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">* Site Conducted</label>
                  <select value={siteConducted} onChange={(e) => setSiteConducted(e.target.value)} className="w-full border border-gray-300 rounded-lg p-3 bg-indigo-100 text-indigo-800 font-medium">
                    <option value="">Select Site</option>
                    {sitesList.map((site) => <option key={site} value={site}>{site}</option>)}
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Conducted on</label>
                  <input type="datetime-local" value={conductedOn} onChange={(e) => setConductedOn(e.target.value)}
                    className="w-full border border-gray-300 rounded-lg p-3 bg-gray-100" />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Prepared by</label>
                  <select value={preparedBy} onChange={(e) => setPreparedBy(e.target.value)} className="w-full border border-gray-300 rounded-lg p-3 bg-white">
                    <option value="">Select Preparer</option>
                    {preparers.map((p) => <option key={p} value={p}>{p}</option>)}
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Location</label>
                  <div className="flex gap-2">
                    <input type="text" value={location} onChange={(e) => setLocation(e.target.value)}
                      className="flex-1 border border-gray-300 rounded-lg p-3" placeholder="Enter location" />
                    <button onClick={getLocation} disabled={isLocating}
                      className="bg-indigo-500 text-white px-4 rounded-lg disabled:bg-indigo-300">
                      {isLocating ? '...' : 'üìç'}
                    </button>
                  </div>
                </div>
              </div>

              <div className="flex justify-end">
                <button onClick={() => setPage(2)} disabled={!siteConducted || !preparedBy}
                  className="bg-indigo-500 text-white px-6 py-3 rounded-lg font-medium disabled:bg-gray-300">
                  Next ‚Üí Page 2/3
                </button>
              </div>
            </div>
          )}

          {/* Page 2 - ITP Form */}
          {page === 2 && (
            <div className="space-y-4">
              <div className="bg-gradient-to-r from-indigo-500 to-indigo-600 rounded-xl p-4 text-white">
                <p className="font-bold text-lg">ITP Form</p>
                <p className="text-indigo-200 text-sm">Page 2/3</p>
              </div>

              <TextInputBox label="* Pre-Construction Meeting completed with Builder : NAME" value={preConstructionMeeting} onChange={setPreConstructionMeeting} placeholder="Tap to edit" />

              <YesNoNAButtons label="High Risk Workshop Completed: (If Applicable)" value={highRiskWorkshop} onChange={setHighRiskWorkshop} />

              <YesNoNAButtons label="Shopdrawings Submitted to Builder and approved by Engineer" value={shopdrawingsApproved} onChange={setShopdrawingsApproved} />

              <YesNoNAButtons label="All Items Above completed and Signed off" value={allItemsSignedOff} onChange={setAllItemsSignedOff} />

              {/* Procurement Section */}
              <SectionHeader title="Procurement" />

              <TextInputBox label="Shopdrawing Revision for Glass Order" value={shopdrawingRevision} onChange={setShopdrawingRevision} />
              <TextInputBox label="Ordered Glass from (Company Name)" value={orderedGlassFrom} onChange={setOrderedGlassFrom} />
              <TextInputBox label="Glass Specification" value={glassSpecification} onChange={setGlassSpecification} />

              {/* Installation of Glass Section */}
              <SectionHeader title="Installation of Glass" progress="0/1 (0%)" />

              <YesNoNAButtons label="Glass free from damages and defects on edges" value={glassFreeFromDamage} onChange={setGlassFreeFromDamage} />
              <TextInputBox label="Specification of Fixings - Grout / Hilti HY270" value={specificationOfFixings} onChange={setSpecificationOfFixings} />
              <TextInputBox label="Setout completed by - Surveyor or J&M Artsteel - Name/Company" value={setoutCompletedBy} onChange={setSetoutCompletedBy} />
              <TextInputBox label="Installation method - Plant Required" value={installationMethod} onChange={setInstallationMethod} />
              <YesNoNAButtons label="Glass Installed with correct RL from builder and 1m from FFL Minimum" value={glassInstalledCorrectRL} onChange={setGlassInstalledCorrectRL} />
              <YesNoNAButtons label="All Glass Locked off, wedged and Glued for 24 hours minimum" value={glassLockedWedgedGlued} onChange={setGlassLockedWedgedGlued} />
              <TextInputBox label="Remove Wedges and Caulk gap if required" value={removeWedgesCaulk} onChange={setRemoveWedgesCaulk} />

              {/* Installation of Handrails Section */}
              <SectionHeader title="Installation of Handrails" progress="0/2 (0%)" />

              <YesNoNAButtons label="Handrail Specification Confirmed and Shopdrawing Approved" value={handrailSpecConfirmed} onChange={setHandrailSpecConfirmed} />
              <YesNoNAButtons label="Install all spigots and threaded couplings hand tight for alignment" value={spigotsCouplingsTight} onChange={setSpigotsCouplingsTight} />
              <YesNoNAButtons label="Installation of handrail to compliant height as per shopdrawing and Architectural details" value={handrailCompliantHeight} onChange={setHandrailCompliantHeight} />
              <YesNoNAButtons label="Thread on all fixings / brackets, tack all tube together" value={threadOnFixings} onChange={setThreadOnFixings} />
              <YesNoNAButtons label="Full welding of all junctions of spigots, handrail joints and all coupling pieces tensioned" value={fullWeldingJunctions} onChange={setFullWeldingJunctions} />

              {/* Handover and Finalisation Section */}
              <SectionHeader title="Handover and Finalisation of install" progress="0/1 (0%)" />

              <YesNoNAButtons label="All glass installed to satisfactory finish with no defects or damages" value={allGlassNoDefects} onChange={setAllGlassNoDefects} />
              <YesNoNAButtons label="All Handrail installed to satisfactory finish with no defects or damages - All joints welded and polished" value={allHandrailNoDefects} onChange={setAllHandrailNoDefects} />
              <YesNoNAButtons label="Balustrade system is installed as per design intent with correct RL heights" value={balustradeAsPerDesign} onChange={setBalustradeAsPerDesign} />

              <div className="flex justify-between">
                <button onClick={() => setPage(1)} className="border border-gray-300 text-gray-700 px-6 py-3 rounded-lg font-medium">
                  ‚Üê Back Page 1/3
                </button>
                <button onClick={() => setPage(3)} className="bg-indigo-500 text-white px-6 py-3 rounded-lg font-medium">
                  Next ‚Üí Page 3/3
                </button>
              </div>
            </div>
          )}

          {/* Page 3 - Sign off Page */}
          {page === 3 && (
            <div className="space-y-4">
              <div className="bg-gradient-to-r from-indigo-500 to-indigo-600 rounded-xl p-4 text-white">
                <p className="font-bold text-lg">Sign off Page</p>
                <p className="text-indigo-200 text-sm">Page 3/3</p>
              </div>

              {/* Builder Signoff */}
              <div className="bg-white rounded-xl p-4 shadow-sm space-y-4">
                <p className="text-gray-700 font-medium">Builder Signoff - Name / Signature</p>
                <input type="text" value={builderSignoffName} onChange={(e) => setBuilderSignoffName(e.target.value)}
                  className="w-full border border-gray-300 rounded-lg p-3" placeholder="Full name" />
                {builderSignoffName && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Signature</label>
                    {builderSignature ? (
                      <div className="relative inline-block">
                        <div className="border-2 border-green-500 rounded-lg p-2 bg-green-50 h-20 w-40">
                          <img src={builderSignature} alt="builder signature" className="h-full w-full object-contain" />
                        </div>
                        <button onClick={() => setBuilderSignature(null)}
                          className="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full text-sm">‚úï</button>
                      </div>
                    ) : (
                      <button onClick={() => setSigningPerson(builderSignoffName)}
                        className="h-20 w-40 border-2 border-dashed border-indigo-300 rounded-lg text-indigo-500 hover:border-indigo-500 flex items-center justify-center">
                        ‚úçÔ∏è Tap to sign
                      </button>
                    )}
                  </div>
                )}
              </div>

              {/* Comments and Notes Section */}
              <SectionHeader title="Comments and Notes" />

              <div className="bg-white rounded-xl p-4 shadow-sm">
                <p className="text-gray-700 mb-2 font-medium">Items for Future correspondence or arisen issues during constructions</p>
                <textarea value={futureCorrespondence} onChange={(e) => setFutureCorrespondence(e.target.value)}
                  className="w-full border border-gray-300 rounded-lg p-3 text-sm min-h-[100px]" placeholder="Tap to edit" />
              </div>

              {validationErrors.length > 0 && (
                <div className="bg-red-50 border border-red-200 rounded-xl p-4">
                  <p className="text-red-800 font-semibold mb-2">Please fix the following:</p>
                  {validationErrors.map((e, i) => <p key={i} className="text-red-700 text-sm">‚Ä¢ {e}</p>)}
                </div>
              )}

              <div className="flex justify-between">
                <button onClick={() => setPage(2)} className="border border-gray-300 text-gray-700 px-6 py-3 rounded-lg font-medium">
                  ‚Üê Back Page 2/3
                </button>
                <button onClick={handleSubmit}
                  className="bg-indigo-500 text-white px-6 py-3 rounded-lg font-medium">
                  Complete
                </button>
              </div>
            </div>
          )}
        </div>
      );
    }

    // Steel Inspection Test Plan View
    function SteelITPView({ onSubmit, sites = [] }) {
      const [step, setStep] = useState(1);
      const [submitted, setSubmitted] = useState(false);
      const [managerSignature, setManagerSignature] = useState(null);
      const [builderSignature, setBuilderSignature] = useState(null);
      const [signingManager, setSigningManager] = useState(false);
      const [signingBuilder, setSigningBuilder] = useState(false);
      const [validationErrors, setValidationErrors] = useState([]);

      // Form state
      const [siteConducted, setSiteConducted] = useState('');
      const [preparedBy, setPreparedBy] = useState('');
      const [location, setLocation] = useState('');
      const [jobStructure, setJobStructure] = useState('');

      // Items section
      const [preConstMeeting, setPreConstMeeting] = useState('');
      const [highRiskWorkshop, setHighRiskWorkshop] = useState('');
      const [shopdrawingsApproved, setShopdrawingsApproved] = useState('');
      const [allItemsSignedOff, setAllItemsSignedOff] = useState('');

      // Fabrication section
      const [materialsOrdered, setMaterialsOrdered] = useState('');
      const [materialsCorrect, setMaterialsCorrect] = useState('');
      const [visualCheck, setVisualCheck] = useState('');
      const [shopdrawingsCurrent, setShopdrawingsCurrent] = useState('');
      const [setoutCorrect, setSetoutCorrect] = useState('');
      const [tackWeld, setTackWeld] = useState('');
      const [fullyWelded, setFullyWelded] = useState('');
      const [packLoad, setPackLoad] = useState('');

      // Specialised finishes
      const [finishConfirmed, setFinishConfirmed] = useState('');
      const [deliveryBooked, setDeliveryBooked] = useState('');
      const [sentToPainter, setSentToPainter] = useState('');
      const [deliveryVehicle, setDeliveryVehicle] = useState('');
      const [afterDeliveryFinish, setAfterDeliveryFinish] = useState('');

      // Site setout
      const [drawingsConfirmed, setDrawingsConfirmed] = useState('');
      const [surveyorMeasurements, setSurveyorMeasurements] = useState('');
      const [surveyorName, setSurveyorName] = useState('');
      const [clashesDetected, setClashesDetected] = useState('');

      // Site installation
      const [chemicalAnchors, setChemicalAnchors] = useState('');
      const [anchorsInstalled, setAnchorsInstalled] = useState('');
      const [levelPlumb, setLevelPlumb] = useState('');
      const [boltsTorqued, setBoltsTorqued] = useState('');
      const [weldingCompleted, setWeldingCompleted] = useState('');

      // Grouting
      const [groutingCompleted, setGroutingCompleted] = useState('');

      // Final inspection
      const [itemsChecked, setItemsChecked] = useState('');
      const [finishAcceptable, setFinishAcceptable] = useState('');
      const [fixingsTorqued, setFixingsTorqued] = useState('');

      // NDT
      const [weldTestingBooked, setWeldTestingBooked] = useState('');
      const [testingIssues, setTestingIssues] = useState('');
      const [weldsPassed, setWeldsPassed] = useState('');

      // Handover
      const [colourConfirmed, setColourConfirmed] = useState('');
      const [defectsChecked, setDefectsChecked] = useState('');
      const [handoverAccepted, setHandoverAccepted] = useState('');

      // Manager info
      const [managerName, setManagerName] = useState('');
      const [builderName, setBuilderName] = useState('');

      const todayDate = new Date().toLocaleDateString('en-AU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
      const defaultSites = ['Site 1 - Sydney CBD', 'Site 2 - Parramatta', 'Site 3 - North Sydney'];
      const sitesList = sites.length > 0 ? sites : defaultSites;

      const SelectField = ({ label, value, onChange }) => (
        <div className="space-y-2">
          <label className="block text-sm font-medium text-gray-700">{label}</label>
          <div className="flex gap-2">
            {['Yes', 'No', 'N/A'].map(opt => (
              <button key={opt} onClick={() => onChange(opt)} className={`flex-1 p-2 rounded-lg border text-sm font-medium ${value === opt ? 'bg-orange-500 text-white border-orange-500' : 'bg-white border-gray-300'}`}>
                {opt}
              </button>
            ))}
          </div>
        </div>
      );

      const handleSubmit = () => {
        const errors = window.formValidator.validateSteelITP({
          siteConducted, preparedBy, managerName, managerSignature
        });
        if (errors.length > 0) {
          setValidationErrors(errors);
          return;
        }
        setValidationErrors([]);
        const data = {
          siteConducted, preparedBy, location, jobStructure,
          preConstMeeting, highRiskWorkshop, shopdrawingsApproved, allItemsSignedOff,
          materialsOrdered, materialsCorrect, visualCheck, shopdrawingsCurrent,
          setoutCorrect, tackWeld, fullyWelded, packLoad,
          finishConfirmed, deliveryBooked, sentToPainter, deliveryVehicle, afterDeliveryFinish,
          drawingsConfirmed, surveyorMeasurements, surveyorName, clashesDetected,
          chemicalAnchors, anchorsInstalled, levelPlumb, boltsTorqued, weldingCompleted,
          groutingCompleted, itemsChecked, finishAcceptable, fixingsTorqued,
          weldTestingBooked, testingIssues, weldsPassed,
          colourConfirmed, defectsChecked, handoverAccepted,
          managerName, managerSignature, builderName, builderSignature,
          submittedAt: new Date().toISOString()
        };
        onSubmit(data);
        setSubmitted(true);
      };

      if (submitted) {
        return (
          <div className="space-y-4">
            <div className="bg-green-500 text-white p-6 rounded-xl text-center">
              <div className="text-6xl mb-4">‚úÖ</div>
              <h2 className="text-2xl font-bold">Steel ITP Submitted!</h2>
            </div>
            <button onClick={() => { setSubmitted(false); setStep(1); }} className="w-full bg-orange-600 text-white p-4 rounded-xl font-semibold">
              Start New Steel ITP
            </button>
          </div>
        );
      }

      return (
        <div className="space-y-4">
          {signingManager && <SignaturePad name={managerName} onSave={(sig) => { setManagerSignature(sig); setSigningManager(false); }} onCancel={() => setSigningManager(false)} />}
          {signingBuilder && <SignaturePad name={builderName} onSave={(sig) => { setBuilderSignature(sig); setSigningBuilder(false); }} onCancel={() => setSigningBuilder(false)} />}

          <div className="bg-gradient-to-r from-slate-600 to-slate-700 text-white p-4 rounded-xl">
            <h2 className="text-xl font-bold">üî© Steel Inspection Test Plan</h2>
            <p className="text-sm opacity-90 mt-1">J&M ArtSteel</p>
            <p className="text-xs mt-2">{todayDate}</p>
          </div>

          {/* Progress */}
          <div className="flex gap-1">
            {[1,2,3,4,5,6,7,8].map(s => (
              <div key={s} className={`flex-1 h-2 rounded ${step >= s ? 'bg-orange-500' : 'bg-gray-200'}`}></div>
            ))}
          </div>
          <p className="text-xs text-gray-500 text-center">Step {step} of 8</p>

          {/* Step 1: Basic Info */}
          {step === 1 && (
            <div className="bg-white rounded-xl p-4 space-y-4">
              <h3 className="font-bold text-gray-800 border-b pb-2">Basic Information</h3>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Site Conducted *</label>
                <select value={siteConducted} onChange={e => setSiteConducted(e.target.value)} className="w-full p-3 border rounded-lg">
                  <option value="">Select site</option>
                  {sitesList.map(s => <option key={s} value={s}>{s}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Prepared By</label>
                <select value={preparedBy} onChange={e => setPreparedBy(e.target.value)} className="w-full p-3 border rounded-lg bg-white">
                  <option value="">Select person</option>
                  <option value="Jeff Fu">Jeff Fu</option>
                  <option value="Scott Seeho">Scott Seeho</option>
                  <option value="Davide Casolini">Davide Casolini</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Location</label>
                <input type="text" value={location} onChange={e => setLocation(e.target.value)} placeholder="Enter location" className="w-full p-3 border rounded-lg" />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Job / Structure ITP carried out on</label>
                <input type="text" value={jobStructure} onChange={e => setJobStructure(e.target.value)} placeholder="Enter job details" className="w-full p-3 border rounded-lg" />
              </div>
            </div>
          )}

          {/* Step 2: Pre-Construction Items */}
          {step === 2 && (
            <div className="bg-white rounded-xl p-4 space-y-4">
              <h3 className="font-bold text-gray-800 border-b pb-2">Items</h3>
              <SelectField label="Pre-Construction Meeting Completed with Builder" value={preConstMeeting} onChange={setPreConstMeeting} />
              <SelectField label="Structural Steel High Risk Workshop Completed" value={highRiskWorkshop} onChange={setHighRiskWorkshop} />
              <SelectField label="Shopdrawings Submitted and Approved by Engineer" value={shopdrawingsApproved} onChange={setShopdrawingsApproved} />
              <SelectField label="All Above items completed and Signed off" value={allItemsSignedOff} onChange={setAllItemsSignedOff} />
            </div>
          )}

          {/* Step 3: Fabrication */}
          {step === 3 && (
            <div className="bg-white rounded-xl p-4 space-y-4">
              <h3 className="font-bold text-gray-800 border-b pb-2">Fabrication</h3>
              <SelectField label="Materials Ordered as Per shopdrawings" value={materialsOrdered} onChange={setMaterialsOrdered} />
              <SelectField label="Materials on delivery are correct" value={materialsCorrect} onChange={setMaterialsCorrect} />
              <SelectField label="Visual Check Materials in good condition" value={visualCheck} onChange={setVisualCheck} />
              <SelectField label="Shopdrawings are current revision" value={shopdrawingsCurrent} onChange={setShopdrawingsCurrent} />
              <SelectField label="Setout cleats, plates, members correct" value={setoutCorrect} onChange={setSetoutCorrect} />
              <SelectField label="Tack weld, check straight and plumb" value={tackWeld} onChange={setTackWeld} />
              <SelectField label="Fully weld as per engineer specifications" value={fullyWelded} onChange={setFullyWelded} />
              <SelectField label="Pack and load materials for transport" value={packLoad} onChange={setPackLoad} />
            </div>
          )}

          {/* Step 4: Specialised Finishes */}
          {step === 4 && (
            <div className="bg-white rounded-xl p-4 space-y-4">
              <h3 className="font-bold text-gray-800 border-b pb-2">Specialised Finishes</h3>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Confirm finish of steel and approved</label>
                <input type="text" value={finishConfirmed} onChange={e => setFinishConfirmed(e.target.value)} placeholder="Enter finish type" className="w-full p-3 border rounded-lg" />
              </div>
              <SelectField label="Book delivery to site/workshop" value={deliveryBooked} onChange={setDeliveryBooked} />
              <SelectField label="Send material to painter/abrasive blaster" value={sentToPainter} onChange={setSentToPainter} />
              <SelectField label="Correct Delivery vehicle and sizes confirmed" value={deliveryVehicle} onChange={setDeliveryVehicle} />
              <SelectField label="After delivery finish is acceptable" value={afterDeliveryFinish} onChange={setAfterDeliveryFinish} />
            </div>
          )}

          {/* Step 5: Site Setout & Installation */}
          {step === 5 && (
            <div className="bg-white rounded-xl p-4 space-y-4">
              <h3 className="font-bold text-gray-800 border-b pb-2">Site Setout & Installation</h3>
              <SelectField label="Confirm correct drawings with builder" value={drawingsConfirmed} onChange={setDrawingsConfirmed} />
              <SelectField label="Surveyor has correct measurements" value={surveyorMeasurements} onChange={setSurveyorMeasurements} />
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Surveyor Name</label>
                <input type="text" value={surveyorName} onChange={e => setSurveyorName(e.target.value)} placeholder="Enter surveyor name" className="w-full p-3 border rounded-lg" />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Clashes detected / issues</label>
                <textarea value={clashesDetected} onChange={e => setClashesDetected(e.target.value)} placeholder="Describe any issues" className="w-full p-3 border rounded-lg" rows={3}></textarea>
              </div>
              <SelectField label="Chemical anchors correct as per specs" value={chemicalAnchors} onChange={setChemicalAnchors} />
              <SelectField label="Anchors installed correctly" value={anchorsInstalled} onChange={setAnchorsInstalled} />
              <SelectField label="Steel checked for level and plumbness" value={levelPlumb} onChange={setLevelPlumb} />
              <SelectField label="Bolts and nuts tightened/torqued" value={boltsTorqued} onChange={setBoltsTorqued} />
              <SelectField label="Welding completed to engineering specs" value={weldingCompleted} onChange={setWeldingCompleted} />
            </div>
          )}

          {/* Step 6: Grouting & Final Inspection */}
          {step === 6 && (
            <div className="bg-white rounded-xl p-4 space-y-4">
              <h3 className="font-bold text-gray-800 border-b pb-2">Grouting & Final Inspection</h3>
              <SelectField label="Grouting completed to all steel members" value={groutingCompleted} onChange={setGroutingCompleted} />
              <SelectField label="All installed items checked as per drawings" value={itemsChecked} onChange={setItemsChecked} />
              <SelectField label="Finish in good condition (touch ups done)" value={finishAcceptable} onChange={setFinishAcceptable} />
              <SelectField label="All fixings torqued at correct lengths" value={fixingsTorqued} onChange={setFixingsTorqued} />
            </div>
          )}

          {/* Step 7: NDT & Handover */}
          {step === 7 && (
            <div className="bg-white rounded-xl p-4 space-y-4">
              <h3 className="font-bold text-gray-800 border-b pb-2">NDT & Handover</h3>
              <SelectField label="Weld Testing booked and confirmed" value={weldTestingBooked} onChange={setWeldTestingBooked} />
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Any issues with Testing?</label>
                <textarea value={testingIssues} onChange={e => setTestingIssues(e.target.value)} placeholder="Describe issues" className="w-full p-3 border rounded-lg" rows={2}></textarea>
              </div>
              <SelectField label="All welds tested have passed compliance" value={weldsPassed} onChange={setWeldsPassed} />
              <SelectField label="Colour/finish confirmed by builder" value={colourConfirmed} onChange={setColourConfirmed} />
              <SelectField label="Builder checked for defects" value={defectsChecked} onChange={setDefectsChecked} />
              <SelectField label="Builder accepted handover (defect free)" value={handoverAccepted} onChange={setHandoverAccepted} />
            </div>
          )}

          {/* Step 8: Sign-offs */}
          {step === 8 && (
            <div className="bg-white rounded-xl p-4 space-y-4">
              <h3 className="font-bold text-gray-800 border-b pb-2">Sign-offs</h3>

              <div className="bg-gray-50 p-4 rounded-lg">
                <h4 className="font-semibold text-gray-700 mb-3">Manager Completing ITP</h4>
                <input type="text" value={managerName} onChange={e => setManagerName(e.target.value)} placeholder="Manager name" className="w-full p-3 border rounded-lg mb-3" />
                {managerSignature ? (
                  <div className="border rounded-lg p-2 bg-white">
                    <p className="text-xs text-gray-500 mb-1">Signature:</p>
                    <img src={managerSignature} alt="Manager signature" className="h-16" />
                  </div>
                ) : (
                  <button onClick={() => setSigningManager(true)} disabled={!managerName} className={`w-full p-3 rounded-lg font-semibold ${managerName ? 'bg-orange-500 text-white' : 'bg-gray-300 text-gray-500'}`}>
                    ‚úçÔ∏è Sign
                  </button>
                )}
              </div>

              <div className="bg-gray-50 p-4 rounded-lg">
                <h4 className="font-semibold text-gray-700 mb-3">Builder Signoff</h4>
                <input type="text" value={builderName} onChange={e => setBuilderName(e.target.value)} placeholder="Builder name" className="w-full p-3 border rounded-lg mb-3" />
                {builderSignature ? (
                  <div className="border rounded-lg p-2 bg-white">
                    <p className="text-xs text-gray-500 mb-1">Signature:</p>
                    <img src={builderSignature} alt="Builder signature" className="h-16" />
                  </div>
                ) : (
                  <button onClick={() => setSigningBuilder(true)} disabled={!builderName} className={`w-full p-3 rounded-lg font-semibold ${builderName ? 'bg-blue-500 text-white' : 'bg-gray-300 text-gray-500'}`}>
                    ‚úçÔ∏è Sign
                  </button>
                )}
              </div>
            </div>
          )}

          {/* Navigation */}
          {validationErrors.length > 0 && (
            <div className="bg-red-50 border border-red-200 rounded-xl p-4">
              <p className="text-red-800 font-semibold mb-2">Please fix the following:</p>
              {validationErrors.map((e, i) => <p key={i} className="text-red-700 text-sm">‚Ä¢ {e}</p>)}
            </div>
          )}

          <div className="flex gap-3">
            {step > 1 && (
              <button onClick={() => setStep(step - 1)} className="flex-1 bg-gray-200 p-4 rounded-xl font-semibold">
                ‚Üê Previous
              </button>
            )}
            {step < 8 ? (
              <button onClick={() => setStep(step + 1)} className="flex-1 bg-orange-600 text-white p-4 rounded-xl font-semibold">
                Next ‚Üí
              </button>
            ) : (
              <button onClick={handleSubmit} disabled={!managerSignature} className={`flex-1 p-4 rounded-xl font-semibold ${managerSignature ? 'bg-green-600 text-white' : 'bg-gray-300 text-gray-500'}`}>
                Submit Steel ITP ‚úì
              </button>
            )}
          </div>
        </div>
      );
    }

    // Emergency View
    function EmergencyView() {
      const contacts = [
        { name: 'Emergency Services', number: '000', desc: 'Police, Fire, Ambulance' },
        { name: 'SafeWork NSW', number: '13 10 50', desc: 'Report serious incidents' },
        { name: 'Poisons Information', number: '13 11 26', desc: '24/7 advice' },
      ];

      return (
        <div className="space-y-4">
          <div className="bg-red-600 rounded-xl p-4 text-white">
            <h2 className="text-xl font-bold flex items-center gap-2">üìû Emergency Information</h2>
            <p className="text-red-100 text-sm mt-1">Keep this information accessible</p>
          </div>
          <div className="bg-white rounded-xl shadow-sm divide-y">
            {contacts.map((contact, idx) => (
              <a key={idx} href={`tel:${contact.number.replace(/\s/g, '')}`} className="p-4 flex items-center justify-between">
                <div>
                  <p className="font-semibold text-gray-800">{contact.name}</p>
                  <p className="text-sm text-gray-500">{contact.desc}</p>
                </div>
                <span className="font-bold text-lg text-red-600">{contact.number}</span>
              </a>
            ))}
          </div>
        </div>
      );
    }

    // Settings View
    function SettingsView({ sites = [], onUpdateSites, signatures = {}, onUpdateSignatures, isAdmin = false, isDeviceAdmin = false, canViewDevices = false, canRevokeDevices = false, pendingDevices = [], approvedDevices = [] }) {
      const [newSite, setNewSite] = useState('');
      const [showAddSite, setShowAddSite] = useState(false);
      const [driveConnected, setDriveConnected] = useState(GoogleDriveSync.isConnected());
      const [backupStatus, setBackupStatus] = useState('');
      const [isBackingUp, setIsBackingUp] = useState(false);
      const [showSignaturePad, setShowSignaturePad] = useState(null); // Name of person to sign
      const [newMemberName, setNewMemberName] = useState('');
      const [showAddMember, setShowAddMember] = useState(false);
      const [devices, setDevices] = useState({ pending: [], approved: [], denied: [] });
      const [pendingCount, setPendingCount] = useState(0);
      const [deviceActionLoading, setDeviceActionLoading] = useState(null);
      const [editingDeviceId, setEditingDeviceId] = useState(null);
      const [editingDeviceName, setEditingDeviceName] = useState('');
      const defaultSites = ['Site 1 - Sydney CBD', 'Site 2 - Parramatta', 'Site 3 - North Sydney'];
      const currentSites = sites.length > 0 ? sites : defaultSites;

      // Listen to device changes if admin, viewer, or has revoke permission
      useEffect(() => {
        if ((isAdmin || canViewDevices || canRevokeDevices) && isFirebaseConfigured) {
          const unsubscribe = DeviceAuthManager.listenToDevices((deviceData) => {
            setDevices(deviceData);
            setPendingCount(deviceData.pending.length);
          });
          return () => unsubscribe();
        }
      }, [isAdmin, canViewDevices, canRevokeDevices]);

      const handleApproveDevice = async (deviceId) => {
        setDeviceActionLoading(deviceId);
        const success = await DeviceAuthManager.approveDevice(deviceId);
        setDeviceActionLoading(null);
        if (!success) {
          alert('Failed to approve device');
        }
      };

      const handleDenyDevice = async (deviceId) => {
        setDeviceActionLoading(deviceId);
        const success = await DeviceAuthManager.denyDevice(deviceId);
        setDeviceActionLoading(null);
        if (!success) {
          alert('Failed to deny device');
        }
      };

      const handleRevokeDevice = async (deviceId) => {
        if (confirm('Are you sure you want to revoke access for this device?')) {
          setDeviceActionLoading(deviceId);
          const success = await DeviceAuth.revokeDevice(deviceId);
          setDeviceActionLoading(null);
          if (!success) {
            alert('Failed to revoke device');
          }
        }
      };

      const handleRemoveDevice = async (deviceId) => {
        if (confirm('Are you sure you want to remove this device?')) {
          setDeviceActionLoading(deviceId);
          const success = await DeviceAuthManager.removeDevice(deviceId);
          setDeviceActionLoading(null);
          if (!success) {
            alert('Failed to remove device');
          }
        }
      };

      const handleStartRename = (device) => {
        setEditingDeviceId(device.id);
        setEditingDeviceName(device.name || '');
      };

      const handleSaveRename = async (deviceId) => {
        if (!editingDeviceName.trim()) {
          alert('Device name cannot be empty');
          return;
        }
        setDeviceActionLoading(deviceId);
        const success = await DeviceAuthManager.renameDevice(deviceId, editingDeviceName);
        setDeviceActionLoading(null);
        setEditingDeviceId(null);
        setEditingDeviceName('');
        if (!success) {
          alert('Failed to rename device');
        }
      };

      const handleCancelRename = () => {
        setEditingDeviceId(null);
        setEditingDeviceName('');
      };

      // Default team members
      const defaultMembers = ['Jeff Fu', 'Scott Seeho', 'Davide Casolini', 'Zonggang Jiang', 'Leon Yu', 'Wang Jia', 'Gen Bao'];
      // Get all members (default + any custom added via signatures)
      const allMembers = [...new Set([...defaultMembers, ...Object.keys(signatures).filter(name => !defaultMembers.includes(name))])];

      const saveSignature = (name, signatureData) => {
        const newSignatures = { ...signatures, [name]: signatureData };
        onUpdateSignatures(newSignatures);
        setShowSignaturePad(null);
      };

      const deleteSignature = (name) => {
        const newSignatures = { ...signatures };
        delete newSignatures[name];
        onUpdateSignatures(newSignatures);
      };

      const addNewMember = () => {
        if (newMemberName.trim() && !allMembers.includes(newMemberName.trim())) {
          // Add member with empty signature (will show "Add Signature" button)
          const newSignatures = { ...signatures, [newMemberName.trim()]: null };
          onUpdateSignatures(newSignatures);
          setNewMemberName('');
          setShowAddMember(false);
        }
      };

      const deleteMember = (name) => {
        // Only allow deleting custom members (not in defaultMembers)
        if (!defaultMembers.includes(name)) {
          const newSignatures = { ...signatures };
          delete newSignatures[name];
          onUpdateSignatures(newSignatures);
        }
      };

      const addSite = () => {
        if (newSite.trim()) {
          onUpdateSites([...currentSites, newSite.trim()]);
          setNewSite('');
          setShowAddSite(false);
        }
      };

      const connectDrive = () => {
        GoogleDriveSync.authorize();
        // Check connection status after a delay
        setTimeout(() => setDriveConnected(GoogleDriveSync.isConnected()), 3000);
      };

      const disconnectDrive = () => {
        GoogleDriveSync.disconnect();
        setDriveConnected(false);
      };

      const backupNow = async () => {
        setIsBackingUp(true);
        setBackupStatus('Backing up...');
        try {
          const formsJson = localStorage.getItem('jmart-safety-forms');
          if (!formsJson) {
            setBackupStatus('No forms to backup');
            setIsBackingUp(false);
            return;
          }
          const forms = JSON.parse(formsJson);
          const result = await GoogleDriveSync.uploadDailyForms(forms);
          if (result.success) {
            setBackupStatus(`‚úÖ Backed up ${result.uploaded} forms to Google Drive!`);
          } else {
            setBackupStatus('‚ùå Backup failed: ' + result.error);
          }
        } catch (error) {
          setBackupStatus('‚ùå Backup error: ' + error.message);
        }
        setIsBackingUp(false);
      };

      const lastBackup = localStorage.getItem('last-drive-backup-date');

      return (
        <div className="space-y-4">
          <div className="bg-white rounded-xl p-4 shadow-sm">
            <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">‚öôÔ∏è Settings</h2>
            {isDeviceAdmin && (
              <p className="text-xs text-green-600 mt-1">üõ°Ô∏è Admin Mode - You can manage device access</p>
            )}
          </div>

          {/* Current Device Info (for all users) */}
          <div className="bg-white rounded-xl shadow-sm p-4">
            <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
              <span className="text-2xl">üîê</span> This Device
            </h3>
            <div className="bg-gray-50 rounded-lg p-3 space-y-1">
              <p className="text-sm"><span className="text-gray-500">Type:</span> <span className="font-medium">{DeviceAuth.deviceInfo?.type}</span></p>
              <p className="text-sm"><span className="text-gray-500">Browser:</span> <span className="font-medium">{DeviceAuth.deviceInfo?.browser}</span></p>
              <p className="text-sm"><span className="text-gray-500">Screen:</span> <span className="font-medium">{DeviceAuth.deviceInfo?.screen}</span></p>
              <p className="text-xs text-gray-400 mt-2">Device ID: {DeviceAuth.deviceId}</p>
            </div>
          </div>

          {/* Device Management Section - Admin, Viewer, or has Revoke permission */}
          {(isAdmin || canViewDevices || canRevokeDevices) && isFirebaseConfigured && (
            <div className="bg-white rounded-xl shadow-sm p-4">
              <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                <span className="text-2xl">üì±</span> Connected Devices
                {isAdmin && pendingCount > 0 && (
                  <span className="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">{pendingCount} pending</span>
                )}
                {!isAdmin && !canRevokeDevices && <span className="text-xs text-gray-400">(View only)</span>}
              </h3>

              {/* Pending Devices - Admin can approve/deny, Viewers can only see */}
              {devices.pending.length > 0 && (
                <div className="mb-4">
                  <p className="text-sm font-medium text-yellow-700 mb-2">‚è≥ Pending Approval ({devices.pending.length})</p>
                  <div className="space-y-2">
                    {devices.pending.map(device => (
                      <div key={device.id} className="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <div className="flex items-center justify-between">
                          <div className="flex-1 min-w-0">
                            {editingDeviceId === device.id ? (
                              <div className="flex items-center gap-2">
                                <input
                                  type="text"
                                  value={editingDeviceName}
                                  onChange={(e) => setEditingDeviceName(e.target.value)}
                                  onKeyDown={(e) => {
                                    if (e.key === 'Enter') handleSaveRename(device.id);
                                    if (e.key === 'Escape') handleCancelRename();
                                  }}
                                  className="border border-gray-300 rounded px-2 py-1 text-sm flex-1 min-w-0"
                                  autoFocus
                                  maxLength={30}
                                />
                                <button
                                  onClick={() => handleSaveRename(device.id)}
                                  className="text-green-600 text-sm font-medium px-2"
                                  disabled={deviceActionLoading === device.id}
                                >
                                  {deviceActionLoading === device.id ? '...' : '‚úì'}
                                </button>
                                <button
                                  onClick={handleCancelRename}
                                  className="text-gray-400 text-sm font-medium px-1"
                                >
                                  ‚úï
                                </button>
                              </div>
                            ) : (
                              <p className="font-medium text-gray-800 flex items-center gap-2">
                                {device.name || 'Unknown Device'}
                                {isAdmin && (
                                  <button
                                    onClick={() => handleStartRename(device)}
                                    className="text-gray-400 hover:text-gray-600 text-xs ml-1"
                                    title="Rename device"
                                  >
                                    ‚úèÔ∏è
                                  </button>
                                )}
                              </p>
                            )}
                            <p className="text-xs text-gray-500">
                              Requested: {new Date(device.registeredAt).toLocaleDateString('en-AU')}
                            </p>
                          </div>
                          {isAdmin && (
                            <div className="flex gap-2">
                              <button
                                onClick={() => handleApproveDevice(device.id)}
                                className="bg-green-600 text-white px-3 py-1 rounded-lg text-sm font-medium"
                              >
                                ‚úì Approve
                              </button>
                              <button
                                onClick={() => handleDenyDevice(device.id)}
                                className="bg-red-600 text-white px-3 py-1 rounded-lg text-sm font-medium"
                              >
                                ‚úï Deny
                              </button>
                            </div>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Approved Devices */}
              <div>
                <p className="text-sm font-medium text-green-700 mb-2">‚úì Approved Devices ({devices.approved.length})</p>
                {devices.approved.length === 0 ? (
                  <p className="text-sm text-gray-500">No approved devices yet</p>
                ) : (
                  <div className="space-y-2">
                    {devices.approved.map(device => (
                      <div key={device.id} className="bg-green-50 border border-green-200 rounded-lg p-3">
                        <div className="flex items-center justify-between">
                          <div className="flex-1 min-w-0">
                            {editingDeviceId === device.id ? (
                              <div className="flex items-center gap-2">
                                <input
                                  type="text"
                                  value={editingDeviceName}
                                  onChange={(e) => setEditingDeviceName(e.target.value)}
                                  onKeyDown={(e) => {
                                    if (e.key === 'Enter') handleSaveRename(device.id);
                                    if (e.key === 'Escape') handleCancelRename();
                                  }}
                                  className="border border-gray-300 rounded px-2 py-1 text-sm flex-1 min-w-0"
                                  autoFocus
                                  maxLength={30}
                                />
                                <button
                                  onClick={() => handleSaveRename(device.id)}
                                  className="text-green-600 text-sm font-medium px-2"
                                  disabled={deviceActionLoading === device.id}
                                >
                                  {deviceActionLoading === device.id ? '...' : '‚úì'}
                                </button>
                                <button
                                  onClick={handleCancelRename}
                                  className="text-gray-400 text-sm font-medium px-1"
                                >
                                  ‚úï
                                </button>
                              </div>
                            ) : (
                              <p className="font-medium text-gray-800 flex items-center gap-2">
                                {device.name || 'Unknown Device'}
                                {device.isAdmin && <span className="text-xs bg-orange-500 text-white px-2 py-0.5 rounded">Admin</span>}
                                {device.canViewDevices && !device.isAdmin && <span className="text-xs bg-blue-500 text-white px-2 py-0.5 rounded">Viewer</span>}
                                {isAdmin && (
                                  <button
                                    onClick={() => handleStartRename(device)}
                                    className="text-gray-400 hover:text-gray-600 text-xs ml-1"
                                    title="Rename device"
                                  >
                                    ‚úèÔ∏è
                                  </button>
                                )}
                              </p>
                            )}
                            <p className="text-xs text-gray-500">
                              Last seen: {device.lastSeen ? new Date(device.lastSeen).toLocaleString('en-AU') : 'Never'}
                            </p>
                          </div>
                          {isAdmin && !device.isAdmin && (
                            <button
                              onClick={() => handleRemoveDevice(device.id)}
                              className="text-red-500 text-sm ml-2"
                            >
                              üóëÔ∏è
                            </button>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Current Device Info */}
              <div className="mt-4 pt-4 border-t border-gray-200">
                <p className="text-xs text-gray-500">Your Device ID: <span className="font-mono">{DeviceAuthManager.deviceId}</span></p>
              </div>
            </div>
          )}

          {/* Google Drive Backup Section */}
          <div className="bg-white rounded-xl shadow-sm p-4">
            <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
              <span className="text-2xl">üìÅ</span> Google Drive Backup
            </h3>

            {!isGoogleDriveConfigured ? (
              <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-3">
                <p className="text-sm text-yellow-800 font-medium">‚ö†Ô∏è Google Drive not configured</p>
                <p className="text-xs text-yellow-700 mt-1">Contact your admin to set up Google Drive integration</p>
              </div>
            ) : (
              <>
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-2">
                    <div className={`w-3 h-3 rounded-full ${driveConnected ? 'bg-green-500' : 'bg-gray-300'}`}></div>
                    <span className="text-sm text-gray-600">{driveConnected ? 'Connected' : 'Not connected'}</span>
                  </div>
                  {driveConnected ? (
                    <button onClick={disconnectDrive} className="text-red-600 text-sm underline">Disconnect</button>
                  ) : (
                    <button onClick={connectDrive} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                      Connect Google Drive
                    </button>
                  )}
                </div>

                {driveConnected && (
                  <>
                    <div className="bg-gray-50 rounded-lg p-3 mb-3">
                      <p className="text-sm text-gray-600">
                        <span className="font-medium">Auto-backup:</span> Every day at 7:00 PM
                      </p>
                      <p className="text-sm text-gray-600">
                        <span className="font-medium">Folder:</span> {DRIVE_FOLDER_NAME}
                      </p>
                      {lastBackup && (
                        <p className="text-sm text-gray-600">
                          <span className="font-medium">Last backup:</span> {lastBackup}
                        </p>
                      )}
                    </div>

                    <button
                      onClick={backupNow}
                      disabled={isBackingUp}
                      className={`w-full py-3 rounded-lg text-white font-medium ${isBackingUp ? 'bg-gray-400' : 'bg-green-600 hover:bg-green-700'}`}
                    >
                      {isBackingUp ? '‚è≥ Backing up...' : '‚òÅÔ∏è Backup Now'}
                    </button>

                    {backupStatus && (
                      <p className={`text-sm mt-2 text-center ${backupStatus.includes('‚úÖ') ? 'text-green-600' : backupStatus.includes('‚ùå') ? 'text-red-600' : 'text-gray-600'}`}>
                        {backupStatus}
                      </p>
                    )}
                  </>
                )}
              </>
            )}
          </div>

          <div className="bg-white rounded-xl shadow-sm p-4">
            <div className="flex items-center justify-between mb-3">
              <h3 className="font-semibold text-gray-800">üèóÔ∏è Sites</h3>
              <button onClick={() => setShowAddSite(!showAddSite)} className="bg-green-600 text-white px-3 py-1 rounded-lg text-sm">+ Add Site</button>
            </div>
            {showAddSite && (
              <div className="mb-4 flex gap-2">
                <input type="text" value={newSite} onChange={(e) => setNewSite(e.target.value)} className="flex-1 border rounded-lg p-2 text-sm" placeholder="Enter site name" />
                <button onClick={addSite} className="bg-green-600 text-white px-4 py-2 rounded-lg text-sm">Add</button>
              </div>
            )}
            <div className="space-y-2">
              {currentSites.map((site, idx) => (
                <div key={idx} className="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                  <span className="text-sm text-gray-700">{site}</span>
                  <button onClick={() => onUpdateSites(currentSites.filter(s => s !== site))} className="text-red-500">üóëÔ∏è</button>
                </div>
              ))}
            </div>
          </div>
          {/* Team Signatures Section */}
          <div className="bg-white rounded-xl shadow-sm p-4">
            <div className="flex items-center justify-between mb-3">
              <h3 className="font-semibold text-gray-800">‚úçÔ∏è Team Signatures</h3>
              <button onClick={() => setShowAddMember(!showAddMember)} className="bg-green-600 text-white px-3 py-1 rounded-lg text-sm">+ Add Member</button>
            </div>
            <p className="text-xs text-gray-500 mb-3">Save signatures once and use them automatically in all forms</p>

            {showAddMember && (
              <div className="mb-4 flex gap-2">
                <input
                  type="text"
                  value={newMemberName}
                  onChange={(e) => setNewMemberName(e.target.value)}
                  className="flex-1 border rounded-lg p-2 text-sm"
                  placeholder="Enter team member name"
                />
                <button onClick={addNewMember} className="bg-green-600 text-white px-4 py-2 rounded-lg text-sm">Add</button>
              </div>
            )}

            <div className="space-y-2">
              {allMembers.map((name, idx) => (
                <div key={idx} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                  <div className="flex items-center gap-3 flex-1">
                    <span className="text-sm font-medium text-gray-700">{name}</span>
                    {signatures[name] ? (
                      <img src={signatures[name]} alt={`${name}'s signature`} className="h-8 border rounded bg-white px-2" />
                    ) : (
                      <span className="text-xs text-gray-400 italic">No signature saved</span>
                    )}
                  </div>
                  <div className="flex items-center gap-2">
                    <button
                      onClick={() => setShowSignaturePad(name)}
                      className={`px-3 py-1 rounded-lg text-sm ${signatures[name] ? 'bg-orange-100 text-orange-600' : 'bg-green-600 text-white'}`}
                    >
                      {signatures[name] ? '‚úèÔ∏è Update' : '‚ûï Add'}
                    </button>
                    {signatures[name] && (
                      <button onClick={() => deleteSignature(name)} className="text-red-500 text-lg">üóëÔ∏è</button>
                    )}
                    {!defaultMembers.includes(name) && (
                      <button onClick={() => deleteMember(name)} className="text-red-500 text-xs underline ml-1">Remove</button>
                    )}
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Signature Pad Modal */}
          {showSignaturePad && (
            <SignaturePad
              name={showSignaturePad}
              onSave={(sig) => saveSignature(showSignaturePad, sig)}
              onCancel={() => setShowSignaturePad(null)}
            />
          )}
          <div className="bg-white rounded-xl shadow-sm p-4">
            <p className="text-sm text-gray-600">J&M Artsteel Safety App v1.0</p>
            <p className="text-sm text-gray-600">NSW WHS Act 2011 Compliant</p>
          </div>
        </div>
      );
    }

    // Job Photo Recordings View
    function RecordingsView({ forms, sites }) {
      const [selectedJob, setSelectedJob] = useState(null);
      const [showJobSelector, setShowJobSelector] = useState(false);
      const [photos, setPhotos] = useState([]);
      const [isUploading, setIsUploading] = useState(false);
      const [uploadStatus, setUploadStatus] = useState('');
      const [savedRecordings, setSavedRecordings] = useState(() => {
        const saved = localStorage.getItem('jmart-job-recordings');
        return saved ? JSON.parse(saved) : [];
      });
      const [viewingRecording, setViewingRecording] = useState(null);
      const cameraInputRef = useRef(null);
      const galleryInputRef = useRef(null);

      // Smart job detection - find today's prestart
      useEffect(() => {
        if (!selectedJob) {
          const today = new Date().toDateString();
          const todaysPrestarts = forms.filter(f =>
            f.type === 'prestart' &&
            new Date(f.createdAt).toDateString() === today
          );

          if (todaysPrestarts.length > 0) {
            // Get the most recent prestart from today
            const latestPrestart = todaysPrestarts.sort((a, b) =>
              new Date(b.createdAt) - new Date(a.createdAt)
            )[0];
            setSelectedJob({
              id: latestPrestart.id,
              name: latestPrestart.data?.siteConducted || 'Unknown Site',
              date: latestPrestart.createdAt,
              type: 'prestart'
            });
          }
        }
      }, [forms, selectedJob]);

      // Get available jobs from prestarts and sites
      const getAvailableJobs = () => {
        const jobs = [];

        // Add jobs from recent prestarts (last 7 days)
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

        forms.filter(f =>
          f.type === 'prestart' &&
          new Date(f.createdAt) > sevenDaysAgo
        ).forEach(prestart => {
          const siteName = prestart.data?.siteConducted || 'Unknown Site';
          const dateStr = new Date(prestart.createdAt).toLocaleDateString('en-AU');
          jobs.push({
            id: prestart.id,
            name: siteName,
            date: prestart.createdAt,
            label: `${siteName} (${dateStr})`,
            type: 'prestart'
          });
        });

        // Add available sites (for manual selection)
        const defaultSites = sites.length > 0 ? sites : ['Site 1 - Sydney CBD', 'Site 2 - Parramatta', 'Site 3 - North Sydney'];
        defaultSites.forEach(site => {
          // Only add if not already in the list from prestarts
          if (!jobs.find(j => j.name === site)) {
            jobs.push({
              id: `site-${site}`,
              name: site,
              date: new Date().toISOString(),
              label: `${site} (No prestart today)`,
              type: 'site'
            });
          }
        });

        return jobs;
      };

      // Compress image
      const compressImage = (file, maxWidth = 1200, quality = 0.7) => {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let width = img.width;
              let height = img.height;

              if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
              }

              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              const compressedData = canvas.toDataURL('image/jpeg', quality);
              resolve(compressedData);
            };
            img.onerror = () => resolve(event.target.result);
            img.src = event.target.result;
          };
          reader.onerror = () => resolve(null);
          reader.readAsDataURL(file);
        });
      };

      // Handle photo capture
      const handlePhotoCapture = async (e) => {
        const files = e.target.files;
        if (files && files.length > 0) {
          for (const file of Array.from(files)) {
            const compressedData = await compressImage(file);
            if (compressedData) {
              const newPhoto = {
                id: Date.now() + Math.random(),
                name: file.name,
                data: compressedData,
                timestamp: new Date().toISOString()
              };
              setPhotos(prev => [...prev, newPhoto]);
            }
          }
        }
        e.target.value = '';
      };

      // Remove photo
      const removePhoto = (photoId) => {
        setPhotos(prev => prev.filter(p => p.id !== photoId));
      };

      // Save recording locally
      const saveRecordingLocally = () => {
        if (!selectedJob || photos.length === 0) return;

        const recording = {
          id: Date.now(),
          jobId: selectedJob.id,
          jobName: selectedJob.name,
          date: new Date().toISOString(),
          photos: photos,
          driveUploaded: false
        };

        const updatedRecordings = [recording, ...savedRecordings];
        setSavedRecordings(updatedRecordings);
        localStorage.setItem('jmart-job-recordings', JSON.stringify(updatedRecordings));
        setPhotos([]);
        setUploadStatus('Saved locally!');
        setTimeout(() => setUploadStatus(''), 3000);
      };

      // Upload to Google Drive
      const uploadToDrive = async () => {
        if (!selectedJob || photos.length === 0) return;
        if (!GoogleDriveSync.isConnected()) {
          setUploadStatus('Please connect Google Drive in Settings first');
          return;
        }

        setIsUploading(true);
        setUploadStatus('Uploading to Google Drive...');

        try {
          const result = await GoogleDriveSync.uploadJobPhotos(photos, selectedJob.name, new Date());

          if (result.success) {
            // Save recording with drive upload status
            const recording = {
              id: Date.now(),
              jobId: selectedJob.id,
              jobName: selectedJob.name,
              date: new Date().toISOString(),
              photos: photos,
              driveUploaded: true,
              driveResults: result.results
            };

            const updatedRecordings = [recording, ...savedRecordings];
            setSavedRecordings(updatedRecordings);
            localStorage.setItem('jmart-job-recordings', JSON.stringify(updatedRecordings));

            setPhotos([]);
            setUploadStatus(`Uploaded ${result.uploaded} photos to Google Drive!`);
          } else {
            setUploadStatus('Upload failed: ' + result.error);
          }
        } catch (error) {
          setUploadStatus('Upload error: ' + error.message);
        }

        setIsUploading(false);
        setTimeout(() => setUploadStatus(''), 5000);
      };

      // Download photos as ZIP (using individual downloads since we can't create ZIP in browser easily)
      const downloadPhotos = () => {
        photos.forEach((photo, idx) => {
          const link = document.createElement('a');
          link.href = photo.data;
          link.download = `${selectedJob?.name || 'job'}-photo-${idx + 1}.jpg`;
          link.click();
        });
        setUploadStatus(`Downloaded ${photos.length} photos!`);
        setTimeout(() => setUploadStatus(''), 3000);
      };

      // Delete saved recording
      const deleteRecording = (recordingId) => {
        const updatedRecordings = savedRecordings.filter(r => r.id !== recordingId);
        setSavedRecordings(updatedRecordings);
        localStorage.setItem('jmart-job-recordings', JSON.stringify(updatedRecordings));
        setViewingRecording(null);
      };

      const todayDate = new Date().toLocaleDateString('en-AU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

      return (
        <div className="space-y-4">
          {/* Header */}
          <div className="bg-gradient-to-r from-teal-500 to-teal-600 rounded-xl p-4 text-white">
            <h2 className="text-xl font-bold flex items-center gap-2">
              <span>üì∏</span> Job Recordings
            </h2>
            <p className="text-teal-100 text-sm mt-1">Capture and save photos for your job</p>
            <div className="mt-2 flex items-center gap-2 text-sm">
              <span>üìÖ</span>
              <span>{todayDate}</span>
            </div>
          </div>

          {/* Job Selector */}
          <div className="bg-white rounded-xl p-4 shadow-sm">
            <div className="flex items-center justify-between mb-2">
              <h3 className="font-semibold text-gray-800">Current Job</h3>
              <button
                onClick={() => setShowJobSelector(!showJobSelector)}
                className="text-teal-600 text-sm underline"
              >
                Change
              </button>
            </div>

            {selectedJob ? (
              <div className="bg-teal-50 border border-teal-200 rounded-lg p-3">
                <div className="flex items-center gap-2">
                  <span className="text-2xl">{selectedJob.type === 'prestart' ? 'üìã' : 'üèóÔ∏è'}</span>
                  <div>
                    <p className="font-medium text-teal-800">{selectedJob.name}</p>
                    <p className="text-xs text-teal-600">
                      {selectedJob.type === 'prestart' ? 'Prestart completed' : 'Manual selection'} - {new Date(selectedJob.date).toLocaleDateString('en-AU')}
                    </p>
                  </div>
                </div>
              </div>
            ) : (
              <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                <p className="text-yellow-800 text-sm">No job detected for today. Please select a job.</p>
              </div>
            )}

            {showJobSelector && (
              <div className="mt-3 space-y-2 max-h-48 overflow-y-auto">
                {getAvailableJobs().map((job, idx) => (
                  <button
                    key={idx}
                    onClick={() => {
                      setSelectedJob(job);
                      setShowJobSelector(false);
                    }}
                    className={`w-full text-left p-3 rounded-lg border transition ${
                      selectedJob?.id === job.id
                        ? 'bg-teal-100 border-teal-300'
                        : 'bg-gray-50 border-gray-200 hover:bg-gray-100'
                    }`}
                  >
                    <div className="flex items-center gap-2">
                      <span>{job.type === 'prestart' ? 'üìã' : 'üèóÔ∏è'}</span>
                      <span className="text-sm font-medium">{job.label}</span>
                    </div>
                  </button>
                ))}
              </div>
            )}
          </div>

          {/* Photo Capture */}
          <div className="bg-white rounded-xl p-4 shadow-sm">
            <h3 className="font-semibold text-gray-800 mb-3">Take Photos</h3>

            <div className="flex gap-2 mb-4">
              <button
                onClick={() => cameraInputRef.current?.click()}
                className="flex-1 bg-teal-600 text-white py-3 rounded-lg font-medium flex items-center justify-center gap-2"
              >
                <span>üì∑</span> Camera
              </button>
              <button
                onClick={() => galleryInputRef.current?.click()}
                className="flex-1 bg-purple-600 text-white py-3 rounded-lg font-medium flex items-center justify-center gap-2"
              >
                <span>üñºÔ∏è</span> Gallery
              </button>
              <input ref={cameraInputRef} type="file" accept="image/*" capture="environment" onChange={handlePhotoCapture} className="hidden" />
              <input ref={galleryInputRef} type="file" accept="image/*" multiple onChange={handlePhotoCapture} className="hidden" />
            </div>

            {/* Photo Preview */}
            {photos.length > 0 && (
              <div className="space-y-3">
                <div className="flex items-center justify-between">
                  <p className="text-sm font-medium text-gray-700">{photos.length} photo(s) ready</p>
                  <button
                    onClick={() => setPhotos([])}
                    className="text-red-500 text-sm underline"
                  >
                    Clear all
                  </button>
                </div>
                <div className="grid grid-cols-4 gap-2">
                  {photos.map((photo) => (
                    <div key={photo.id} className="relative">
                      <img src={photo.data} alt="captured" className="w-full h-16 object-cover rounded-lg" />
                      <button
                        onClick={() => removePhoto(photo.id)}
                        className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center"
                      >
                        ‚úï
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>

          {/* Save Options */}
          {photos.length > 0 && selectedJob && (
            <div className="bg-white rounded-xl p-4 shadow-sm space-y-3">
              <h3 className="font-semibold text-gray-800">Save Photos</h3>

              <button
                onClick={downloadPhotos}
                className="w-full bg-blue-600 text-white py-3 rounded-lg font-medium flex items-center justify-center gap-2"
              >
                <span>üì•</span> Download to Phone
              </button>

              <button
                onClick={saveRecordingLocally}
                className="w-full bg-green-600 text-white py-3 rounded-lg font-medium flex items-center justify-center gap-2"
              >
                <span>üíæ</span> Save in App
              </button>

              <button
                onClick={uploadToDrive}
                disabled={isUploading || !GoogleDriveSync.isConnected()}
                className={`w-full py-3 rounded-lg font-medium flex items-center justify-center gap-2 ${
                  GoogleDriveSync.isConnected()
                    ? 'bg-orange-600 text-white'
                    : 'bg-gray-300 text-gray-500'
                }`}
              >
                {isUploading ? (
                  <>
                    <span className="animate-spin">‚è≥</span> Uploading...
                  </>
                ) : (
                  <>
                    <span>‚òÅÔ∏è</span> Upload to Google Drive
                  </>
                )}
              </button>

              {!GoogleDriveSync.isConnected() && (
                <p className="text-xs text-gray-500 text-center">Connect Google Drive in Settings to enable cloud upload</p>
              )}
            </div>
          )}

          {/* Status Message */}
          {uploadStatus && (
            <div className={`p-3 rounded-lg text-center ${
              uploadStatus.includes('error') || uploadStatus.includes('failed')
                ? 'bg-red-100 text-red-700'
                : 'bg-green-100 text-green-700'
            }`}>
              {uploadStatus}
            </div>
          )}

          {/* Saved Recordings */}
          {savedRecordings.length > 0 && (
            <div className="bg-white rounded-xl p-4 shadow-sm">
              <h3 className="font-semibold text-gray-800 mb-3">Saved Recordings</h3>
              <div className="space-y-2">
                {savedRecordings.slice(0, 10).map((recording) => (
                  <button
                    key={recording.id}
                    onClick={() => setViewingRecording(recording)}
                    className="w-full text-left p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition"
                  >
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <span className="text-2xl">üì∏</span>
                        <div>
                          <p className="font-medium text-gray-800">{recording.jobName}</p>
                          <p className="text-xs text-gray-500">
                            {new Date(recording.date).toLocaleDateString('en-AU')} - {recording.photos.length} photos
                          </p>
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        {recording.driveUploaded && <span className="text-green-500 text-sm">‚òÅÔ∏è</span>}
                        <span className="text-gray-400">‚Ä∫</span>
                      </div>
                    </div>
                  </button>
                ))}
              </div>
            </div>
          )}

          {/* View Recording Modal */}
          {viewingRecording && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] p-4">
              <div className="bg-white rounded-2xl max-w-md w-full shadow-2xl max-h-[80vh] overflow-hidden flex flex-col">
                <div className="bg-teal-600 text-white p-4 flex items-center justify-between">
                  <h2 className="text-lg font-bold">{viewingRecording.jobName}</h2>
                  <button onClick={() => setViewingRecording(null)} className="text-white text-2xl">&times;</button>
                </div>
                <div className="flex-1 overflow-y-auto p-4 space-y-3">
                  <p className="text-sm text-gray-500">
                    {new Date(viewingRecording.date).toLocaleDateString('en-AU', {
                      weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
                    })}
                  </p>
                  {viewingRecording.driveUploaded && (
                    <div className="bg-green-50 border border-green-200 rounded-lg p-2">
                      <p className="text-green-700 text-sm">‚òÅÔ∏è Uploaded to Google Drive</p>
                    </div>
                  )}
                  <div className="grid grid-cols-3 gap-2">
                    {viewingRecording.photos.map((photo, idx) => (
                      <img
                        key={idx}
                        src={photo.data}
                        alt={`Photo ${idx + 1}`}
                        className="w-full h-24 object-cover rounded-lg cursor-pointer hover:opacity-80"
                        onClick={() => {
                          const win = window.open('', '_blank');
                          win.document.write(`<img src="${photo.data}" style="max-width:100%;height:auto;">`);
                        }}
                      />
                    ))}
                  </div>
                </div>
                <div className="p-4 border-t border-gray-200 space-y-2">
                  <button
                    onClick={() => {
                      viewingRecording.photos.forEach((photo, idx) => {
                        const link = document.createElement('a');
                        link.href = photo.data;
                        link.download = `${viewingRecording.jobName}-photo-${idx + 1}.jpg`;
                        link.click();
                      });
                    }}
                    className="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
                  >
                    <span>üì•</span> Download All Photos
                  </button>
                  <button
                    onClick={() => deleteRecording(viewingRecording.id)}
                    className="w-full bg-red-100 text-red-600 py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
                  >
                    <span>üóëÔ∏è</span> Delete Recording
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Info Box */}
          <div className="bg-blue-50 border border-blue-200 rounded-xl p-4">
            <div className="flex items-start gap-3">
              <span className="text-2xl">üí°</span>
              <div>
                <h4 className="font-semibold text-blue-800">Storage Info</h4>
                <p className="text-sm text-blue-700 mt-1">
                  Photos are saved to your phone and can be uploaded to Google Drive.
                  Firebase/Drive has plenty of space (~5GB free, affordable beyond that).
                </p>
              </div>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<AppWithAuth />);
  </script>

  <!-- Loading Screen -->
  <script>
    // Show loading spinner while React loads
    document.getElementById('root').innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:#f3f4f6;"><div class="spinner"></div><p style="margin-top:16px;color:#6b7280;font-family:system-ui;">Loading J&M Artsteel Safety...</p></div>';
  </script>

  <!-- Service Worker Registration (v3 - external file with stale-while-revalidate, background sync) -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./src-v3/sw.js')
        .then(reg => {
          console.log('‚úÖ SW v3 registered, scope:', reg.scope);
          // Listen for updates
          reg.addEventListener('updatefound', () => {
            const newWorker = reg.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                console.log('üîÑ New SW available ‚Äî will activate on next reload');
              }
            });
          });
        })
        .catch(err => console.log('SW registration skipped:', err.message));

      // Handle messages FROM the service worker (background sync triggers)
      navigator.serviceWorker.addEventListener('message', event => {
        if (event.data?.type === 'PROCESS_SYNC_QUEUE') {
          console.log('üì° SW requested form sync');
          // Trigger Firebase sync if available
          if (window.firebaseDb && typeof window.processSyncQueue === 'function') {
            window.processSyncQueue();
          }
        }
        if (event.data?.type === 'PROCESS_DRIVE_QUEUE') {
          console.log('üì° SW requested Drive sync');
          if (typeof window.processDriveQueue === 'function') {
            window.processDriveQueue();
          }
        }
        if (event.data?.type === 'CACHE_STATUS') {
          console.log('üì¶ Cache status:', event.data);
        }
      });
    }

    // Detect standalone mode (installed PWA)
    if (window.matchMedia('(display-mode: standalone)').matches) {
      document.body.classList.add('pwa-standalone');
      console.log('Running as installed PWA');
    }

    // Prevent pull-to-refresh on mobile (interferes with app UX)
    document.body.style.overscrollBehavior = 'none';

    // Handle iOS standalone mode
    if (window.navigator.standalone === true) {
      document.body.classList.add('ios-standalone');
    }
  </script>
</body>
</html>
